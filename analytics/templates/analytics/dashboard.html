{% extends "base.html" %}
{% load static %}

{% block title %}AI Analytics Dashboard - {{ block.super }}{% endblock %}

{% block extra_css %}
<style>
  /* Excel Minimal Design System */
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    font-size: 11pt;
    color: #201F1E;
    background: #F0F0F0;
    line-height: 1.4;
  }

  .page-wrapper {
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    background: #F0F0F0;
  }

  .unified-header {
    background: linear-gradient(135deg, #4472C4 0%, #2B579A 100%);
    border-bottom: 3px solid #1F4788;
    padding: 16px 24px;
    display: flex;
    flex-direction: row;
    align-items: center;
    justify-content: space-between;
    gap: 24px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }

  .header-title-section h2 {
    margin: 0;
    font-size: 20px;
    font-weight: 600;
    color: white;
    line-height: 1.2;
  }

  .company-name {
    font-size: 12px;
    opacity: 0.85;
    color: rgba(255, 255, 255, 0.95);
    margin: 0;
    font-weight: 400;
  }

  .balance-grid {
    display: flex;
    align-items: stretch;
    gap: 12px;
    flex: 1;
    justify-content: flex-end;
  }

  .balance-item {
    flex: 0 0 auto;
    padding: 10px 16px;
    background: white;
    border-radius: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-width: 140px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.08);
    border: 1px solid rgba(255, 255, 255, 0.2);
    transition: transform 0.2s, box-shadow 0.2s;
  }

  .balance-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
  }

  .balance-item:first-child { border-left: 3px solid #4472C4; }
  .balance-item:nth-child(2) { border-left: 3px solid #107C10; }
  .balance-item:nth-child(3) { border-left: 3px solid #CA5010; }
  .balance-item:nth-child(4) { border-left: 3px solid #D83B01; }

  .balance-label {
    font-size: 9px;
    color: #605E5C;
    margin-bottom: 4px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    text-align: center;
  }

  .balance-value {
    font-size: 18px;
    font-weight: 700;
    font-family: Consolas, 'Courier New', monospace;
    color: #201F1E;
  }

  .header-actions {
    display: flex;
    gap: 8px;
    flex: 0 0 auto;
  }

  .header-actions .btn-primary,
  .header-actions .btn-danger {
    background: white;
    color: #4472C4;
    border: none;
    padding: 8px 16px;
    font-size: 11pt;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 6px;
    text-decoration: none;
    border-radius: 0;
  }

  .header-actions .btn-danger { color: #D83B01; }
  .header-actions .btn-primary:hover {
    background: #F3F2F1;
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }
  .header-actions .btn-danger:hover {
    background: #D83B01;
    color: white;
  }

  .content-area {
    flex: 1;
    padding: 20px;
    max-width: 1600px;
    margin: 0 auto;
    width: 100%;
  }

  .excel-card {
    background: white;
    border: 1px solid #D2D0CE;
    border-radius: 0;
    margin-bottom: 20px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.08);
  }

  .excel-card-header {
    padding: 14px 18px;
    background: #F3F2F1;
    border-bottom: 2px solid #4472C4;
    font-size: 12pt;
    font-weight: 600;
    color: #323130;
  }

  .excel-card-body {
    padding: 18px;
  }

  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 12px;
    margin-bottom: 20px;
  }

  .stat-box {
    background: white;
    border: 1px solid #D2D0CE;
    border-left: 3px solid #4472C4;
    padding: 14px;
    transition: all 0.2s;
  }

  .stat-box:hover {
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    transform: translateY(-1px);
  }

  .stat-label {
    font-size: 10px;
    color: #8A8886;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 8px;
    font-weight: 700;
  }

  .stat-value {
    font-size: 24px;
    font-weight: 700;
    color: #323130;
    font-family: 'Segoe UI', sans-serif;
    margin-bottom: 4px;
  }

  .stat-subtext {
    font-size: 10px;
    color: #605E5C;
  }

  .excel-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 11pt;
  }

  .excel-table thead {
    background: #F3F2F1;
    border-bottom: 2px solid #4472C4;
  }

  .excel-table th {
    padding: 12px 14px;
    text-align: left;
    font-weight: 600;
    color: #323130;
    border-right: 1px solid #EDEBE9;
    font-size: 10pt;
    text-transform: uppercase;
    letter-spacing: 0.3px;
  }

  .excel-table th:last-child { border-right: none; }

  .excel-table tbody tr {
    border-bottom: 1px solid #EDEBE9;
    transition: background 0.15s;
  }

  .excel-table tbody tr:hover {
    background: #F8F9FA;
  }

  .excel-table td {
    padding: 12px 14px;
    border-right: 1px solid #EDEBE9;
    font-size: 11pt;
  }

  .excel-table td:last-child { border-right: none; }

  .excel-badge {
    display: inline-block;
    padding: 4px 10px;
    font-size: 9pt;
    font-weight: 600;
    border-radius: 0;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .excel-badge-success {
    background: #DFF6DD;
    color: #107C10;
    border: 1px solid #107C10;
  }

  .excel-badge-info {
    background: #DEECF9;
    color: #4472C4;
    border: 1px solid #4472C4;
  }

  .excel-badge-warning {
    background: #FFF4CE;
    color: #CA5010;
    border: 1px solid #CA5010;
  }

  .excel-badge-danger {
    background: #FDE7E9;
    color: #D83B01;
    border: 1px solid #D83B01;
  }

  .health-indicator {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    display: inline-block;
    margin-right: 6px;
  }

  .health-excellent { background-color: #107C10; }
  .health-good { background-color: #4472C4; }
  .health-fair { background-color: #CA5010; }
  .health-poor { background-color: #D83B01; }

  .excel-btn {
    font-family: 'Segoe UI', sans-serif;
    font-size: 10pt;
    padding: 6px 12px;
    border: 1px solid #D2D0CE;
    border-radius: 0;
    background: #FFFFFF;
    color: #4472C4;
    cursor: pointer;
    transition: all 0.2s;
    text-decoration: none;
    display: inline-block;
  }

  .excel-btn:hover {
    background: #4472C4;
    color: #FFFFFF;
    border-color: #4472C4;
  }

  .excel-empty {
    text-align: center;
    padding: 40px 20px;
    color: #8A8886;
  }

  .excel-empty-icon {
    font-size: 48px;
    margin-bottom: 16px;
    opacity: 0.3;
  }

  .two-col-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 20px;
  }

  @media (max-width: 768px) {
    .two-col-grid {
      grid-template-columns: 1fr;
    }
  }

  .chart-container {
    position: relative;
    height: 250px;
  }
</style>
{% endblock %}

{% block content %}
<div class="page-wrapper">
  <div class="unified-header">
    <div class="header-title-section">
      <h2>🧠 AI Analytics Dashboard</h2>
      <p class="company-name">{{ company.name }} • {{ date_range_start|date:"M d" }} to {{ date_range_end|date:"M d, Y" }}</p>
    </div>
    
    <div class="balance-grid">
      <div class="balance-item">
        <div class="balance-label">Transactions</div>
        <div class="balance-value">{{ total_transactions|default:"0" }}</div>
      </div>
      <div class="balance-item">
        <div class="balance-label">AI Matched</div>
        <div class="balance-value">{{ total_ai_matched|default:"0" }}</div>
      </div>
      <div class="balance-item">
        <div class="balance-label">Automation</div>
        <div class="balance-value">{{ avg_automation_rate|default:"0" }}%</div>
      </div>
      <div class="balance-item">
        <div class="balance-label">Time Saved</div>
        <div class="balance-value">{{ total_time_saved_hours|default:"0" }}h</div>
      </div>
    </div>
    
    <div class="header-actions">
      <button class="btn-primary" onclick="window.location.reload()">🔄 Refresh</button>
      <a href="{% url 'analytics:reset_ai' %}" class="btn-danger">🗑️ Reset AI</a>
    </div>
  </div>

  <div class="content-area">
    <div class="two-col-grid">
      <div class="excel-card">
        <div class="excel-card-header">📈 AI Accuracy Trend (Last 7 Days)</div>
        <div class="excel-card-body">
          <div class="chart-container">
            <canvas id="accuracyChart"></canvas>
          </div>
        </div>
      </div>

      <div class="excel-card">
        <div class="excel-card-header">🤖 Automation Rate Trend (Last 7 Days)</div>
        <div class="excel-card-body">
          <div class="chart-container">
            <canvas id="automationChart"></canvas>
          </div>
        </div>
      </div>
    </div>

    <div class="two-col-grid">
      <div class="excel-card">
        <div class="excel-card-header">🏆 Top Performing Patterns</div>
        <div class="excel-card-body">
          {% if top_patterns %}
            <table class="excel-table">
              <thead>
                <tr>
                  <th>Pattern</th>
                  <th style="text-align:center;">Accuracy</th>
                  <th style="text-align:center;">Used</th>
                  <th style="text-align:center;">Status</th>
                  <th style="text-align:center;">Action</th>
                </tr>
              </thead>
              <tbody>
                {% for analytics in top_patterns %}
                <tr>
                  <td>
                    <div style="font-weight:600;">{{ analytics.pattern.description_pattern|truncatechars:40 }}</div>
                    <div style="font-size:10pt;color:#8A8886;">{{ analytics.pattern.pattern_name }}</div>
                  </td>
                  <td style="text-align:center;">
                    {% if analytics.acceptance_rate >= 90 %}
                      <span class="excel-badge excel-badge-success">{{ analytics.acceptance_rate|floatformat:1 }}%</span>
                    {% elif analytics.acceptance_rate >= 70 %}
                      <span class="excel-badge excel-badge-info">{{ analytics.acceptance_rate|floatformat:1 }}%</span>
                    {% else %}
                      <span class="excel-badge excel-badge-warning">{{ analytics.acceptance_rate|floatformat:1 }}%</span>
                    {% endif %}
                  </td>
                  <td style="text-align:center;font-weight:700;font-family:Consolas,monospace;">{{ analytics.times_suggested }}</td>
                  <td style="text-align:center;">
                    <span class="health-indicator health-{{ analytics.pattern.health_status }}"></span>
                    {{ analytics.pattern.get_health_status_display }}
                  </td>
                  <td style="text-align:center;">
                    <a href="{% url 'analytics:pattern_detail' analytics.pattern.id %}" class="excel-btn">View</a>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          {% else %}
            <div class="excel-empty">
              <div class="excel-empty-icon">🧠</div>
              <p>No AI patterns detected yet</p>
            </div>
          {% endif %}
        </div>
      </div>

      <div class="excel-card">
        <div class="excel-card-header">🔧 System Health</div>
        <div class="excel-card-body">
          {% if system_health %}
            <div class="stats-grid" style="grid-template-columns:1fr 1fr;">
              <div class="stat-box" style="border-left-color:#107C10;">
                <div class="stat-label">Health Status</div>
                <div class="stat-value" style="font-size:18px;">
                  <span class="health-indicator health-{{ system_health.health_status }}"></span>
                  {{ system_health.get_health_status_display }}
                </div>
              </div>
              <div class="stat-box" style="border-left-color:#4472C4;">
                <div class="stat-label">Active Patterns</div>
                <div class="stat-value">{{ system_health.active_patterns }}</div>
              </div>
              <div class="stat-box" style="border-left-color:#CA5010;">
                <div class="stat-label">Avg Response</div>
                <div class="stat-value" style="font-size:18px;">{{ system_health.avg_response_time|floatformat:0 }}ms</div>
              </div>
              <div class="stat-box" style="border-left-color:#8A8886;">
                <div class="stat-label">Last Check</div>
                <div class="stat-value" style="font-size:16px;">{{ system_health.date|timesince }}</div>
                <div class="stat-subtext">ago</div>
              </div>
            </div>
          {% else %}
            <div class="excel-empty">
              <div class="excel-empty-icon">💓</div>
              <p>No health data available</p>
            </div>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="two-col-grid">
      <div class="excel-card">
        <div class="excel-card-header">📊 Pattern Statistics</div>
        <div class="excel-card-body">
          <div class="stats-grid" style="grid-template-columns:1fr 1fr;">
            <div class="stat-box">
              <div class="stat-label">Total Patterns</div>
              <div class="stat-value">{{ pattern_stats.total_patterns|default:"0" }}</div>
            </div>
            <div class="stat-box" style="border-left-color:#107C10;">
              <div class="stat-label">Well Trained</div>
              <div class="stat-value" style="color:#107C10;">{{ pattern_stats.well_trained|default:"0" }}</div>
              <div class="stat-subtext">{{ pattern_stats.well_trained_pct|default:0|floatformat:0 }}%</div>
            </div>
            <div class="stat-box" style="border-left-color:#4472C4;">
              <div class="stat-label">High Accuracy</div>
              <div class="stat-value" style="color:#4472C4;">{{ pattern_stats.high_accuracy|default:"0" }}</div>
              <div class="stat-subtext">{{ pattern_stats.high_accuracy_pct|default:0|floatformat:0 }}%</div>
            </div>
            <div class="stat-box" style="border-left-color:#CA5010;">
              <div class="stat-label">Needs Training</div>
              <div class="stat-value" style="color:#CA5010;">{{ pattern_stats.needs_training|default:"0" }}</div>
              <div class="stat-subtext">{{ pattern_stats.needs_training_pct|default:0|floatformat:0 }}%</div>
            </div>
          </div>
        </div>
      </div>

      <div class="excel-card">
        <div class="excel-card-header">👥 User Performance Leaderboard</div>
        <div class="excel-card-body">
          {% if user_leaderboard %}
            <table class="excel-table">
              <thead>
                <tr>
                  <th>User</th>
                  <th style="text-align:center;">Reconciled</th>
                  <th style="text-align:center;">AI Usage</th>
                  <th style="text-align:center;">Time Saved</th>
                </tr>
              </thead>
              <tbody>
                {% for user in user_leaderboard %}
                <tr>
                  <td>
                    {% if forloop.counter == 1 %}🥇{% elif forloop.counter == 2 %}🥈{% elif forloop.counter == 3 %}🥉{% endif %}
                    <strong>{{ user.display_name }}</strong>
                  </td>
                  <td style="text-align:center;font-family:Consolas,monospace;font-weight:600;">{{ user.total_reconciliations }}</td>
                  <td style="text-align:center;">
                    <span class="excel-badge excel-badge-info">{{ user.ai_usage_rate|floatformat:0 }}%</span>
                  </td>
                  <td style="text-align:center;font-family:Consolas,monospace;font-weight:600;">{{ user.time_saved_hours }}h</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          {% else %}
            <div class="excel-empty">
              <div class="excel-empty-icon">👥</div>
              <p>No user data yet</p>
            </div>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="excel-card">
      <div class="excel-card-header">💬 Recent AI Feedback</div>
      <div class="excel-card-body">
        {% if recent_feedback %}
          <table class="excel-table">
            <thead>
              <tr>
                <th style="width:120px;">Time</th>
                <th>Pattern</th>
                <th style="width:100px;text-align:center;">Feedback</th>
                <th style="width:150px;">User</th>
                <th>Comments</th>
              </tr>
            </thead>
            <tbody>
              {% for feedback in recent_feedback %}
              <tr>
                <td style="color:#8A8886;font-size:10pt;">{{ feedback.created_at|timesince }} ago</td>
                <td>{{ feedback.pattern.description_pattern|truncatechars:40 }}</td>
                <td style="text-align:center;">
                  {% if feedback.was_correct %}
                    <span class="excel-badge excel-badge-success">✓ Correct</span>
                  {% else %}
                    <span class="excel-badge excel-badge-danger">✗ Wrong</span>
                  {% endif %}
                </td>
                <td>{{ feedback.user.username }}</td>
                <td style="color:#605E5C;">{{ feedback.comments|default:"-"|truncatechars:50 }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        {% else %}
          <div class="excel-empty">
            <div class="excel-empty-icon">💬</div>
            <p>No feedback yet</p>
          </div>
        {% endif %}
      </div>
    </div>

  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
const accuracyCtx = document.getElementById('accuracyChart').getContext('2d');
new Chart(accuracyCtx, {
    type: 'line',
    data: {
        labels: {{ chart_dates|safe }},
        datasets: [{
            label: 'AI Accuracy %',
            data: {{ chart_ai_accuracy|safe }},
            borderColor: '#4472C4',
            backgroundColor: 'rgba(68, 114, 196, 0.1)',
            tension: 0.4,
            fill: true,
            borderWidth: 2
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: { display: false }
        },
        scales: {
            y: {
                beginAtZero: true,
                max: 100,
                ticks: {
                    callback: function(value) {
                        return value + '%';
                    }
                }
            }
        }
    }
});

const automationCtx = document.getElementById('automationChart').getContext('2d');
new Chart(automationCtx, {
    type: 'line',
    data: {
        labels: {{ chart_dates|safe }},
        datasets: [{
            label: 'Automation Rate %',
            data: {{ chart_automation_rate|safe }},
            borderColor: '#107C10',
            backgroundColor: 'rgba(16, 124, 16, 0.1)',
            tension: 0.4,
            fill: true,
            borderWidth: 2
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: { display: false }
        },
        scales: {
            y: {
                beginAtZero: true,
                max: 100,
                ticks: {
                    callback: function(value) {
                        return value + '%';
                    }
                }
            }
        }
    }
});
</script>
{% endblock %}

{% extends 'base.html' %}
{% load static %}

{% block title %}Fixed Assets - {{ active_company.name|default:"Professional Accounting System" }}{% endblock %}

{% block extra_css %}
<style>
  .fa-banner { background:#f6f7f8; border:1px solid #e5e7eb; border-radius:.5rem; }
  .x-tabs .nav-link { font-weight:600; }
  .x-tabs .nav-link.active { border-bottom:3px solid #2563eb; color:#111827; }
  .empty-box { border:1px solid #e5e7eb; border-radius:.5rem; background:#fff; }
  .asset-row:hover { background:#f9fafb; }
  .status-badge { font-size:.75rem; }
</style>
{% endblock %}

{% block content %}
<!-- Company Context Header -->
{% if active_company %}
<div class="company-context-header mb-3">
    <div class="d-flex align-items-center">
        <div class="company-logo-small me-3">
            {% if active_company.logo %}
                <img src="{{ active_company.logo.url }}" alt="{{ active_company.name }}" class="rounded" style="width: 40px; height: 40px; object-fit: cover;">
            {% else %}
                <div class="bg-primary rounded d-flex align-items-center justify-content-center" style="width: 40px; height: 40px; color: white; font-weight: 600;">
                    {{ active_company.name|first|upper }}
                </div>
            {% endif %}
        </div>
        <div>
            <h6 class="text-muted mb-0">
                <i class="bi bi-building me-1"></i>
                {{ active_company.name }}
            </h6>
            <small class="text-muted">Fixed Assets</small>
        </div>
    </div>
</div>
{% endif %}

<!-- Breadcrumb Navigation -->
<nav aria-label="breadcrumb" class="mb-3">
    <ol class="breadcrumb">
        {% if active_company %}
            <li class="breadcrumb-item">{{ active_company.name }}</li>
        {% endif %}
        <li class="breadcrumb-item">Assets</li>
        <li class="breadcrumb-item active">Fixed Assets</li>
    </ol>
</nav>

<div class="container-fluid py-4">
  <!-- Header actions -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h5 class="mb-0">Fixed Assets</h5>
    <div class="d-flex gap-2">
      <a href="{% url 'assets:run_depreciation' %}" class="btn btn-outline-primary btn-sm"><i class="bi bi-calculator me-1"></i>Run depreciation</a>
      <a href="{% url 'assets:new' %}" class="btn btn-success btn-sm"><i class="bi bi-plus me-1"></i>New asset</a>
      <div class="dropdown">
        <button class="btn btn-outline-secondary btn-sm dropdown-toggle" data-bs-toggle="dropdown"><i class="bi bi-three-dots-vertical"></i></button>
        <ul class="dropdown-menu dropdown-menu-end">
          <li><a class="dropdown-item" href="{% url 'assets:import' %}"><i class="bi bi-upload me-2"></i>Import registry</a></li>
          <li><a class="dropdown-item" href="{% url 'assets:export' %}"><i class="bi bi-download me-2"></i>Export</a></li>
        </ul>
      </div>
    </div>
  </div>

  <!-- Sub banner (optional) -->
  <div class="fa-banner p-2 mb-3 small text-muted d-flex justify-content-between">
    <span>Last depreciation: <strong>{{ last_depr_date|default:'none' }}</strong></span>
    <a class="text-decoration-underline" href="#" onclick="document.getElementById('promoBanner')?.classList.toggle('d-none'); return false;">Show banner</a>
  </div>
  <div id="promoBanner" class="alert alert-info d-none">Tip: Add your existing assets or import your registry to start tracking depreciation.</div>

  <!-- Tabs: Draft | Registered | Sold/Disposed -->
  <ul class="nav nav-tabs x-tabs mb-3">
    <li class="nav-item"><a class="nav-link {% if tab == 'draft' %}active{% endif %}" href="{% url 'assets:list' %}?tab=draft">Draft <span class="badge bg-secondary ms-1">{{ counts.draft|default:0 }}</span></a></li>
    <li class="nav-item"><a class="nav-link {% if tab == 'registered' %}active{% endif %}" href="{% url 'assets:list' %}?tab=registered">Registered <span class="badge bg-secondary ms-1">{{ counts.registered|default:0 }}</span></a></li>
    <li class="nav-item"><a class="nav-link {% if tab == 'sold' %}active{% endif %}" href="{% url 'assets:list' %}?tab=sold">Sold/Disposed <span class="badge bg-secondary ms-1">{{ counts.sold|default:0 }}</span></a></li>
  </ul>

  {% if assets %}
  <!-- Bulk Actions Bar -->
  <div class="card mb-2" id="bulkActionsBar" style="display: none;">
    <div class="card-body py-2">
      <div class="d-flex align-items-center justify-content-between">
        <span class="text-muted small">
          <span id="selectedCount">0</span> asset(s) selected
        </span>
        <div class="d-flex gap-2">
          <button class="btn btn-outline-danger btn-sm" onclick="confirmBulkDelete()">
            <i class="bi bi-trash me-1"></i>Delete Selected
          </button>
          <button class="btn btn-outline-secondary btn-sm" onclick="clearSelection()">
            Clear Selection
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="table-responsive">
      <table class="table align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th style="width: 40px;">
              <input type="checkbox" class="form-check-input" id="selectAll" onchange="toggleAllCheckboxes()">
            </th>
            <th>Asset</th>
            <th>Asset #</th>
            <th>Type</th>
            <th class="text-end">Purchase price</th>
            <th>Purchase date</th>
            <th>Status</th>
            <th class="text-end">Book value</th>
            <th class="text-end">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for a in assets %}
          <tr class="asset-row">
            <td>
              <input type="checkbox" class="form-check-input asset-checkbox" name="selected_assets" value="{{ a.id }}" onchange="updateBulkActions()">
            </td>
            <td>
              <a href="{% url 'assets:detail' a.id %}" class="fw-semibold text-decoration-none">{{ a.name }}</a>
              <div class="small text-muted">{{ a.description|default:'' }}</div>
            </td>
            <td>{{ a.number }}</td>
            <td>{{ a.type_name }}</td>
            <td class="text-end">${{ a.purchase_price|floatformat:2 }}</td>
            <td>{{ a.purchase_date|date:'d M Y' }}</td>
            <td><span class="badge bg-{{ a.status_badge }} status-badge">{{ a.status|title }}</span></td>
            <td class="text-end">${{ a.book_value|default:0|floatformat:2 }}</td>
            <td class="text-end">
              <div class="btn-group btn-group-sm">
                <a class="btn btn-outline-secondary" href="{% url 'assets:edit' a.id %}" title="Edit asset"><i class="bi bi-pencil"></i></a>
                <a class="btn btn-outline-secondary" href="{% url 'assets:depreciation' a.id %}" title="View depreciation"><i class="bi bi-graph-up"></i></a>
                <button class="btn btn-outline-danger" onclick="confirmDelete({{ a.id }}, '{{ a.name|escapejs }}')" title="Delete asset"><i class="bi bi-trash"></i></button>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  {% else %}
  <div class="empty-box p-5 text-center text-muted">
    <div class="fw-semibold mb-1">No {{ tab|default:'draft' }} assets to display</div>
    <div class="small">Add an asset manually from the <a href="{% url 'assets:new' %}">New asset</a> button or import your registry to see them here.</div>
  </div>
  {% endif %}
</div>

<!-- Bulk Delete Confirmation Modal -->
<div class="modal fade" id="bulkDeleteModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Confirm Bulk Deletion</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="d-flex align-items-center mb-3">
          <i class="bi bi-exclamation-triangle text-warning me-3" style="font-size: 2rem;"></i>
          <div>
            <h6 class="mb-1">Are you sure you want to delete the selected assets?</h6>
            <p class="mb-0 text-muted">This action cannot be undone.</p>
          </div>
        </div>
        <div class="border rounded p-3 bg-light">
          <strong>Selected assets:</strong> <span id="bulkDeleteCount"></span>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" onclick="executeBulkDelete()">
          <i class="bi bi-trash me-1"></i>Delete Selected Assets
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Confirm Asset Deletion</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="d-flex align-items-center mb-3">
          <i class="bi bi-exclamation-triangle text-warning me-3" style="font-size: 2rem;"></i>
          <div>
            <h6 class="mb-1">Are you sure you want to delete this asset?</h6>
            <p class="mb-0 text-muted">This action cannot be undone.</p>
          </div>
        </div>
        <div class="border rounded p-3 bg-light">
          <strong>Asset:</strong> <span id="deleteAssetName"></span>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <form id="deleteForm" method="post" style="display: inline;">
          {% csrf_token %}
          <button type="submit" class="btn btn-danger">
            <i class="bi bi-trash me-1"></i>Delete Asset
          </button>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function confirmDelete(assetId, assetName) {
  // Set the asset name in the modal
  document.getElementById('deleteAssetName').textContent = assetName;
  
  // Set the form action URL
  document.getElementById('deleteForm').action = `/assets/${assetId}/delete/`;
  
  // Show the modal
  const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
  modal.show();
}

function toggleAllCheckboxes() {
  const selectAll = document.getElementById('selectAll');
  const checkboxes = document.querySelectorAll('.asset-checkbox');
  
  checkboxes.forEach(checkbox => {
    checkbox.checked = selectAll.checked;
  });
  
  updateBulkActions();
}

function updateBulkActions() {
  const selectedCheckboxes = document.querySelectorAll('.asset-checkbox:checked');
  const selectedCount = selectedCheckboxes.length;
  const bulkActionsBar = document.getElementById('bulkActionsBar');
  const selectedCountSpan = document.getElementById('selectedCount');
  
  if (selectedCount > 0) {
    bulkActionsBar.style.display = 'block';
    selectedCountSpan.textContent = selectedCount;
  } else {
    bulkActionsBar.style.display = 'none';
  }
  
  // Update "select all" checkbox state
  const allCheckboxes = document.querySelectorAll('.asset-checkbox');
  const selectAllCheckbox = document.getElementById('selectAll');
  
  if (selectedCount === 0) {
    selectAllCheckbox.indeterminate = false;
    selectAllCheckbox.checked = false;
  } else if (selectedCount === allCheckboxes.length) {
    selectAllCheckbox.indeterminate = false;
    selectAllCheckbox.checked = true;
  } else {
    selectAllCheckbox.indeterminate = true;
  }
}

function clearSelection() {
  document.querySelectorAll('.asset-checkbox').forEach(checkbox => {
    checkbox.checked = false;
  });
  document.getElementById('selectAll').checked = false;
  updateBulkActions();
}

function confirmBulkDelete() {
  const selectedCheckboxes = document.querySelectorAll('.asset-checkbox:checked');
  const selectedCount = selectedCheckboxes.length;
  
  if (selectedCount === 0) {
    alert('Please select at least one asset to delete.');
    return;
  }
  
  document.getElementById('bulkDeleteCount').textContent = `${selectedCount} asset(s)`;
  
  const modal = new bootstrap.Modal(document.getElementById('bulkDeleteModal'));
  modal.show();
}

function executeBulkDelete() {
  const selectedCheckboxes = document.querySelectorAll('.asset-checkbox:checked');
  const assetIds = Array.from(selectedCheckboxes).map(cb => cb.value);
  
  if (assetIds.length === 0) {
    return;
  }
  
  // Create a form to submit the bulk delete request
  const form = document.createElement('form');
  form.method = 'POST';
  form.action = '/assets/bulk-delete/';
  
  // Add CSRF token
  const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
  const csrfInput = document.createElement('input');
  csrfInput.type = 'hidden';
  csrfInput.name = 'csrfmiddlewaretoken';
  csrfInput.value = csrfToken;
  form.appendChild(csrfInput);
  
  // Add asset IDs
  assetIds.forEach(id => {
    const input = document.createElement('input');
    input.type = 'hidden';
    input.name = 'asset_ids';
    input.value = id;
    form.appendChild(input);
  });
  
  document.body.appendChild(form);
  form.submit();
}

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
  updateBulkActions();
});
</script>
{% endblock %}

{% extends 'base.html' %}
{% load static %}

{% block title %}Import bank transactions{% endblock %}

{% block extra_css %}
<style>
  .step { display:flex; align-items:center; gap:.5rem; color:#6b7280; }
  .step.active { color:#111827; font-weight:600; }
  .dropzone { 
    border:2px dashed #cbd5e1; 
    border-radius:.75rem; 
    padding:3rem 2rem; 
    text-align:center; 
    color:#6b7280;
    cursor: pointer;
    transition: all 0.3s ease;
    background: #fafbfc;
  }
  .dropzone:hover {
    border-color: #3b82f6;
    background: #f0f9ff;
  }
  .dropzone.file-selected {
    border-color: #16a34a;
    background: #f0fdf4;
    border-style: solid;
  }
  .file-preview {
    display: none;
  }
  .file-preview.show {
    display: block;
  }
  .upload-history-item {
    transition: all 0.2s ease;
  }
  .upload-history-item:hover {
    background-color: #f8fafc;
  }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
  <h5 class="mb-3">{{ account.name }} â€” Import transactions</h5>

  <!-- Steps -->
  <div class="d-flex align-items-center gap-4 mb-4">
    <div class="step active"><span class="badge bg-primary">1</span> Upload</div>
    <div class="step"><span class="badge bg-secondary">2</span> Review</div>
    <div class="step"><span class="badge bg-secondary">3</span> Complete</div>
  </div>

  <div class="card" style="max-width:900px;">
    <div class="card-body">
      <h6 class="mb-3">
        <i class="fas fa-upload me-2 text-primary"></i>Upload bank statement
      </h6>
      <p class="text-muted small mb-3">
        Upload your bank statement as CSV (.csv) or Excel (.xlsx, .xls) file. Expected format: <strong>Date, Amount, Payee, Description, Reference</strong>
      </p>
      
      <!-- Format Example -->
      <div class="alert alert-info mb-3">
        <strong>ðŸ“‹ Expected CSV Format:</strong><br>
        <code>Date,Amount,Payee,Description,Reference</code><br>
        <code>01/01/2025,520000,,Cash deposit,REF15695</code><br>
        <small class="text-muted">â€¢ Date: DD/MM/YYYY or MM/DD/YYYY format<br>
        â€¢ Amount: Numbers only (negative for debits, positive for credits)<br>
        â€¢ Description: Transaction description<br>
        â€¢ Reference: Transaction reference number</small>
      </div>

      <form method="post" enctype="multipart/form-data" id="uploadForm">
        {% csrf_token %}
        
        <!-- Single Dropzone Area -->
        <div class="dropzone mb-3" id="dropzone">
          <div id="dropzoneContent">
            <i class="fas fa-cloud-upload-alt fa-2x mb-2 text-muted"></i>
            <div class="mb-2">Drag and drop your CSV or Excel file here</div>
            <div class="text-muted small mb-3">or</div>
            <button class="btn btn-outline-primary" type="button" id="selectFileBtn">
              <i class="fas fa-folder-open me-1"></i>Select File
            </button>
          </div>
        </div>
        
        <input type="file" id="fileInput" name="statement_file" class="d-none" accept=".csv,.xlsx,.xls"/>
        
        <div class="small text-muted mb-3">File should be CSV (.csv) or Excel (.xlsx, .xls) format, maximum 10MB</div>

        <!-- Action Buttons -->
        <div class="d-flex justify-content-between align-items-center">
          <a href="{% url 'bank_accounts:dashboard' %}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-1"></i>Back to Accounts
          </a>
          <div class="d-flex gap-2">
            <button type="button" class="btn btn-outline-warning d-none" id="clearBtn">
              <i class="fas fa-times me-1"></i>Clear File
            </button>
            <button type="submit" class="btn btn-primary" id="uploadBtn" disabled>
              <i class="fas fa-upload me-1"></i>Upload & Process
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>
  
  {% if recent_uploads %}
  <div class="card mt-4" style="max-width:900px;">
    <div class="card-header bg-light">
      <h6 class="mb-0">
        <i class="fas fa-history me-2 text-primary"></i>Previously Uploaded Files
      </h6>
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover mb-0">
          <thead class="table-light">
            <tr>
              <th class="ps-3">
                <i class="fas fa-file me-1 text-success"></i>File Name
              </th>
              <th>
                <i class="fas fa-calendar me-1 text-info"></i>Upload Date
              </th>
              <th>
                <i class="fas fa-chart-bar me-1 text-warning"></i>Results
              </th>
              <th class="text-center">
                <i class="fas fa-check-circle me-1 text-success"></i>Status
              </th>
              <th class="text-center">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for upload in recent_uploads %}
            <tr>
              <td class="ps-3">
                <div class="d-flex align-items-center">
                  <div class="bg-success bg-opacity-10 rounded p-2 me-3">
                    {% if '.xlsx' in upload.original_filename or '.xls' in upload.original_filename %}
                      <i class="fas fa-file-excel text-success"></i>
                    {% else %}
                      <i class="fas fa-file-csv text-success"></i>
                    {% endif %}
                  </div>
                  <div>
                    <div class="fw-semibold text-primary">{{ upload.original_filename }}</div>
                    <div class="small text-muted">
                      <i class="fas fa-weight me-1"></i>{{ upload.file_size|filesizeformat }}
                      <span class="mx-2">â€¢</span>
                      <i class="fas fa-rows me-1"></i>{{ upload.total_rows }} rows
                    </div>
                  </div>
                </div>
              </td>
              <td>
                <div class="fw-medium">{{ upload.uploaded_at|date:"M j, Y" }}</div>
                <div class="small text-muted">{{ upload.uploaded_at|time:"g:i A" }}</div>
              </td>
              <td>
                <div class="d-flex flex-wrap gap-1">
                  {% if upload.imported_count > 0 %}
                  <span class="badge bg-success">
                    <i class="fas fa-check me-1"></i>{{ upload.imported_count }} imported
                  </span>
                  {% endif %}
                  {% if upload.duplicate_count > 0 %}
                  <span class="badge bg-warning">
                    <i class="fas fa-copy me-1"></i>{{ upload.duplicate_count }} duplicates
                  </span>
                  {% endif %}
                  {% if upload.error_count > 0 %}
                  <span class="badge bg-danger">
                    <i class="fas fa-exclamation me-1"></i>{{ upload.error_count }} errors
                  </span>
                  {% endif %}
                </div>
              </td>
              <td class="text-center">
                {% if upload.imported_count > 0 %}
                  {% if upload.error_count == 0 %}
                    <span class="badge bg-success">
                      <i class="fas fa-check-circle me-1"></i>Complete
                    </span>
                  {% else %}
                    <span class="badge bg-warning">
                      <i class="fas fa-exclamation-triangle me-1"></i>Partial
                    </span>
                  {% endif %}
                {% else %}
                  <span class="badge bg-danger">
                    <i class="fas fa-times-circle me-1"></i>Failed
                  </span>
                {% endif %}
              </td>
              <td class="text-center">
                <div class="btn-group" role="group">
                  <button class="btn btn-outline-info btn-sm" title="View Details">
                    <i class="fas fa-eye"></i>
                  </button>
                  <button class="btn btn-outline-danger btn-sm" 
                          onclick="confirmDelete('{{ upload.id }}', '{{ upload.original_filename }}', {{ upload.imported_count }})"
                          title="Delete Upload">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    <div class="card-footer bg-light text-muted">
      <small>
        <i class="fas fa-info-circle me-1"></i>
        Showing {{ recent_uploads|length }} most recent upload{{ recent_uploads|length|pluralize }}. 
        Deleting an upload will remove all its associated transactions.
      </small>
    </div>
  </div>
  {% else %}
  <!-- No uploads yet message -->
  <div class="card mt-4" style="max-width:900px;">
    <div class="card-body text-center py-4">
      <i class="fas fa-upload fa-3x text-muted mb-3"></i>
      <h6 class="text-muted">No Files Uploaded Yet</h6>
      <p class="text-muted small mb-0">
        Upload your first CSV or Excel file to see it listed here with processing results and management options.
      </p>
    </div>
  </div>
  {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const dropzone = document.getElementById('dropzone');
  const fileInput = document.getElementById('fileInput');
  const selectBtn = document.getElementById('selectFileBtn');
  const uploadBtn = document.getElementById('uploadBtn');
  const clearBtn = document.getElementById('clearBtn');
  const form = document.getElementById('uploadForm');
  const dropzoneContent = document.getElementById('dropzoneContent');
  
  // Single file select handler
  selectBtn.addEventListener('click', function(e) {
    e.preventDefault();
    fileInput.click();
  });
  
  // Dropzone click handler
  dropzone.addEventListener('click', function(e) {
    if (e.target === dropzone || e.target === dropzoneContent) {
      fileInput.click();
    }
  });
  
  // File input change handler
  fileInput.addEventListener('change', function() {
    handleFileSelection();
  });
  
  // Clear file handler
  clearBtn.addEventListener('click', function() {
    clearFile();
  });
  
  // Form submission handler
  form.addEventListener('submit', function(e) {
    if (!fileInput.files || fileInput.files.length === 0) {
      e.preventDefault();
      alert('Please select a CSV file to upload.');
      return false;
    }
    
    const file = fileInput.files[0];
    if (!file.name.toLowerCase().match(/\.(csv|xlsx|xls)$/)) {
      e.preventDefault();
      alert('Please select a CSV (.csv) or Excel (.xlsx, .xls) file.');
      return false;
    }
    
    // Show uploading state with progress
    uploadBtn.disabled = true;
    clearBtn.style.display = 'none';
    
    // Update dropzone to show upload progress
    dropzoneContent.innerHTML = `
      <div class="text-primary">
        <i class="fas fa-cloud-upload-alt fa-3x mb-3 text-primary"></i>
        <div class="fw-bold fs-6 mb-2">Uploading ${file.name}</div>
        <div class="alert alert-primary py-2 mb-3">
          <div class="d-flex align-items-center mb-2">
            <i class="fas fa-spinner fa-spin me-2"></i>
            <span class="fw-bold">Processing file...</span>
          </div>
          <div class="progress" style="height: 10px;">
            <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100">
              <span class="visually-hidden">Uploading...</span>
            </div>
          </div>
          <small class="text-muted mt-1 d-block">
            <i class="fas fa-info-circle me-1"></i>Uploading and processing transactions...
          </small>
        </div>
      </div>
    `;
    
    uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Processing...';
  });
  
  // Drag and drop handlers
  dropzone.addEventListener('dragover', function(e) { 
    e.preventDefault(); 
    dropzone.classList.add('border-primary');
  });
  
  dropzone.addEventListener('dragleave', function(e) { 
    e.preventDefault();
    dropzone.classList.remove('border-primary');
  });
  
  dropzone.addEventListener('drop', function(e) { 
    e.preventDefault(); 
    dropzone.classList.remove('border-primary');
    
    if (e.dataTransfer.files.length > 0) {
      const file = e.dataTransfer.files[0];
      if (file.name.toLowerCase().match(/\.(csv|xlsx|xls)$/)) {
        fileInput.files = e.dataTransfer.files; 
        handleFileSelection();
      } else {
        alert('Please drop a CSV (.csv) or Excel (.xlsx, .xls) file.');
      }
    }
  });
  
  // Handle file selection and update UI
  function handleFileSelection() {
    if (fileInput.files.length === 0) return;
    
    const file = fileInput.files[0];
    
    // Validate file type
    if (!file.name.toLowerCase().match(/\.(csv|xlsx|xls)$/)) {
      alert('Please select a CSV (.csv) or Excel (.xlsx, .xls) file.');
      fileInput.value = '';
      return;
    }
    
    // Validate file size (10MB max)
    if (file.size > 10 * 1024 * 1024) {
      alert('File size must be less than 10MB.');
      fileInput.value = '';
      return;
    }
    
    const fileSize = (file.size / 1024).toFixed(1) + ' KB';
    if (file.size > 1024 * 1024) {
      fileSize = (file.size / (1024 * 1024)).toFixed(1) + ' MB';
    }
    
    // Show file preparation progress first
    dropzone.classList.add('file-selected');
    const fileIcon = file.name.toLowerCase().match(/\.(xlsx|xls)$/) ? 'file-excel' : 'file-csv';
    dropzoneContent.innerHTML = `
      <div class="text-info">
        <i class="fas fa-${fileIcon} fa-3x mb-3 text-info"></i>
        <div class="fw-bold fs-6 mb-2">${file.name}</div>
        <div class="alert alert-info py-2 mb-3">
          <div class="d-flex align-items-center mb-2">
            <i class="fas fa-spinner fa-spin me-2"></i>
            <span class="fw-bold">Preparing file...</span>
          </div>
          <div class="progress" style="height: 8px;">
            <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" id="prepProgress">
            </div>
          </div>
          <small class="text-muted mt-1 d-block">Validating file format and size...</small>
        </div>
      </div>
    `;
    
    // Animate progress to 100% over 1 second
    const progressBar = document.getElementById('prepProgress');
    let progress = 0;
    const interval = setInterval(() => {
      progress += 10;
      progressBar.style.width = progress + '%';
      progressBar.setAttribute('aria-valuenow', progress);
      
      if (progress >= 100) {
        clearInterval(interval);
        // Show final ready state after animation completes
        setTimeout(() => showFileReady(file, fileSize), 200);
      }
    }, 80); // 10 steps over 800ms
  }
  
  // Show file ready state
  function showFileReady(file, fileSize) {
    const fileIcon = file.name.toLowerCase().match(/\.(xlsx|xls)$/) ? 'file-excel' : 'file-csv';
    const fileType = file.name.toLowerCase().match(/\.(xlsx|xls)$/) ? 'Excel File' : 'CSV File';
    dropzoneContent.innerHTML = `
      <div class="text-success">
        <i class="fas fa-${fileIcon} fa-3x mb-3 text-success"></i>
        <div class="fw-bold fs-6 mb-2">${file.name}</div>
        <div class="small text-muted mb-3">
          <span class="badge bg-light text-dark me-2">
            <i class="fas fa-weight me-1"></i>${fileSize}
          </span>
          <span class="badge bg-light text-dark">
            <i class="fas fa-file-alt me-1"></i>${fileType}
          </span>
        </div>
        <div class="alert alert-success py-2 mb-3">
          <div class="d-flex align-items-center mb-2">
            <i class="fas fa-check-circle me-2"></i>
            <span class="fw-bold">File ready for upload</span>
          </div>
          <div class="progress" style="height: 8px;">
            <div class="progress-bar bg-success" role="progressbar" style="width: 100%" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100">
              <span class="visually-hidden">100% Complete</span>
            </div>
          </div>
          <small class="text-muted mt-1 d-block">
            <i class="fas fa-info-circle me-1"></i>File validated and ready to process
          </small>
        </div>
      </div>
    `;
    
    // Enable upload button and show clear button
    uploadBtn.disabled = false;
    uploadBtn.innerHTML = `<i class="fas fa-upload me-1"></i>Upload "${file.name.length > 20 ? file.name.substring(0, 20) + '...' : file.name}"`;
    clearBtn.classList.remove('d-none');
  }
  
  // Clear file selection
  function clearFile() {
    fileInput.value = '';
    dropzone.classList.remove('file-selected');
    dropzoneContent.innerHTML = `
      <i class="fas fa-cloud-upload-alt fa-2x mb-2 text-muted"></i>
      <div class="mb-2">Drag and drop your CSV file here</div>
      <div class="text-muted small mb-3">or</div>
      <button class="btn btn-outline-primary" type="button" id="selectFileBtn">
        <i class="fas fa-folder-open me-1"></i>Select File
      </button>
    `;
    
    // Re-attach select button event
    document.getElementById('selectFileBtn').addEventListener('click', function(e) {
      e.preventDefault();
      fileInput.click();
    });
    
    // Reset buttons
    uploadBtn.disabled = true;
    uploadBtn.innerHTML = '<i class="fas fa-upload me-1"></i>Upload & Process';
    clearBtn.classList.add('d-none');
  }
  
  // Global function for delete confirmation
  window.confirmDelete = function(uploadId, filename, transactionCount) {
    const message = `Are you sure you want to delete "${filename}"?\n\nThis will remove ${transactionCount} transactions from this account.`;
    if (confirm(message)) {
      const form = document.createElement('form');
      form.method = 'post';
      form.action = '{% url "bank_accounts:delete_upload" account.id 0 %}'.replace('0', uploadId);
      
      const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
      const csrfInput = document.createElement('input');
      csrfInput.type = 'hidden';
      csrfInput.name = 'csrfmiddlewaretoken';
      csrfInput.value = csrfToken;
      form.appendChild(csrfInput);
      
      document.body.appendChild(form);
      form.submit();
    }
  };
});
</script>
{% endblock %}

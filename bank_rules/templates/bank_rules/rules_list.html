{% extends "base.html" %}
{% load static %}

{% block title %}Bank Rules - {{ company.name }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
  <div class="row mb-4">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h2 class="mb-1">ðŸŽ¯ Bank Reconciliation Rules</h2>
          <p class="text-muted">Automate repetitive transaction matching</p>
        </div>
        <div>
          <a href="{% url 'bank_rules:create' %}" class="btn btn-primary">
            <i class="fas fa-plus"></i> Create New Rule
          </a>
        </div>
      </div>
    </div>
  </div>

  {% if messages %}
  <div class="row mb-3">
    <div class="col-12">
      {% for message in messages %}
      <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
      {% endfor %}
    </div>
  </div>
  {% endif %}

  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">Active Rules ({{ rules|length }})</h5>
        </div>
        <div class="card-body">
          {% if rules %}
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>Status</th>
                  <th>Name</th>
                  <th>Conditions</th>
                  <th>Actions</th>
                  <th>Priority</th>
                  <th>Stats</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for rule in rules %}
                <tr>
                  <td>
                    {% if rule.is_active %}
                    <span class="badge bg-success">Active</span>
                    {% else %}
                    <span class="badge bg-secondary">Disabled</span>
                    {% endif %}
                  </td>
                  <td>
                    <strong>{{ rule.name }}</strong>
                    {% if rule.description %}
                    <br><small class="text-muted">{{ rule.description|truncatewords:10 }}</small>
                    {% endif %}
                  </td>
                  <td>
                    <span class="badge bg-info">
                      {{ rule.match_logic }} - {{ rule.conditions.count }} condition{{ rule.conditions.count|pluralize }}
                    </span>
                    <div class="small text-muted mt-1">
                      {% for condition in rule.conditions.all|slice:":3" %}
                      <div>â€¢ {{ condition }}</div>
                      {% endfor %}
                      {% if rule.conditions.count > 3 %}
                      <div>â€¢ ... {{ rule.conditions.count|add:"-3" }} more</div>
                      {% endif %}
                    </div>
                  </td>
                  <td>
                    <div class="small">
                      {% if rule.suggested_who %}
                      <div><i class="fas fa-user text-primary"></i> {{ rule.suggested_who.name }}</div>
                      {% endif %}
                      {% if rule.suggested_what %}
                      <div><i class="fas fa-comment text-info"></i> {{ rule.suggested_what|truncatewords:5 }}</div>
                      {% endif %}
                      {% if rule.suggested_coa %}
                      <div><i class="fas fa-chart-line text-success"></i> {{ rule.suggested_coa.code }}</div>
                      {% endif %}
                    </div>
                  </td>
                  <td>
                    <span class="badge bg-dark">{{ rule.priority }}</span>
                  </td>
                  <td>
                    <div class="small">
                      <div>Matched: {{ rule.times_matched }}</div>
                      {% if rule.last_matched %}
                      <div class="text-muted">Last: {{ rule.last_matched|timesince }} ago</div>
                      {% endif %}
                    </div>
                  </td>
                  <td>
                    <div class="btn-group btn-group-sm" role="group">
                      <a href="{% url 'bank_rules:test' rule.id %}" 
                         class="btn btn-outline-info" 
                         title="Test Rule">
                        <i class="fas fa-flask"></i>
                      </a>
                      <a href="{% url 'bank_rules:edit' rule.id %}" 
                         class="btn btn-outline-primary" 
                         title="Edit">
                        <i class="fas fa-edit"></i>
                      </a>
                      <form method="post" 
                            action="{% url 'bank_rules:toggle' rule.id %}" 
                            style="display: inline;">
                        {% csrf_token %}
                        <button type="submit" 
                                class="btn btn-outline-{% if rule.is_active %}warning{% else %}success{% endif %}"
                                title="{% if rule.is_active %}Disable{% else %}Enable{% endif %}">
                          <i class="fas fa-{% if rule.is_active %}pause{% else %}play{% endif %}"></i>
                        </button>
                      </form>
                      <button type="button" 
                              class="btn btn-outline-danger" 
                              data-bs-toggle="modal" 
                              data-bs-target="#deleteModal{{ rule.id }}"
                              title="Delete">
                        <i class="fas fa-trash"></i>
                      </button>
                    </div>

                    <!-- Delete Confirmation Modal -->
                    <div class="modal fade" id="deleteModal{{ rule.id }}" tabindex="-1">
                      <div class="modal-dialog">
                        <div class="modal-content">
                          <div class="modal-header">
                            <h5 class="modal-title">Confirm Delete</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                          </div>
                          <div class="modal-body">
                            Are you sure you want to delete rule "<strong>{{ rule.name }}</strong>"?
                          </div>
                          <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <form method="post" action="{% url 'bank_rules:delete' rule.id %}" style="display: inline;">
                              {% csrf_token %}
                              <button type="submit" class="btn btn-danger">Delete</button>
                            </form>
                          </div>
                        </div>
                      </div>
                    </div>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% else %}
          <div class="text-center py-5">
            <i class="fas fa-ruler-combined fa-3x text-muted mb-3"></i>
            <h5>No Rules Yet</h5>
            <p class="text-muted">Create your first bank rule to automate transaction matching.</p>
            <a href="{% url 'bank_rules:create' %}" class="btn btn-primary">
              <i class="fas fa-plus"></i> Create Rule
            </a>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- Help Section -->
  <div class="row mt-4">
    <div class="col-12">
      <div class="card bg-light">
        <div class="card-body">
          <h6><i class="fas fa-info-circle"></i> How Bank Rules Work</h6>
          <ul class="mb-0 small">
            <li><strong>Rules match transactions automatically</strong> based on conditions you define (description, amount, etc.)</li>
            <li><strong>When a transaction matches</strong>, the system suggests WHO/WHAT/COA for you to apply</li>
            <li><strong>Higher priority rules</strong> are checked first</li>
            <li><strong>Test your rules</strong> before activating them to see how many transactions they would match</li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% extends 'base.html' %}
{% load static %}

{% block title %}Tax Rates{% endblock %}

{% block extra_css %}
<style>
  .getting-started { 
    background: #ecfdf5; 
    border: 1px solid #bbf7d0; 
    border-radius: .5rem; 
  }
  .table-hover tbody tr:hover { 
    background: #f9fafb; 
  }
  .tax-rate-item {
    transition: all 0.2s ease;
  }
  .tax-rate-item:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h5 class="mb-0">Tax Rates</h5>
    {% if active_company %}
      <small class="text-muted">Company: {{ active_company.name }}</small>
    {% endif %}
  </div>

  <!-- Getting Started banner -->
  <div class="getting-started p-3 mb-3" id="gettingStartedBanner">
    <div class="d-flex gap-3">
      <div class="flex-grow-1">
        <div class="fw-semibold">Getting Started with Tax Rates</div>
        <div class="row g-2 small mt-2">
          <div class="col-md-4">
            <div class="border rounded p-2 bg-white">
              <div class="d-flex justify-content-between">
                <span class="fw-medium">Account</span>
                <span class="text-muted">Tax Rate</span>
              </div>
              <hr class="my-2">
              <div class="text-muted small">Tax on Sales (8.5%)</div>
              <div class="text-muted small">Tax on Purchases (7%)</div>
              <div class="text-muted small">Tax Exempt (0%)</div>
              <div class="text-muted small">Zero Rated (0%)</div>
            </div>
          </div>
          <div class="col-md-8 small text-muted">
            Every transaction line needs a Tax Rate. If your rates have multiple components (e.g. city 5% + import 3%), 
            create one Tax Rate with components using the "New Tax Rate" button.
          </div>
        </div>
      </div>
      <button class="btn-close" aria-label="Close" onclick="document.getElementById('gettingStartedBanner').remove()"></button>
    </div>
  </div>

  <div class="d-flex justify-content-between align-items-center mb-2">
    <div class="btn-group">
      <button class="btn btn-outline-danger btn-sm" disabled id="deleteBtn">Delete Selected</button>
    </div>
    <a href="{% url 'coa:tax_rate_new' %}" class="btn btn-primary btn-sm">
      <i class="bi bi-plus me-1"></i>New Tax Rate
    </a>
  </div>

  <div class="card">
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th style="width:36px">
              <input class="form-check-input" type="checkbox" onclick="toggleAll(this)">
            </th>
            <th>Name</th>
            <th>Tax Rate</th>
            <th>Type</th>
            <th>Accounts using this Tax Rate</th>
            <th>Status</th>
            <th style="width:120px">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for tax_rate in tax_rates %}
          <tr class="tax-rate-item">
            <td>
              <input class="form-check-input row-check" type="checkbox" 
                     value="{{ tax_rate.id }}" onchange="updateDeleteButton()">
            </td>
            <td>
              <div class="fw-medium">
                {{ tax_rate.name }}
                {% if tax_rate.is_system_defined %}
                  <i class="bi bi-shield-lock-fill text-warning ms-1" title="System Defined"></i>
                {% endif %}
              </div>
              {% if tax_rate.description %}
                <small class="text-muted">{{ tax_rate.description|truncatechars:60 }}</small>
              {% endif %}
            </td>
            <td>
              <span class="badge bg-primary fs-6">{{ tax_rate.rate|floatformat:2 }}%</span>
              {% if tax_rate.is_default %}
                <small class="text-success d-block">Default</small>
              {% endif %}
            </td>
            <td>
              {% if tax_rate.tax_type %}
                <span class="badge bg-secondary">{{ tax_rate.get_tax_type_display }}</span>
              {% else %}
                <span class="text-muted">-</span>
              {% endif %}
            </td>
            <td>
              <span class="badge bg-info">{{ tax_rate.account_count|default:0 }} account{{ tax_rate.account_count|pluralize }}</span>
            </td>
            <td>
              {% if tax_rate.is_active %}
                <span class="badge bg-success">Active</span>
              {% else %}
                <span class="badge bg-secondary">Inactive</span>
              {% endif %}
            </td>
            <td>
              <div class="btn-group btn-group-sm">
                <a href="{% url 'coa:tax_rate_edit' tax_rate.id %}" 
                   class="btn btn-outline-primary" title="Edit">
                  <i class="bi bi-pencil"></i>
                </a>
                {% if tax_rate.is_system_defined %}
                  <button class="btn btn-outline-secondary" disabled title="System defined tax rates cannot be deleted">
                    <i class="bi bi-shield-lock"></i>
                  </button>
                {% elif tax_rate.account_count == 0 %}
                  <a href="{% url 'coa:tax_rate_delete' tax_rate.id %}" 
                     class="btn btn-outline-danger" title="Delete"
                     onclick="return confirm('Are you sure you want to delete this tax rate?')">
                    <i class="bi bi-trash"></i>
                  </a>
                {% else %}
                  <button class="btn btn-outline-secondary" disabled title="Cannot delete - in use by accounts">
                    <i class="bi bi-lock"></i>
                  </button>
                {% endif %}
              </div>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="7" class="text-center text-muted py-5">
              <i class="bi bi-calculator-fill d-block mb-2" style="font-size: 2rem; opacity: 0.3;"></i>
              No tax rates yet. 
              <a href="{% url 'coa:tax_rate_new' %}" class="text-decoration-none">Click here to add your first tax rate</a>.
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  {% if tax_rates %}
  <div class="mt-3">
    <small class="text-muted">
      Total: {{ total_tax_rates|default:0 }} tax rate{{ total_tax_rates|pluralize }}
      {% if active_company %}for {{ active_company.name }}{% endif %}
    </small>
  </div>
  {% endif %}
</div>

<script>
  function toggleAll(checkbox) {
    const checkboxes = document.querySelectorAll('.row-check');
    checkboxes.forEach(cb => cb.checked = checkbox.checked);
    updateDeleteButton();
  }
  
  function updateDeleteButton() {
    const checkedBoxes = document.querySelectorAll('.row-check:checked');
    const deleteBtn = document.getElementById('deleteBtn');
    deleteBtn.disabled = checkedBoxes.length === 0;
    deleteBtn.textContent = checkedBoxes.length > 0 ? 
      `Delete ${checkedBoxes.length} Selected` : 'Delete Selected';
  }
  
  // Bulk delete functionality
  document.getElementById('deleteBtn').addEventListener('click', function() {
    const checkedBoxes = document.querySelectorAll('.row-check:checked');
    if (checkedBoxes.length === 0) return;
    
    const taxRateIds = Array.from(checkedBoxes).map(cb => cb.value);
    const confirmMsg = `Are you sure you want to delete ${taxRateIds.length} tax rate(s)?`;
    
    if (confirm(confirmMsg)) {
      // Here you could implement bulk delete API call
      alert('Bulk delete functionality would be implemented here');
    }
  });
</script>
{% endblock %}

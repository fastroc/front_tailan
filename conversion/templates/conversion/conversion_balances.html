{% extends 'base.html' %}
{% load static %}

{% block title %}Conversion balances{% endblock %}

{% block extra_css %}
<style>
  /* EXCEL-LIKE MINIMAL DESIGN - MATCHING COMPANY PAGE */
  body {
    font-family: 'Segoe UI', Calibri, Arial, sans-serif;
    font-size: 11pt;
    background: #f0f0f0;
  }
  
  .page-wrapper {
    max-width: 100%;
    margin: 0;
    padding: 0;
    background: white;
  }
  
  /* Unified Header Section - Modern Excel Style */
  .unified-header {
    background: linear-gradient(135deg, #4472C4 0%, #2B579A 100%);
    border-bottom: 3px solid #1F4788;
    padding: 16px 24px;
    display: flex;
    flex-direction: row;
    align-items: center;
    justify-content: space-between;
    gap: 24px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }
  
  .header-title-section {
    display: flex;
    flex-direction: column;
    gap: 6px;
    flex: 0 0 auto;
  }
  
  .header-title-section h2 {
    margin: 0;
    font-size: 20px;
    font-weight: 600;
    font-family: 'Segoe UI', sans-serif;
    display: flex;
    align-items: center;
    gap: 12px;
    color: white;
    line-height: 1.2;
  }
  
  .header-title-section h2 i {
    font-size: 20px;
    color: white;
    opacity: 0.95;
  }
  
  .company-name {
    font-size: 12px;
    opacity: 0.85;
    color: rgba(255, 255, 255, 0.95);
    margin: 0;
    font-weight: 400;
  }
  
  /* Balance Grid - Compact Cards */
  .balance-grid {
    display: flex;
    align-items: stretch;
    gap: 12px;
    flex: 1;
    justify-content: flex-end;
  }
  
  .balance-item {
    flex: 0 0 auto;
    padding: 10px 16px;
    background: white;
    border-radius: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-width: 140px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.08);
    border: 1px solid rgba(255, 255, 255, 0.2);
    transition: transform 0.2s, box-shadow 0.2s;
  }
  
  .balance-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
  }
  
  .balance-item:first-child {
    border-left: 3px solid #4472C4;
  }
  
  .balance-item:nth-child(2) {
    border-left: 3px solid #4472C4;
  }
  
  .balance-item:nth-child(3) {
    border-left: 3px solid #CA5010;
  }
  
  .balance-item:last-child {
    border-left: 3px solid #D83B01;
  }
  
  .balance-label {
    font-size: 9px;
    color: #605E5C;
    margin-bottom: 4px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-family: 'Segoe UI', sans-serif;
    text-align: center;
  }
  
  .balance-value {
    font-size: 16px;
    font-weight: 700;
    font-family: 'Segoe UI', sans-serif;
    letter-spacing: -0.3px;
    text-align: center;
  }
  
  .balance-value.text-primary {
    color: #4472C4 !important;
  }
  
  .balance-value.text-success {
    color: #4472C4 !important;
  }
  
  .balance-value.text-warning {
    color: #CA5010 !important;
  }
  
  .balance-value.text-danger {
    color: #D83B01 !important;
  }
  
  /* Header Actions */
  .header-actions {
    display: flex;
    align-items: center;
    gap: 12px;
  }
  
  .header-actions .btn-primary {
    background: white;
    color: #4472C4;
    border: none;
    border-radius: 0;
    padding: 10px 20px;
    font-size: 11pt;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.15);
    transition: all 0.2s;
  }
  
  .header-actions .btn-primary:hover {
    background: #F3F9FF;
    color: #2B579A;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
  }
  
  /* Excel-Style Content Area */
  .content-area {
    background: white;
    padding: 20px 24px;
  }
  
  /* Info Banner */
  .info-banner {
    background: linear-gradient(135deg, #E6F2FF 0%, #D4E9FF 100%);
    border-left: 3px solid #4472C4;
    border-radius: 0;
    padding: 16px 20px;
    margin-bottom: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.08);
    display: flex;
    align-items: center;
    gap: 16px;
  }
  
  .info-banner h5 {
    font-family: 'Segoe UI', sans-serif;
    font-size: 16px;
    font-weight: 600;
    color: #323130;
    margin: 0 0 4px 0;
  }
  
  .info-banner p {
    font-size: 11pt;
    color: #605E5C;
    margin: 0;
  }
  
  /* Period Tabs */
  .period-tabs {
    display: flex;
    gap: 2px;
    margin-bottom: 20px;
    border-bottom: 2px solid #D2D0CE;
  }
  
  .period-tab {
    padding: 10px 20px;
    background: white;
    border: 1px solid #D2D0CE;
    border-bottom: none;
    border-radius: 0;
    color: #605E5C;
    text-decoration: none;
    font-family: 'Segoe UI', sans-serif;
    font-size: 11pt;
    font-weight: 500;
    transition: all 0.2s;
  }
  
  .period-tab:hover {
    background: #F3F2F1;
    color: #323130;
  }
  
  .period-tab.active {
    background: #4472C4;
    color: white;
    border-color: #4472C4;
    font-weight: 600;
  }
  
  /* Grid Box */
  .grid-box {
    background: white;
    border: 1px solid #D2D0CE;
    border-radius: 0;
    box-shadow: 0 2px 4px rgba(0,0,0,0.08);
    margin-bottom: 20px;
  }
  
  .grid-header {
    background: #F3F2F1;
    border-bottom: 2px solid #D2D0CE;
    padding: 12px 16px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  
  .grid-header-text {
    font-size: 11pt;
    color: #323130;
    font-weight: 500;
  }
  
  .grid-header-actions {
    display: flex;
    gap: 16px;
  }
  
  .grid-header-actions a {
    font-size: 11pt;
    color: #4472C4;
    text-decoration: underline;
    cursor: pointer;
  }
  
  .grid-header-actions a:hover {
    color: #2B579A;
  }
  
  /* Excel-Style Table */
  .cb-grid {
    width: 100%;
    border-collapse: collapse;
    font-family: 'Segoe UI', sans-serif;
    font-size: 11pt;
  }
  
  .cb-grid thead th {
    background: #F3F2F1;
    color: #323130;
    font-weight: 600;
    padding: 10px 12px;
    border-bottom: 2px solid #D2D0CE;
    position: sticky;
    top: 0;
    z-index: 1;
    text-align: left;
  }
  
  .cb-grid tbody tr {
    border-bottom: 1px solid #EDEBE9;
  }
  
  .cb-grid tbody tr:hover {
    background: #F8F9FA;
  }
  
  .cb-grid td {
    padding: 8px 12px;
    color: #323130;
  }
  
  .cb-grid tfoot tr {
    border-top: 2px solid #D2D0CE;
  }
  
  .cb-grid tfoot td {
    padding: 10px 12px;
    font-weight: 600;
    color: #323130;
  }
  
  .row-drag {
    cursor: grab;
    color: #8A8886;
    font-size: 14px;
  }
  
  /* Form Controls */
  .form-select, .form-control {
    border: 1px solid #8A8886;
    border-radius: 0;
    font-family: 'Segoe UI', sans-serif;
    font-size: 11pt;
    padding: 6px 10px;
  }
  
  .form-select:focus, .form-control:focus {
    border-color: #4472C4;
    outline: none;
    box-shadow: 0 0 0 2px rgba(68, 114, 196, 0.2);
  }
  
  /* Buttons */
  .btn {
    border-radius: 0;
    font-family: 'Segoe UI', sans-serif;
    font-size: 11pt;
    font-weight: 500;
    padding: 8px 20px;
    transition: all 0.2s;
  }
  
  .btn-primary {
    background: #4472C4;
    border: none;
    color: white;
  }
  
  .btn-primary:hover {
    background: #2B579A;
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.15);
  }
  
  .btn-success {
    background: #4472C4;
    border: none;
    color: white;
  }
  
  .btn-success:hover {
    background: #2B579A;
  }
  
  .btn-warning {
    background: #CA5010;
    border: none;
    color: white;
  }
  
  .btn-warning:hover {
    background: #A74109;
  }
  
  .btn-outline-primary {
    background: white;
    border: 1px solid #4472C4;
    color: #4472C4;
  }
  
  .btn-outline-primary:hover {
    background: #4472C4;
    color: white;
  }
  
  .btn-outline-secondary {
    background: white;
    border: 1px solid #8A8886;
    color: #605E5C;
  }
  
  .btn-outline-secondary:hover {
    background: #F3F2F1;
    border-color: #605E5C;
  }
  
  .btn-outline-danger {
    background: white;
    border: 1px solid #D83B01;
    color: #D83B01;
  }
  
  .btn-outline-danger:hover {
    background: #D83B01;
    color: white;
  }
  
  /* Help Box */
  .help-box {
    background: white;
    border: 1px solid #D2D0CE;
    border-radius: 0;
    box-shadow: 0 2px 4px rgba(0,0,0,0.08);
  }
  
  .help-header {
    padding: 16px 20px;
    font-weight: 600;
    border-bottom: 2px solid #D2D0CE;
    color: #323130;
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  
  .accordion-button {
    background: white;
    border-radius: 0;
    font-family: 'Segoe UI', sans-serif;
    font-size: 11pt;
    font-weight: 600;
    color: #323130;
    padding: 12px 16px;
  }
  
  .accordion-button:not(.collapsed) {
    background: #F3F2F1;
    color: #4472C4;
  }
  
  .accordion-button:focus {
    box-shadow: none;
    border-color: #D2D0CE;
  }
  
  .accordion-body {
    font-family: 'Segoe UI', sans-serif;
    font-size: 11pt;
    color: #605E5C;
    padding: 16px;
    line-height: 1.5;
  }
  
  /* Warning Messages */
  .text-warning {
    color: #CA5010 !important;
  }
  
  /* Grid Actions */
  .grid-actions {
    display: flex;
    justify-content: center;
    gap: 12px;
    padding: 20px;
    border-top: 2px solid #D2D0CE;
    background: #F8F9FA;
  }
</style>
{% endblock %}

{% block content %}
<div class="page-wrapper">
  <!-- Unified Header - Excel Style -->
  <div class="unified-header">
    <div class="header-title-section">
      <h2>
        <i class="bi bi-arrow-repeat"></i>
        Conversion Balances
      </h2>
      <p class="company-name">{{ company.name }} • As at {{ as_at|date:'d M Y' }}</p>
    </div>
    
    <!-- Balance Grid -->
    <div class="balance-grid">
      <div class="balance-item">
        <div class="balance-label">Total Debits</div>
        <div class="balance-value text-primary" id="headerDr">$0.00</div>
      </div>
      <div class="balance-item">
        <div class="balance-label">Total Credits</div>
        <div class="balance-value text-success" id="headerCr">$0.00</div>
      </div>
      <div class="balance-item">
        <div class="balance-label">Difference</div>
        <div class="balance-value text-warning" id="headerDiff">$0.00</div>
      </div>
      <div class="balance-item">
        <div class="balance-label">Conv. Date</div>
        <div class="balance-value text-danger">{{ conv_date.conversion_date|date:"d M" }}</div>
      </div>
    </div>
    
    <div class="header-actions">
      <a href="{% url 'conversion:comparatives' company.id %}" class="btn-primary">
        <i class="bi bi-plus-lg"></i>Comparatives
      </a>
      <a href="{% url 'dashboard' %}" class="btn-primary">
        <i class="bi bi-speedometer2"></i>Dashboard
      </a>
    </div>
  </div>
  
  <!-- Content Area -->
  <div class="content-area">

  <!-- Info Banner -->
  <div class="info-banner">
    <div style="flex: 1;">
      <h5>📊 Opening Balance Setup</h5>
      <p>Enter your account balances as they existed in your previous system. This ensures accurate financial reporting from day one.</p>
    </div>
  </div>

  <!-- Period Tabs -->
  <div class="period-tabs">
    {% for p in periods %}
      <a class="period-tab {% if p.active %}active{% endif %}" 
         href="{% url 'conversion:balances' company.id %}?start={{ p.start }}&end={{ p.end }}">
        {{ p.label }}
      </a>
    {% endfor %}
  </div>

  <div class="row g-3">
    <div class="col-lg-8">
      <div class="grid-box">
        <div class="grid-header">
          <div class="grid-header-text">
            Enter opening balances as at <strong>{{ as_at|date:'d M Y' }}</strong>
          </div>
          <div class="grid-header-actions">
            <a href="#" onclick="showAll();return false;">Show all accounts</a>
            <a href="#" onclick="removeZeros();return false;">Remove zero balances</a>
          </div>
        </div>

        <div class="table-responsive">
          <table class="table table-sm align-middle mb-0 cb-grid" id="grid">
            <thead>
              <tr>
                <th style="width:28px"></th>
                <th>Account</th>
                <th class="text-end" style="width:180px">Debit</th>
                <th class="text-end" style="width:180px">Credit</th>
                <th style="width:40px"></th>
              </tr>
            </thead>
            <tbody id="gridBody">
              {% for row in rows %}
              <tr>
                <td class="row-drag">⋮⋮</td>
                <td>
                  <select class="form-select form-select-sm acc">
                    <option value="">Select Account...</option>
                    {% for a in accounts %}
                      <option value="{{ a.code }}" {% if a.code == row.account %}selected{% endif %}>
                        {{ a.code }} — {{ a.name }}
                      </option>
                    {% endfor %}
                  </select>
                </td>
                <td class="text-end">
                  <input type="number" step="0.01" min="0" 
                         class="form-control form-control-sm text-end debit" 
                         value="{{ row.debit|default:'' }}">
                </td>
                <td class="text-end">
                  <input type="number" step="0.01" min="0" 
                         class="form-control form-control-sm text-end credit" 
                         value="{{ row.credit|default:'' }}">
                </td>
                <td>
                  <button class="btn btn-outline-danger btn-sm" onclick="removeRow(this)" title="Remove row">
                    <i class="bi bi-x"></i>
                  </button>
                </td>
              </tr>
              {% endfor %}
            </tbody>
            <tfoot>
              <tr>
                <td></td>
                <td>
                  <button class="btn btn-outline-primary btn-sm" onclick="addRow()">
                    <i class="bi bi-plus me-1"></i>Add a new line
                  </button>
                </td>
                <td class="text-end fw-semibold">Total Debits</td>
                <td class="text-end fw-semibold" id="totCrLabel">Total Credits</td>
                <td></td>
              </tr>
              <tr style="background: #F3F2F1;">
                <td></td>
                <td></td>
                <td class="text-end fw-bold" id="totDr">$0.00</td>
                <td class="text-end fw-bold" id="totCr">$0.00</td>
                <td></td>
              </tr>
              <tr id="diffRow" style="display: none; background: #FFF4CE;">
                <td></td>
                <td colspan="3">
                  <div style="color: #CA5010; font-weight: 600;">
                    <strong>⚠️ Out of Balance</strong> — Debits and credits must be equal
                  </div>
                </td>
                <td class="text-end fw-semibold" style="color: #CA5010;" id="diff">$0.00</td>
              </tr>
            </tfoot>
          </table>
        </div>

        <div class="grid-actions">
          <button class="btn btn-success px-4" onclick="saveBalances()" id="saveBtn">
            <i class="bi bi-save me-1"></i>Save Balances
          </button>
          <a href="{% url 'dashboard' %}" class="btn btn-outline-secondary px-4">
            <i class="bi bi-x me-1"></i>Cancel
          </a>
        </div>
      </div>
    </div>

    <!-- Right help column -->
    <div class="col-lg-4">
      <div class="help-box">
        <div class="help-header">
          <i class="bi bi-question-circle" style="color: #CA5010;"></i>
          Starting with the right numbers
        </div>
        <div class="accordion" id="helpAcc">
          <div class="accordion-item">
            <h2 class="accordion-header">
              <button class="accordion-button" data-bs-toggle="collapse" data-bs-target="#h0">
                What's this?
              </button>
            </h2>
            <div id="h0" class="accordion-collapse collapse show">
              <div class="accordion-body small">
                Enter bank balances, outstanding invoices and bills, and other balances as at your conversion date.
                This ensures your new accounting system starts with accurate opening balances.
              </div>
            </div>
          </div>
          {% for help_item in help_items %}
          <div class="accordion-item">
            <h2 class="accordion-header">
              <button class="accordion-button collapsed" data-bs-toggle="collapse" data-bs-target="#h{{ forloop.counter }}">
                {{ forloop.counter }}. {{ help_item.title }}
              </button>
            </h2>
            <div id="h{{ forloop.counter }}" class="accordion-collapse collapse">
              <div class="accordion-body small">
                {{ help_item.body }}
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
  
  </div><!-- /.content-area -->
</div><!-- /.page-wrapper -->

<script>
  function fmt(n) {
    return new Intl.NumberFormat('en-US', {
      style: 'currency',
      currency: 'USD',
      minimumFractionDigits: 2,
      maximumFractionDigits: 2
    }).format(parseFloat(n) || 0);
  }

  function recalc() {
    let dr = 0, cr = 0;
    document.querySelectorAll('#gridBody tr').forEach(tr => {
      const debitInput = tr.querySelector('.debit');
      const creditInput = tr.querySelector('.credit');
      
      if (debitInput && creditInput) {
        dr += parseFloat(debitInput.value || 0);
        cr += parseFloat(creditInput.value || 0);
      }
    });

    // Update table totals
    document.getElementById('totDr').textContent = fmt(dr);
    document.getElementById('totCr').textContent = fmt(cr);
    
    // Update header balance cards
    document.getElementById('headerDr').textContent = fmt(dr);
    document.getElementById('headerCr').textContent = fmt(cr);
    
    const difference = Math.abs(dr - cr);
    const diffRow = document.getElementById('diffRow');
    const saveBtn = document.getElementById('saveBtn');
    
    // Update header difference
    document.getElementById('headerDiff').textContent = fmt(difference);
    
    if (difference > 0.01) {
      document.getElementById('diff').textContent = fmt(difference);
      diffRow.style.display = '';
      saveBtn.classList.add('btn-warning');
      saveBtn.classList.remove('btn-success');
      saveBtn.innerHTML = '<i class="bi bi-exclamation-triangle me-1"></i>Out of Balance';
    } else {
      diffRow.style.display = 'none';
      saveBtn.classList.add('btn-success');
      saveBtn.classList.remove('btn-warning');
      saveBtn.innerHTML = '<i class="bi bi-save me-1"></i>Save Balances';
    }
  }

  function addRow() {
    const tb = document.getElementById('gridBody');
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class='row-drag'>⋮⋮</td>
      <td>
        <select class='form-select form-select-sm acc'>
          <option value="">Select Account...</option>
          {% for a in accounts %}
            <option value="{{ a.code }}">{{ a.code }} — {{ a.name }}</option>
          {% endfor %}
        </select>
      </td>
      <td class='text-end'><input type='number' step='0.01' min='0' class='form-control form-control-sm text-end debit'></td>
      <td class='text-end'><input type='number' step='0.01' min='0' class='form-control form-control-sm text-end credit'></td>
      <td><button class='btn btn-outline-danger btn-sm' onclick='removeRow(this)' title='Remove row'><i class='bi bi-x'></i></button></td>
    `;
    tr.querySelectorAll('input').forEach(el => el.addEventListener('input', recalc));
    tb.appendChild(tr);
    recalc();
  }

  function removeRow(btn) {
    btn.closest('tr').remove();
    recalc();
  }

  function showAll() {
    // TODO: Implement show all accounts functionality
    alert('Show all accounts feature coming soon!');
  }

  function removeZeros() {
    document.querySelectorAll('#gridBody tr').forEach(tr => {
      const debitInput = tr.querySelector('.debit');
      const creditInput = tr.querySelector('.credit');
      
      if (debitInput && creditInput) {
        const d = parseFloat(debitInput.value || 0);
        const c = parseFloat(creditInput.value || 0);
        
        if (d === 0 && c === 0) {
          tr.remove();
        }
      }
    });
    recalc();
  }

  function saveBalances() {
    const lines = [...document.querySelectorAll('#gridBody tr')].map(tr => {
      const accountSelect = tr.querySelector('.acc');
      const debitInput = tr.querySelector('.debit');
      const creditInput = tr.querySelector('.credit');
      
      if (accountSelect && debitInput && creditInput && accountSelect.value) {
        return {
          account: accountSelect.value,
          debit: parseFloat(debitInput.value || 0),
          credit: parseFloat(creditInput.value || 0),
        };
      }
      return null;
    }).filter(l => l !== null && (l.debit > 0 || l.credit > 0));

    const payload = {
      as_at: '{{ as_at|date:"Y-m-d" }}',
      lines: lines
    };

    // Show loading state
    const saveBtn = document.getElementById('saveBtn');
    const originalText = saveBtn.innerHTML;
    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Saving...';
    saveBtn.disabled = true;

    fetch(`{% url 'conversion:save_balances' company.id %}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': '{{ csrf_token }}'
      },
      body: JSON.stringify(payload)
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // Show success message
        const alertDiv = document.createElement('div');
        alertDiv.className = 'alert alert-success alert-dismissible fade show';
        alertDiv.innerHTML = `
          <i class="fas fa-check-circle me-2"></i>${data.message}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.getElementById('cbRoot').insertBefore(alertDiv, document.getElementById('cbRoot').firstChild);
        
        // Auto-hide after 3 seconds
        setTimeout(() => {
          alertDiv.remove();
        }, 3000);
      } else {
        throw new Error(data.message);
      }
    })
    .catch(error => {
      // Show error message
      const alertDiv = document.createElement('div');
      alertDiv.className = 'alert alert-danger alert-dismissible fade show';
      alertDiv.innerHTML = `
        <i class="fas fa-exclamation-triangle me-2"></i>Error: ${error.message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      `;
      document.getElementById('cbRoot').insertBefore(alertDiv, document.getElementById('cbRoot').firstChild);
    })
    .finally(() => {
      // Restore button state
      saveBtn.innerHTML = originalText;
      saveBtn.disabled = false;
    });
  }

  // Initialize
  document.addEventListener('input', e => {
    if (e.target.matches('.debit,.credit')) {
      recalc();
    }
  });

  document.addEventListener('DOMContentLoaded', () => {
    recalc();
  });
</script>
{% endblock %}

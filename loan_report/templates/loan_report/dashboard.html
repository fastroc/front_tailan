{% extends 'base.html' %}
{% load humanize %}

{% block title %}{{ title }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.min.css">
<style>
    .report-card {
        transition: all 0.3s ease;
        border: none;
        border-radius: 15px;
        overflow: hidden;
    }
    
    .report-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    }
    
    .status-badge {
        animation: pulse 2s infinite;
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
    }
    
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.7; }
    }
    
    .metric-icon {
        font-size: 2.5rem;
        opacity: 0.3;
    }
    
    .chart-container {
        position: relative;
        height: 300px;
    }
    
    .filter-section {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 15px;
        color: white;
    }
    
    .btn-dynamic {
        background: linear-gradient(45deg, #28a745, #20c997);
        border: none;
        color: white;
        border-radius: 25px;
        padding: 0.5rem 1.5rem;
        font-weight: 600;
    }
    
    .btn-dynamic:hover {
        background: linear-gradient(45deg, #20c997, #28a745);
        color: white;
        transform: scale(1.05);
    }
    
    .aging-row {
        border-left: 4px solid;
        transition: all 0.3s ease;
    }
    
    .aging-row:hover {
        background-color: rgba(0,0,0,0.02);
    }
    
    .customer-avatar {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        font-size: 1.2rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Enhanced Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-2 text-gray-800">
                        <i class="fas fa-chart-line text-primary me-2"></i>
                        {{ title }}
                        <span class="status-badge badge bg-success ms-2">
                            <i class="fas fa-database me-1"></i>{{ data_status|default:"100% Dynamic" }}
                        </span>
                    </h1>
                    <p class="text-muted mb-0">
                        Real-time loan portfolio intelligence • 
                        Last updated: <span id="last-updated">{{ last_updated|date:"M d, Y g:i A" }}</span>
                    </p>
                </div>
                <div>
                    <button class="btn btn-outline-primary me-2" onclick="refreshAllData()">
                        <i class="fas fa-sync-alt me-1" id="refresh-icon"></i>Refresh Data
                    </button>
                    <div class="btn-group">
                        <button class="btn btn-dynamic dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            <i class="fas fa-download me-1"></i>Export Reports
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" onclick="exportReport('pdf')">
                                <i class="fas fa-file-pdf me-2 text-danger"></i>Executive PDF
                            </a></li>
                            <li><a class="dropdown-item" href="#" onclick="exportReport('excel')">
                                <i class="fas fa-file-excel me-2 text-success"></i>Detailed Excel
                            </a></li>
                            <li><a class="dropdown-item" href="#" onclick="exportReport('csv')">
                                <i class="fas fa-file-csv me-2 text-info"></i>Data CSV
                            </a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Smart Filters Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card filter-section">
                <div class="card-body p-3">
                    <div class="row align-items-end">
                        <div class="col-md-2">
                            <label class="form-label small opacity-75">Time Period</label>
                            <select class="form-select form-select-sm" id="dateRange" onchange="updateReports()">
                                <option value="7d">Last 7 Days</option>
                                <option value="30d" selected>Last 30 Days</option>
                                <option value="90d">Last 90 Days</option>
                                <option value="1y">Last Year</option>
                                <option value="custom">Custom Range</option>
                            </select>
                        </div>
                        <div class="col-md-3" id="customDateRange" style="display: none;">
                            <label class="form-label small opacity-75">Custom Dates</label>
                            <div class="input-group input-group-sm">
                                <input type="date" class="form-control" id="startDate">
                                <input type="date" class="form-control" id="endDate">
                            </div>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label small opacity-75">Loan Status</label>
                            <select class="form-select form-select-sm" id="statusFilter">
                                <option value="">All Loans</option>
                                <option value="active">Active Only</option>
                                <option value="completed">Completed</option>
                                <option value="overdue">Overdue</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <button class="btn btn-light btn-sm" onclick="applyFilters()">
                                <i class="fas fa-filter me-1"></i>Apply Filters
                            </button>
                            <button class="btn btn-outline-light btn-sm ms-1" onclick="resetFilters()">
                                <i class="fas fa-undo me-1"></i>Reset
                            </button>
                        </div>
                        <div class="col-md-2 text-end">
                            <div class="small opacity-75">Auto-refresh</div>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="autoRefresh" checked>
                                <label class="form-check-label small" for="autoRefresh">Every 2min</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Key Performance Indicators -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="card report-card border-start border-primary border-4">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                Total Portfolio Value
                            </div>
                            <div class="h4 mb-0 font-weight-bold text-gray-800">
                                ${{ portfolio_stats.total_portfolio_value|floatformat:0|intcomma }}
                            </div>
                            <div class="mt-1">
                                <span class="badge bg-success-subtle text-success">
                                    <i class="fas fa-arrow-up me-1"></i>{{ portfolio_stats.application_growth|default:"0.0" }}%
                                </span>
                                <small class="text-muted ms-1">vs last month</small>
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-chart-area metric-icon text-primary"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-3">
            <div class="card report-card border-start border-success border-4">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                Collection Rate
                            </div>
                            <div class="h4 mb-0 font-weight-bold text-gray-800">
                                {{ portfolio_stats.collection_rate|default:"0.0" }}%
                            </div>
                            <div class="mt-1">
                                {% if portfolio_stats.collection_rate|default:0 > 90 %}
                                    <span class="badge bg-success-subtle text-success">Excellent</span>
                                {% elif portfolio_stats.collection_rate|default:0 > 75 %}
                                    <span class="badge bg-warning-subtle text-warning">Good</span>
                                {% else %}
                                    <span class="badge bg-danger-subtle text-danger">Needs Attention</span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-percentage metric-icon text-success"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-3">
            <div class="card report-card border-start border-info border-4">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                Active Loans
                            </div>
                            <div class="h4 mb-0 font-weight-bold text-gray-800">
                                {{ portfolio_stats.active_loans_count|default:"0" }}
                            </div>
                            <div class="mt-1">
                                <small class="text-muted">
                                    Avg: ${{ portfolio_stats.avg_loan_amount|floatformat:0|intcomma }}
                                </small>
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-handshake metric-icon text-info"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-3">
            <div class="card report-card border-start border-warning border-4">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                Approval Rate
                            </div>
                            <div class="h4 mb-0 font-weight-bold text-gray-800">
                                {{ portfolio_stats.approval_rate|default:"0.0" }}%
                            </div>
                            <div class="mt-1">
                                <small class="text-muted">{{ portfolio_stats.pending_applications|default:"0" }} pending</small>
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-check-circle metric-icon text-warning"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts and Analytics Row -->
    <div class="row mb-4">
        <!-- Monthly Trends Chart -->
        <div class="col-lg-8 mb-4">
            <div class="card report-card">
                <div class="card-header bg-transparent d-flex justify-content-between align-items-center">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-chart-line me-2"></i>Monthly Performance Trends
                    </h6>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-primary active" onclick="showChart('disbursements')">
                            Disbursements
                        </button>
                        <button class="btn btn-outline-primary" onclick="showChart('collections')">
                            Collections
                        </button>
                        <button class="btn btn-outline-primary" onclick="showChart('applications')">
                            Applications
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="monthlyTrendsChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Risk Assessment -->
        <div class="col-lg-4 mb-4">
            <div class="card report-card">
                <div class="card-header bg-transparent">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-shield-alt me-2"></i>Risk Assessment
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row text-center mb-3">
                        <div class="col-4">
                            <div class="h3 text-danger mb-0">{{ risk_metrics.high_risk_loans|default:"0" }}</div>
                            <small class="text-muted">High Risk</small>
                        </div>
                        <div class="col-4">
                            <div class="h3 text-warning mb-0">{{ risk_metrics.medium_risk_loans|default:"0" }}</div>
                            <small class="text-muted">Medium Risk</small>
                        </div>
                        <div class="col-4">
                            <div class="h3 text-success mb-0">{{ risk_metrics.low_risk_loans|default:"0" }}</div>
                            <small class="text-muted">Low Risk</small>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="riskChart"></canvas>
                    </div>
                    <div class="row mt-3">
                        <div class="col-6">
                            <div class="text-center">
                                <div class="h5 mb-0">{{ risk_metrics.npl_ratio|default:"0.0" }}%</div>
                                <small class="text-muted">NPL Ratio</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="text-center">
                                <div class="h5 mb-0">{{ risk_metrics.loss_rate|default:"0.0" }}%</div>
                                <small class="text-muted">Loss Rate</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Detailed Analytics Row -->
    <div class="row">
        <!-- Aging Analysis -->
        <div class="col-lg-6 mb-4">
            <div class="card report-card">
                <div class="card-header bg-transparent">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-clock me-2"></i>Portfolio Aging Analysis
                    </h6>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th class="ps-3">Age Range</th>
                                    <th class="text-end">Amount</th>
                                    <th class="text-center">Count</th>
                                    <th class="text-center">%</th>
                                    <th class="text-center">Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="aging-row" style="border-left-color: #28a745;">
                                    <td class="ps-3 fw-bold">Current</td>
                                    <td class="text-end">${{ aging_analysis.current.amount|floatformat:0|intcomma }}</td>
                                    <td class="text-center">{{ aging_analysis.current.count }}</td>
                                    <td class="text-center">{{ aging_analysis.current.percentage }}%</td>
                                    <td class="text-center">
                                        <span class="badge bg-success">Excellent</span>
                                    </td>
                                </tr>
                                <tr class="aging-row" style="border-left-color: #ffc107;">
                                    <td class="ps-3 fw-bold">1-30 Days</td>
                                    <td class="text-end">${{ aging_analysis.days_1_30.amount|floatformat:0|intcomma }}</td>
                                    <td class="text-center">{{ aging_analysis.days_1_30.count }}</td>
                                    <td class="text-center">{{ aging_analysis.days_1_30.percentage }}%</td>
                                    <td class="text-center">
                                        <span class="badge bg-warning">Watch</span>
                                    </td>
                                </tr>
                                <tr class="aging-row" style="border-left-color: #fd7e14;">
                                    <td class="ps-3 fw-bold">31-60 Days</td>
                                    <td class="text-end">${{ aging_analysis.days_31_60.amount|floatformat:0|intcomma }}</td>
                                    <td class="text-center">{{ aging_analysis.days_31_60.count }}</td>
                                    <td class="text-center">{{ aging_analysis.days_31_60.percentage }}%</td>
                                    <td class="text-center">
                                        <span class="badge bg-orange">Caution</span>
                                    </td>
                                </tr>
                                <tr class="aging-row" style="border-left-color: #dc3545;">
                                    <td class="ps-3 fw-bold">61-90 Days</td>
                                    <td class="text-end">${{ aging_analysis.days_61_90.amount|floatformat:0|intcomma }}</td>
                                    <td class="text-center">{{ aging_analysis.days_61_90.count }}</td>
                                    <td class="text-center">{{ aging_analysis.days_61_90.percentage }}%</td>
                                    <td class="text-center">
                                        <span class="badge bg-danger">Critical</span>
                                    </td>
                                </tr>
                                <tr class="aging-row" style="border-left-color: #6c757d;">
                                    <td class="ps-3 fw-bold">Over 90 Days</td>
                                    <td class="text-end">${{ aging_analysis.over_90.amount|floatformat:0|intcomma }}</td>
                                    <td class="text-center">{{ aging_analysis.over_90.count }}</td>
                                    <td class="text-center">{{ aging_analysis.over_90.percentage }}%</td>
                                    <td class="text-center">
                                        <span class="badge bg-dark">Write-off</span>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Top Performing Customers -->
        <div class="col-lg-6 mb-4">
            <div class="card report-card">
                <div class="card-header bg-transparent">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-star me-2"></i>Top Performing Customers
                    </h6>
                </div>
                <div class="card-body">
                    {% for customer in top_customers %}
                    <div class="d-flex align-items-center mb-3 p-2 rounded hover-bg-light">
                        <div class="customer-avatar bg-primary me-3">
                            {{ forloop.counter }}
                        </div>
                        <div class="flex-grow-1">
                            <div class="fw-bold">{{ customer.name }}</div>
                            <small class="text-muted">
                                ${{ customer.total_borrowed|floatformat:0|intcomma }} • 
                                {{ customer.payments_made }} payments made
                            </small>
                        </div>
                        <div>
                            <span class="badge fs-6 
                                {% if customer.score == 'A' %}bg-success
                                {% elif customer.score == 'B' %}bg-primary
                                {% else %}bg-warning{% endif %}">
                                {{ customer.score }}
                            </span>
                        </div>
                    </div>
                    {% empty %}
                    <div class="text-center text-muted py-3">
                        <i class="fas fa-users fa-3x mb-3 opacity-25"></i>
                        <p>No customer performance data available yet.</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div id="loadingOverlay" class="d-none position-fixed top-0 start-0 w-100 h-100 bg-dark bg-opacity-50" style="z-index: 9999;">
    <div class="d-flex justify-content-center align-items-center h-100">
        <div class="text-center text-white">
            <div class="spinner-border mb-3" role="status"></div>
            <div>Updating report data...</div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.min.js"></script>
<script>
let monthlyChart, riskChart;
let autoRefreshInterval;

document.addEventListener('DOMContentLoaded', function() {
    initializeCharts();
    setupAutoRefresh();
    setupEventListeners();
});

function initializeCharts() {
    // Monthly Trends Chart
    const monthlyCtx = document.getElementById('monthlyTrendsChart').getContext('2d');
    monthlyChart = new Chart(monthlyCtx, {
        type: 'line',
        data: {
            labels: [{% for item in monthly_data %}"{{ item.month }}"{% if not forloop.last %},{% endif %}{% endfor %}],
            datasets: [{
                label: 'Disbursements ($)',
                data: [{% for item in monthly_data %}{{ item.disbursements }}{% if not forloop.last %},{% endif %}{% endfor %}],
                borderColor: '#4e73df',
                backgroundColor: 'rgba(78, 115, 223, 0.1)',
                fill: true,
                tension: 0.4,
                pointRadius: 5,
                pointHoverRadius: 8
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return '$' + (value / 1000) + 'K';
                        }
                    }
                }
            },
            interaction: {
                intersect: false,
                mode: 'index'
            }
        }
    });

    // Risk Assessment Pie Chart
    const riskCtx = document.getElementById('riskChart').getContext('2d');
    riskChart = new Chart(riskCtx, {
        type: 'doughnut',
        data: {
            labels: ['Low Risk', 'Medium Risk', 'High Risk'],
            datasets: [{
                data: [
                    {{ risk_metrics.low_risk_loans|default:"0" }},
                    {{ risk_metrics.medium_risk_loans|default:"0" }},
                    {{ risk_metrics.high_risk_loans|default:"0" }}
                ],
                backgroundColor: ['#28a745', '#ffc107', '#dc3545'],
                borderWidth: 3,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: { padding: 15, usePointStyle: true }
                }
            }
        }
    });
}

function setupEventListeners() {
    document.getElementById('dateRange').addEventListener('change', function() {
        const customRange = document.getElementById('customDateRange');
        if (this.value === 'custom') {
            customRange.style.display = 'block';
        } else {
            customRange.style.display = 'none';
            updateReports();
        }
    });

    document.getElementById('autoRefresh').addEventListener('change', function() {
        if (this.checked) {
            setupAutoRefresh();
        } else {
            clearInterval(autoRefreshInterval);
        }
    });
}

function setupAutoRefresh() {
    clearInterval(autoRefreshInterval);
    if (document.getElementById('autoRefresh').checked) {
        autoRefreshInterval = setInterval(refreshAllData, 120000); // 2 minutes
    }
}

function showChart(type) {
    const datasets = {
        disbursements: {
            label: 'Disbursements ($)',
            data: [{% for item in monthly_data %}{{ item.disbursements }}{% if not forloop.last %},{% endif %}{% endfor %}],
            borderColor: '#4e73df',
            backgroundColor: 'rgba(78, 115, 223, 0.1)'
        },
        collections: {
            label: 'Collections ($)',
            data: [{% for item in monthly_data %}{{ item.collections }}{% if not forloop.last %},{% endif %}{% endfor %}],
            borderColor: '#1cc88a',
            backgroundColor: 'rgba(28, 200, 138, 0.1)'
        },
        applications: {
            label: 'Applications (#)',
            data: [{% for item in monthly_data %}{{ item.applications }}{% if not forloop.last %},{% endif %}{% endfor %}],
            borderColor: '#36b9cc',
            backgroundColor: 'rgba(54, 185, 204, 0.1)'
        }
    };

    monthlyChart.data.datasets[0] = {
        ...datasets[type],
        fill: true,
        tension: 0.4,
        pointRadius: 5,
        pointHoverRadius: 8
    };
    monthlyChart.update();

    // Update button states
    document.querySelectorAll('.btn-group .btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
}

function refreshAllData() {
    showLoading();
    const refreshIcon = document.getElementById('refresh-icon');
    refreshIcon.classList.add('fa-spin');

    fetch('{% url "loan_report:refresh_cache" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload(); // Simple refresh for now
        } else {
            alert('Error refreshing data: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error refreshing data');
    })
    .finally(() => {
        hideLoading();
        refreshIcon.classList.remove('fa-spin');
        updateLastUpdatedTime();
    });
}

function updateReports() {
    showLoading();
    // Implementation for filtered updates
    setTimeout(() => {
        hideLoading();
        updateLastUpdatedTime();
    }, 1500);
}

function applyFilters() {
    updateReports();
}

function resetFilters() {
    document.getElementById('dateRange').value = '30d';
    document.getElementById('statusFilter').value = '';
    document.getElementById('customDateRange').style.display = 'none';
    updateReports();
}

function exportReport(format) {
    showLoading();
    
    fetch('{% url "loan_report:export_report" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            format: format,
            report_type: 'portfolio'
        })
    })
    .then(response => response.json())
    .then(data => {
        hideLoading();
        if (data.success) {
            alert('Export created successfully! Download will be available shortly.');
        } else {
            alert('Export failed: ' + data.error);
        }
    })
    .catch(error => {
        hideLoading();
        alert('Export error: ' + error);
    });
}

function showLoading() {
    document.getElementById('loadingOverlay').classList.remove('d-none');
}

function hideLoading() {
    document.getElementById('loadingOverlay').classList.add('d-none');
}

function updateLastUpdatedTime() {
    document.getElementById('last-updated').textContent = new Date().toLocaleString();
}
</script>
{% endblock %}

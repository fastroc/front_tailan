{% extends 'base.html' %}
{% load static %}

{% block title %}Application Decision - {{ application.application_id }}{% endblock %}

{% block extra_css %}
<style>
    /* CSS Variables for consistent theming */
    :root {
        --primary-color: #1e40af;
        --primary-hover: #1d4ed8;
        --secondary-color: #6b7280;
        --success-color: #059669;
        --border-color: #d1d5db;
        --border-hover: #9ca3af;
        --background-light: #f9fafb;
        --text-primary: #374151;
        --text-secondary: #6b7280;
    }

    /* Decision Options */
    .decision-option {
        transition: all 0.3s ease;
        height: 100%;
    }

    .decision-option:hover {
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        transform: translateY(-2px);
    }

    .decision-option .btn {
        width: 100%;
    }

    /* Payment Type Buttons - Side by Side Layout */
    .payment-type-container {
        display: flex;
        flex-direction: row;
        gap: 16px;
        margin-bottom: 24px;
        align-items: stretch;
    }

    .payment-type-wrapper {
        flex: 1;
        min-width: 0;
    }

    .payment-type-container .custom-payment-btn {
        width: 100%;
        background: #ffffff;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 20px 16px;
        cursor: pointer;
        transition: all 0.2s ease;
        text-align: center;
        font-family: inherit;
        outline: none;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 80px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .payment-type-container .custom-payment-btn:hover {
        border-color: var(--border-hover);
        background: var(--background-light);
        box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        transform: translateY(-1px);
    }

    .payment-type-container .custom-payment-btn.active-payment {
        border-color: var(--primary-color);
        background: var(--primary-color);
        color: white;
        box-shadow: 0 4px 12px rgba(30,64,175,0.3);
        transform: translateY(-1px);
    }

    .payment-type-container .payment-btn-text {
        font-size: 16px;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 6px;
        line-height: 1.2;
    }

    .payment-type-container .custom-payment-btn.active-payment .payment-btn-text {
        color: white;
    }

    .payment-type-container .payment-btn-desc {
        font-size: 13px;
        font-weight: 400;
        color: var(--text-secondary);
        line-height: 1.4;
        margin: 0;
    }

    .payment-type-container .custom-payment-btn.active-payment .payment-btn-desc {
        color: rgba(255,255,255,0.9);
    }

    /* Schedule Summary Cards */
    .summary-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    .summary-card {
        background: white;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 1rem;
        text-align: center;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        transition: all 0.3s ease;
    }

    .summary-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }

    .summary-card.primary { border-left: 4px solid var(--primary-color); }
    .summary-card.success { border-left: 4px solid var(--success-color); }
    .summary-card.warning { border-left: 4px solid #d97706; }
    .summary-card.info { border-left: 4px solid #0284c7; }

    .summary-card-value {
        font-size: 1.5rem;
        font-weight: 700;
        margin-bottom: 0.25rem;
        color: #111827;
    }

    .summary-card-label {
        font-size: 0.8rem;
        color: var(--text-secondary);
        font-weight: 500;
    }

    /* Schedule Table */
    .schedule-table {
        background: white;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-top: 1rem;
    }

    .schedule-table th {
        background: var(--primary-color);
        color: white;
        font-weight: 600;
        padding: 0.75rem 0.5rem;
        border: none;
        font-size: 0.85rem;
    }

    .schedule-table td {
        padding: 0.5rem;
        border-color: #e2e8f0;
        vertical-align: middle;
        font-size: 0.8rem;
    }

    .schedule-table tbody tr:hover {
        background: rgba(30,64,175,0.03);
    }

    /* Form Controls */
    .form-control:focus, .form-select:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 0.2rem rgba(30,64,175,0.25);
    }

    #scheduleContainer {
        max-height: 400px;
        overflow-y: auto;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
        .payment-type-container {
            flex-direction: column;
            gap: 12px;
        }
        
        .custom-payment-btn {
            min-height: 70px;
            padding: 16px 12px;
        }
        
        .payment-btn-text {
            font-size: 15px;
        }
        
        .payment-btn-desc {
            font-size: 12px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <!-- Application Summary Card -->
            <div class="card mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        Application Summary: {{ application.application_id }}
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Customer:</strong> {{ application.customer.full_name }}</p>
                            <p><strong>Product:</strong> {{ application.loan_product.name }}</p>
                            <p><strong>Requested Amount:</strong> ${{ application.requested_amount|floatformat:2 }}</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Term:</strong> {{ application.term_months }} months</p>
                            <p><strong>Interest Rate:</strong> {{ application.interest_rate }}%</p>
                            <p><strong>Current Status:</strong> 
                                <span class="badge bg-warning">{{ application.get_status_display }}</span>
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Simple Decision Card -->
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-gavel me-2"></i>
                        Make Your Decision
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <!-- Approve & Make Contract -->
                        <div class="col-md-4 mb-3">
                            <div class="decision-option p-4 border rounded h-100">
                                <div class="mb-3">
                                    <i class="fas fa-check-circle text-success" style="font-size: 3rem;"></i>
                                </div>
                                <h5 class="text-success">Approve & Make Contract</h5>
                                <p class="text-muted">Approve application and proceed to create loan contract with disbursement scheduling.</p>
                                <button type="button" class="btn btn-success btn-lg" onclick="approveApplication()">
                                    <i class="fas fa-handshake me-2"></i>Approve & Contract
                                </button>
                            </div>
                        </div>

                        <!-- Reject -->
                        <div class="col-md-4 mb-3">
                            <div class="decision-option p-4 border rounded h-100">
                                <div class="mb-3">
                                    <i class="fas fa-times-circle text-danger" style="font-size: 3rem;"></i>
                                </div>
                                <h5 class="text-danger">Reject Application</h5>
                                <p class="text-muted">Decline the application and provide rejection reason to customer.</p>
                                <button type="button" class="btn btn-danger btn-lg" onclick="rejectApplication()">
                                    <i class="fas fa-ban me-2"></i>Reject
                                </button>
                            </div>
                        </div>

                        <!-- Leave Submitted -->
                        <div class="col-md-4 mb-3">
                            <div class="decision-option p-4 border rounded h-100">
                                <div class="mb-3">
                                    <i class="fas fa-clock text-warning" style="font-size: 3rem;"></i>
                                </div>
                                <h5 class="text-warning">Leave Submitted</h5>
                                <p class="text-muted">Keep application in submitted status for further review or documentation.</p>
                                <button type="button" class="btn btn-warning btn-lg" onclick="leaveSubmitted()">
                                    <i class="fas fa-pause me-2"></i>Leave Submitted
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="row mt-4">
                        <div class="col-12 text-center">
                            <a href="{% url 'loans_core:application_detail' application.pk %}" class="btn btn-outline-secondary me-2">
                                <i class="fas fa-eye me-1"></i>View Full Details
                            </a>
                            <a href="{% url 'loans_core:application_list' %}" class="btn btn-outline-primary">
                                <i class="fas fa-list me-1"></i>Back to Applications
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Approve Modal -->
<div class="modal fade" id="approveModal" tabindex="-1" aria-labelledby="approveModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="approveModalLabel">
                    <i class="fas fa-handshake me-2"></i>Approve Application & Create Contract
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" id="approveForm">
                {% csrf_token %}
                <div class="modal-body">
                    <input type="hidden" name="action" value="approve">
                    <input type="hidden" name="schedule_type" id="schedule_type" value="equal-total">
                    <input type="hidden" name="schedule_data" id="schedule_data" value="">
                    
                    <!-- Loan Terms Section -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-success border-bottom pb-2">
                                <i class="fas fa-file-contract me-1"></i>Loan Terms & Conditions
                            </h6>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="approved_amount" class="form-label">Approved Amount <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="approved_amount" name="approved_amount" 
                                       value="{{ application.requested_amount }}" step="0.01" required>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="interest_rate" class="form-label">Interest Rate (%) <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="interest_rate" name="interest_rate" 
                                       value="{{ application.interest_rate }}" step="0.01" required>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="term_months" class="form-label">Term (Months) <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="term_months" name="term_months" 
                                       value="{{ application.term_months }}" required>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="interest_basis" class="form-label">Interest Basis</label>
                                <select class="form-select" id="interest_basis" name="interest_basis">
                                    <option value="365" selected>365 Days</option>
                                    <option value="360">360 Days (Banker's)</option>
                                </select>
                                <small class="text-muted" id="basisEffect">Standard calendar year</small>
                            </div>
                        </div>
                    </div>

                    <!-- Scheduling Section -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-primary border-bottom pb-2">
                                <i class="fas fa-calendar-alt me-1"></i>Disbursement & Payment Schedule
                            </h6>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="disbursement_date" class="form-label">Disbursement Date <span class="text-danger">*</span></label>
                                <input type="date" class="form-control" id="disbursement_date" name="disbursement_date" 
                                       value="{% if application.disbursement_date %}{{ application.disbursement_date|date:'Y-m-d' }}{% else %}{% now 'Y-m-d' %}{% endif %}" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="first_payment_date" class="form-label">First Payment Date <span class="text-danger">*</span></label>
                                <input type="date" class="form-control" id="first_payment_date" name="first_payment_date" 
                                       value="{% if application.first_payment_date %}{{ application.first_payment_date|date:'Y-m-d' }}{% endif %}" required>
                            </div>
                        </div>
                    </div>

                    <!-- Payment Schedule Type -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-info border-bottom pb-2">
                                <i class="fas fa-list-check me-1"></i>Payment Schedule Type
                            </h6>
                        </div>
                        <div class="col-12">
                            <div class="payment-type-container">
                                <!-- Equal Total Payment -->
                                <div class="payment-type-wrapper">
                                    <button type="button" class="custom-payment-btn active-payment" data-type="equal-total">
                                        <span class="payment-btn-text">Equal Payment</span>
                                        <span class="payment-btn-desc">Fixed monthly payment</span>
                                    </button>
                                </div>

                                <!-- Equal Principal Payment -->
                                <div class="payment-type-wrapper">
                                    <button type="button" class="custom-payment-btn" data-type="equal-principal">
                                        <span class="payment-btn-text">Equal Principal</span>
                                        <span class="payment-btn-desc">Fixed principal, varying payment</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Schedule Display -->
                    <div class="row mb-4" id="scheduleContainer" style="display: none;">
                        <!-- Schedule Table -->
                        <div class="col-12">
                            <div class="schedule-table" id="standardScheduleTable">
                                <table class="table table-striped table-sm">
                                    <thead>
                                        <tr>
                                            <th>Payment #</th>
                                            <th>Date</th>
                                            <th>Days</th>
                                            <th>Payment</th>
                                            <th>Principal</th>
                                            <th>Interest</th>
                                            <th>Balance</th>
                                        </tr>
                                    </thead>
                                    <tbody id="standardScheduleTableBody">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Additional Terms Section -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="mb-3">
                                <label for="notes" class="form-label">Approval Notes</label>
                                <textarea class="form-control" id="notes" name="notes" rows="2" 
                                          placeholder="Any conditions or notes for the approval..."></textarea>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>Cancel
                    </button>
                    <button type="button" class="btn btn-info me-2" onclick="calculateSchedule()">
                        <i class="fas fa-calculator me-1"></i>Calculate Schedule
                    </button>
                    <button type="submit" class="btn btn-success btn-lg">
                        <i class="fas fa-handshake me-1"></i>Approve & Create Contract
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Reject Modal -->
<div class="modal fade" id="rejectModal" tabindex="-1" aria-labelledby="rejectModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="rejectModalLabel">Reject Application</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" id="rejectForm">
                {% csrf_token %}
                <div class="modal-body">
                    <input type="hidden" name="action" value="reject">
                    <div class="mb-3">
                        <label for="rejection_reason" class="form-label">Rejection Reason <span class="text-danger">*</span></label>
                        <textarea class="form-control" id="rejection_reason" name="rejection_reason" rows="4" 
                                  placeholder="Please provide a clear reason for rejection..." required></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="reject_notes" class="form-label">Additional Notes</label>
                        <textarea class="form-control" id="reject_notes" name="notes" rows="2" 
                                  placeholder="Any additional information for internal use..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-ban me-1"></i>Reject Application
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// NEW: global equal-payment cache (for "equal-total" mode)
window.__EQUAL_PAYMENT_BASE__ = null;

// Global Modal Functions (must be available immediately)
function approveApplication() {
    const approveModal = new bootstrap.Modal(document.getElementById('approveModal'));
    
    // Only set default first payment date if application doesn't have one
    const firstPaymentInput = document.getElementById('first_payment_date');
    if (!firstPaymentInput.value) {
        // Set default first payment date to 30 days from disbursement
        const firstPaymentDate = new Date();
        firstPaymentDate.setDate(firstPaymentDate.getDate() + 30);
        firstPaymentInput.value = firstPaymentDate.toISOString().split('T')[0];
    }
    
    approveModal.show();
}

function rejectApplication() {
    const rejectModal = new bootstrap.Modal(document.getElementById('rejectModal'));
    rejectModal.show();
}

function leaveSubmitted() {
    if (confirm('Keep this application in submitted status?')) {
        window.location.href = '{% url "loans_core:application_list" %}';
    }
}

function calculateSchedule() {
    if (typeof window.calculateScheduleFunction === 'function') {
        window.calculateScheduleFunction();
    }
}

// Ensure functions are globally accessible
window.approveApplication = approveApplication;
window.rejectApplication = rejectApplication;
window.leaveSubmitted = leaveSubmitted;
window.calculateSchedule = calculateSchedule;

// Main Initialization - Wait for jQuery
document.addEventListener('DOMContentLoaded', function() {
    var attempts = 0;
    (function waitForJQ() {
        if (typeof window.jQuery !== 'undefined') {
            initializeLoanApproval();
        } else if (attempts < 50) {
            attempts++;
            setTimeout(waitForJQ, 100);
        } else {
            console.warn('jQuery not available; limited functionality.');
        }
    })();
});

function initializeLoanApproval() {
    const $ = window.jQuery;
    
    // Basic payment calculation
    function updatePaymentCalculation() {
        const amount = parseFloat($('#approved_amount').val()) || 0;
        const rate = parseFloat($('#interest_rate').val()) || 0;
        const months = parseInt($('#term_months').val()) || 0;
        
        if (amount > 0 && rate > 0 && months > 0) {
            const monthlyRate = rate / 100 / 12;
            const monthlyPayment = amount * (monthlyRate * Math.pow(1 + monthlyRate, months)) / 
                                  (Math.pow(1 + monthlyRate, months) - 1);
            const totalInterest = (monthlyPayment * months) - amount;
            
            // Summary elements removed - no UI update needed
        }
    }

    // Complete schedule calculation with Equal Payment and Equal Principal options
    function calculateScheduleMain() {
        const amount = parseFloat($('#approved_amount').val()) || 0;
        const rate = parseFloat($('#interest_rate').val()) || 0;
        const months = parseInt($('#term_months').val()) || 0;
        const firstPaymentDate = $('#first_payment_date').val();
        const disbursementDate = $('#disbursement_date').val();
        const scheduleType = $('#schedule_type').val() || 'equal-total';

        if (!(amount > 0 && rate >= 0 && months > 0 && firstPaymentDate && disbursementDate)) {
            $('#scheduleContainer').hide();
            return;
        }

        $('#scheduleContainer').show();

        // Helpers
        function daysBetween(startDate, endDate) {
            const start = new Date(startDate);
            const end = new Date(endDate);
            const diffTime = end - start; // NOT abs: direction should be forward
            return Math.max(0, Math.round(diffTime / (1000 * 60 * 60 * 24)));
        }

        const annualRate = rate / 100;
        const dailyRate = annualRate / 365;

        let schedule = [];
        let balance = amount;
        let currentDate = new Date(firstPaymentDate);
        let previousDate = new Date(disbursementDate);

        if (scheduleType === 'equal-principal') {
            // === Equal Principal (unchanged behavior, but final row balances) ===
            const principalPayment = amount / months;

            for (let i = 1; i <= months; i++) {
                const daysInPeriod = daysBetween(previousDate, currentDate);
                const interestPayment = balance * dailyRate * daysInPeriod;

                let principal = (i === months) ? balance : principalPayment;
                let payment   = principal + interestPayment;

                balance -= principal;

                schedule.push({
                    payment_number: i,
                    date: new Date(currentDate).toISOString().split('T')[0],
                    payment,
                    principal,
                    interest: interestPayment,
                    balance: Math.max(0, balance),
                    days: daysInPeriod
                });

                previousDate = new Date(currentDate);
                currentDate.setMonth(currentDate.getMonth() + 1);
            }

            updateScheduleDisplay(schedule);
            $('#schedule_data').val(JSON.stringify(schedule));
            return;
        }

        // === Equal Total Payment (constant payment) ===
        // For true daily interest calculation, we need to use daily compounding for the base payment too
        const monthlyRate = annualRate / 12;
        let basePayment;
        
        if (annualRate === 0) {
            basePayment = amount / months;
        } else {
            // Option 1: Traditional monthly compounding (standard loan calculation)
            basePayment = amount * (monthlyRate * Math.pow(1 + monthlyRate, months)) /
                          (Math.pow(1 + monthlyRate, months) - 1);
            
            // Option 2: Daily compounding approach (more accurate for actual daily interest)
            // Uncomment this if you want daily compounding consistency
            /*
            const dailyPayments = months * 30.4375; // Average days per month
            const dailyCompoundRate = Math.pow(1 + dailyRate, dailyPayments);
            basePayment = amount * (dailyRate * dailyCompoundRate) / (dailyCompoundRate - 1);
            basePayment = basePayment * 30.4375; // Convert to monthly equivalent
            */
        }

        // Cache globally so manual edits can use it
        window.__EQUAL_PAYMENT_BASE__ = basePayment;

        // Debug logging to understand the base payment calculation
        console.log('Loan Parameters:', {
            amount: amount,
            annualRate: annualRate,
            monthlyRate: monthlyRate,
            dailyRate: dailyRate,
            months: months,
            basePayment: basePayment
        });

        // Calculate what first period interest should be with daily rate
        const daysFirst = daysBetween(disbursementDate, firstPaymentDate);
        const interestFirst = amount * dailyRate * daysFirst;
        const principalFirst = basePayment - interestFirst;
        
        console.log('First Period Analysis:', {
            daysFirst: daysFirst,
            dailyRate: dailyRate,
            interestFirstExpected: interestFirst,
            basePayment: basePayment,
            principalFirstExpected: principalFirst,
            interestAsPercent: (interestFirst / basePayment * 100).toFixed(1) + '%'
        });
        
        if (interestFirst > basePayment) {
            console.warn('PROBLEM: First period interest exceeds base payment!', {
                interestFirst: interestFirst,
                basePayment: basePayment,
                difference: interestFirst - basePayment
            });
        }

        for (let i = 1; i <= months; i++) {
            const daysInPeriod = daysBetween(previousDate, currentDate);
            const interestPayment = balance * dailyRate * daysInPeriod;

            // By default keep payment constant (except final balancing)
            let payment = (i === months) ? 0 : basePayment; // final computed below
            let principal = payment - interestPayment;

            // Debug the first payment calculation
            if (i === 1) {
                console.log(`First Payment Debug:`, {
                    payment: payment,
                    interestPayment: interestPayment,
                    principal: principal,
                    balance: balance,
                    daysInPeriod: daysInPeriod,
                    calculationBreakdown: {
                        'balance * dailyRate * days': `${balance} * ${dailyRate} * ${daysInPeriod} = ${balance * dailyRate * daysInPeriod}`,
                        'Expected from analysis': interestFirst,
                        'Difference': Math.abs(interestPayment - interestFirst)
                    }
                });
            }

            // For Equal Payment, we should always have principal unless it's impossible
            // Only set principal to 0 if interest truly exceeds payment
            if (i !== months && principal < 0) {
                console.warn(`Payment ${i}: Interest (${interestPayment.toFixed(2)}) exceeds base payment (${basePayment.toFixed(2)}). Setting principal to 0.`);
                principal = 0;
                payment = basePayment; // still constant, but all goes to interest
            }

            // Ensure we don't pay more principal than remaining balance
            if (principal > balance) {
                principal = balance;
            }

            // Final row must clear the balance exactly
            if (i === months) {
                // interest for the last period is already computed above
                principal = balance;
                payment = principal + interestPayment; // may differ from basePayment by a small amount
            }

            balance -= principal;

            schedule.push({
                payment_number: i,
                date: new Date(currentDate).toISOString().split('T')[0],
                payment,
                principal,
                interest: interestPayment,
                balance: Math.max(0, balance),
                days: daysInPeriod
            });

            previousDate = new Date(currentDate);
            currentDate.setMonth(currentDate.getMonth() + 1);
        }

        updateScheduleDisplay(schedule);
        $('#schedule_data').val(JSON.stringify(schedule));
    }
    
    // Event handlers
    updatePaymentCalculation();
    
    $('#approved_amount, #interest_rate, #term_months, #first_payment_date, #disbursement_date')
        .on('input change', function() {
            updatePaymentCalculation();
            calculateScheduleMain();
        });

    // Payment type selection
    $('.custom-payment-btn').on('click', function() {
        $('.custom-payment-btn').removeClass('active-payment');
        $(this).addClass('active-payment');
        $('#schedule_type').val($(this).data('type'));
        calculateScheduleMain();
    });

    // Handle manual principal editing with recalculation
    $(document).on('input', '.editable-principal', function() {
        const rowIndex = parseInt($(this).data('row'));
        let newPrincipal = parseFloat($(this).val()) || 0;

        // Current schedule
        let schedule = [];
        try {
            schedule = JSON.parse($('#schedule_data').val() || '[]');
        } catch(e) {
            return;
        }
        if (!schedule.length || rowIndex < 0 || rowIndex >= schedule.length) return;

        const amount = parseFloat($('#approved_amount').val()) || 0;
        const rate   = parseFloat($('#interest_rate').val()) || 0;
        const dailyRate = (rate / 100) / 365;
        const basePayment = window.__EQUAL_PAYMENT_BASE__ || 0;

        // Rebuild running balance up to the edited row
        let runningBalance = amount;
        for (let i = 0; i < rowIndex; i++) {
            runningBalance -= (schedule[i].principal || 0);
        }

        // === Apply edit on the target row ===
        const edited = schedule[rowIndex];
        const isLast = (rowIndex === schedule.length - 1);

        if (!isLast) {
            // For Equal Payment schedule with manual edits:
            // If principal is 0, this becomes an interest-only payment
            // If principal > 0, maintain the base payment amount
            
            // Clamp principal not to exceed running balance
            newPrincipal = Math.max(0, Math.min(newPrincipal, runningBalance));

            // For Equal Payment: Calculate the actual ACT/365 interest for this period
            const days = edited.days || 0;
            const actualInterest = runningBalance * dailyRate * days;
            const interest = actualInterest;
            
            let payment;
            if (newPrincipal === 0) {
                // Interest-only payment: payment equals just the interest
                payment = interest;
            } else {
                // Normal Equal Payment: maintain base payment amount
                payment = basePayment;
                
                // Ensure principal doesn't exceed what's possible with base payment
                const maxPrincipalWithBasePayment = basePayment - interest;
                if (newPrincipal > maxPrincipalWithBasePayment && maxPrincipalWithBasePayment > 0) {
                    newPrincipal = maxPrincipalWithBasePayment;
                }
            }
            
            edited.principal = newPrincipal;
            edited.interest = interest;
            edited.payment = payment;
            
            // Update balance: only reduce if principal was actually paid
            runningBalance -= newPrincipal;
            edited.balance = Math.max(0, runningBalance);
        } else {
            // Last row: balance to zero exactly
            const days = edited.days || 0;
            const interest = runningBalance * dailyRate * days;
            const principal = runningBalance;
            edited.principal = principal;
            edited.interest  = interest;
            edited.payment   = principal + interest; // may differ from basePayment
            runningBalance   = 0;
            edited.balance   = 0;
        }

        // === Recompute forward rows to preserve: constant payments & ACT/365 interest ===
        for (let i = rowIndex + 1; i < schedule.length; i++) {
            const isLastRow = (i === schedule.length - 1);
            const days = schedule[i].days || 0;
            const interest = runningBalance * dailyRate * days;

            if (!isLastRow) {
                // Keep payment equal for all non-last rows
                const payment = basePayment;

                // Default principal from equal payment
                let principal = payment - interest;

                // Prevent negative principal when interest > payment
                if (principal < 0) {
                    principal = 0; // defer to later rows
                }

                // Prevent overpaying more than remaining balance
                if (principal > runningBalance) principal = runningBalance;

                schedule[i].interest  = interest;
                schedule[i].principal = principal;
                schedule[i].payment   = payment;
                runningBalance -= principal;
                schedule[i].balance = Math.max(0, runningBalance);
            } else {
                // Final row clears the account
                const principal = runningBalance;
                const payment = principal + interest;

                schedule[i].interest  = interest;
                schedule[i].principal = principal;
                schedule[i].payment   = payment;
                runningBalance = 0;
                schedule[i].balance = 0;
            }
        }

        updateScheduleDisplay(schedule);
        $('#schedule_data').val(JSON.stringify(schedule));
    });
    
    // Helper function to update schedule display
    function updateScheduleDisplay(schedule) {
        const $tbody = $('#standardScheduleTableBody');
        $tbody.empty();
        
        schedule.forEach((payment, index) => {
            $tbody.append(`
                <tr>
                    <td>${payment.payment_number}</td>
                    <td>${new Date(payment.date).toLocaleDateString()}</td>
                    <td class="text-center"><span class="badge bg-info">${payment.days} days</span></td>
                    <td>$${payment.payment.toLocaleString('en-US', {minimumFractionDigits: 2})}</td>
                    <td><input type="number" class="form-control form-control-sm editable-principal" 
                              value="${payment.principal.toFixed(2)}" step="0.01" min="0" data-row="${index}"></td>
                    <td>$${payment.interest.toLocaleString('en-US', {minimumFractionDigits: 2})}</td>
                    <td>$${payment.balance.toLocaleString('en-US', {minimumFractionDigits: 2})}</td>
                </tr>
            `);
        });
    }

    // Auto-calculate first payment date
    $('#disbursement_date').on('change', function() {
        const disbursementDate = new Date($(this).val());
        if (!isNaN(disbursementDate)) {
            const firstPaymentDate = new Date(disbursementDate);
            firstPaymentDate.setMonth(firstPaymentDate.getMonth() + 1);
            $('#first_payment_date').val(firstPaymentDate.toISOString().split('T')[0]);
        }
    });
    
    // Expose global function
    window.calculateScheduleFunction = calculateScheduleMain;
}
</script>
{% endblock %}

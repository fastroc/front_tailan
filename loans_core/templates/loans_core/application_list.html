{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block title %}Loan Applications{% endblock %}

{% block extra_css %}
<style>
/* Simple dropdown styling */
.dropdown-menu {
    z-index: 1050;
    min-width: 200px;
}

/* Progress Badge Styling */
.badge {
    font-size: 0.75rem;
    padding: 0.35em 0.65em;
}

.badge i {
    margin-right: 0.25rem;
}

/* Progress Bar Styling */
.progress {
    background-color: #e9ecef;
    border-radius: 0.25rem;
}

.progress-bar {
    /* No transitions - keep it simple */
}

/* Progress Column Styling */
.approval-progress {
    min-width: 120px;
}

.approval-progress .progress {
    margin-top: 2px;
}

/* Quick Action Button Styling */
.btn-sm {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
    margin-left: 0.25rem;
}

/* Badge Colors */
.badge-secondary {
    background-color: #6c757d !important;
    color: white;
}

.badge-success {
    background-color: #28a745 !important;
    color: white;
}

.badge-warning {
    background-color: #ffc107 !important;
    color: #212529;
}

.badge-info {
    background-color: #17a2b8 !important;
    color: white;
}

/* Hover effects for progress badges */
.badge:hover {
    /* Simple hover - no transitions */
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .approval-progress {
        min-width: 100px;
    }
    
    .progress {
        width: 50px !important;
    }
    
    .btn-sm {
        font-size: 0.7rem;
        padding: 0.2rem 0.4rem;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-0 text-gray-800">
                        <i class="fas fa-file-alt text-primary me-2"></i>
                        Loan Applications
                    </h1>
                    <p class="text-muted mb-0">Manage and review loan applications</p>
                </div>
                <div>
                    <a href="{% url 'loans_core:application_create' %}" class="btn btn-primary">
                        <i class="fas fa-plus me-2"></i>New Application
                    </a>
                    <a href="{% url 'loans_core:application_bulk_upload' %}" class="btn btn-success ms-2">
                        <i class="fas fa-upload me-2"></i>Bulk Upload
                    </a>
                    <a href="{% url 'loans_core:bulk_upload_review' %}" class="btn btn-info ms-2">
                        <i class="fas fa-clipboard-check me-2"></i>Review Uploads
                    </a>
                    <!-- DEBUG: Simple test button -->
                    <button class="btn btn-warning ms-2" onclick="console.log('🧪 TEST BUTTON CLICKED!'); alert('JavaScript is working!');">
                        Test JS
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-info shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                Total Applications
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ stats.total_applications|default:"0" }}</div>
                            <div class="text-xs text-muted">
                                ${{ stats.total_requested_amount|floatformat:0|intcomma }} requested
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-file-alt fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                Pending Review
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ stats.pending_applications|default:"0" }}</div>
                            <div class="text-xs text-muted">
                                Avg: ${{ stats.average_requested_amount|floatformat:0|intcomma }}
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-clock fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                Approved ({{ stats.approval_rate }}%)
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ stats.approved_applications|default:"0" }}</div>
                            <div class="text-xs text-muted">
                                ${{ stats.total_approved_amount|floatformat:0|intcomma }} approved
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-check fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-danger shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">
                                Rejected
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ stats.rejected_applications|default:"0" }}</div>
                            <div class="text-xs text-muted">
                                Draft: {{ stats.draft_applications|default:"0" }}
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-times fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Search and Filters -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-body">
                    <form method="get" action="">
                        <div class="row">
                            <div class="col-md-3">
                                <label for="search" class="form-label">Search Applications</label>
                                <input type="text" class="form-control" id="search" name="search" 
                                       value="{{ search_query }}" placeholder="Application ID, customer name, email">
                            </div>
                            <div class="col-md-2">
                                <label for="status" class="form-label">Status</label>
                                <select class="form-select" id="status" name="status">
                                    <option value="">All Status</option>
                                    {% for value, label in status_choices %}
                                        <option value="{{ value }}" {% if status_filter == value %}selected{% endif %}>{{ label }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label for="progress" class="form-label">Approval Progress</label>
                                <select class="form-select" id="progress" name="progress">
                                    <option value="">All Progress</option>
                                    <option value="completed" {% if progress_filter == 'completed' %}selected{% endif %}>All Approved</option>
                                    <option value="partial" {% if progress_filter == 'partial' %}selected{% endif %}>Partially Approved</option>
                                    <option value="not_started" {% if progress_filter == 'not_started' %}selected{% endif %}>Not Started</option>
                                    <option value="pending_disbursement" {% if progress_filter == 'pending_disbursement' %}selected{% endif %}>Pending Disbursement</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label for="product" class="form-label">Product</label>
                                <select class="form-select" id="product" name="product">
                                    <option value="">All Products</option>
                                    {% for product in loan_products %}
                                        <option value="{{ product.pk }}" {% if product_filter == product.pk|stringformat:"s" %}selected{% endif %}>{{ product.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-1 d-flex align-items-end">
                                <button type="submit" class="btn btn-outline-primary w-100">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                            <div class="col-md-2 d-flex align-items-end">
                                <a href="{% url 'loans_core:application_list' %}" class="btn btn-outline-secondary w-100">
                                    <i class="fas fa-times me-1"></i>Clear
                                </a>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Applications Table -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Loan Applications</h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered" width="100%" cellspacing="0">
                            <thead>
                                <tr>
                                    <th>Loan Number</th>
                                    <th>Application ID</th>
                                    <th>Customer</th>
                                    <th>Product</th>
                                    <th>Amount Requested</th>
                                    <th>Term</th>
                                    <th>Status</th>
                                    <th>Approval Progress</th>
                                    <th>Date Applied</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody class="applications-tbody">
                                {% for item in page_obj %}
                                <tr data-application-id="{{ item.application.pk }}">
                                    <td>
                                        {% if item.loan %}
                                            <small class="text-muted">{{ item.loan.loan_number }}</small>
                                        {% else %}
                                            <span class="text-muted">—</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <small class="text-muted">{{ item.application.application_id }}</small>
                                    </td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="avatar bg-primary text-white rounded-circle me-3" style="width: 35px; height: 35px; display: flex; align-items: center; justify-content: center; font-size: 0.8rem;">
                                                <strong>{{ item.application.customer.first_name|first }}{{ item.application.customer.last_name|first }}</strong>
                                            </div>
                                            <div>
                                                <strong>{{ item.application.customer.full_name }}</strong><br>
                                                <small class="text-muted">{{ item.application.customer.email }}</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <strong>{{ item.application.loan_product.name }}</strong><br>
                                        <small class="text-muted">{{ item.application.loan_product.category|title }}</small>
                                    </td>
                                    <td>
                                        <strong>${{ item.application.requested_amount|floatformat:0|intcomma }}</strong>
                                        {% if item.application.approved_amount %}
                                            <br><small class="text-success">Approved: ${{ item.application.approved_amount|floatformat:0|intcomma }}</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {{ item.application.term_months }} months<br>
                                        <small class="text-muted">{{ item.application.interest_rate }}% APR</small>
                                    </td>
                                    <td>
                                        {% if item.application.status == 'approved' %}
                                            <span class="badge bg-success">{{ item.application.status|title }}</span>
                                        {% elif item.application.status == 'submitted' or item.application.status == 'under_review' %}
                                            <span class="badge bg-warning">{{ item.application.get_status_display }}</span>
                                        {% elif item.application.status == 'rejected' %}
                                            <span class="badge bg-danger">{{ item.application.status|title }}</span>
                                        {% elif item.application.status == 'draft' %}
                                            <span class="badge bg-secondary">{{ item.application.status|title }}</span>
                                        {% else %}
                                            <span class="badge bg-info">{{ item.application.get_status_display }}</span>
                                        {% endif %}
                                    </td>
                                    <td class="approval-progress progress-cell">
                                        <!-- Server-side progress with lazy loading fallback -->
                                        {% with progress=item.application.get_approval_progress %}
                                            <div class="progress-container">
                                                <div class="progress-bar">
                                                    <div class="progress-fill progress-{{ progress.status }}" style="width: {{ progress.percentage }}%"></div>
                                                </div>
                                                <div class="progress-text">
                                                    <span class="progress-percentage">{{ progress.percentage }}%</span>
                                                    <span class="progress-status">({{ progress.approved_payments }}/{{ progress.total_payments }})</span>
                                                </div>
                                                <div class="progress-label">
                                                    <span class="badge badge-{{ progress.status }}">{{ progress.status_display }}</span>
                                                </div>
                                            </div>
                                        {% endwith %}
                                    </td>
                                    <td>
                                        {{ item.application.application_date|date:"M d, Y" }}<br>
                                        <small class="text-muted">{{ item.application.created_at|timesince }} ago</small>
                                    </td>
                                    <td>
                                            <div class="btn-group btn-group-sm" role="group">
                                                <a href="{% url 'loans_core:application_detail' item.application.pk %}" 
                                                   class="btn btn-outline-primary" 
                                                   title="View Application Details" 
                                                   data-bs-toggle="tooltip">
                                                    <i class="fas fa-eye me-1"></i>View
                                                </a>

                                                {% if item.application.status == 'submitted' or item.application.status == 'under_review' %}
                                                <a href="{% url 'loans_core:application_approve' item.application.pk %}" 
                                                   class="btn btn-outline-success" 
                                                   title="Review & Approve/Reject" 
                                                   data-bs-toggle="tooltip">
                                                    <i class="fas fa-gavel me-1"></i>Review
                                                </a>
                                                {% endif %}

                                                {% if item.application.status == 'draft' %}
                                                <a href="#" 
                                                   class="btn btn-outline-info" 
                                                   title="Edit Application" 
                                                   data-bs-toggle="tooltip">
                                                    <i class="fas fa-edit me-1"></i>Edit
                                                </a>
                                                {% endif %}

                                                {% comment %}
                                                Progress button - Show for applications with sufficient data for analysis
                                                Required: interest_rate, term_months, and requested_amount (minimum)
                                                {% endcomment %}
                                                {% if item.application.interest_rate and item.application.term_months and item.application.requested_amount %}
                                                <!-- Progress Button - Available for any application with complete loan terms -->
                                                <a href="{% url 'loans_core:application_progress' item.application.pk %}" 
                                                   class="btn btn-outline-{% if item.application.status == 'approved' %}success{% else %}info{% endif %}" 
                                                   title="View Payment Analysis {% if item.application.status != 'approved' %}(Projected){% endif %}" 
                                                   data-bs-toggle="tooltip">
                                                    <i class="fas fa-chart-line me-1"></i>Progress
                                                    {% if item.application.status != 'approved' %}
                                                        <small class="d-block" style="font-size: 0.7em;">Projected</small>
                                                    {% endif %}
                                                </a>
                                                
                                                <!-- Quick Progress Actions for Approved Applications -->
                                                {% if item.application.status == 'approved' and item.progress %}
                                                    {% if item.progress.status == 'partial' %}
                                                        <a href="{% url 'loans_core:application_progress' item.application.pk %}#approve-pending" 
                                                           class="btn btn-outline-warning btn-sm" 
                                                           title="Quick approve {{ item.progress.total_payments|add:'-'|add:item.progress.approved_payments }} pending payments" 
                                                           data-bs-toggle="tooltip">
                                                            <i class="fas fa-bolt me-1"></i>Quick Approve
                                                        </a>
                                                    {% elif item.progress.status == 'not_started' and item.progress.total_payments > 0 %}
                                                        <a href="{% url 'loans_core:application_progress' item.application.pk %}#approve-all" 
                                                           class="btn btn-outline-primary btn-sm" 
                                                           title="Start approving {{ item.progress.total_payments }} payments" 
                                                           data-bs-toggle="tooltip">
                                                            <i class="fas fa-play me-1"></i>Start Approvals
                                                        </a>
                                                    {% endif %}
                                                {% endif %}
                                                {% endif %}

                                                {% if item.application.status == 'approved' %}
                                                <!-- Contract and Schedule buttons for approved applications -->
                                                <a href="#" 
                                                   class="btn btn-outline-info" 
                                                   title="Create Loan Contract" 
                                                   data-bs-toggle="tooltip">
                                                    <i class="fas fa-file-contract me-1"></i>Contract
                                                </a>
                                                <button type="button" 
                                                        class="btn btn-outline-secondary toggle-schedule" 
                                                        data-application-id="{{ item.application.pk }}"
                                                        title="Toggle Payment Schedule" 
                                                        data-bs-toggle="tooltip">
                                                    <i class="fas fa-calendar-alt me-1"></i>Schedule
                                                </button>
                                                {% endif %}

                                                <!-- Simple More Button (just for other actions) -->
                                                <div class="btn-group" role="group">
                                                    <button type="button" 
                                                            class="btn btn-outline-secondary dropdown-toggle" 
                                                            data-bs-toggle="dropdown" 
                                                            aria-expanded="false"
                                                            title="More Actions">
                                                        <i class="fas fa-ellipsis-h"></i>
                                                    </button>
                                                    <ul class="dropdown-menu dropdown-menu-end">
                                                        <li>
                                                            <a class="dropdown-item" href="{% url 'loans_customers:customer_detail' item.application.customer.pk %}">
                                                                <i class="fas fa-user me-2 text-info"></i>View Customer
                                                            </a>
                                                        </li>
                                                        <li>
                                                            <a class="dropdown-item" href="{% url 'loans_customers:customer_documents' item.application.customer.pk %}">
                                                                <i class="fas fa-folder me-2 text-info"></i>Customer Documents
                                                            </a>
                                                        </li>
                                                        <li><hr class="dropdown-divider"></li>
                                                        <li>
                                                            <a class="dropdown-item" href="#" onclick="printApplication({{ item.application.pk }})">
                                                                <i class="fas fa-print me-2 text-secondary"></i>Print Application
                                                            </a>
                                                        </li>
                                                        <li>
                                                            <a class="dropdown-item" href="#" onclick="downloadApplication({{ item.application.pk }})">
                                                                <i class="fas fa-download me-2 text-secondary"></i>Download PDF
                                                            </a>
                                                        </li>
                                                        {% if item.application.status in 'draft,submitted,rejected,cancelled' %}
                                                        <li><hr class="dropdown-divider"></li>
                                                        <li>
                                                            <a class="dropdown-item text-danger" href="#" onclick="deleteApplication({{ item.application.pk }}, '{{ item.application.customer.full_name|escapejs }}')">
                                                                <i class="fas fa-trash me-2"></i>Delete Application
                                                            </a>
                                                        </li>
                                                        {% endif %}
                                                        {% if item.application.status == 'submitted' %}
                                                        <li>
                                                            <a class="dropdown-item text-warning" href="#" onclick="requestDocuments({{ item.application.pk }})">
                                                                <i class="fas fa-file-upload me-2"></i>Request Documents
                                                            </a>
                                                        </li>
                                                        {% endif %}
                                                    </ul>
                                                </div>
                                            </div>
                                    </td>
                                </tr>

                                {# Collapsible Payment Schedule Row(s) #}
                                {% if item.application.status == 'approved' %}
                                    {% if item.loan %}
                                    <!-- REAL schedule row (unique ID) -->
                                    <tr class="schedule-row d-none" id="schedule-{{ item.application.pk }}">
                                        <td colspan="9" class="p-0">
                                            <div class="card border-0 shadow-sm m-2">
                                                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                                                    <h6 class="mb-0">
                                                        <i class="fas fa-calendar-alt text-primary me-2"></i>
                                                        Payment Schedule - Loan #{{ item.loan.loan_number }}
                                                    </h6>
                                                    <small class="text-muted">
                                                        {{ item.loan.payment_schedule.schedule_type|title }} Schedule
                                                    </small>
                                                </div>
                                                <div class="card-body">
                                                    {% if item.loan.payment_schedule %}
                                                    <div class="row mb-3">
                                                        <div class="col-md-3">
                                                            <div class="text-center">
                                                                <h5 class="text-primary">${{ item.loan.payment_schedule.total_amount|floatformat:2|intcomma }}</h5>
                                                                <small class="text-muted">Total Amount</small>
                                                            </div>
                                                        </div>
                                                        <div class="col-md-3">
                                                            <div class="text-center">
                                                                <h5 class="text-success">${{ item.loan.payment_schedule.total_principal|floatformat:2|intcomma }}</h5>
                                                                <small class="text-muted">Principal</small>
                                                            </div>
                                                        </div>
                                                        <div class="col-md-3">
                                                            <div class="text-center">
                                                                <h5 class="text-info">${{ item.loan.payment_schedule.total_interest|floatformat:2|intcomma }}</h5>
                                                                <small class="text-muted">Interest</small>
                                                            </div>
                                                        </div>
                                                        <div class="col-md-3">
                                                            <div class="text-center">
                                                                <h5 class="text-warning">{{ item.loan.payment_schedule.total_payments }}</h5>
                                                                <small class="text-muted">Payments</small>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <div class="table-responsive">
                                                        <table class="table table-sm table-hover">
                                                            <thead class="table-light">
                                                                <tr>
                                                                    <th>#</th>
                                                                    <th>Due Date</th>
                                                                    <th>Principal</th>
                                                                    <th>Interest</th>
                                                                    <th>Total Payment</th>
                                                                    <th>Balance</th>
                                                                    <th>Status</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                                {% for payment in item.loan.payment_schedule.scheduled_payments.all|slice:":10" %}
                                                                <tr>
                                                                    <td>
                                                                        <strong>{{ payment.payment_number }}</strong>
                                                                        {% if payment.is_custom_amount %}
                                                                            <span class="badge badge-sm bg-info ms-1" title="Custom Amount">C</span>
                                                                        {% endif %}
                                                                    </td>
                                                                    <td>{{ payment.due_date|date:"M d, Y" }}</td>
                                                                    <td>
                                                                        <span class="{% if payment.principal_amount == 0 %}text-warning{% endif %}">
                                                                            ${{ payment.principal_amount|floatformat:2|intcomma }}
                                                                        </span>
                                                                    </td>
                                                                    <td>${{ payment.interest_amount|floatformat:2|intcomma }}</td>
                                                                    <td><strong>${{ payment.total_amount|floatformat:2|intcomma }}</strong></td>
                                                                    <td>${{ payment.ending_balance|floatformat:2|intcomma }}</td>
                                                                    <td>
                                                                        {% if payment.status == 'paid' %}
                                                                            <span class="badge bg-success">Paid</span>
                                                                        {% elif payment.status == 'overdue' %}
                                                                            <span class="badge bg-danger">Overdue</span>
                                                                        {% else %}
                                                                            <span class="badge bg-secondary">Scheduled</span>
                                                                        {% endif %}
                                                                    </td>
                                                                </tr>
                                                                {% empty %}
                                                                <tr>
                                                                    <td colspan="7" class="text-center text-muted py-3">
                                                                        <i class="fas fa-spinner fa-spin me-2"></i>Loading payment schedule...
                                                                    </td>
                                                                </tr>
                                                                {% endfor %}
                                                                {% if item.loan.payment_schedule.scheduled_payments.count > 10 %}
                                                                <tr>
                                                                    <td colspan="7" class="text-center text-muted">
                                                                        <small>... and {{ item.loan.payment_schedule.scheduled_payments.count|add:"-10" }} more payments</small>
                                                                        <a href="{% url 'loans_core:loan_detail' item.loan.pk %}" class="btn btn-sm btn-outline-primary ms-2">
                                                                            View Full Schedule
                                                                        </a>
                                                                    </td>
                                                                </tr>
                                                                {% endif %}
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                    {% else %}
                                                    <div class="text-center text-muted py-3">
                                                        <i class="fas fa-calendar-times fa-2x mb-2"></i>
                                                        <h6>No Payment Schedule Found</h6>
                                                        <p>Payment schedule has not been generated for this loan.</p>
                                                    </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                    {% else %}
                                    <!-- TEST/Placeholder row when no loan exists (distinct ID) -->
                                    <tr class="schedule-row d-none" id="schedule-test-{{ item.application.pk }}">
                                        <td colspan="9" class="p-3 bg-light">
                                            <div class="alert alert-info mb-0">
                                                <h5>🧪 TEST SCHEDULE for Application {{ item.application.pk }}</h5>
                                                <p><strong>❌ No loan found for this approved application.</strong></p>
                                                <p>This placeholder verifies the toggle works even without a payment schedule.</p>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endif %}
                                {% endif %}
                                {% empty %}
                                <tr>
                                    <td colspan="8" class="text-center py-4">
                                        <div class="text-muted">
                                            <i class="fas fa-file-alt fa-3x mb-3"></i>
                                            <h5>No applications found</h5>
                                            <p>
                                                {% if search_query or status_filter %}
                                                    No applications match your search criteria.
                                                {% else %}
                                                    Start by creating your first loan application.
                                                {% endif %}
                                            </p>
                                            <a href="{% url 'loans_core:application_create' %}" class="btn btn-primary">
                                                <i class="fas fa-plus me-2"></i>Create Application
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    {% if page_obj.has_other_pages %}
                    <nav aria-label="Applications pagination">
                        <ul class="pagination justify-content-center">
                            {% if page_obj.has_previous %}
                                <li class="page-item">
                                    <a class="page-link" href="?page=1{% if search_query %}&search={{ search_query }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if progress_filter %}&progress={{ progress_filter }}{% endif %}{% if product_filter %}&product={{ product_filter }}{% endif %}">First</a>
                                </li>
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if progress_filter %}&progress={{ progress_filter }}{% endif %}{% if product_filter %}&product={{ product_filter }}{% endif %}">Previous</a>
                                </li>
                            {% endif %}

                            <li class="page-item active">
                                <span class="page-link">
                                    Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
                                </span>
                            </li>

                            {% if page_obj.has_next %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if progress_filter %}&progress={{ progress_filter }}{% endif %}{% if product_filter %}&product={{ product_filter }}{% endif %}">Next</a>
                                </li>
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if search_query %}&search={{ search_query }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if progress_filter %}&progress={{ progress_filter }}{% endif %}{% if product_filter %}&product={{ product_filter }}{% endif %}">Last</a>
                                </li>
                            {% endif %}
                        </ul>
                    </nav>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Simple, clean frontend system -->
<script src="{% static 'js/loan_system_simple.js' %}"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('Simple application list loaded');
    
    // Initialize Bootstrap tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});
</script>

// ---------- CSRF helper ----------
function getCookie(name) {
  const value = `; ${document.cookie}`;
  const parts = value.split(`; ${name}=`);
  if (parts.length === 2) return parts.pop().split(';').shift();
  return '';
}
const CSRF_TOKEN = getCookie('csrftoken');

// ---------- Print / Download ----------
function printApplication(applicationId) {
  window.open(`/loans/applications/${applicationId}/print/`, '_blank');
}
function downloadApplication(applicationId) {
  window.location.href = `/loans/applications/${applicationId}/download/`;
}

// ---------- Delete ----------
function deleteApplication(applicationId, customerName) {
  if (!confirm(`Are you sure you want to DELETE the loan application for "${customerName}"?\n\nThis action cannot be undone.`)) return;
  if (!confirm(`FINAL CONFIRMATION: Delete application for "${customerName}"?`)) return;

  const loadingHtml = `
    <div class="alert alert-warning alert-dismissible fade show" role="alert">
      <i class="fas fa-spinner fa-spin me-2"></i>
      Deleting application for "${customerName}"...
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>`;
  $('.container-fluid > .row:first').after(loadingHtml);

  $.ajax({
    url: `/loans/applications/${applicationId}/delete/`,
    type: 'POST',
    headers: {
      'X-Requested-With': 'XMLHttpRequest',
      'X-CSRFToken': CSRF_TOKEN
    },
    success: function (response) {
      if (response.success) {
        const successHtml = `
          <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="fas fa-check-circle me-2"></i>
            Application for "${customerName}" deleted successfully!
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          </div>`;
        $('.container-fluid > .row:first').after(successHtml);
        setTimeout(() => window.location.reload(), 1200);
      } else {
        alert('Error: ' + (response.error || 'Failed to delete application'));
      }
    },
    error: function () {
      alert('An error occurred while deleting the application.');
    }
  });
}

// ---------- Request docs ----------
function requestDocuments(applicationId) {
  const message = prompt('What additional documents do you need from the customer?\n\nEnter your request:');
  if (!message || !message.trim()) return;

  const loadingHtml = `
    <div class="alert alert-info alert-dismissible fade show" role="alert">
      <i class="fas fa-spinner fa-spin me-2"></i>
      Sending document request...
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>`;
  $('.container-fluid > .row:first').after(loadingHtml);

  $.ajax({
    url: `/loans/applications/${applicationId}/request-documents/`,
    type: 'POST',
    data: { 'message': message.trim() },
    headers: {
      'X-Requested-With': 'XMLHttpRequest',
      'X-CSRFToken': CSRF_TOKEN
    },
    success: function (response) {
      if (response.success) {
        const successHtml = `
          <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="fas fa-check-circle me-2"></i>
            Document request sent to customer successfully!
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          </div>`;
        $('.container-fluid > .row:first').after(successHtml);
      } else {
        alert('Error: ' + (response.error || 'Failed to send document request'));
      }
    },
    error: function () {
      alert('An error occurred while sending the document request.');
    }
  });
}

// ---------- Payment Schedule Toggle ----------
$(function () {
  $(document).on('click', '.toggle-schedule', function (e) {
    e.preventDefault();
    e.stopPropagation();

    const appId = $(this).data('application-id');
    let $row = $('#schedule-' + appId);           // real schedule row
    if ($row.length === 0) $row = $('#schedule-test-' + appId); // fallback test row

    if ($row.length === 0) {
      console.warn('[schedule] No schedule row found for app', appId);
      alert('Schedule row not found for application ' + appId);
      return;
    }

    const wasVisible = !$row.hasClass('d-none');
    $row.toggleClass('d-none'); // show/hide

    // Update button look/text
    $(this)
      .toggleClass('btn-outline-success', wasVisible)
      .toggleClass('btn-outline-danger', !wasVisible)
      .html(wasVisible
        ? '<i class="fas fa-calendar-alt me-1"></i>Schedule'
        : '<i class="fas fa-times me-1"></i>Hide')
      .attr('title', wasVisible ? 'View Payment Schedule' : 'Hide Payment Schedule');
  });
});
</script>
{% endblock %}

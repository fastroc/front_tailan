{% extends 'base.html' %}
{% load humanize %}

{% block title %}Loan Reports & Analytics{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Enhanced Header with Live Data Indicator -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-0 text-gray-800">
                        <i class="fas fa-chart-line text-primary me-2"></i>
                        Loan Reports & Analytics
                        <span class="badge bg-success ms-2" id="data-status">
                            <i class="fas fa-database" style="font-size: 0.7rem;"></i> Live Data
                        </span>
                    </h1>
                    <p class="text-muted mb-0">Real-time portfolio performance and business intelligence</p>
                </div>
                <div>
                    <button class="btn btn-outline-secondary me-2" onclick="refreshReports()">
                        <i class="fas fa-sync-alt me-2"></i>Refresh
                    </button>
                    <div class="btn-group">
                        <button class="btn btn-primary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            <i class="fas fa-download me-2"></i>Export
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" onclick="exportReport('pdf')"><i class="fas fa-file-pdf me-2"></i>PDF Report</a></li>
                            <li><a class="dropdown-item" href="#" onclick="exportReport('excel')"><i class="fas fa-file-excel me-2"></i>Excel Data</a></li>
                            <li><a class="dropdown-item" href="#" onclick="exportReport('csv')"><i class="fas fa-file-csv me-2"></i>CSV Export</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Dynamic Report Filters -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="row align-items-end">
                        <div class="col-md-2">
                            <label for="date-range" class="form-label small text-muted">Time Period</label>
                            <select class="form-select form-select-sm" id="date-range" onchange="updateReports()">
                                <option value="month">This Month</option>
                                <option value="quarter">This Quarter</option>
                                <option value="year" selected>This Year</option>
                                <option value="custom">Custom Range</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="product-filter" class="form-label small text-muted">Loan Product</label>
                            <select class="form-select form-select-sm" id="product-filter" onchange="updateReports()">
                                <option value="">All Products</option>
                                <option value="personal">Personal Loans</option>
                                <option value="business">Business Loans</option>
                                <option value="auto">Auto Loans</option>
                                <option value="home">Home Loans</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="status-filter" class="form-label small text-muted">Status</label>
                            <select class="form-select form-select-sm" id="status-filter" onchange="updateReports()">
                                <option value="">All Status</option>
                                <option value="active">Active</option>
                                <option value="completed">Completed</option>
                                <option value="overdue">Overdue</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="custom-date-range" class="form-label small text-muted">Custom Date Range</label>
                            <div class="input-group input-group-sm">
                                <input type="date" class="form-control" id="start-date">
                                <input type="date" class="form-control" id="end-date">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <button class="btn btn-sm btn-primary" onclick="applyFilters()">
                                <i class="fas fa-filter me-1"></i>Apply Filters
                            </button>
                            <button class="btn btn-sm btn-outline-secondary ms-2" onclick="resetFilters()">
                                <i class="fas fa-undo me-1"></i>Reset
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Enhanced Key Performance Indicators -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-primary shadow h-100 py-2 kpi-card">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">Portfolio Value</div>
                            <div class="h4 mb-0 font-weight-bold text-gray-800">${{ portfolio_stats.total_portfolio_value|floatformat:0|intcomma }}</div>
                            <div class="text-xs text-success mt-1">
                                <i class="fas fa-arrow-up"></i> +{{ portfolio_stats.monthly_growth }}% this month
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-chart-area fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-success shadow h-100 py-2 kpi-card">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">Collection Rate</div>
                            <div class="h4 mb-0 font-weight-bold text-gray-800">{{ portfolio_stats.collection_rate }}%</div>
                            <div class="text-xs text-success mt-1">
                                <i class="fas fa-check-circle"></i> Excellent performance
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-percentage fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-info shadow h-100 py-2 kpi-card">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">Portfolio Yield</div>
                            <div class="h4 mb-0 font-weight-bold text-gray-800">{{ portfolio_stats.portfolio_yield }}%</div>
                            <div class="text-xs text-info mt-1">
                                <i class="fas fa-chart-line"></i> Above industry avg
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-coins fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-warning shadow h-100 py-2 kpi-card">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">Risk Score</div>
                            <div class="h4 mb-0 font-weight-bold text-gray-800">{{ portfolio_stats.risk_score }}</div>
                            <div class="text-xs text-success mt-1">
                                <i class="fas fa-shield-alt"></i> Low risk (Good)
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-shield-alt fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts and Analytics Row -->
    <div class="row mb-4">
        <!-- Monthly Performance Chart -->
        <div class="col-lg-8 mb-4">
            <div class="card shadow">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">Monthly Performance Trends</h6>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-primary active" onclick="showChart('disbursements')">Disbursements</button>
                        <button class="btn btn-outline-primary" onclick="showChart('collections')">Collections</button>
                        <button class="btn btn-outline-primary" onclick="showChart('applications')">Applications</button>
                    </div>
                </div>
                <div class="card-body">
                    <canvas id="monthlyChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>

        <!-- Portfolio Distribution -->
        <div class="col-lg-4 mb-4">
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Portfolio Distribution</h6>
                </div>
                <div class="card-body">
                    <canvas id="portfolioChart" width="300" height="300"></canvas>
                    <div class="mt-3">
                        {% for product in product_performance %}
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="small">{{ product.name }}</span>
                            <span class="badge bg-{% if product.status == 'excellent' %}success{% elif product.status == 'good' %}primary{% else %}warning{% endif %}">
                                ${{ product.total_amount|floatformat:0|intcomma }}
                            </span>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Detailed Analytics Row -->
    <div class="row mb-4">
        <!-- Aging Analysis -->
        <div class="col-lg-6 mb-4">
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Aging Analysis</h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Age Range</th>
                                    <th>Amount</th>
                                    <th>Count</th>
                                    <th>%</th>
                                    <th>Health</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="table-success">
                                    <td>Current</td>
                                    <td>${{ aging_analysis.current.amount|floatformat:0|intcomma }}</td>
                                    <td>{{ aging_analysis.current.count }}</td>
                                    <td>{{ aging_analysis.current.percentage }}%</td>
                                    <td><span class="badge bg-success">Excellent</span></td>
                                </tr>
                                <tr class="table-warning">
                                    <td>1-30 Days</td>
                                    <td>${{ aging_analysis.days_1_30.amount|floatformat:0|intcomma }}</td>
                                    <td>{{ aging_analysis.days_1_30.count }}</td>
                                    <td>{{ aging_analysis.days_1_30.percentage }}%</td>
                                    <td><span class="badge bg-warning">Watch</span></td>
                                </tr>
                                <tr class="table-danger">
                                    <td>31-60 Days</td>
                                    <td>${{ aging_analysis.days_31_60.amount|floatformat:0|intcomma }}</td>
                                    <td>{{ aging_analysis.days_31_60.count }}</td>
                                    <td>{{ aging_analysis.days_31_60.percentage }}%</td>
                                    <td><span class="badge bg-danger">Action Required</span></td>
                                </tr>
                                <tr>
                                    <td>61-90 Days</td>
                                    <td>${{ aging_analysis.days_61_90.amount|floatformat:0|intcomma }}</td>
                                    <td>{{ aging_analysis.days_61_90.count }}</td>
                                    <td>{{ aging_analysis.days_61_90.percentage }}%</td>
                                    <td><span class="badge bg-dark">Critical</span></td>
                                </tr>
                                <tr>
                                    <td>Over 90 Days</td>
                                    <td>${{ aging_analysis.over_90.amount|floatformat:0|intcomma }}</td>
                                    <td>{{ aging_analysis.over_90.count }}</td>
                                    <td>{{ aging_analysis.over_90.percentage }}%</td>
                                    <td><span class="badge bg-dark">Write-off</span></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Top Performing Customers -->
        <div class="col-lg-6 mb-4">
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Top Performing Customers</h6>
                </div>
                <div class="card-body">
                    {% for customer in top_customers %}
                    <div class="d-flex justify-content-between align-items-center mb-3 p-2 rounded {% cycle 'bg-light' '' %}">
                        <div class="d-flex align-items-center">
                            <div class="me-3">
                                <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                                    <span class="text-white font-weight-bold">{{ forloop.counter }}</span>
                                </div>
                            </div>
                            <div>
                                <div class="font-weight-bold">{{ customer.name }}</div>
                                <small class="text-muted">${{ customer.total_borrowed|floatformat:0|intcomma }} • {{ customer.payments_made }} payments</small>
                            </div>
                        </div>
                        <div class="text-right">
                            <span class="badge bg-{% if customer.score == 'A+' %}success{% elif customer.score|slice:':1' == 'A' %}primary{% elif customer.score|slice:':1' == 'B' %}warning{% else %}secondary{% endif %} fs-6">
                                {{ customer.score }}
                            </span>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- Risk Metrics Dashboard -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Risk Management Dashboard</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-2 text-center mb-3">
                            <div class="h4 text-danger">{{ risk_metrics.high_risk_loans }}</div>
                            <small class="text-muted">High Risk</small>
                        </div>
                        <div class="col-md-2 text-center mb-3">
                            <div class="h4 text-warning">{{ risk_metrics.medium_risk_loans }}</div>
                            <small class="text-muted">Medium Risk</small>
                        </div>
                        <div class="col-md-2 text-center mb-3">
                            <div class="h4 text-success">{{ risk_metrics.low_risk_loans }}</div>
                            <small class="text-muted">Low Risk</small>
                        </div>
                        <div class="col-md-2 text-center mb-3">
                            <div class="h4 text-info">{{ risk_metrics.provision_coverage }}%</div>
                            <small class="text-muted">Provision Coverage</small>
                        </div>
                        <div class="col-md-2 text-center mb-3">
                            <div class="h4 text-primary">{{ risk_metrics.npl_ratio }}%</div>
                            <small class="text-muted">NPL Ratio</small>
                        </div>
                        <div class="col-md-2 text-center mb-3">
                            <div class="h4 text-secondary">{{ risk_metrics.loss_rate }}%</div>
                            <small class="text-muted">Loss Rate</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.kpi-card {
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}
.kpi-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important;
}

#data-status {
    animation: pulse 3s infinite;
}

@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.7; }
    100% { opacity: 1; }
}

.card {
    border: none;
    border-radius: 0.75rem;
}

.table-responsive {
    border-radius: 0.5rem;
}
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    initializeCharts();
    
    // Auto-refresh every 2 minutes
    setInterval(function() {
        refreshReports();
    }, 120000);
});

function initializeCharts() {
    // Monthly Performance Chart
    const monthlyCtx = document.getElementById('monthlyChart').getContext('2d');
    window.monthlyChart = new Chart(monthlyCtx, {
        type: 'line',
        data: {
            labels: [{% for item in monthly_data %}"{{ item.month }}"{% if not forloop.last %},{% endif %}{% endfor %}],
            datasets: [{
                label: 'Disbursements ($)',
                data: [{% for item in monthly_data %}{{ item.disbursements }}{% if not forloop.last %},{% endif %}{% endfor %}],
                borderColor: '#4e73df',
                backgroundColor: 'rgba(78, 115, 223, 0.1)',
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return '$' + (value / 1000) + 'K';
                        }
                    }
                }
            }
        }
    });

    // Portfolio Distribution Chart
    const portfolioCtx = document.getElementById('portfolioChart').getContext('2d');
    new Chart(portfolioCtx, {
        type: 'doughnut',
        data: {
            labels: [{% for product in product_performance %}'{{ product.name }}'{% if not forloop.last %},{% endif %}{% endfor %}],
            datasets: [{
                data: [{% for product in product_performance %}{{ product.total_amount }}{% if not forloop.last %},{% endif %}{% endfor %}],
                backgroundColor: ['#4e73df', '#1cc88a', '#36b9cc', '#f6c23e'],
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 20,
                        usePointStyle: true
                    }
                }
            }
        }
    });
}

function showChart(type) {
    // Update chart data based on selection
    const datasets = {
        disbursements: {
            label: 'Disbursements ($)',
            data: [{% for item in monthly_data %}{{ item.disbursements }}{% if not forloop.last %},{% endif %}{% endfor %}],
            borderColor: '#4e73df',
            backgroundColor: 'rgba(78, 115, 223, 0.1)'
        },
        collections: {
            label: 'Collections ($)',
            data: [{% for item in monthly_data %}{{ item.collections }}{% if not forloop.last %},{% endif %}{% endfor %}],
            borderColor: '#1cc88a',
            backgroundColor: 'rgba(28, 200, 138, 0.1)'
        },
        applications: {
            label: 'Applications (#)',
            data: [{% for item in monthly_data %}{{ item.applications }}{% if not forloop.last %},{% endif %}{% endfor %}],
            borderColor: '#36b9cc',
            backgroundColor: 'rgba(54, 185, 204, 0.1)'
        }
    };
    
    window.monthlyChart.data.datasets[0] = {
        ...datasets[type],
        fill: true,
        tension: 0.4
    };
    window.monthlyChart.update();
    
    // Update button states
    document.querySelectorAll('.btn-group button').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
}

function updateReports() {
    // Mock update functionality
    document.getElementById('data-status').textContent = '🔄 Updating...';
    setTimeout(() => {
        document.getElementById('data-status').innerHTML = '<i class="fas fa-database" style="font-size: 0.7rem;"></i> Live Data';
    }, 1500);
}

function refreshReports() {
    // Mock refresh functionality with visual feedback
    const indicators = document.querySelectorAll('.kpi-card .h4');
    indicators.forEach(indicator => {
        indicator.style.backgroundColor = '#e3f2fd';
        setTimeout(() => {
            indicator.style.backgroundColor = '';
        }, 1000);
    });
}

function applyFilters() {
    updateReports();
}

function resetFilters() {
    document.getElementById('date-range').value = 'year';
    document.getElementById('product-filter').value = '';
    document.getElementById('status-filter').value = '';
    updateReports();
}

function exportReport(format) {
    alert(`Exporting report in ${format.toUpperCase()} format... (Feature coming soon!)`);
}
</script>
{% endblock %}

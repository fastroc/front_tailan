{% extends 'base.html' %}
{% load static %}

{% block extra_head %}
<!-- Critical: Load global functions immediately -->
<script>
// Define WHO dropdown function globally and immediately  
window.showMainWhoDropdown = function(button, transactionId) {
    console.log('üéØ WHO dropdown clicked for transaction:', transactionId);
    
    // Remove existing dropdowns
    document.querySelectorAll('.temp-who-dropdown, .temp-dropdown').forEach(d => d.remove());
    
    // Create dropdown
    const dropdown = document.createElement('div');
    dropdown.className = 'temp-who-dropdown position-absolute bg-white border rounded shadow';
    dropdown.style.cssText = 'z-index: 9999; top: 100%; left: 0; min-width: 250px; max-height: 300px; overflow-y: auto; margin-top: 2px;';
    
    const customers = ['Richard Rodriguez', 'Joseph Johnson', 'David Anderson', 'David Johnson', 'Mary Jackson'];
    
    dropdown.innerHTML = `
        <div class="p-2 border-bottom bg-light fw-bold">Loan Customers</div>
        ${customers.map(name => `
            <div class="p-2" style="cursor: pointer;" 
                 onmouseover="this.style.background='#f8f9fa'" 
                 onmouseout="this.style.background='white'"
                 onclick="selectWhoCustomer_main('${name}', ${transactionId})">${name}</div>
        `).join('')}
    `;
    
    // Position dropdown
    const container = button.parentElement;
    container.style.position = 'relative';
    container.appendChild(dropdown);
    
    return false;
};

window.selectWhoCustomer_main = function(customerName, transactionId) {
    console.log('‚úÖ Selected customer:', customerName, 'for transaction:', transactionId);
    
    // Find and populate WHO input
    const whoInput = document.querySelector(`[data-transaction-id="${transactionId}"] .hybrid-input`);
    if (whoInput) {
        whoInput.value = customerName;
        console.log('‚úÖ Set WHO input to:', customerName);
    }
    
    // Remove dropdown
    document.querySelectorAll('.temp-who-dropdown, .temp-dropdown').forEach(d => d.remove());
};

console.log('‚úÖ WHO dropdown functions defined at page load');
</script>
{% endblock %}

{% block title %}{{ title|default:"Bank Reconciliation" }}{% endblock %}

{% block extra_css %}
<style>
  /* ‚Äî‚Äî Layout polish to resemble Xero ‚Äî‚Äî */
  .balance-banner { background:#f6f7f8; border:1px solid #e5e7eb; border-radius:.5rem; }
  .balance-metric .label { font-size:.8rem; color:#6b7280; }
  .balance-metric .value { font-weight:700; font-size:1rem; }
  .diff-badge { font-size:.75rem; }

  .x-tabs .nav-link { font-weight:600; }
  .x-tabs .nav-link.active { border-bottom:3px solid #2563eb; color:#111827; }

  .transaction-item { transition: background .15s ease, border-color .15s ease; }
  .transaction-item:hover { background:#f8fafc; }
  .border-credit { border-left:4px solid #16a34a !important; }
  .border-debit  { border-left:4px solid #ef4444 !important; }
  .amount-pos { color:#16a34a; font-weight:600; }
  .amount-neg { color:#ef4444; font-weight:600; }

  .pillar-label { font-size:.75rem; text-transform:uppercase; letter-spacing:.04em; font-weight:700; }
  .form-control-sm, .form-select-sm { font-size:.85rem; }

  .ok-btn { min-width:96px; }

  /* Compact mode */
  .compact .transaction-item { padding:.5rem .75rem !important; }
  .compact .txn-title { font-size:.9rem; }
  .compact .txn-meta { display:none; }
  .compact .matching-form { display:none; }

  .matching-form { background:#f8fafc; border-radius:.5rem; padding:1rem; margin-top:.5rem; }

  .sticky-side { position:sticky; top:1rem; }

  .badge-soft { background:#eaf2ff; color:#2563eb; border:1px solid #cfe0ff; }

  /* Smart Details Link Styling */
  .btn-link.text-muted {
    border: none;
    transition: all 0.2s ease;
  }
  .btn-link.text-muted:hover {
    color: #2563eb !important;
    background-color: rgba(37, 99, 235, 0.05);
    text-decoration: none;
    border-radius: 4px;
  }
  .btn-link.text-muted:focus {
    box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.2);
  }

  /* Hybrid Input Styling (Account & Tax) */
  .hybrid-input {
    border-top-right-radius: 0 !important;
    border-bottom-right-radius: 0 !important;
  }
  
  /* Ensure consistent field heights */
  .matching-form .form-control,
  .matching-form .hybrid-input {
    height: calc(1.5em + 0.5rem + 2px);
  }
  
  /* Hide datalist dropdown arrow to avoid duplication */
  .hybrid-input::-webkit-calendar-picker-indicator,
  .hybrid-input::-webkit-list-button {
    display: none !important;
  }
  
  .hybrid-input::-moz-list-bullet {
    display: none !important;
  }
  
  .input-group .hybrid-dropdown-btn {
    border-top-left-radius: 0 !important;
    border-bottom-left-radius: 0 !important;
    border-left: none;
    width: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
  }
  
  /* Ensure no Bootstrap dropdown arrows */
  .hybrid-dropdown-btn::after {
    display: none !important;
  }
  
  .hybrid-dropdown-btn .bi-chevron-down {
    font-size: 0.875rem;
    color: #6c757d;
    transition: color 0.2s ease;
  }
  
  .hybrid-dropdown-btn:hover .bi-chevron-down {
    color: #495057;
  }
  
  /* Fixed positioning for dropdowns */
  .hybrid-dropdown {
    position: absolute !important;
    top: 100% !important;
    left: 0 !important;
    right: 0 !important;
    z-index: 1050 !important;
    max-height: 300px;
    overflow-y: auto;
    border: 1px solid #dee2e6 !important;
    border-radius: 0.375rem;
    background: white;
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    animation: slideDown 0.15s ease-out;
    margin-top: 2px;
  }
  
  .hybrid-dropdown .dropdown-item {
    padding: 0.5rem 0.75rem;
    cursor: pointer;
    font-size: 0.875rem;
    border-bottom: 1px solid #f8f9fa;
  }
  
  .hybrid-dropdown .dropdown-item:hover {
    background-color: #f8f9fa;
  }
  
  .hybrid-dropdown .dropdown-item:active {
    background-color: #e9ecef;
  }
  
  .hybrid-dropdown .category-header {
    background-color: #f8f9fa;
    color: #6c757d;
    font-weight: 600;
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    padding: 0.375rem 0.75rem;
    border-bottom: 1px solid #dee2e6;
    position: sticky;
    top: 0;
  }
  
  @keyframes slideDown {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  /* Balance Validation Styling */
  #balanceValidationRow {
    background-color: #f8f9fa;
  }
  
  .balance-matched {
    background-color: #d1e7dd !important;
    color: #0a3622 !important;
    border: 1px solid #a3cfbb !important;
  }
  
  .balance-unmatched {
    background-color: #f8d7da !important;
    color: #58151c !important;
    border: 1px solid #f1aeb5 !important;
  }
  
  .balance-warning {
    background-color: #fff3cd !important;
    color: #664d03 !important;
    border: 1px solid #ffecb5 !important;
  }
  
  #balanceDifference.positive {
    color: #dc3545;
    font-weight: 600;
  }
  
  #balanceDifference.negative {
    color: #dc3545;
    font-weight: 600;
  }
  
  #balanceDifference.zero {
    color: #198754;
    font-weight: 600;
  }

  .pulse {
    animation: pulse 2s infinite;
  }
  
  @keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.7; }
    100% { opacity: 1; }
  }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4" id="reconRoot">
  {% csrf_token %}
  <!-- ======= Top banner: balances ======= -->
  <div class="balance-banner p-3 mb-3">
    <div class="d-flex align-items-center justify-content-between flex-wrap gap-3">
      <div class="d-flex align-items-center gap-3">
        <i class="bi bi-bank2" style="font-size: 28px; color: #2563eb;"></i>
        <div class="fw-bold">Match transactions from your bank with your books</div>
      </div>
      <div class="d-flex align-items-center gap-3">
        <div class="balance-metric text-end">
          <div class="label">Statement Balance</div>
          <div class="value" id="statementBalance">${{ statement_balance|floatformat:2 }}</div>
        </div>
        <div class="vr"></div>
        <div class="balance-metric text-end">
          <div class="label">Reconciled Balance in System</div>
          <div class="value" id="reconciledBalance">${{ reconciled_balance|floatformat:2 }}</div>
        </div>
        <span id="diffBadge" class="badge diff-badge ms-2"></span>
      </div>
    </div>
  </div>

  <!-- ======= Matched Transactions Section ======= -->
  {% if matched_transactions %}
  <div class="card mb-3">
    <div class="card-header bg-success text-white">
      <div class="d-flex align-items-center justify-content-between">
        <div class="d-flex align-items-center">
          <i class="bi bi-check-circle me-2"></i>
          <h6 class="mb-0">Matched Transactions ({{ matched_transactions|length }})</h6>
        </div>
        <button class="btn btn-sm btn-outline-light" onclick="toggleMatchedSection()">
          <i class="bi bi-chevron-down" id="matchedToggleIcon"></i>
        </button>
      </div>
    </div>
    <div class="card-body p-0" id="matchedTransactionsSection" style="display: none;">
      <div class="table-responsive">
        <table class="table table-sm mb-0">
          <thead class="table-light">
            <tr>
              <th width="8%">Date</th>
              <th width="25%">Description</th>
              <th width="12%">Amount</th>
              <th width="15%">Contact</th>
              <th width="20%">GL Account</th>
              <th width="12%">Tax</th>
              <th width="8%">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for match in matched_transactions %}
            <tr id="matchedRow_{{ match.id }}">
              <td class="text-muted small">{{ match.bank_transaction.date|date:"M d" }}</td>
              <td>
                <div class="fw-medium">{{ match.bank_transaction.description|truncatechars:40 }}</div>
                <small class="text-muted">{{ match.description|default:"No notes"|truncatechars:30 }}</small>
              </td>
              <td>
                <span class="{% if match.bank_transaction.amount >= 0 %}text-success{% else %}text-danger{% endif %} fw-medium">
                  {% if match.bank_transaction.amount >= 0 %}+{% endif %}${{ match.bank_transaction.amount|floatformat:2 }}
                </span>
              </td>
              <td class="text-muted small">{{ match.contact|default:"‚Äî" }}</td>
              <td>
                {% if match.gl_account %}
                <span class="fw-medium">{{ match.gl_account.code }}</span><br>
                <small class="text-muted">{{ match.gl_account.name|truncatechars:25 }}</small>
                {% elif match.is_split_transaction %}
                <span class="badge bg-info">Split ({{ match.splits.count }} parts)</span>
                {% else %}
                <span class="text-muted">‚Äî</span>
                {% endif %}
              </td>
              <td class="text-muted small">{{ match.tax_rate|default:"No Tax" }}</td>
              <td>
                <div class="btn-group btn-group-sm">
                  <button class="btn btn-outline-primary btn-sm" 
                          onclick="editTransactionMatch({{ match.id }})"
                          title="Edit Match">
                    <i class="bi bi-pencil"></i>
                  </button>
                  <button class="btn btn-outline-danger btn-sm" 
                          onclick="unmatchTransaction({{ match.id }})"
                          title="Remove Match">
                    <i class="bi bi-x-lg"></i>
                  </button>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- ======= Tabs (Reconcile only) ======= -->
  <ul class="nav nav-tabs x-tabs mb-3" role="tablist">
    <li class="nav-item" role="presentation">
      <span class="nav-link active" role="tab">Reconcile ({{ transactions|length|default:25 }})</span>
    </li>
    <li class="ms-auto nav-item d-flex align-items-center gap-2">
      <span class="text-muted small">Compact view</span>
      <div class="form-check form-switch m-0">
        <input class="form-check-input" type="checkbox" id="compactToggle">
      </div>
    </li>
  </ul>

  <div class="row g-3">
    <!-- ======= Bank transactions with embedded forms ======= -->
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-header bg-white border-0 pt-3 pb-2 d-flex justify-content-between align-items-center">
          <div class="fw-bold">Bank transactions ({{ transactions|length|default:25 }})</div>
          <div class="small text-muted">Review your bank statement lines</div>
        </div>
        <div class="card-body p-0">
          <!-- Debug: Show transaction count -->
          <div class="alert alert-info m-3">
            <strong>Debug Info:</strong> Found {{ transactions|length }} transactions to display.
            {% if not transactions %}
              <br>No transactions available.
            {% endif %}
          </div>
          <div class="transaction-list" style="max-height:70vh; overflow-y:auto;">
            {% for t in transactions %}
            <div class="transaction-item p-3 border-bottom {% if t.amount > 0 %}border-credit{% else %}border-debit{% endif %}" data-transaction-id="{{ t.id }}">
              <div class="row align-items-center">
                <!-- Transaction Number -->
                <div class="col-auto pe-2">
                  <div class="transaction-number bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 35px; height: 35px; font-weight: 600; font-size: 0.9rem;">
                    {{ forloop.counter }}
                  </div>
                </div>
                
                <!-- Left: Transaction Info -->
                <div class="col-md-4">
                  <div class="d-flex align-items-start justify-content-between">
                    <div class="flex-grow-1" style="min-width:0;">
                      <div class="small text-primary fw-semibold txn-date"><i class="bi bi-calendar me-1"></i>{{ t.date|date:"d M Y" }}</div>
                      <div class="txn-title fw-semibold">{{ t.description|default:"(no description)" }}</div>
                      <div class="txn-meta text-muted small">Ref: {{ t.reference|default:"‚Äî" }}</div>
                    </div>
                    <div class="text-end ms-3">
                      <div class="{% if t.amount > 0 %}amount-pos{% else %}amount-neg{% endif %}">{% if t.amount > 0 %}+{% endif %}${{ t.amount|floatformat:2 }}</div>
                      <div class="small text-muted">{% if t.amount > 0 %}Received{% else %}Spent{% endif %}</div>
                    </div>
                  </div>
                </div>
                
                <!-- Middle: OK Button -->
                <div class="col-md-2 text-center">
                  <button type="button" class="btn btn-primary btn-lg ok-btn{% if t.id != 1 %} d-none{% endif %}" id="ok{{ t.id }}" onclick="okMatch({{ t.id }})">
                    <i class="bi bi-check me-1"></i>OK
                  </button>
                </div>
                
                <!-- Right: WHO/WHAT/WHY Form -->
                <div class="col-md-5">
                  <div class="matching-form p-3 bg-light rounded">
                    <div class="row mb-2">
                      <div class="col-6">
                        <label class="pillar-label text-info mb-1"><i class="bi bi-person me-1"></i>Who</label>
                        <div class="input-group input-group-sm position-relative">
                          <input type="text" 
                                 class="form-control hybrid-input" 
                                 name="who_text_{{ t.id }}"
                                 placeholder="Type customer or contact name..."
                                 value=""
                                 list="mainWhoSuggestions_{{ t.id }}"
                                 oninput="handleMainWhoInput(this, {{ t.id }})"
                                 autocomplete="off">
                          <input type="hidden" name="who_{{ t.id }}" id="who_hidden_{{ t.id }}" value="">
                          <datalist id="mainWhoSuggestions_{{ t.id }}">
                            <!-- Loan customers and contacts will be populated by JavaScript -->
                          </datalist>
                          <button class="btn btn-outline-secondary hybrid-dropdown-btn" 
                                  type="button" 
                                  onclick="showMainWhoDropdown(this, {{ t.id }})"
                                  title="Browse all customers and contacts">
                            <i class="bi bi-chevron-down"></i>
                          </button>
                        </div>
                          
                        <!-- Loan payment indicator -->
                        <div class="loan-payment-indicator mt-1" 
                             id="loan-indicator-{{ t.id }}" 
                             style="display: none;">
                          <small class="text-success">
                            <i class="bi bi-bank me-1"></i>
                            <span class="indicator-text">Potential loan payment detected</span>
                          </small>
                        </div>
                      </div>
                      <div class="col-6">
                        <label class="pillar-label text-warning mb-1"><i class="bi bi-graph-up me-1"></i>What *</label>
                        <div class="input-group input-group-sm position-relative">
                          <input type="text" 
                                 class="form-control hybrid-input" 
                                 name="what_text_{{ t.id }}"
                                 placeholder="Type account code or name..."
                                 value="{% if t.id == 1 %}4100 ‚Äî Service Revenue{% endif %}"
                                 list="mainAccountSuggestions_{{ t.id }}"
                                 oninput="handleMainAccountInput(this, {{ t.id }})"
                                 onchange="checkOK({{ t.id }})"
                                 autocomplete="off"
                                 required>
                          <input type="hidden" name="what_{{ t.id }}" id="what_hidden_{{ t.id }}" value="{% if t.id == 1 %}{{ accounts.0.id }}{% endif %}">
                          <datalist id="mainAccountSuggestions_{{ t.id }}">
                            {% for group, accounts in coa_groups.items %}
                              {% for acc in accounts %}
                              <option value="{{ acc.code }} ‚Äî {{ acc.name }}" data-id="{{ acc.id }}">
                              {% endfor %}
                            {% endfor %}
                          </datalist>
                          <button class="btn btn-outline-secondary hybrid-dropdown-btn" 
                                  type="button" 
                                  onclick="showMainAccountDropdown(this, {{ t.id }})"
                                  title="Browse all accounts">
                            <i class="bi bi-chevron-down"></i>
                          </button>
                        </div>
                      </div>
                    </div>
                    <div class="row">
                      <div class="col-6">
                        <label class="pillar-label text-success mb-1"><i class="bi bi-chat-text me-1"></i>Why</label>
                        <input class="form-control form-control-sm" name="why_{{ t.id }}" placeholder="Enter a description‚Ä¶" value="{% if t.id == 1 %}Monthly web development services{% else %}{{ t.description|default:'' }}{% endif %}"/>
                      </div>
                      <div class="col-6">
                        <label class="pillar-label text-primary mb-1"><i class="bi bi-percent me-1"></i>Tax</label>
                        <div class="input-group input-group-sm position-relative">
                          <input type="text" 
                                 class="form-control hybrid-input" 
                                 name="tax_text_{{ t.id }}"
                                 placeholder="Type tax rate..."
                                 value="{% if t.id == 1 %}Tax Exempt (0%){% endif %}"
                                 list="mainTaxSuggestions_{{ t.id }}"
                                 oninput="handleMainTaxInput(this, {{ t.id }})"
                                 autocomplete="off">
                          <input type="hidden" name="tax_{{ t.id }}" id="tax_hidden_{{ t.id }}" value="">
                          <datalist id="mainTaxSuggestions_{{ t.id }}">
                            <option value="Tax Exempt (0%)" data-id="">
                            {% for tx in tax_rates %}
                            <option value="{{ tx.name }}" data-id="{{ tx.id }}">
                            {% endfor %}
                          </datalist>
                          <button class="btn btn-outline-secondary hybrid-dropdown-btn" 
                                  type="button" 
                                  onclick="showMainTaxDropdown(this, {{ t.id }})"
                                  title="Browse all tax rates">
                            <i class="bi bi-chevron-down"></i>
                          </button>
                        </div>
                      </div>
                    </div>
                    
                    <!-- Smart Details Link -->
                    <div class="row mt-2">
                      <div class="col-12 text-center">
                        <a href="javascript:void(0)" 
                           class="btn btn-link btn-sm text-muted px-2 py-1" 
                           id="addDetails_{{ t.id }}"
                           onclick="toggleSmartDetails({{ t.id }})"
                           style="font-size: 0.85rem; text-decoration: none;">
                          <i class="bi bi-plus-circle me-1"></i>Add Details
                        </a>
                      </div>
                    </div>
                    
                  </div>
                </div>
              </div>
            </div>
            {% empty %}
            <div class="text-center text-muted py-5"><i class="bi bi-inbox fa-2x mb-2"></i><div>No transactions</div></div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // Real COA Data from Django
  const realCoaGroups = {
    {% for group, accounts in coa_groups.items %}
    "{{ group }}": [
      {% for acc in accounts %}
      {
        id: "{{ acc.id }}",
        code: "{{ acc.code }}",
        name: "{{ acc.name }}",
        display: "{{ acc.code }} ‚Äî {{ acc.name }}"
      }{% if not forloop.last %},{% endif %}
      {% endfor %}
    ]{% if not forloop.last %},{% endif %}
    {% endfor %}
  };

  // Real Tax Rates from Django  
  const realTaxRates = [
    { id: "", name: "Tax Exempt (0%)", description: "No tax applicable" },
    {% for tx in tax_rates %}
    {
      id: "{{ tx.id }}",
      name: "{{ tx.name }}",
      description: "{{ tx.description|default:'Tax rate' }}"
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
  ];

  // Real Contacts from Django
  const contacts = [
    {% for contact in contacts %}
    "{{ contact|escapejs }}"{% if not forloop.last %},{% endif %}
    {% endfor %}
  ];
</script>

  // ‚Äî‚Äî‚Äî Balances diff badge ‚Äî‚Äî‚Äî
  function updateDiffBadge() {
    const s = parseFloat((document.getElementById('statementBalance')?.textContent||'0').replace(/[,\s$]/g,'')) || 0;
    const r = parseFloat((document.getElementById('reconciledBalance')?.textContent||'0').replace(/[,\s$]/g,'')) || 0;
    const diff = (s - r).toFixed(2);
    const badge = document.getElementById('diffBadge');
    if (!badge) return;
    if (diff == 0 || diff === '0.00') {
      badge.className = 'badge bg-success diff-badge';
      badge.textContent = 'Balanced';
    } else {
      badge.className = 'badge bg-warning text-dark diff-badge';
      badge.textContent = 'Remaining $' + Math.abs(diff).toLocaleString();
    }
  }

  // ‚Äî‚Äî‚Äî Compact toggle ‚Äî‚Äî‚Äî
  const root = document.getElementById('reconRoot');
  const compactToggle = document.getElementById('compactToggle');
  if (compactToggle) {
    compactToggle.addEventListener('change', (e) => {
      if (e.target.checked) root.classList.add('compact');
      else root.classList.remove('compact');
    });
  }

  // ‚Äî‚Äî‚Äî Matching logic ‚Äî‚Äî‚Äî
  let matched = [];

  function checkOK(id) {
    const sel = document.querySelector(`[name="what_${id}"]`);
    const btn = document.getElementById('ok'+id);
    if (!sel || !btn) return;
    if (sel.value) btn.classList.remove('d-none');
    else btn.classList.add('d-none');
  }

  async function okMatch(id) {
    const row = document.querySelector(`[data-transaction-id="${id}"]`);
    const contactField = row.querySelector(`[name="who_${id}"]`); // This is now the hidden input
    const accountField = row.querySelector(`[name="what_${id}"]`); // Hidden input for account
    const taxField = row.querySelector(`[name="tax_${id}"]`); // Hidden input for tax
    const notesField = row.querySelector(`[name="why_${id}"]`); // The description field
    
    // Get contact from hidden input or visible text input
    const contactTextInput = row.querySelector(`[name="who_text_${id}"]`);
    const contact = contactTextInput ? contactTextInput.value : (contactField?.value || '');
    const accountId = accountField?.value;
    const taxTreatment = taxField?.value || 'no_gst';
    const notes = notesField?.value || '';
    
    if (!accountId) { 
      alert('Please choose an account (What)'); 
      return; 
    }

    // Show loading state
    const okBtn = document.getElementById('ok'+id);
    okBtn.disabled = true;
    okBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Matching...';

    try {
      // Prepare data for AJAX call
      const data = {
        transaction_id: id,
        contact: contact,
        account_id: accountId,
        tax_treatment: taxTreatment,
        notes: notes
      };

      console.log('Sending transaction match data:', data);

      const response = await fetch('{% url "reconciliation:match_transaction" %}', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify(data)
      });

      const result = await response.json();
      console.log('Transaction match result:', result);

      if (result.success) {
        // Freeze fields
        row.querySelectorAll('select, input').forEach(el => el.disabled = true);

        // Show loan payment success message if created
        if (result.loan_payment && result.loan_payment.created) {
          const loanPayment = result.loan_payment;
          showAlert(`üí∞ Loan Payment Recorded!\n\nCustomer: ${loanPayment.customer}\nLoan: ${loanPayment.loan_number}\nAmount: $${loanPayment.amount.toFixed(2)}\nPayment ID: ${loanPayment.payment_id}`, 'success');
          
          // Show detailed allocation info in console
          console.log('üè¶ Loan Payment Details:', loanPayment);
          console.log('üìä Payment Allocation:', loanPayment.allocation_summary);
        }

        // Visual confirmation
        okBtn.innerHTML = '<i class="bi bi-check me-1"></i>Matched';
        okBtn.classList.add('btn-outline-success');
        okBtn.classList.remove('btn-primary');

        // Add to matched array
        matched.push(id);

        // Cool disappearing effect
        setTimeout(() => {
          row.style.transition = 'all 0.8s ease-out';
          row.style.transform = 'translateX(20px)';
          row.style.opacity = '0';
          row.style.maxHeight = row.offsetHeight + 'px';
          
          setTimeout(() => {
            row.style.maxHeight = '0';
            row.style.padding = '0';
            row.style.marginBottom = '0';
            row.style.borderBottom = 'none';
            
            setTimeout(() => {
              row.remove();
              
              // Update transaction count in tab
              const remainingCount = document.querySelectorAll('.transaction-item').length;
              const tabElement = document.querySelector('.nav-link.active');
              if (tabElement) {
                tabElement.textContent = `Reconcile (${remainingCount})`;
              }
              
              // Update progress statistics
              updateProgressStats();
              
            }, 400);
          }, 400);
        }, 1000);
        
      } else {
        // Handle error
        alert('Error: ' + (result.error || 'Failed to match transaction'));
        okBtn.disabled = false;
        okBtn.innerHTML = 'OK';
      }

    } catch (error) {
      console.error('Error matching transaction:', error);
      alert('Network error occurred. Please try again.');
      okBtn.disabled = false;
      okBtn.innerHTML = 'OK';
    }
  }

  // Update progress statistics
  async function updateProgressStats() {
    try {
      const accountId = '{{ account.id }}';
      const response = await fetch(`{% url "reconciliation:reconciliation_progress" account_id=0 %}`.replace('0', accountId));
      const result = await response.json();
      
      if (result.success) {
        const progress = result.progress;
        
        // Update progress display if elements exist
        const progressBar = document.querySelector('.progress-bar');
        const progressPercentage = document.querySelector('.progress-percentage');
        
        if (progressBar) {
          progressBar.style.width = `${progress.percentage}%`;
        }
        if (progressPercentage) {
          progressPercentage.textContent = `${progress.percentage}%`;
        }
        
        console.log('Progress updated:', progress);
      }
    } catch (error) {
      console.error('Error updating progress:', error);
    }
  }

  function autoMatch(){
    alert('Auto-match will learn from your past matches and suggest accounts. (Feature coming soon)');
  }

  function clearMatches(){
    if(!confirm('Clear all matches?')) return;
    
    // Since matched transactions are removed, we need to reload the page
    // or recreate the transactions to restore them
    alert('Page will reload to restore all transactions');
    window.location.reload();
  }

  // Smart Details Toggle Function - Split Transaction Modal
  function toggleSmartDetails(transactionId) {
    console.log('Opening split transaction modal for transaction:', transactionId);
    
    // Get transaction data from DOM elements
    const transactionElement = document.querySelector(`[data-transaction-id="${transactionId}"]`);
    
    let transactionData = {
      id: transactionId,
      description: '',
      amount: '0.00',
      payee: '',
      date: new Date().toISOString().split('T')[0], // Default to today
      reference: ''
    };
    
    // Extract actual transaction data from the DOM
    if (transactionElement) {
      const descElement = transactionElement.querySelector('.txn-title');
      const amountElement = transactionElement.querySelector('.amount-pos, .amount-neg');
      const dateElement = transactionElement.querySelector('.txn-date');
      const refElement = transactionElement.querySelector('.txn-meta');
      const whoInput = transactionElement.querySelector(`input[name="who_${transactionId}"]`);
      const whatInput = transactionElement.querySelector(`input[name="what_text_${transactionId}"]`);
      const whyInput = transactionElement.querySelector(`input[name="why_${transactionId}"]`);
      
      if (descElement) transactionData.description = descElement.textContent.trim() || 'Split Transaction';
      if (amountElement) {
        const amountText = amountElement.textContent.replace(/[+\-$,]/g, '').trim();
        transactionData.amount = amountText || '0.00';
      }
      if (dateElement) {
        // Extract date from "8 Sep 2024" format
        const dateText = dateElement.textContent.trim();
        const dateMatch = dateText.match(/(\d{1,2})\s+(\w{3})\s+(\d{4})/);
        if (dateMatch) {
          const months = {'Jan':1, 'Feb':2, 'Mar':3, 'Apr':4, 'May':5, 'Jun':6, 'Jul':7, 'Aug':8, 'Sep':9, 'Oct':10, 'Nov':11, 'Dec':12};
          const day = dateMatch[1].padStart(2, '0');
          const month = months[dateMatch[2]].toString().padStart(2, '0');
          const year = dateMatch[3];
          transactionData.date = `${year}-${month}-${day}`;
        }
      }
      if (refElement) {
        const refText = refElement.textContent.trim();
        transactionData.reference = refText.replace('Ref: ', '').replace('‚Äî', '').trim();
      }
      if (whoInput) transactionData.payee = whoInput.value || '';
      if (whatInput) transactionData.whatAccount = whatInput.value || '';
      if (whyInput) transactionData.description = whyInput.value || transactionData.description;
    }
    
    // Ensure all fields have valid values
    transactionData.description = transactionData.description || 'Split Transaction';
    transactionData.amount = transactionData.amount || '0.00';
    transactionData.payee = transactionData.payee || '';
    transactionData.reference = transactionData.reference || '';
    
    console.log('Transaction data prepared:', transactionData);
    
    // Show the split transaction modal
    showSplitTransactionModal(transactionData);
  }

  // Show Split Transaction Modal (Prototype Only - No Functionality)
  function showSplitTransactionModal(transactionData) {
    // Sanitize and format data for display
    const sanitizedData = {
      id: transactionData.id || 0,
      description: (transactionData.description || 'Split Transaction').replace(/"/g, '&quot;'),
      amount: parseFloat(transactionData.amount || 0).toFixed(2),
      payee: (transactionData.payee || '').replace(/"/g, '&quot;'),
      date: transactionData.date || new Date().toISOString().split('T')[0],
      reference: (transactionData.reference || '').replace(/"/g, '&quot;')
    };
    
    // Create modal backdrop
    const backdrop = document.createElement('div');
    backdrop.className = 'modal-backdrop fade show';
    backdrop.style.zIndex = '1040';
    
    // Create modal container
    const modal = document.createElement('div');
    modal.className = 'modal fade show';
    modal.style.display = 'block';
    modal.style.zIndex = '1050';
    modal.setAttribute('tabindex', '-1');
    
    // Modal content with split transaction interface
    modal.innerHTML = `
      <div class="modal-dialog modal-xl">
        <div class="modal-content">
          <!-- Modal Header -->
          <div class="modal-header bg-light">
            <div class="d-flex align-items-center">
              <i class="bi bi-diagram-3 me-2 text-primary" style="font-size: 1.2rem;"></i>
              <h5 class="modal-title mb-0">Split Transaction Details</h5>
            </div>
            <button type="button" class="btn-close" onclick="closeSplitModal()"></button>
          </div>

          <!-- Modal Body -->
          <div class="modal-body">
            <div class="container-fluid">
              <!-- Transaction Info Header -->
              <div class="alert alert-info mb-4">
                <div class="row">
                  <div class="col-md-8">
                    <strong>Transaction:</strong> ${sanitizedData.description}<br>
                    <small class="text-muted">Split this transaction into multiple GL codes with proper accounting allocation</small>
                  </div>
                  <div class="col-md-4 text-end">
                    <div class="fs-5 fw-bold text-primary" id="originalAmount">$${sanitizedData.amount}</div>
                  </div>
                </div>
                <!-- Hidden transaction ID for form submission -->
                <input type="hidden" id="transactionId" value="${sanitizedData.id}">
              </div>

              <!-- Header fields -->
              <div class="row mb-4">
                <div class="col-md-4">
                  <label class="form-label">Date:</label>
                  <input type="date" class="form-control" value="${sanitizedData.date}" readonly>
                </div>
                <div class="col-md-4">
                  <label class="form-label"><i class="bi bi-person me-1"></i>Who (Payee):</label>
                  <input type="text" class="form-control who-input" value="${sanitizedData.payee}" placeholder="e.g., XYZ Corp">
                </div>
                <div class="col-md-4">
                  <label class="form-label"><i class="bi bi-chat-text me-1"></i>Why (Description):</label>
                  <input type="text" class="form-control" id="splitDescription" value="${sanitizedData.description}" placeholder="Enter description for this split transaction">
                </div>
              </div>

              <!-- Split Lines Table -->
              <div class="table-responsive">
                <table class="table table-bordered align-middle" id="splitLinesTable">
                  <thead class="table-light">
                    <tr>
                      <th style="min-width:300px">Description</th>
                      <th style="min-width:250px">Account</th>
                      <th style="min-width:150px">Tax Rate</th>
                      <th style="min-width:150px" class="text-end">Amount</th>
                      <th style="width:50px"></th>
                    </tr>
                  </thead>
                  <tbody id="splitLineBody">
                    <!-- Default split lines will be added here -->
                  </tbody>
                  <tfoot>
                    <tr class="table-secondary">
                      <td colspan="3" class="text-end fw-semibold">Split Total:</td>
                      <td class="text-end fw-semibold" id="splitTotalAmount">$0.00</td>
                      <td></td>
                    </tr>
                    <tr id="balanceValidationRow" class="border-top-0">
                      <td colspan="3" class="text-end">
                        <div class="d-flex justify-content-end align-items-center gap-3">
                          <div>
                            <small class="text-muted">Original Amount:</small>
                            <span class="fw-semibold" id="originalAmount">$0.00</span>
                          </div>
                          <div>
                            <small class="text-muted">Difference:</small>
                            <span class="fw-semibold" id="balanceDifference">$0.00</span>
                          </div>
                        </div>
                      </td>
                      <td class="text-end">
                        <span class="badge" id="balanceStatus">
                          <i class="bi bi-circle"></i> Checking...
                        </span>
                      </td>
                      <td></td>
                    </tr>
                  </tfoot>
                </table>
              </div>

              <button class="btn btn-outline-primary btn-sm" onclick="addSplitLine()">
                <i class="bi bi-plus me-1"></i>Add Split Line
              </button>
            </div>
          </div>

          <!-- Modal Footer -->
          <div class="modal-footer">
            <div class="me-auto">
              <span class="badge bg-info">Prototype Only</span>
              <small class="text-muted ms-2">No data will be saved</small>
            </div>
            <button type="button" class="btn btn-success" onclick="saveSplitTransaction()">
              <i class="bi bi-check me-1"></i>Apply Split
            </button>
            <button type="button" class="btn btn-secondary" onclick="closeSplitModal()">Cancel</button>
          </div>
        </div>
      </div>
    `;

    // Add modal to DOM
    document.body.appendChild(backdrop);
    document.body.appendChild(modal);
    document.body.classList.add('modal-open');

    // Initialize split lines with transaction data
    initializeSplitLines(transactionData.amount, transactionData);
  }

  // Show loan-specific split transaction modal with pre-populated data
  function showLoanSplitTransactionModal(transactionData, loanBreakdown) {
    // Create modal backdrop
    const backdrop = document.createElement('div');
    backdrop.className = 'modal-backdrop fade show';
    backdrop.style.zIndex = '1040';
    
    // Create modal container
    const modal = document.createElement('div');
    modal.className = 'modal fade show';
    modal.style.display = 'block';
    modal.style.zIndex = '1050';
    modal.setAttribute('tabindex', '-1');
    
    const customer = loanBreakdown.customer;
    const loan = loanBreakdown.loans && loanBreakdown.loans.length > 0 ? loanBreakdown.loans[0] : null;
    
    // Modal content with loan-specific split transaction interface
    modal.innerHTML = `
      <div class="modal-dialog modal-xl">
        <div class="modal-content">
          <!-- Modal Header -->
          <div class="modal-header bg-primary text-white">
            <div class="d-flex align-items-center">
              <i class="bi bi-bank me-2" style="font-size: 1.2rem;"></i>
              <h5 class="modal-title mb-0">üè¶ Loan Payment Split Transaction</h5>
            </div>
            <button type="button" class="btn-close btn-close-white" onclick="closeSplitModal()"></button>
          </div>

          <!-- Modal Body -->
          <div class="modal-body">
            <div class="container-fluid">
              <!-- Loan Info Header -->
              <div class="alert alert-info mb-4">
                <div class="row">
                  <div class="col-md-8">
                    <strong>üè¶ Loan Payment for ${customer.name}</strong><br>
                    ${loan ? `<strong>Loan Number:</strong> ${loan.loan_number} | <strong>Current Balance:</strong> ${loan.balance}<br>` : ''}
                    <small class="text-muted">Automatically allocated according to loan payment rules (Late Fees ‚Üí Interest ‚Üí Principal)</small>
                  </div>
                  <div class="col-md-4 text-end">
                    <div class="fs-5 fw-bold text-primary" id="originalAmount">$${transactionData.amount.toFixed(2)}</div>
                    <small class="text-muted">Total Payment Amount</small>
                  </div>
                </div>
                <!-- Hidden transaction ID for form submission -->
                <input type="hidden" id="transactionId" value="${transactionData.id}">
              </div>

              <!-- Header fields -->
              <div class="row mb-4">
                <div class="col-md-4">
                  <label class="form-label">Date:</label>
                  <input type="date" class="form-control" value="${transactionData.date || new Date().toISOString().split('T')[0]}" readonly>
                </div>
                <div class="col-md-4">
                  <label class="form-label"><i class="bi bi-person me-1"></i>Customer:</label>
                  <input type="text" class="form-control who-input" value="${customer.name}" readonly>
                </div>
                <div class="col-md-4">
                  <label class="form-label"><i class="bi bi-chat-text me-1"></i>Description:</label>
                  <input type="text" class="form-control" id="splitDescription" value="Loan Payment${loan ? ` - ${loan.loan_number}` : ''}" placeholder="Enter description">
                </div>
              </div>

              <!-- Split Lines Table with Loan Data -->
              <div class="table-responsive">
                <table class="table table-bordered align-middle" id="splitLinesTable">
                  <thead class="table-light">
                    <tr>
                      <th style="min-width:300px">Description</th>
                      <th style="min-width:250px">Account</th>
                      <th style="min-width:150px">Tax Rate</th>
                      <th style="min-width:150px" class="text-end">Amount</th>
                      <th style="width:50px"></th>
                    </tr>
                  </thead>
                  <tbody id="loanSplitLineBody">
                    <!-- Loan payment allocation lines will be added here -->
                  </tbody>
                  <tfoot>
                    <tr class="table-success">
                      <td colspan="3" class="text-end fw-semibold">Split Total:</td>
                      <td class="text-end fw-semibold" id="splitTotalAmount">$${transactionData.amount.toFixed(2)}</td>
                      <td></td>
                    </tr>
                    <tr id="balanceValidationRow" class="border-top-0">
                      <td colspan="3" class="text-end">
                        <div class="d-flex justify-content-end align-items-center gap-3">
                          <div>
                            <small class="text-muted">Original Amount:</small>
                            <span class="fw-semibold" id="originalAmountFooter">$${transactionData.amount.toFixed(2)}</span>
                          </div>
                          <div>
                            <small class="text-muted">Difference:</small>
                            <span class="fw-semibold" id="balanceDifference">$0.00</span>
                          </div>
                        </div>
                      </td>
                      <td class="text-end">
                        <span class="badge bg-success" id="balanceStatus">
                          <i class="bi bi-check-circle"></i> Balanced
                        </span>
                      </td>
                      <td></td>
                    </tr>
                  </tfoot>
                </table>
              </div>

              <!-- Action Buttons -->
              <div class="row mt-4">
                <div class="col-md-6">
                  <div class="alert alert-success">
                    <i class="bi bi-info-circle me-1"></i>
                    <strong>Payment Allocation:</strong> This transaction has been automatically split according to loan payment rules.
                  </div>
                </div>
                <div class="col-md-6 text-end">
                  <button type="button" class="btn btn-secondary me-2" onclick="closeSplitModal()">
                    <i class="bi bi-x me-1"></i>Cancel
                  </button>
                  <button type="button" class="btn btn-success" onclick="saveLoanSplitTransaction()">
                    <i class="bi bi-check me-1"></i>Save Loan Payment Split
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    `;

    // Add modal to DOM
    document.body.appendChild(backdrop);
    document.body.appendChild(modal);
    document.body.classList.add('modal-open');

    console.log('üé≠ Modal added to DOM, waiting for initialization...');
    
    // Initialize split lines with loan payment breakdown (with delay to ensure DOM is ready)
    setTimeout(() => {
      console.log('‚è∞ Timeout triggered, initializing split lines...');
      initializeLoanSplitLines(loanBreakdown);
    }, 200);
  }

  // Initialize split lines with loan payment breakdown
  function initializeLoanSplitLines(loanBreakdown) {
    console.log('üéØ Initializing loan split lines with:', loanBreakdown);
    console.log('üìã Payment breakdown:', loanBreakdown.payment_breakdown);
    
    const tbody = document.getElementById('loanSplitLineBody');
    if (!tbody) {
      console.error('‚ùå Could not find loanSplitLineBody element');
      return;
    }
    console.log('‚úÖ Found table body:', tbody);
    tbody.innerHTML = '';

    loanBreakdown.payment_breakdown.forEach((allocation, index) => {
      console.log(`‚ûï Adding allocation ${index}:`, allocation);
      addLoanSplitLineRow(allocation, index, loanBreakdown.gl_accounts);
    });

    updateSplitTotal();
    
    // Debug: Show the actual table HTML after adding all rows
    setTimeout(() => {
      const tbody = document.getElementById('loanSplitLineBody');
      console.log('üîç FINAL TABLE BODY HTML:', tbody.innerHTML);
      console.log('üîç FINAL TABLE BODY CHILDREN:', tbody.children.length);
      console.log('üîç TABLE BODY COMPUTED STYLES:', window.getComputedStyle(tbody));
      
      // Force scroll to show the table rows
      setTimeout(() => {
        tbody.scrollIntoView({ behavior: 'smooth', block: 'center' });
        console.log('üìú Scrolled table into view');
      }, 100);
    }, 100);
  }

  // Add loan split line row with pre-populated data
  function addLoanSplitLineRow(allocation, index, glAccounts) {
    console.log('üî® Creating row for allocation:', allocation);
    
    const tbody = document.getElementById('loanSplitLineBody');
    if (!tbody) {
      console.error('‚ùå Could not find loanSplitLineBody for adding row');
      return;
    }
    
    const row = document.createElement('tr');
    
    const glAccount = glAccounts[allocation.account_code];
    const accountDisplay = glAccount ? `${glAccount.code} ‚Äî ${glAccount.name}` : `${allocation.account_code} ‚Äî ${allocation.account_name}`;
    console.log('üè¶ Account display:', accountDisplay);
    
    // Determine description based on allocation type
    let description = '';
    let badgeClass = '';
    let icon = '';
    
    switch(allocation.type) {
      case 'late_fees':
        description = 'Late Fee Collection';
        badgeClass = 'bg-warning';
        icon = '‚ö†Ô∏è';
        break;
      case 'interest':
        description = 'Interest Payment';
        badgeClass = 'bg-info';
        icon = 'üí∞';
        break;
      case 'principal':
        description = 'Principal Payment';
        badgeClass = 'bg-success';
        icon = 'üè¶';
        break;
      default:
        description = 'Loan Payment';
        badgeClass = 'bg-secondary';
        icon = 'üí≥';
    }
    
    row.innerHTML = `
      <td>
        <div class="d-flex align-items-center">
          <span class="me-2">${icon}</span>
          <input type="text" class="form-control form-control-sm" 
                 value="${description}" 
                 placeholder="Line description">
          <span class="badge ${badgeClass} ms-2">${allocation.type.replace('_', ' ').toUpperCase()}</span>
        </div>
      </td>
      <td>
        <div class="input-group input-group-sm position-relative">
          <input type="text" 
                 class="form-control hybrid-input" 
                 placeholder="Type account code or name..."
                 value="${accountDisplay}"
                 list="accountSuggestions_${index}"
                 oninput="handleSplitAccountInput(this, ${index})"
                 autocomplete="off">
          <input type="hidden" id="split_account_hidden_${index}" value="${glAccount ? glAccount.id : ''}">
          <datalist id="accountSuggestions_${index}">
            {% for group, accounts in coa_groups.items %}
              {% for acc in accounts %}
              <option value="{{ acc.code }} ‚Äî {{ acc.name }}" data-id="{{ acc.id }}">
              {% endfor %}
            {% endfor %}
          </datalist>
          <button class="btn btn-outline-secondary hybrid-dropdown-btn" 
                  type="button" 
                  onclick="showSplitAccountDropdown(this, ${index})"
                  title="Browse all accounts">
            <i class="bi bi-chevron-down"></i>
          </button>
        </div>
      </td>
      <td>
        <select class="form-select form-select-sm">
          <option value="no_gst" selected>Tax Exempt</option>
          <option value="gst_free">GST Free</option>
          <option value="input_taxed">Input Taxed</option>
        </select>
      </td>
      <td class="text-end">
        <input type="number" 
               class="form-control form-control-sm text-end split-amount" 
               value="${parseFloat(allocation.amount).toFixed(2)}" 
               step="0.01" 
               min="0"
               onchange="updateSplitTotal()"
               placeholder="0.00">
      </td>
      <td class="text-center">
        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeSplitLine(this)" title="Remove line">
          <i class="bi bi-trash"></i>
        </button>
      </td>
    `;
    
    console.log('‚úÖ Row HTML created, appending to tbody:', tbody);
    tbody.appendChild(row);
    console.log('üéâ Row successfully added to table. Total rows now:', tbody.children.length);
  }

  // Save loan split transaction (enhanced version)
  function saveLoanSplitTransaction() {
    // Check balance before saving
    const originalAmount = parseFloat(document.getElementById('originalAmount').textContent.replace(/[$,]/g, '')) || 0;
    const splitTotal = parseFloat(document.getElementById('splitTotalAmount').textContent.replace(/[$,]/g, '')) || 0;
    const difference = Math.abs(splitTotal - originalAmount);
    
    if (difference > 0.01) {
      showAlert('‚ö†Ô∏è Balance Validation Failed\n\nSplit total ($' + splitTotal.toFixed(2) + ') does not match original amount ($' + originalAmount.toFixed(2) + ').\n\nPlease adjust the split amounts to balance the transaction.', 'error');
      return;
    }
    
    // Show success and close modal
    showAlert('üè¶ Loan Payment Split Transaction Saved!\n\nThe payment has been properly allocated according to loan payment rules.', 'success');
    
    // Call the regular save split transaction function
    saveSplitTransaction();
  }

  // Initialize split lines with transaction-specific data or blank lines
  function initializeSplitLines(totalAmount, transactionData = {}) {
    const amount = parseFloat(totalAmount) || 0;
    
    // Set original amount for balance validation
    document.getElementById('originalAmount').textContent = '$' + amount.toFixed(2);
    
    // Create split lines based on actual transaction data or provide blank template
    const splitLines = [];
    
    // If we have existing account data from the main form, use it as first split line
    if (transactionData.whatAccount && transactionData.whatAccount.trim() !== '') {
      splitLines.push({
        description: transactionData.description || 'Split Item 1',
        account: transactionData.whatAccount,
        taxRate: 'Tax Exempt (0%)',
        amount: amount.toFixed(2)
      });
    } else {
      // Provide blank split lines for user to fill in
      splitLines.push({
        description: transactionData.description || '',
        account: '',
        taxRate: 'Tax Exempt (0%)',
        amount: amount.toFixed(2)
      });
      
      // Add a second blank line if amount is significant (suggest potential split)
      if (amount > 100) {
        splitLines.push({
          description: '',
          account: '',
          taxRate: 'Tax Exempt (0%)',
          amount: '0.00'
        });
      }
    }

    const tbody = document.getElementById('splitLineBody');
    tbody.innerHTML = '';

    splitLines.forEach((line, index) => {
      addSplitLineRow(line, index);
    });

    updateSplitTotal();
  }

  // Add split line row
  function addSplitLineRow(preset = {}, index = 0) {
    const tbody = document.getElementById('splitLineBody');
    const row = document.createElement('tr');
    
    row.innerHTML = `
      <td>
        <input type="text" class="form-control form-control-sm" 
               value="${preset.description || ''}" 
               placeholder="Line description">
      </td>
      <td>
        <div class="input-group input-group-sm position-relative">
          <input type="text" 
                 class="form-control hybrid-input" 
                 placeholder="Type account code or name..."
                 value="${preset.account || ''}"
                 list="accountSuggestions_${index}"
                 oninput="handleSplitAccountInput(this, ${index})"
                 autocomplete="off">
          <input type="hidden" id="split_account_hidden_${index}" value="${preset.account_id || ''}">
          <datalist id="accountSuggestions_${index}">
            {% for group, accounts in coa_groups.items %}
              {% for acc in accounts %}
              <option value="{{ acc.code }} ‚Äî {{ acc.name }}" data-id="{{ acc.id }}">
              {% endfor %}
            {% endfor %}
          </datalist>
          <button class="btn btn-outline-secondary hybrid-dropdown-btn" 
                  type="button" 
                  onclick="showSplitAccountDropdown(this, ${index})"
                  title="Browse all accounts">
            <i class="bi bi-chevron-down"></i>
          </button>
        </div>
      </td>
      <td>
        <div class="input-group input-group-sm position-relative">
          <input type="text" 
                 class="form-control hybrid-input" 
                 placeholder="Type tax rate..."
                 value="${preset.taxRate || ''}"
                 list="taxSuggestions_${index}"
                 oninput="handleSplitTaxInput(this, ${index})"
                 autocomplete="off">
          <input type="hidden" id="split_tax_hidden_${index}" value="${preset.tax_id || ''}">
          <datalist id="taxSuggestions_${index}">
            <option value="Tax Exempt (0%)" data-id="">
            {% for tx in tax_rates %}
            <option value="{{ tx.name }}" data-id="{{ tx.id }}">
            {% endfor %}
          </datalist>
          <button class="btn btn-outline-secondary hybrid-dropdown-btn" 
                  type="button" 
                  onclick="showSplitTaxDropdown(this, ${index})"
                  title="Browse all tax rates">
            <i class="bi bi-chevron-down"></i>
          </button>
        </div>
      </td>
      <td>
        <input type="number" class="form-control form-control-sm text-end split-amount" 
               value="${preset.amount || ''}" 
               step="0.01" 
               placeholder="0.00"
               oninput="updateSplitTotal()"
               onchange="updateSplitTotal()">
      </td>
      <td>
        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeSplitLine(this)">
          <i class="bi bi-trash"></i>
        </button>
      </td>
    `;

    tbody.appendChild(row);
  }

  // Add new split line
  function addSplitLine() {
    addSplitLineRow();
    updateSplitTotal();
  }

  // Remove split line
  function removeSplitLine(button) {
    button.closest('tr').remove();
    updateSplitTotal();
  }

  // Update split total with balance validation
  function updateSplitTotal() {
    const amounts = document.querySelectorAll('.split-amount');
    let splitTotal = 0;
    
    amounts.forEach(input => {
      splitTotal += parseFloat(input.value) || 0;
    });

    // Get original transaction amount
    const originalAmountElement = document.getElementById('originalAmount');
    const originalAmount = parseFloat(originalAmountElement.textContent.replace(/[$,]/g, '')) || 0;
    
    // Calculate difference
    const difference = splitTotal - originalAmount;
    const absDifference = Math.abs(difference);
    
    // Update display
    document.getElementById('splitTotalAmount').textContent = '$' + splitTotal.toFixed(2);
    document.getElementById('balanceDifference').textContent = (difference >= 0 ? '+' : '') + '$' + difference.toFixed(2);
    
    // Update balance status and styling
    const statusBadge = document.getElementById('balanceStatus');
    const differenceElement = document.getElementById('balanceDifference');
    const validationRow = document.getElementById('balanceValidationRow');
    
    if (absDifference === 0) {
      // Perfect balance
      statusBadge.className = 'badge balance-matched';
      statusBadge.innerHTML = '<i class="bi bi-check-circle"></i> Balanced';
      differenceElement.className = 'fw-semibold zero';
      validationRow.className = 'border-top-0';
    } else if (absDifference <= 0.01) {
      // Minor rounding difference (acceptable)
      statusBadge.className = 'badge balance-warning';
      statusBadge.innerHTML = '<i class="bi bi-exclamation-triangle"></i> Minor Diff';
      differenceElement.className = 'fw-semibold';
      validationRow.className = 'border-top-0';
    } else {
      // Significant imbalance
      statusBadge.className = 'badge balance-unmatched pulse';
      statusBadge.innerHTML = '<i class="bi bi-exclamation-circle"></i> Unbalanced';
      differenceElement.className = difference > 0 ? 'fw-semibold positive' : 'fw-semibold negative';
      validationRow.className = 'border-top-0';
    }
    
    // Update save button state
    updateSaveButtonState(absDifference);
  }
  
  // Update save button based on balance status
  function updateSaveButtonState(difference) {
    const saveButton = document.querySelector('button[onclick="saveSplitTransaction()"]');
    if (!saveButton) return;
    
    if (difference === 0) {
      saveButton.disabled = false;
      saveButton.className = 'btn btn-success';
      saveButton.innerHTML = '<i class="bi bi-check me-1"></i>Apply Split';
    } else if (difference <= 0.01) {
      saveButton.disabled = false;
      saveButton.className = 'btn btn-warning text-dark';
      saveButton.innerHTML = '<i class="bi bi-exclamation-triangle me-1"></i>Apply (Minor Diff)';
    } else {
      saveButton.disabled = true;
      saveButton.className = 'btn btn-danger';
      saveButton.innerHTML = '<i class="bi bi-exclamation-circle me-1"></i>Balance Required';
    }
  }

  // Handle account input with smart suggestions
  function handleAccountInput(input) {
    const value = input.value.toLowerCase();
    
    // Simple prototype suggestion logic
    if (value.includes('1400') || value.includes('equipment') || value.includes('asset')) {
      console.log('Suggesting: Equipment/Asset accounts');
    } else if (value.includes('2300') || value.includes('gst') || value.includes('tax')) {
      console.log('Suggesting: GST/Tax accounts');
    } else if (value.includes('6200') || value.includes('rent')) {
      console.log('Suggesting: Rent expense accounts');
    }
    
    // In production, this would trigger smart suggestions based on:
    // - Account code matching
    // - Account name fuzzy matching  
    // - Previous transaction patterns
    // - ML-based recommendations
  }

  // Show account dropdown menu
  function showAccountDropdown(button) {
    // Close any existing dropdowns
    closeAllDropdowns();
    
    const inputGroup = button.parentElement;
    const input = inputGroup.querySelector('.hybrid-input');

    const dropdown = document.createElement('div');
    dropdown.className = 'hybrid-dropdown account-dropdown';

    // Use real COA data from Django
    let dropdownHTML = '';
    Object.entries(realCoaGroups).forEach(([groupName, accounts]) => {
      if (accounts.length > 0) {
        dropdownHTML += `<div class="category-header">${groupName}</div>`;
        accounts.forEach(acc => {
          dropdownHTML += `
            <div class="dropdown-item" onclick="selectHybridValue('${acc.display}', this)">
              <div class="d-flex justify-content-between align-items-center">
                <span class="fw-semibold text-primary">${acc.code}</span>
                <span class="text-muted">${acc.name}</span>
              </div>
            </div>
          `;
        });
      }
    });

    dropdown.innerHTML = dropdownHTML;
    inputGroup.appendChild(dropdown);

    // Add click outside listener
    setTimeout(() => {
      document.addEventListener('click', function closeDropdown(e) {
        if (!dropdown.contains(e.target) && e.target !== button) {
          dropdown.remove();
          document.removeEventListener('click', closeDropdown);
        }
      });
    }, 100);
  }

  // Show tax dropdown menu
  function showTaxDropdown(button) {
    // Close any existing dropdowns
    closeAllDropdowns();
    
    const inputGroup = button.parentElement;
    const input = inputGroup.querySelector('.hybrid-input');

    const dropdown = document.createElement('div');
    dropdown.className = 'hybrid-dropdown tax-dropdown';

    // Group tax rates logically using real data
    const standardRates = realTaxRates.filter(tax => 
      tax.name.includes('Tax Exempt') || tax.name.includes('GST')
    );
    const otherRates = realTaxRates.filter(tax => 
      !tax.name.includes('Tax Exempt') && !tax.name.includes('GST')
    );

    let dropdownHTML = '';
    
    // Standard rates section
    if (standardRates.length > 0) {
      dropdownHTML += `<div class="category-header">Standard Rates</div>`;
      standardRates.forEach(tax => {
        dropdownHTML += `
          <div class="dropdown-item" onclick="selectHybridValue('${tax.name}', this)">
            <div class="d-flex flex-column">
              <div class="fw-semibold text-success">${tax.name}</div>
              <small class="text-muted">${tax.description}</small>
            </div>
          </div>
        `;
      });
    }
    
    // Other rates section
    if (otherRates.length > 0) {
      dropdownHTML += `<div class="category-header">Other Tax Rates</div>`;
      otherRates.forEach(tax => {
        dropdownHTML += `
          <div class="dropdown-item" onclick="selectHybridValue('${tax.name}', this)">
            <div class="d-flex flex-column">
              <div class="fw-semibold text-success">${tax.name}</div>
              <small class="text-muted">${tax.description}</small>
            </div>
          </div>
        `;
      });
    }

    dropdown.innerHTML = dropdownHTML;
    inputGroup.appendChild(dropdown);

    // Add click outside listener
    setTimeout(() => {
      document.addEventListener('click', function closeDropdown(e) {
        if (!dropdown.contains(e.target) && e.target !== button) {
          dropdown.remove();
          document.removeEventListener('click', closeDropdown);
        }
      });
    }, 100);
  }

  // Handle tax input with suggestions
  function handleTaxInput(input) {
    const value = input.value.toLowerCase();
    
    // Simple tax suggestion logic
    if (value.includes('gst') || value.includes('10')) {
      console.log('Suggesting: GST 10%');
    } else if (value.includes('exempt') || value.includes('0')) {
      console.log('Suggesting: Tax Exempt');
    } else if (value.includes('input') || value.includes('financial')) {
      console.log('Suggesting: Input Taxed');
    }
  }

  // Universal select function for hybrid dropdowns
  function selectHybridValue(value, element) {
    const dropdown = element.closest('.hybrid-dropdown');
    const inputGroup = dropdown.parentElement;
    const input = inputGroup.querySelector('.hybrid-input');
    
    input.value = value;
    dropdown.remove();
    
    // Trigger events
    input.dispatchEvent(new Event('input', { bubbles: true }));
    input.dispatchEvent(new Event('change', { bubbles: true }));
  }

  // Close all open dropdowns
  // Close all dropdowns - make globally available
  window.closeAllDropdowns = function() {
    document.querySelectorAll('.hybrid-dropdown').forEach(dropdown => {
      dropdown.remove();
    });
  }

  // ========== MAIN RECONCILIATION HYBRID INPUTS ==========
  
  // Handle main account input
  function handleMainAccountInput(input, transactionId) {
    const value = input.value;
    const hiddenInput = document.getElementById(`what_hidden_${transactionId}`);
    
    // Try to find matching account from datalist
    const datalist = document.getElementById(`mainAccountSuggestions_${transactionId}`);
    const options = datalist.querySelectorAll('option');
    
    let foundMatch = false;
    options.forEach(option => {
      if (option.value === value) {
        hiddenInput.value = option.getAttribute('data-id') || '';
        foundMatch = true;
      }
    });
    
    if (!foundMatch) {
      hiddenInput.value = '';
    }
    
    // Simple suggestion logic
    const lowerValue = value.toLowerCase();
    if (lowerValue.includes('4100') || lowerValue.includes('revenue') || lowerValue.includes('service')) {
      console.log('Suggesting: Revenue accounts');
    } else if (lowerValue.includes('6200') || lowerValue.includes('rent')) {
      console.log('Suggesting: Rent expense accounts');
    } else if (lowerValue.includes('6300') || lowerValue.includes('phone') || lowerValue.includes('telecom')) {
      console.log('Suggesting: Telecommunications accounts');
    }
  }

  // Handle main tax input  
  function handleMainTaxInput(input, transactionId) {
    const value = input.value;
    const hiddenInput = document.getElementById(`tax_hidden_${transactionId}`);
    
    // Try to find matching tax from datalist
    const datalist = document.getElementById(`mainTaxSuggestions_${transactionId}`);
    const options = datalist.querySelectorAll('option');
    
    let foundMatch = false;
    options.forEach(option => {
      if (option.value === value) {
        hiddenInput.value = option.getAttribute('data-id') || '';
        foundMatch = true;
      }
    });
    
    if (!foundMatch) {
      hiddenInput.value = '';
    }
    
    // Simple suggestion logic
    const lowerValue = value.toLowerCase();
    if (lowerValue.includes('gst') || lowerValue.includes('10')) {
      console.log('Suggesting: GST 10%');
    } else if (lowerValue.includes('exempt') || lowerValue.includes('0')) {
      console.log('Suggesting: Tax Exempt');
    }
  }

  // Show main account dropdown
  function showMainAccountDropdown(button, transactionId) {
    closeAllDropdowns();
    
    const inputGroup = button.parentElement;
    const input = inputGroup.querySelector('.hybrid-input');

    const dropdown = document.createElement('div');
    dropdown.className = 'hybrid-dropdown main-account-dropdown';

    // Use real COA data from Django
    let dropdownHTML = '';
    Object.entries(realCoaGroups).forEach(([groupName, accounts]) => {
      if (accounts.length > 0) {
        dropdownHTML += `<div class="category-header">${groupName}</div>`;
        accounts.forEach(acc => {
          dropdownHTML += `
            <div class="dropdown-item" onclick="selectMainAccount('${acc.display}', '${acc.id}', ${transactionId})">
              <div class="d-flex justify-content-between align-items-center">
                <span class="fw-semibold text-primary">${acc.code}</span>
                <span class="text-muted">${acc.name}</span>
              </div>
            </div>
          `;
        });
      }
    });

    dropdown.innerHTML = dropdownHTML;
    inputGroup.appendChild(dropdown);

    // Add click outside listener
    setTimeout(() => {
      document.addEventListener('click', function closeDropdown(e) {
        if (!dropdown.contains(e.target) && e.target !== button) {
          dropdown.remove();
          document.removeEventListener('click', closeDropdown);
        }
      });
    }, 100);
  }

  // Show main tax dropdown
  function showMainTaxDropdown(button, transactionId) {
    closeAllDropdowns();
    
    const inputGroup = button.parentElement;
    const input = inputGroup.querySelector('.hybrid-input');

    const dropdown = document.createElement('div');
    dropdown.className = 'hybrid-dropdown main-tax-dropdown';

    // Group tax rates logically
    const standardRates = realTaxRates.filter(tax => 
      tax.name.includes('Tax Exempt') || tax.name.includes('GST')
    );
    const otherRates = realTaxRates.filter(tax => 
      !tax.name.includes('Tax Exempt') && !tax.name.includes('GST')
    );

    let dropdownHTML = '';
    
    // Standard rates section
    if (standardRates.length > 0) {
      dropdownHTML += `<div class="category-header">Standard Rates</div>`;
      standardRates.forEach(tax => {
        dropdownHTML += `
          <div class="dropdown-item" onclick="selectMainTax('${tax.name}', '${tax.id}', ${transactionId})">
            <div class="d-flex flex-column">
              <div class="fw-semibold text-success">${tax.name}</div>
              <small class="text-muted">${tax.description}</small>
            </div>
          </div>
        `;
      });
    }
    
    // Other rates section
    if (otherRates.length > 0) {
      dropdownHTML += `<div class="category-header">Other Tax Rates</div>`;
      otherRates.forEach(tax => {
        dropdownHTML += `
          <div class="dropdown-item" onclick="selectMainTax('${tax.name}', '${tax.id}', ${transactionId})">
            <div class="d-flex flex-column">
              <div class="fw-semibold text-success">${tax.name}</div>
              <small class="text-muted">${tax.description}</small>
            </div>
          </div>
        `;
      });
    }

    dropdown.innerHTML = dropdownHTML;
    inputGroup.appendChild(dropdown);

    // Add click outside listener
    setTimeout(() => {
      document.addEventListener('click', function closeDropdown(e) {
        if (!dropdown.contains(e.target) && e.target !== button) {
          dropdown.remove();
          document.removeEventListener('click', closeDropdown);
        }
      });
    }, 100);
  }

  // Select main account
  function selectMainAccount(accountText, accountId, transactionId) {
    const input = document.querySelector(`input[name="what_text_${transactionId}"]`);
    const hiddenInput = document.getElementById(`what_hidden_${transactionId}`);
    
    input.value = accountText;
    hiddenInput.value = accountId;
    
    closeAllDropdowns();
    
    // Trigger validation
    input.dispatchEvent(new Event('input', { bubbles: true }));
    input.dispatchEvent(new Event('change', { bubbles: true }));
    checkOK(transactionId);
  }

  // Select main tax
  function selectMainTax(taxText, taxId, transactionId) {
    const input = document.querySelector(`input[name="tax_text_${transactionId}"]`);
    const hiddenInput = document.getElementById(`tax_hidden_${transactionId}`);
    
    input.value = taxText;
    hiddenInput.value = taxId;
    
    closeAllDropdowns();
    
    // Trigger events
    input.dispatchEvent(new Event('input', { bubbles: true }));
    input.dispatchEvent(new Event('change', { bubbles: true }));
  }

  // ========== MAIN WHO (CONTACT/CUSTOMER) HYBRID INPUTS ==========
  
  // Handle main who input
  function handleMainWhoInput(input, transactionId) {
    const value = input.value;
    const hiddenInput = document.getElementById(`who_hidden_${transactionId}`);
    
    // Try to find matching contact/customer from datalist
    const datalist = document.getElementById(`mainWhoSuggestions_${transactionId}`);
    const options = datalist.querySelectorAll('option');
    
    let foundMatch = false;
    options.forEach(option => {
      if (option.value === value) {
        hiddenInput.value = option.getAttribute('data-id') || '';
        foundMatch = true;
        
        // Check if this is a loan customer and show indicator
        const customerType = option.getAttribute('data-type');
        const loanInfo = option.getAttribute('data-loan-info');
        if (customerType === 'loan_customer') {
          showLoanPaymentIndicator(transactionId, value, loanInfo);
          // Auto-detect loan payment for this transaction
          if (transactionId && !isNaN(parseInt(transactionId))) {
            detectLoanPayment(parseInt(transactionId));
          }
          
          // NEW: Auto-trigger split transaction modal for loan payments when typing - REMOVED
          // Auto-split functionality removed per user request
          
        } else {
          hideLoanPaymentIndicator(transactionId);
        }
      }
    });
    
    if (!foundMatch) {
      hiddenInput.value = '';
      hideLoanPaymentIndicator(transactionId);
      
      // Auto-trigger functionality removed per user request
      // Fuzzy matching for potential loan customers disabled
    }
    
    // Simple suggestion logic for fuzzy matching
    const lowerValue = value.toLowerCase();
    if (lowerValue.includes('johnson') || lowerValue.includes('mary') || lowerValue.includes('rodriguez')) {
      console.log('Suggesting: Loan customers');
    } else if (lowerValue.includes('corp') || lowerValue.includes('company') || lowerValue.includes('ltd')) {
      console.log('Suggesting: Business contacts');
    }
  }

  // Select main who (contact/customer)
  // Select main WHO contact - make globally available

    let dropdownHTML = '';
    
    // Loan Customers Section
    if (allLoanCustomers && allLoanCustomers.length > 0) {
      dropdownHTML += `<div class="category-header">Loan Customers</div>`;
      allLoanCustomers.forEach(customer => {
        dropdownHTML += `
          <div class="dropdown-item" onclick="selectMainWho('${customer.display_name}', '${customer.id}', ${transactionId}, 'loan_customer', '${customer.loan_info || ''}')">
            <div class="d-flex justify-content-between align-items-center">
              <div class="d-flex flex-column">
                <span class="fw-semibold text-primary">${customer.display_name}</span>
                <small class="text-muted">ID: ${customer.customer_id}</small>
              </div>
              <div class="text-end">
                <span class="badge bg-info">Loan Customer</span>
                ${customer.loan_info ? `<small class="text-muted d-block">${customer.loan_info}</small>` : ''}
              </div>
            </div>
          </div>
        `;
      });
    } else {
      // Show sample loan customers for testing
      dropdownHTML += `<div class="category-header">Loan Customers (Sample)</div>`;
      const sampleCustomers = [
        'Richard Rodriguez',
        'Joseph Johnson', 
        'David Anderson',
        'David Johnson',
        'Mary Jackson'
      ];
      
      sampleCustomers.forEach(customerName => {
        dropdownHTML += `
          <div class="dropdown-item" onclick="selectMainWho('${customerName}', '', ${transactionId}, 'loan_customer', '')">
            <div class="d-flex justify-content-between align-items-center">
              <div class="d-flex flex-column">
                <span class="fw-semibold text-primary">${customerName}</span>
                <small class="text-muted">Sample loan customer</small>
              </div>
              <div class="text-end">
                <span class="badge bg-info">Loan Customer</span>
              </div>
            </div>
          </div>
        `;
      });
    }
    
    // General Contacts Section
    if (typeof contacts !== 'undefined' && contacts.length > 0) {
      dropdownHTML += `<div class="category-header">General Contacts</div>`;
      contacts.forEach(contact => {
        dropdownHTML += `
          <div class="dropdown-item" onclick="selectMainWho('${contact}', '', ${transactionId}, 'general_contact', '')">
            <div class="d-flex justify-content-between align-items-center">
              <span class="fw-semibold text-secondary">${contact}</span>
              <span class="badge bg-secondary">Contact</span>
            </div>
          </div>
        `;
      });
    }

    // If no data available, show message
    if (!dropdownHTML) {
      dropdownHTML = `<div class="dropdown-item text-muted">No customers or contacts available</div>`;
    }

    dropdown.innerHTML = dropdownHTML;
    inputGroup.appendChild(dropdown);

    // Add click outside listener
    setTimeout(() => {
      document.addEventListener('click', function closeDropdown(e) {
        if (!dropdown.contains(e.target) && e.target !== button) {
          dropdown.remove();
          document.removeEventListener('click', closeDropdown);
        }
      });
    }, 100);
  }

  // Select main who (contact/customer)
  // Select main WHO contact - make globally available
  window.selectMainWho = function(contactText, contactId, transactionId, contactType, loanInfo) {
    const input = document.querySelector(`input[name="who_text_${transactionId}"]`);
    const hiddenInput = document.getElementById(`who_hidden_${transactionId}`);
    
    input.value = contactText;
    hiddenInput.value = contactId;
    
    closeAllDropdowns();
    
    // Show loan payment indicator if this is a loan customer
    if (contactType === 'loan_customer') {
      showLoanPaymentIndicator(transactionId, contactText, loanInfo);
      // Auto-detect loan payment for this transaction
      if (transactionId && !isNaN(parseInt(transactionId))) {
        detectLoanPayment(parseInt(transactionId));
      }
      
      // NEW: Auto-trigger split transaction modal for loan payments - REMOVED
      // Auto-split functionality removed per user request
      
    } else {
      hideLoanPaymentIndicator(transactionId);
    }
    
    // Trigger validation
    input.dispatchEvent(new Event('input', { bubbles: true }));
    input.dispatchEvent(new Event('change', { bubbles: true }));
    checkOK(transactionId);
  }

  // Save split transaction - Full Backend Integration
  function saveSplitTransaction() {
    // Check balance before saving
    const originalAmount = parseFloat(document.getElementById('originalAmount').textContent.replace(/[$,]/g, '')) || 0;
    const splitTotal = parseFloat(document.getElementById('splitTotalAmount').textContent.replace(/[$,]/g, '')) || 0;
    const difference = Math.abs(splitTotal - originalAmount);
    
    if (difference > 0.01) {
      showAlert('‚ö†Ô∏è Balance Validation Failed\n\nSplit total ($' + splitTotal.toFixed(2) + ') does not match original amount ($' + originalAmount.toFixed(2) + ').\n\nPlease adjust the split amounts to balance the transaction.', 'error');
      return;
    }
    
    // Get transaction data from modal
    const transactionId = document.getElementById('transactionId').value;
    const contactInput = document.querySelector('.who-input');
    const contact = contactInput ? contactInput.value : '';
    const descriptionInput = document.getElementById('splitDescription');
    const description = descriptionInput ? descriptionInput.value : '';
    
    // Collect and validate split data
    const splits = [];
    let hasErrors = false;
    
    document.querySelectorAll('#splitLineBody tr').forEach((row, index) => {
      const descInput = row.querySelector('input[type="text"]');
      const accountInput = row.querySelector('.hybrid-input');
      const taxInput = row.querySelectorAll('.hybrid-input')[1];
      const amountInput = row.querySelector('.split-amount');
      
      const rowDescription = descInput ? descInput.value.trim() : '';
      const accountText = accountInput ? accountInput.value.trim() : '';
      const taxText = taxInput ? taxInput.value.trim() : '';
      const amount = parseFloat(amountInput ? amountInput.value : 0) || 0;
      
      // Get account ID from hidden input
      const accountHidden = row.querySelector('input[type="hidden"][id*="split_account_hidden"]');
      const glAccountId = accountHidden ? accountHidden.value : null;
      
      // Get tax rate from hidden input  
      const taxHidden = row.querySelector('input[type="hidden"][id*="split_tax_hidden"]');
      const taxRate = taxHidden ? taxHidden.value : '';
      
      if (amount > 0) {
        if (!glAccountId) {
          showAlert(`Split ${index + 1}: Please select a valid GL account`, 'error');
          hasErrors = true;
          return;
        }
        
        splits.push({
          description: rowDescription,
          gl_account_id: parseInt(glAccountId),
          tax_rate: taxRate || '0%',
          amount: amount
        });
      }
    });
    
    if (hasErrors) return;
    
    if (splits.length < 2) {
      showAlert('At least 2 split lines with amounts are required', 'error');
      return;
    }
    
    // Show loading state
    const saveBtn = document.querySelector('.btn-success[onclick="saveSplitTransaction()"]');
    const originalText = saveBtn.textContent;
    saveBtn.textContent = 'Saving...';
    saveBtn.disabled = true;
    
    // Prepare data for API
    const requestData = {
      transaction_id: parseInt(transactionId),
      contact: contact,
      description: description,
      splits: splits
    };
    
    // Send to backend
    fetch('{% url "reconciliation:create_split_transaction" %}', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken')
      },
      body: JSON.stringify(requestData)
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        showAlert(`‚úÖ Success!\n\nSplit transaction created with ${data.total_splits} splits.\nJournal entry #${data.journal_id} has been generated.`, 'success');
        
        // Update the transaction row in the table to show it's matched
        updateTransactionRowAsMatched(transactionId, true);
        
        // Close modal
        closeSplitModal();
        
        // Refresh the page or update progress
        setTimeout(() => {
          window.location.reload();
        }, 2000);
        
      } else {
        showAlert('‚ùå Error creating split transaction:\n\n' + data.error, 'error');
      }
    })
    .catch(error => {
      console.error('Split transaction error:', error);
      showAlert('‚ùå Network error creating split transaction. Please try again.', 'error');
    })
    .finally(() => {
      // Reset button
      saveBtn.textContent = originalText;
      saveBtn.disabled = false;
    });
  }
  
  // Helper function to show alerts
  function showAlert(message, type = 'info') {
    // Use Bootstrap alert or simple alert
    if (typeof bootstrap !== 'undefined') {
      // Create Bootstrap alert
      const alertDiv = document.createElement('div');
      alertDiv.className = `alert alert-${type === 'error' ? 'danger' : type === 'success' ? 'success' : 'info'} alert-dismissible fade show position-fixed`;
      alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; max-width: 400px;';
      alertDiv.innerHTML = `
        ${message.replace(/\n/g, '<br>')}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      `;
      document.body.appendChild(alertDiv);
      
      // Auto-dismiss after 5 seconds
      setTimeout(() => {
        alertDiv.remove();
      }, 5000);
    } else {
      // Fallback to simple alert
      alert(message);
    }
  }
  
  // Helper function to update transaction row
  function updateTransactionRowAsMatched(transactionId, isSplit = false) {
    const row = document.querySelector(`tr[data-transaction-id="${transactionId}"]`);
    if (row) {
      const actionCell = row.querySelector('.text-end');
      if (actionCell) {
        actionCell.innerHTML = `
          <span class="badge bg-success">
            <i class="bi bi-check-circle me-1"></i>
            ${isSplit ? 'Split Match' : 'Matched'}
          </span>
        `;
      }
    }
  }
  
  // Helper function to get CSRF token
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  // Close split modal
  function closeSplitModal() {
    const modals = document.querySelectorAll('.modal, .modal-backdrop');
    modals.forEach(modal => modal.remove());
    document.body.classList.remove('modal-open');
  }

  // Split transaction input handlers
  function handleSplitAccountInput(input, splitIndex) {
    const value = input.value;
    const hiddenInput = document.getElementById(`split_account_hidden_${splitIndex}`);
    
    // Check if the input matches an option in the datalist
    const datalist = document.getElementById(`accountSuggestions_${splitIndex}`);
    const options = datalist.querySelectorAll('option');
    
    let matchedId = '';
    for (const option of options) {
      if (option.value === value) {
        matchedId = option.getAttribute('data-id') || '';
        break;
      }
    }
    
    if (hiddenInput) {
      hiddenInput.value = matchedId;
    }
    
    // Update split totals when account changes
    updateSplitTotal();
  }
  
  function handleSplitTaxInput(input, splitIndex) {
    const value = input.value;
    const hiddenInput = document.getElementById(`split_tax_hidden_${splitIndex}`);
    
    // Check if the input matches an option in the datalist  
    const datalist = document.getElementById(`taxSuggestions_${splitIndex}`);
    const options = datalist.querySelectorAll('option');
    
    let matchedId = '';
    for (const option of options) {
      if (option.value === value) {
        matchedId = option.getAttribute('data-id') || '';
        break;
      }
    }
    
    if (hiddenInput) {
      hiddenInput.value = matchedId;
    }
  }
  
  function showSplitAccountDropdown(button, splitIndex) {
    // Close any existing dropdowns
    closeAllDropdowns();
    
    const inputGroup = button.parentElement;
    const input = inputGroup.querySelector('.hybrid-input');
    const hiddenInput = document.getElementById(`split_account_hidden_${splitIndex}`);

    const dropdown = document.createElement('div');
    dropdown.className = 'hybrid-dropdown account-dropdown';

    // Use real COA data from Django
    let dropdownHTML = '<div class="dropdown-header">Chart of Accounts</div>';
    
    {% for group, accounts in coa_groups.items %}
    dropdownHTML += '<div class="dropdown-header">{{ group }}</div>';
    {% for acc in accounts %}
    dropdownHTML += `<div class="dropdown-item" onclick="selectSplitAccount('{{ acc.code }} ‚Äî {{ acc.name }}', '{{ acc.id }}', ${splitIndex})">
      <div class="d-flex justify-content-between">
        <span>{{ acc.code }} ‚Äî {{ acc.name }}</span>
        <small class="text-muted">{{ acc.account_type }}</small>
      </div>
    </div>`;
    {% endfor %}
    {% endfor %}

    dropdown.innerHTML = dropdownHTML;
    
    // Position dropdown
    inputGroup.appendChild(dropdown);
    
    // Add click outside listener
    setTimeout(() => {
      document.addEventListener('click', function closeDropdown(e) {
        if (!inputGroup.contains(e.target)) {
          dropdown.remove();
          document.removeEventListener('click', closeDropdown);
        }
      });
    }, 10);
  }
  
  function showSplitTaxDropdown(button, splitIndex) {
    // Close any existing dropdowns
    closeAllDropdowns();
    
    const inputGroup = button.parentElement;
    const input = inputGroup.querySelector('.hybrid-input');
    const hiddenInput = document.getElementById(`split_tax_hidden_${splitIndex}`);

    const dropdown = document.createElement('div');
    dropdown.className = 'hybrid-dropdown tax-dropdown';

    let dropdownHTML = '<div class="dropdown-header">Tax Rates</div>';
    
    // Tax Exempt option
    dropdownHTML += `<div class="dropdown-item" onclick="selectSplitTax('Tax Exempt (0%)', '', ${splitIndex})">
      <div class="d-flex justify-content-between">
        <span>Tax Exempt (0%)</span>
        <small class="text-muted">No Tax</small>
      </div>
    </div>`;
    
    // Real tax rates from Django
    {% for tx in tax_rates %}
    dropdownHTML += `<div class="dropdown-item" onclick="selectSplitTax('{{ tx.name }}', '{{ tx.id }}', ${splitIndex})">
      <div class="d-flex justify-content-between">
        <span>{{ tx.name }}</span>
        <small class="text-muted">{{ tx.rate }}%</small>
      </div>
    </div>`;
    {% endfor %}

    dropdown.innerHTML = dropdownHTML;
    
    // Position dropdown
    inputGroup.appendChild(dropdown);
    
    // Add click outside listener
    setTimeout(() => {
      document.addEventListener('click', function closeDropdown(e) {
        if (!inputGroup.contains(e.target)) {
          dropdown.remove();
          document.removeEventListener('click', closeDropdown);
        }
      });
    }, 10);
  }
  
  function selectSplitAccount(accountText, accountId, splitIndex) {
    const input = document.querySelector(`#splitLineBody tr:nth-child(${splitIndex + 1}) .hybrid-input`);
    const hiddenInput = document.getElementById(`split_account_hidden_${splitIndex}`);
    
    if (input) {
      input.value = accountText;
    }
    if (hiddenInput) {
      hiddenInput.value = accountId;
    }
    
    // Close dropdown
    closeAllDropdowns();
    
    // Trigger events
    if (input) {
      input.dispatchEvent(new Event('input', { bubbles: true }));
      input.dispatchEvent(new Event('change', { bubbles: true }));
    }
  }
  
  function selectSplitTax(taxText, taxId, splitIndex) {
    const taxInputs = document.querySelectorAll(`#splitLineBody tr:nth-child(${splitIndex + 1}) .hybrid-input`);
    const taxInput = taxInputs[1]; // Second hybrid input is tax
    const hiddenInput = document.getElementById(`split_tax_hidden_${splitIndex}`);
    
    if (taxInput) {
      taxInput.value = taxText;
    }
    if (hiddenInput) {
      hiddenInput.value = taxId;
    }
    
    // Close dropdown
    closeAllDropdowns();
    
    // Trigger events
    if (taxInput) {
      taxInput.dispatchEvent(new Event('input', { bubbles: true }));
      taxInput.dispatchEvent(new Event('change', { bubbles: true }));
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    updateDiffBadge();
    
    // Load loan customers for dropdowns
    loadAllLoanCustomers();
  });

  // ============= EDIT FUNCTIONALITY =============
  
  function toggleMatchedSection() {
    const section = document.getElementById('matchedTransactionsSection');
    const icon = document.getElementById('matchedToggleIcon');
    
    if (section.style.display === 'none') {
      section.style.display = 'block';
      icon.className = 'bi bi-chevron-up';
    } else {
      section.style.display = 'none';
      icon.className = 'bi bi-chevron-down';
    }
  }

  async function editTransactionMatch(matchId) {
    try {
      // Fetch current match details
      const response = await fetch(`/reconciliation/ajax/get-match/${matchId}/`);
      const result = await response.json();
      
      if (!result.success) {
        alert('Error loading transaction details: ' + result.error);
        return;
      }
      
      const match = result.match;
      showEditModal(match);
      
    } catch (error) {
      console.error('Error fetching match details:', error);
      alert('Error loading transaction details. Please try again.');
    }
  }

  function showEditModal(match) {
    // Create modal backdrop
    const backdrop = document.createElement('div');
    backdrop.className = 'modal-backdrop fade show';
    backdrop.style.zIndex = '1040';
    
    // Create modal container
    const modal = document.createElement('div');
    modal.className = 'modal fade show';
    modal.style.display = 'block';
    modal.style.zIndex = '1050';
    modal.setAttribute('tabindex', '-1');
    modal.id = 'editMatchModal';
    
    // Modal content
    modal.innerHTML = `
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">
              <i class="bi bi-pencil me-2"></i>Edit Transaction Match
            </h5>
            <button type="button" class="btn-close" onclick="closeEditModal()"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <strong>Transaction:</strong> ${match.description}<br>
              <small class="text-muted">Amount: $${match.amount} | Date: ${match.date}</small>
            </div>
            
            <form id="editMatchForm">
              <input type="hidden" id="editMatchId" value="${match.match_id}">
              
              <div class="row mb-3">
                <div class="col-6">
                  <label class="form-label">Contact (WHO)</label>
                  <input type="text" class="form-control" id="editContact" 
                         value="${match.contact || ''}" placeholder="Enter contact name...">
                </div>
                <div class="col-6">
                  <label class="form-label">GL Account (WHAT) *</label>
                  <select class="form-select" id="editGLAccount" required>
                    <option value="">Select an account...</option>
                    {% for group, accounts in coa_groups.items %}
                      <optgroup label="{{ group }}">
                        {% for acc in accounts %}
                        <option value="{{ acc.id }}">{{ acc.code }} ‚Äî {{ acc.name }}</option>
                        {% endfor %}
                      </optgroup>
                    {% endfor %}
                  </select>
                </div>
              </div>
              
              <div class="row mb-3">
                <div class="col-6">
                  <label class="form-label">Description (WHY)</label>
                  <textarea class="form-control" id="editDescription" rows="2" 
                            placeholder="Enter description...">${match.match_description || ''}</textarea>
                </div>
                <div class="col-6">
                  <label class="form-label">Tax Treatment</label>
                  <select class="form-select" id="editTaxRate">
                    <option value="">No Tax</option>
                    <option value="gst_10">GST 10%</option>
                    <option value="gst_free">GST Free</option>
                    <option value="input_taxed">Input Taxed</option>
                    <option value="no_gst">Tax Exempt</option>
                  </select>
                </div>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeEditModal()">Cancel</button>
            <button type="button" class="btn btn-primary" onclick="saveEditMatch()">
              <i class="bi bi-check me-1"></i>Save Changes
            </button>
          </div>
        </div>
      </div>
    `;
    
    // Add to DOM
    document.body.appendChild(backdrop);
    document.body.appendChild(modal);
    
    // Set current values
    if (match.gl_account_id) {
      document.getElementById('editGLAccount').value = match.gl_account_id;
    }
    if (match.tax_rate) {
      document.getElementById('editTaxRate').value = match.tax_rate;
    }
    
    // Store backdrop and modal references
    modal.backdrop = backdrop;
  }

  function closeEditModal() {
    const modal = document.getElementById('editMatchModal');
    if (modal) {
      if (modal.backdrop) {
        modal.backdrop.remove();
      }
      modal.remove();
    }
  }

  async function saveEditMatch() {
    const matchId = document.getElementById('editMatchId').value;
    const contact = document.getElementById('editContact').value;
    const accountId = document.getElementById('editGLAccount').value;
    const description = document.getElementById('editDescription').value;
    const taxRate = document.getElementById('editTaxRate').value;
    
    if (!accountId) {
      alert('Please select a GL Account');
      return;
    }
    
    try {
      const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
      
      const response = await fetch(`/reconciliation/ajax/edit-match/${matchId}/`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
          contact: contact,
          account_id: accountId,
          tax_treatment: taxRate,
          notes: description
        })
      });
      
      const result = await response.json();
      
      if (result.success) {
        // Update the UI
        const row = document.getElementById(`matchedRow_${matchId}`);
        if (row) {
          // Refresh the page to show updated data
          window.location.reload();
        }
        
        closeEditModal();
        
        // Show success message
        const alert = document.createElement('div');
        alert.className = 'alert alert-success alert-dismissible fade show position-fixed';
        alert.style.top = '20px';
        alert.style.right = '20px';
        alert.style.zIndex = '1055';
        alert.innerHTML = `
          <i class="bi bi-check-circle me-2"></i>Transaction match updated successfully!
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.body.appendChild(alert);
        
        // Auto-remove after 3 seconds
        setTimeout(() => {
          alert.remove();
        }, 3000);
        
      } else {
        alert('Error updating match: ' + result.error);
      }
      
    } catch (error) {
      console.error('Error saving match:', error);
      alert('Error saving changes. Please try again.');
    }
  }

  async function unmatchTransaction(matchId) {
    if (!confirm('Are you sure you want to remove this transaction match? This will move the transaction back to unmatched.')) {
      return;
    }
    
    try {
      const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
      
      const response = await fetch('/reconciliation/ajax/unmatch-transaction/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
          match_id: matchId
        })
      });
      
      const result = await response.json();
      
      if (result.success) {
        // Refresh the page to show updated data
        window.location.reload();
      } else {
        alert('Error removing match: ' + result.error);
      }
      
    } catch (error) {
      console.error('Error removing match:', error);
      alert('Error removing match. Please try again.');
    }
  }

  // ====== LOAN CUSTOMER SEARCH FUNCTIONS ======
  
  let searchTimeout;
  let activeDropdown;

  // ====== SIMPLE DROPDOWN APPROACH FOR LOAN CUSTOMERS ======
  
  let allLoanCustomers = []; // Cache for loan customers
  
  // Load all loan customers when page loads
  async function loadAllLoanCustomers() {
    try {
      console.log('Loading all loan customers...');
      const response = await fetch('/reconciliation/ajax/get-all-loan-customers/');
      const data = await response.json();
      
      if (data.customers) {
        allLoanCustomers = data.customers;
        populateAllDropdowns();
        populateWhoDataLists(); // Add this line to populate hybrid datalists
        console.log(`Loaded ${allLoanCustomers.length} loan customers`);
      } else {
        console.error('No customers data received:', data);
      }
    } catch (error) {
      console.error('Error loading loan customers:', error);
    }
  }

  // Populate all WHO datalists for hybrid inputs
  function populateWhoDataLists() {
    try {
      // Find all WHO datalists
      const datalists = document.querySelectorAll('datalist[id^="mainWhoSuggestions_"]');
      console.log(`Populating ${datalists.length} WHO datalists`);
      
      datalists.forEach(datalist => {
        // Clear existing options
        datalist.innerHTML = '';
        
        // Add loan customers
        if (allLoanCustomers && allLoanCustomers.length > 0) {
          allLoanCustomers.forEach(customer => {
            const option = document.createElement('option');
            option.value = customer.display_name;
            option.setAttribute('data-id', customer.id);
            option.setAttribute('data-type', 'loan_customer');
            option.setAttribute('data-loan-info', customer.loan_info || '');
            datalist.appendChild(option);
          });
          console.log(`Added ${allLoanCustomers.length} loan customers to datalists`);
        }
        
        // Add general contacts
        if (typeof contacts !== 'undefined' && contacts && contacts.length > 0) {
          contacts.forEach(contact => {
            const option = document.createElement('option');
            option.value = contact;
            option.setAttribute('data-id', '');
            option.setAttribute('data-type', 'general_contact');
            option.setAttribute('data-loan-info', '');
            datalist.appendChild(option);
          });
          console.log(`Added ${contacts.length} general contacts to datalists`);
        } else {
          console.log('No general contacts available or contacts variable undefined');
        }
      });
    } catch (error) {
      console.error('Error populating WHO datalists:', error);
    }
  }
  
  // Populate all WHO dropdowns with loan customers (Legacy - now handled by populateWhoDataLists)
  function populateAllDropdowns() {
    // This function is kept for compatibility but functionality moved to populateWhoDataLists
    // Check if there are any old-style dropdowns still present
    const dropdowns = document.querySelectorAll('.loan-customer-dropdown');
    
    if (dropdowns.length > 0) {
      // Legacy support: populate old-style dropdowns if they exist
      dropdowns.forEach(dropdown => {
        dropdown.innerHTML = '<option value="">Select loan customer...</option>';
        
        allLoanCustomers.forEach(customer => {
          const option = document.createElement('option');
          option.value = customer.id;
          option.textContent = customer.display_name;
          option.setAttribute('data-customer-id', customer.customer_id);
          option.setAttribute('data-loan-info', customer.loan_info);
          dropdown.appendChild(option);
        });
      });
    }
    
    console.log('Legacy dropdown population completed. Found', dropdowns.length, 'old-style dropdowns.');
  }
  
  // Handle customer selection from dropdown (Legacy - kept for compatibility)
  function selectLoanCustomer(selectElement) {
    // Check if this is an old-style select element or new hybrid input
    if (!selectElement) return;
    
    if (selectElement.tagName === 'SELECT') {
      // Legacy select dropdown handling
      const selectedOption = selectElement.options[selectElement.selectedIndex];
      const transactionId = selectElement.getAttribute('data-transaction-id');
      
      if (selectedOption.value) {
        const customerId = selectedOption.value;
        const customerName = selectedOption.textContent;
        const customerIdNumber = selectedOption.getAttribute('data-customer-id');
        const loanInfo = selectedOption.getAttribute('data-loan-info');
        
        console.log(`Selected loan customer (legacy): ${customerName} (ID: ${customerId})`);
        
        // Show loan payment indicator
        showLoanPaymentIndicator(transactionId, customerName, loanInfo);
        
        // Auto-detect loan payment for this transaction
        if (transactionId && !isNaN(parseInt(transactionId))) {
          detectLoanPayment(parseInt(transactionId));
        }
      } else {
        // Hide loan payment indicator if no customer selected
        hideLoanPaymentIndicator(transactionId);
      }
    } else {
      console.log('selectLoanCustomer called with non-select element, ignoring');
    }
  }
  
  // Show loan payment indicator
  function showLoanPaymentIndicator(transactionId, customerName, loanInfo) {
    const indicator = document.getElementById(`loan-indicator-${transactionId}`);
    if (indicator) {
      const indicatorText = indicator.querySelector('.indicator-text');
      if (indicatorText) {
        indicatorText.textContent = `Loan payment for ${customerName}${loanInfo ? ' - ' + loanInfo : ''}`;
      }
      indicator.style.display = 'block';
    }
  }
  
  // Hide loan payment indicator
  function hideLoanPaymentIndicator(transactionId) {
    const indicator = document.getElementById(`loan-indicator-${transactionId}`);
    if (indicator) {
      indicator.style.display = 'none';
    }
  }

  // Check if manually typed value might be a loan customer
  async function checkIfPotentialLoanCustomer(transactionId, customerName) {
    try {
      console.log('üîç Checking if potential loan customer:', customerName);
      
      // Get transaction amount first
      const transactionRow = document.querySelector(`[data-transaction-id="${transactionId}"]`);
      if (!transactionRow) {
        console.log('‚ùå Transaction row not found');
        return;
      }
      
      const amountElement = transactionRow.querySelector('.amount-pos, .amount-neg');
      const amountText = amountElement ? amountElement.textContent.trim() : '';
      const amount = parseFloat(amountText.replace(/[$,+]/g, ''));
      
      if (!amount || amount <= 0) {
        console.log('‚ùå Invalid amount:', amountText);
        return;
      }
      
      console.log('üí∞ Checking loan customer with amount:', amount);
      
      // Call our endpoint to check if this is a loan customer
      const baseUrl = '{% url "reconciliation:get_loan_payment_breakdown" %}';
      const fullUrl = `${baseUrl}?customer_name=${encodeURIComponent(customerName)}&amount=${amount}`;
      console.log('üîç Generated base URL:', baseUrl);
      console.log('üîç Full URL:', fullUrl);
      const response = await fetch(fullUrl);
      
      if (response.ok) {
        const breakdown = await response.json();
        
        if (breakdown.success && breakdown.is_loan_customer) {
          console.log('‚úÖ Confirmed loan customer, triggering split modal');
          
          // Show confirmation notification with correct loan reference
          const loanInfo = breakdown.loans && breakdown.loans.length > 0 ? breakdown.loans[0] : null;
          const loanDisplay = loanInfo ? `\nLoan: ${loanInfo.loan_number}` : '';
          showAlert(`üè¶ Loan Customer Detected!\n\nCustomer: ${breakdown.customer.name}${loanDisplay}\n\nTriggering split transaction with payment breakdown...`, 'success');
          
          // Trigger the split modal with a short delay
          setTimeout(() => {
            triggerLoanPaymentSplitTransaction(transactionId, customerName);
          }, 1000);
        } else {
          console.log('‚ÑπÔ∏è Not a loan customer or no active loans');
        }
      } else {
        console.log('‚ö†Ô∏è API call failed, not a loan customer');
      }
      
    } catch (error) {
      console.log('‚ùå Error checking loan customer:', error);
    }
  }

  // Auto-trigger split transaction modal for loan payments
  async function triggerLoanPaymentSplitTransaction(transactionId, customerName) {
    try {
      console.log('üè¶ AUTO-TRIGGER CALLED:', customerName, 'Transaction:', transactionId);
      
      // Get transaction data
      const transactionRow = document.querySelector(`[data-transaction-id="${transactionId}"]`);
      if (!transactionRow) {
        console.error('‚ùå Transaction row not found for ID:', transactionId);
        console.log('Available transaction rows:', document.querySelectorAll('[data-transaction-id]').length);
        return;
      }
      
      console.log('‚úÖ Found transaction row');
      
      // Extract amount from transaction
      const amountElement = transactionRow.querySelector('.amount-pos, .amount-neg');
      const amountText = amountElement ? amountElement.textContent.trim() : '';
      const amount = parseFloat(amountText.replace(/[$,+]/g, ''));
      
      console.log('üí∞ Amount element:', amountElement);
      console.log('üí∞ Amount text:', amountText);
      console.log('üí∞ Parsed amount:', amount);
      
      if (!amount || amount <= 0) {
        console.error('‚ùå Invalid amount found:', amountText);
        return;
      }
      
      console.log('üåê Making API call to get loan payment breakdown...');
      
      // Get loan payment breakdown from backend
      const baseUrl = '{% url "reconciliation:get_loan_payment_breakdown" %}';
      const cacheBuster = Date.now(); // Force fresh request
      const url = `${baseUrl}?customer_name=${encodeURIComponent(customerName)}&amount=${amount}&_cb=${cacheBuster}`;
      console.log('üîç Generated base URL:', baseUrl);
      console.log('üì° API URL:', url);
      
      const response = await fetch(url);
      console.log('üì° Response status:', response.status);
      
      const breakdown = await response.json();
      console.log('üìä Full API response:', breakdown);
      
      if (!breakdown.success) {
        console.warn('‚ö†Ô∏è API returned error:', breakdown.error);
        
        // Show user notification
        if (breakdown.error.includes('No customer found')) {
          showAlert(`üí° Loan Customer Detection\n\n"${customerName}" was detected as a loan customer, but no matching customer found in the loan system.\n\nYou can still process this manually using the Split Transaction feature.`, 'info');
        } else if (breakdown.error.includes('No active loans')) {
          showAlert(`üìã No Active Loans\n\nCustomer "${customerName}" was found but has no active loans.\n\nYou can process this as a regular transaction.`, 'info');
        } else {
          showAlert(`‚ö†Ô∏è Error: ${breakdown.error}`, 'warning');
        }
        return;
      }
      
      console.log('‚úÖ Successfully got loan breakdown');
      
      // Handle multiple loans case
      if (breakdown.multiple_loans) {
        console.log('üè¶ Multiple loans detected, showing selection');
        showMultipleLoanSelection(transactionId, breakdown);
        return;
      }
      
      console.log('üéâ Single loan found, showing split modal');
      
      // Show success notification with loan details
      const loanInfo = breakdown.loans && breakdown.loans.length > 0 ? breakdown.loans[0] : null;
      const customer = breakdown.customer;
      
      if (loanInfo) {
        showAlert(`üè¶ Loan Payment Detected!\n\nCustomer: ${customer.name}\nLoan: ${loanInfo.loan_number}\nCurrent Balance: ${loanInfo.balance}\n\nOpening Split Transaction with recommended allocation...`, 'success');
      } else {
        showAlert(`üè¶ Loan Payment Detected!\n\nCustomer: ${customer.name}\n\nOpening Split Transaction with recommended allocation...`, 'success');
      }
      
      // Small delay to show notification, then open split modal
      setTimeout(() => {
        showLoanPaymentSplitModal(transactionId, breakdown);
      }, 1000);
      
    } catch (error) {
      console.error('Error triggering loan payment split:', error);
      showAlert('‚ö†Ô∏è Error getting loan payment breakdown. You can still use the Split Transaction feature manually.', 'warning');
    }
  }

  // Show multiple loan selection dialog
  function showMultipleLoanSelection(transactionId, breakdown) {
    const backdrop = document.createElement('div');
    backdrop.className = 'modal-backdrop fade show';
    backdrop.style.zIndex = '1040';
    
    const modal = document.createElement('div');
    modal.className = 'modal fade show';
    modal.style.display = 'block';
    modal.style.zIndex = '1050';
    
    const customer = breakdown.customer;
    const loanOptions = breakdown.loan_options;
    
    let optionsHTML = '';
    loanOptions.forEach(loan => {
      optionsHTML += `
        <div class="loan-option border rounded p-3 mb-2" style="cursor: pointer;" onclick="selectLoanForSplit(${transactionId}, '${customer.name}', '${loan.loan_id}', '${loan.loan_number}')">
          <div class="d-flex justify-content-between">
            <div>
              <strong>Loan ${loan.loan_number}</strong>
            </div>
            <div class="text-end">
              <span class="badge bg-info">Balance: ${loan.formatted_balance}</span>
            </div>
          </div>
        </div>
      `;
    });
    
    modal.innerHTML = `
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">üè¶ Multiple Loans Found</h5>
            <button type="button" class="btn-close" onclick="closeMultipleLoanModal()"></button>
          </div>
          <div class="modal-body">
            <p><strong>Customer:</strong> ${customer.name}</p>
            <p>This customer has multiple active loans. Please select which loan this payment is for:</p>
            ${optionsHTML}
            <hr>
            <div class="text-center">
              <button class="btn btn-secondary" onclick="closeMultipleLoanModal()">Cancel - Process Manually</button>
            </div>
          </div>
        </div>
      </div>
    `;
    
    modal.id = 'multipleLoanModal';
    backdrop.id = 'multipleLoanBackdrop';
    
    document.body.appendChild(backdrop);
    document.body.appendChild(modal);
  }

  // Close multiple loan selection modal
  function closeMultipleLoanModal() {
    const modal = document.getElementById('multipleLoanModal');
    const backdrop = document.getElementById('multipleLoanBackdrop');
    if (modal) modal.remove();
    if (backdrop) backdrop.remove();
  }

  // Select specific loan for split transaction
  async function selectLoanForSplit(transactionId, customerName, loanId, loanNumber) {
    closeMultipleLoanModal();
    
    try {
      // Get amount from transaction
      const transactionRow = document.querySelector(`[data-transaction-id="${transactionId}"]`);
      const amountElement = transactionRow.querySelector('.amount-pos, .amount-neg');
      const amount = parseFloat(amountElement.textContent.trim().replace(/[$,+]/g, ''));
      
      // Get breakdown for specific loan
      const response = await fetch(`{% url 'reconciliation:get_loan_payment_breakdown' %}?customer_name=${encodeURIComponent(customerName)}&amount=${amount}&loan_id=${loanId}`);
      const breakdown = await response.json();
      
      if (breakdown.success) {
        showAlert(`üí∞ Processing payment for Loan ${loanNumber}`, 'success');
        setTimeout(() => {
          showLoanPaymentSplitModal(transactionId, breakdown);
        }, 800);
      } else {
        showAlert('‚ö†Ô∏è Error getting loan details. Processing manually.', 'warning');
      }
    } catch (error) {
      console.error('Error selecting loan for split:', error);
      showAlert('‚ö†Ô∏è Error processing loan selection. You can use Split Transaction manually.', 'warning');
    }
  }

  // Show split transaction modal with pre-populated loan data
  function showLoanPaymentSplitModal(transactionId, breakdown) {
    console.log('üéØ showLoanPaymentSplitModal called with:', transactionId, breakdown);
    
    // Get transaction data
    const transactionRow = document.querySelector(`[data-transaction-id="${transactionId}"]`);
    if (!transactionRow) {
      console.error('‚ùå Transaction row not found for ID:', transactionId);
      return;
    }
    
    console.log('üìã Found transaction row:', transactionRow);
    
    const descElement = transactionRow.querySelector('.description');
    const amountElement = transactionRow.querySelector('.amount-pos, .amount-neg');
    const dateElement = transactionRow.querySelector('.date');

    console.log('üîç Description element:', descElement);
    console.log('üí∞ Amount element:', amountElement);
    console.log('üìÖ Date element:', dateElement);

    const transactionData = {
      id: transactionId,
      description: descElement ? descElement.textContent.trim() : '',
      amount: parseFloat(amountElement.textContent.trim().replace(/[$,+]/g, '')),
      date: dateElement ? dateElement.textContent.trim() : '',
      payee: breakdown.customer.name
    };
    
    console.log('üìä Final transaction data:', transactionData);
    
    // Show customized split modal with loan data
    showLoanSplitTransactionModal(transactionData, breakdown);
  }

  // ====== LEGACY SEARCH FUNCTIONS (KEPT FOR COMPATIBILITY) ======

  async function searchLoanCustomers(input) {
    const query = input.value.trim();
    const transactionId = input.getAttribute('data-transaction-id');
    const dropdown = document.getElementById(`loan-dropdown-${transactionId}`);
    
    // Clear previous timeout
    if (searchTimeout) {
      clearTimeout(searchTimeout);
    }
    
    // Hide dropdown if query is empty
    if (query.length === 0) {
      dropdown.style.display = 'none';
      return;
    }
    
    // Debounce search
    searchTimeout = setTimeout(async () => {
      try {
        const response = await fetch(`/reconciliation/ajax/search-loan-customers/?q=${encodeURIComponent(query)}`);
        const data = await response.json();
        
        if (data.customers && data.customers.length > 0) {
          showCustomerResults(dropdown, data.customers, transactionId);
        } else {
          hideCustomerDropdown(dropdown);
        }
        
        // Auto-detect loan payment for this transaction
        if (transactionId && !isNaN(parseInt(transactionId))) {
          detectLoanPayment(transactionId);
        }
        
      } catch (error) {
        console.error('Error searching loan customers:', error);
        hideCustomerDropdown(dropdown);
      }
    }, 300);
  }

  function showCustomerResults(dropdown, customers, transactionId) {
    let html = '';
    
    customers.forEach(customer => {
      html += `
        <div class="customer-item p-2 border-bottom" style="cursor: pointer;" 
             onclick="selectLoanCustomer('${customer.id}', '${customer.name}', ${transactionId})">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <strong>${customer.name}</strong>
              <small class="text-muted d-block">ID: ${customer.customer_id}</small>
            </div>
            <span class="badge bg-primary">${customer.loans.length} loan${customer.loans.length !== 1 ? 's' : ''}</span>
          </div>
          <div class="mt-1">
            ${customer.loans.map(loan => `
              <small class="text-info d-block">
                ${loan.loan_number}: $${loan.balance.toLocaleString()} balance, 
                $${loan.monthly_payment.toLocaleString()}/month
              </small>
            `).join('')}
          </div>
        </div>
      `;
    });
    
    dropdown.innerHTML = html;
    dropdown.style.display = 'block';
    activeDropdown = dropdown;
  }

  function selectLoanCustomer(customerId, customerName, transactionId) {
    const input = document.querySelector(`[name="who_${transactionId}"]`);
    const dropdown = document.getElementById(`loan-dropdown-${transactionId}`);
    
    input.value = customerName;
    input.setAttribute('data-customer-id', customerId);
    dropdown.style.display = 'none';
    
    // Show loan payment indicator
    showLoanPaymentIndicator(transactionId, 'Customer selected - ready for loan payment');
    
    // Trigger checkOK to enable submit button
    checkOK(transactionId);
  }

  function showCustomerDropdown(input) {
    const transactionId = input.getAttribute('data-transaction-id');
    const dropdown = document.getElementById(`loan-dropdown-${transactionId}`);
    
    if (input.value.trim().length > 0) {
      searchLoanCustomers(input);
    }
  }

  function hideCustomerDropdown(dropdown) {
    dropdown.style.display = 'none';
  }

  async function detectLoanPayment(transactionId) {
    try {
      const response = await fetch(`/reconciliation/ajax/detect-loan-payment/${transactionId}/`);
      
      if (!response.ok) {
        console.warn(`Failed to detect loan payment for transaction ${transactionId}: ${response.status}`);
        return;
      }
      
      const data = await response.json();
      
      if (data.error) {
        console.warn(`Loan payment detection error for transaction ${transactionId}:`, data.error);
        return;
      }
      
      if (data.is_loan_payment && data.suggestions.length > 0) {
        showLoanPaymentIndicator(transactionId, 
          `Detected potential loan payment (${data.suggestions.length} suggestion${data.suggestions.length !== 1 ? 's' : ''})`);
        
        // Auto-suggest the highest confidence customer
        const topSuggestion = data.suggestions[0];
        if (topSuggestion.confidence > 70) {
          const input = document.querySelector(`[name="who_${transactionId}"]`);
          if (input && !input.value.trim()) {
            input.value = topSuggestion.customer_name;
            input.setAttribute('data-customer-id', topSuggestion.customer_id);
          }
        }
      }
    } catch (error) {
      console.warn('Error detecting loan payment for transaction', transactionId, ':', error);
    }
  }

  function showLoanPaymentIndicator(transactionId, message) {
    const indicator = document.getElementById(`loan-indicator-${transactionId}`);
    const indicatorText = indicator.querySelector('.indicator-text');
    
    indicatorText.textContent = message;
    indicator.style.display = 'block';
  }

  function hideLoanPaymentIndicator(transactionId) {
    const indicator = document.getElementById(`loan-indicator-${transactionId}`);
    indicator.style.display = 'none';
  }

  // Close dropdown when clicking outside
  document.addEventListener('click', function(e) {
    if (activeDropdown && !activeDropdown.contains(e.target) && 
        !e.target.classList.contains('loan-customer-search')) {
      activeDropdown.style.display = 'none';
      activeDropdown = null;
    }
  });

  // Auto-detect loan payments on page load - DISABLED for now
  document.addEventListener('DOMContentLoaded', function() {
    console.log('Auto-split functionality removed per user request.');
    // All auto-detection and auto-split functionality has been removed
  });

  // Show split transaction modal with pre-populated loan payment data
  function showLoanSplitTransactionModal(transactionData, breakdown) {
    console.log('üéØ showLoanInfoApprovalModal called with:', transactionData, breakdown);
    
    // Close any existing modals
    closeSplitModal();
    
    // Create backdrop
    const backdrop = document.createElement('div');
    backdrop.className = 'modal-backdrop fade show';
    backdrop.style.zIndex = '1040';
    backdrop.id = 'loanApprovalBackdrop';
    
    // Create modal
    const modal = document.createElement('div');
    modal.className = 'modal fade show';
    modal.style.display = 'block';
    modal.style.zIndex = '1050';
    modal.id = 'loanApprovalModal';
    
    // Extract loan information from breakdown
    const customer = breakdown.customer || {};
    const paymentBreakdown = breakdown.payment_breakdown || [];
    
    // Calculate payment totals
    let principalAmount = 0, interestAmount = 0, lateFeeAmount = 0;
    paymentBreakdown.forEach(line => {
      const amount = parseFloat(line.amount || 0);
      if (line.type === 'principal_payment') principalAmount += amount;
      if (line.type === 'interest_payment') interestAmount += amount;
      if (line.type === 'late_fee_payment') lateFeeAmount += amount;
    });
    
    // Build modal HTML - Loan Information + Approval Workflow
    modal.innerHTML = `
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <!-- Modal Header -->
          <div class="modal-header bg-info text-white">
            <div class="d-flex align-items-center">
              <i class="bi bi-info-circle me-2" style="font-size: 1.2rem;"></i>
              <h5 class="modal-title mb-0">üè¶ Loan Payment Information</h5>
            </div>
            <button type="button" class="btn-close btn-close-white" onclick="closeLoanApprovalModal()"></button>
          </div>

          <!-- Modal Body -->
          <div class="modal-body">
            <div class="container-fluid">
              
              <!-- Payment Summary Card -->
              <div class="card border-primary mb-4">
                <div class="card-header bg-primary text-white">
                  <h6 class="mb-0"><i class="bi bi-cash-coin me-2"></i>Payment Summary</h6>
                </div>
                <div class="card-body">
                  <div class="row">
                    <div class="col-md-6">
                      <p><strong>Customer:</strong> ${customer.name || 'Unknown'}</p>
                      <p><strong>Payment Date:</strong> ${transactionData.date || new Date().toISOString().split('T')[0]}</p>
                      <p><strong>Payment Amount:</strong> <span class="text-success fw-bold fs-5">$${transactionData.amount.toFixed(2)}</span></p>
                    </div>
                    <div class="col-md-6">
                      <p><strong>Description:</strong> Loan Payment</p>
                      <p><strong>Transaction Reference:</strong> ${transactionData.reference || 'N/A'}</p>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Loan Allocation Breakdown -->
              <div class="card border-success mb-4">
                <div class="card-header bg-success text-white">
                  <h6 class="mb-0"><i class="bi bi-pie-chart me-2"></i>Payment Allocation Breakdown</h6>
                </div>
                <div class="card-body">
                  <div class="row text-center">
                    <div class="col-md-4">
                      <div class="border rounded p-3 h-100">
                        <div class="text-primary fs-4 fw-bold">$${lateFeeAmount.toFixed(2)}</div>
                        <div class="text-muted">Late Fees</div>
                        <small class="text-muted">Priority 1</small>
                      </div>
                    </div>
                    <div class="col-md-4">
                      <div class="border rounded p-3 h-100">
                        <div class="text-warning fs-4 fw-bold">$${interestAmount.toFixed(2)}</div>
                        <div class="text-muted">Interest</div>
                        <small class="text-muted">Priority 2</small>
                      </div>
                    </div>
                    <div class="col-md-4">
                      <div class="border rounded p-3 h-100">
                        <div class="text-success fs-4 fw-bold">$${principalAmount.toFixed(2)}</div>
                        <div class="text-muted">Principal</div>
                        <small class="text-muted">Priority 3</small>
                      </div>
                    </div>
                  </div>
                  <div class="mt-3 text-center">
                    <small class="text-muted">
                      <i class="bi bi-info-circle me-1"></i>
                      Payment automatically allocated according to loan payment rules (Late Fees ‚Üí Interest ‚Üí Principal)
                    </small>
                  </div>
                </div>
              </div>

              <!-- Verification Section -->
              <div class="alert alert-warning">
                <h6><i class="bi bi-exclamation-triangle me-2"></i>Please Verify</h6>
                <p class="mb-2">Please verify this is the correct loan payment before processing:</p>
                <ul class="mb-0">
                  <li>Customer name matches the loan account</li>
                  <li>Payment amount is correct</li>
                  <li>Payment allocation looks reasonable</li>
                </ul>
              </div>

              <!-- Hidden transaction data -->
              <input type="hidden" id="loanTransactionId" value="${transactionData.id}">
              <input type="hidden" id="loanBreakdownData" value='${JSON.stringify(breakdown)}'>
            </div>
          </div>

          <!-- Modal Footer -->
          <div class="modal-footer">
            <div class="me-auto">
              <span class="badge bg-info">Ready for Processing</span>
              <small class="text-muted ms-2">Payment breakdown calculated</small>
            </div>
            <button type="button" class="btn btn-success btn-lg" onclick="processLoanPayment()">
              <i class="bi bi-check-circle me-2"></i>Process Loan Payment
            </button>
            <button type="button" class="btn btn-secondary" onclick="closeLoanApprovalModal()">
              <i class="bi bi-x-circle me-2"></i>Cancel
            </button>
          </div>
        </div>
      </div>
    `;
    
    // Add modal to page
    document.body.appendChild(backdrop);
    document.body.appendChild(modal);
    
    console.log('‚úÖ Loan approval modal created and displayed');
  }

  // Close loan approval modal
  function closeLoanApprovalModal() {
    const modal = document.getElementById('loanApprovalModal');
    const backdrop = document.getElementById('loanApprovalBackdrop');
    if (modal) modal.remove();
    if (backdrop) backdrop.remove();
  }

  // Process loan payment - this triggers the Phase 3 automatic Payment creation
  function processLoanPayment() {
    const transactionId = document.getElementById('loanTransactionId').value;
    const breakdownData = JSON.parse(document.getElementById('loanBreakdownData').value);
    
    console.log('üéØ Processing loan payment for transaction:', transactionId);
    console.log('üí∞ Using breakdown data:', breakdownData);
    
    // Show processing indicator
    const processButton = document.querySelector('button[onclick="processLoanPayment()"]');
    const originalText = processButton.innerHTML;
    processButton.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Processing...';
    processButton.disabled = true;
    
    // Call the existing reconciliation endpoint which will trigger Phase 3 Payment creation
    fetch('/reconciliation/reconcile/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCsrfToken()
      },
      body: JSON.stringify({
        transaction_id: transactionId,
        reconcile_action: 'loan_payment',
        breakdown_data: breakdownData
      })
    })
    .then(response => response.json())
    .then(data => {
      console.log('‚úÖ Loan payment processing response:', data);
      
      if (data.success) {
        // Close modal
        closeLoanApprovalModal();
        
        // Show success message
        showAlert('üéâ Loan Payment Processed Successfully!\n\nPayment record has been created and the transaction has been reconciled.', 'success');
        
        // Refresh the reconciliation view
        location.reload();
      } else {
        // Restore button
        processButton.innerHTML = originalText;
        processButton.disabled = false;
        
        // Show error
        showAlert('‚ùå Error Processing Loan Payment\n\n' + (data.error || 'An unknown error occurred'), 'error');
      }
    })
    .catch(error => {
      console.error('‚ùå Error processing loan payment:', error);
      
      // Restore button
      processButton.innerHTML = originalText;
      processButton.disabled = false;
      
      showAlert('‚ùå Network Error\n\nFailed to process loan payment. Please try again.', 'error');
    });
  }
    let targetAmount = 0;
    
    if (transactionRow) {
      const amountElement = transactionRow.querySelector('.amount-pos, .amount-neg');
      if (amountElement) {
        targetAmount = parseFloat(amountElement.textContent.trim().replace(/[$,+]/g, ''));
      }
    }
    
    const difference = total - targetAmount;
    
    if (differenceElement) {
      differenceElement.textContent = `$${difference.toFixed(2)}`;
    }
    
    if (statusElement) {
      if (Math.abs(difference) < 0.01) {
        statusElement.innerHTML = '<i class="bi bi-check-circle"></i> Balanced';
        statusElement.className = 'badge bg-success';
      } else {
        statusElement.innerHTML = '<i class="bi bi-exclamation-triangle"></i> Unbalanced';
        statusElement.className = 'badge bg-warning';
      }
    }
  }

  // Save loan split transaction
  // ====== DEBUG FUNCTIONS FOR TESTING ======
  
  // Test functionality removed per user request
  // All auto-split and test functions have been disabled
  
  // Test function to check if API endpoint works
  window.testLoanAPI = async function(customerName = 'John Smith', amount = 500) {
    console.log('üß™ MANUAL TEST: Testing loan API endpoint');
    
    const url = `{% url 'reconciliation:get_loan_payment_breakdown' %}?customer_name=${encodeURIComponent(customerName)}&amount=${amount}`;
    console.log('üì° Testing URL:', url);
    
    try {
      const response = await fetch(url);
      console.log('üì° Response status:', response.status);
      
      const data = await response.json();
      console.log('üìä API Response:', data);
      
      return data;
    } catch (error) {
      console.error('‚ùå API Error:', error);
      return null;
    }
  };

  // ====== END DEBUG FUNCTIONS ======
</script>
{% endblock %}

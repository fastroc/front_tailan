{% extends 'base.html' %}
{% load static humanize %}

<!-- ⚡ COMPLETELY REBUILT - NO BOOTSTRAP GRID - FLEXBOX ONLY - V3.0 - 2025-10-02 18:45 ⚡ -->

{% block extra_head %}
<!-- No extra head content needed - CSRF handled via cookies -->
{% endblock %}

{% block title %}{{ title|default:"Bank Reconciliation" }} - Simple Mode{% endblock %}

{% block extra_css %}
<style>
  /* —— CRITICAL: Override main-content padding for this page —— */
  .main-content {
    padding: 1rem !important;
  }
  
  /* —— SIMPLE LAYOUT WITHOUT BOOTSTRAP GRID —— */
  #reconciliation-page {
    width: 100%;
    max-width: 100%;
    padding: 0;
    margin: 0;
  }
  
  .section-container {
    width: 100%;
    padding: 0 15px;
    margin-bottom: 1.5rem;
    box-sizing: border-box;
  }
  
  .header-section {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
  }
  
  .header-left h2 {
    margin-bottom: 0.5rem;
  }
  
  .header-buttons {
    display: flex;
    gap: 0.5rem;
  }
  
  /* Transaction items must stay within bounds */
  .transaction-item {
    width: 100%;
    max-width: 100%;
    box-sizing: border-box;
  }
  
  /* —— Layout polish to resemble Xero —— */
  .balance-banner { 
    background:#f6f7f8; 
    border:1px solid #e5e7eb; 
    border-radius:.5rem;
    padding: 2rem;
    width: 100%;
    box-sizing: border-box;
  }
  
  .balance-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1.5rem;
    text-align: center;
  }
  
  .balance-metric .label { font-size:.8rem; color:#6b7280; }
  .balance-metric .value { font-weight:700; font-size:1rem; }
  .diff-badge { font-size:.75rem; }

  .x-tabs .nav-link { font-weight:600; }
  .x-tabs .nav-link.active { border-bottom:3px solid #2563eb; color:#111827; }

  .transaction-item { 
    transition: all 0.5s ease-out, background .15s ease, border-color .15s ease;
    transform: translateY(0);
    opacity: 1;
    max-height: 1000px;
    overflow: visible;
  }
  .transaction-item.saving {
    transition: all 0.3s ease-out;
    opacity: 0.8;
    transform: scale(0.98);
  }
  .transaction-item.completed {
    transition: all 0.5s ease-out;
    transform: translateY(-50px);
    opacity: 0;
    max-height: 0;
    padding: 0 !important;
    margin: 0 !important;
    overflow: hidden;
  }
  .transaction-item:hover { background:#f8fafc; }
  .border-credit { border-left:4px solid #16a34a !important; }
  .border-debit  { border-left:4px solid #ef4444 !important; }
  .amount-pos { color:#16a34a; font-weight:600; }
  .amount-neg { color:#ef4444; font-weight:600; }

  .pillar-label { font-size:.75rem; text-transform:uppercase; letter-spacing:.04em; font-weight:700; }
  .form-control-sm, .form-select-sm { font-size:.85rem; }

  .ok-btn { min-width:96px; }

  /* Compact mode */
  .compact .transaction-item { padding:.5rem .75rem !important; }
  .compact .txn-title { font-size:.9rem; }
  .compact .txn-meta { display:none; }
  .compact .matching-form { display:none; }

  .matching-form { background:#f8fafc; border-radius:.5rem; padding:1rem; margin-top:.5rem; }

  .sticky-side { position:sticky; top:1rem; }

  .badge-soft { background:#eaf2ff; color:#2563eb; border:1px solid #cfe0ff; }

  /* Smart Details Link Styling */
  .btn-link.text-muted {
    border: none;
    transition: all 0.2s ease;
  }
  .btn-link.text-muted:hover {
    color: #2563eb !important;
    background-color: rgba(37, 99, 235, 0.05);
  }

  /* Hybrid input styling - exact same as original */
  .hybrid-input { border: 1px solid #d1d5db; border-radius: 0.375rem; }
  .hybrid-dropdown-btn { border-left: 1px solid #d1d5db; }
  .temp-dropdown { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
  .temp-who-dropdown { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }

  /* Progress and balance styling */
  .progress-text { font-size:.85rem; color:#6b7280; }
  .btn-reconcile { background: #059669; border-color: #059669; color: white; }
  .btn-reconcile:hover { background: #047857; border-color: #047857; }

  /* Loan Customers Section Styling */
  .border-left-primary { border-left: 4px solid #2563eb !important; }
  .card.shadow-sm { box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075) !important; }
  .card.shadow-sm:hover { box-shadow: 0 0.25rem 0.5rem rgba(0, 0, 0, 0.1) !important; transition: box-shadow 0.15s ease-in-out; }

  /* Enhanced Reconciliation Progress Styles */
  .reconciliation-progress {
    background: rgba(255, 255, 255, 0.8);
    border: 1px solid #e5e7eb;
    border-radius: 0.5rem;
    padding: 1rem;
  }
  
  .progress-info .fw-semibold {
    font-size: 0.95rem;
  }
  
  /* Smart Suggestions Showcase Styles */
  .suggestions-section {
    background: linear-gradient(135deg, #f8f9ff 0%, #f0f4ff 100%);
    border-radius: 8px;
    padding: 1rem;
    border: 2px solid #e0e7ff;
  }
  
  .badge-soft {
    background-color: #dbeafe;
    color: #1e40af;
    border: 1px solid #93c5fd;
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
  }
  
  .suggestion-card {
    transition: all 0.2s ease;
    border: 1px solid #e5e7eb !important;
    background-color: white !important;
  }
  
  .suggestion-card:hover {
    border-color: #2563eb !important;
    box-shadow: 0 2px 8px rgba(37, 99, 235, 0.15);
    transform: translateY(-1px);
  }
  
  .suggestion-engine {
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    font-weight: 600;
  }
  
  .suggestion-details {
    font-size: 0.8rem;
    line-height: 1.3;
  }
  
  .collapse-toggle {
    transition: transform 0.2s ease;
  }
  
  .collapse-toggle[aria-expanded="true"] i {
    transform: rotate(180deg);
  }
  
  .progress-stats .badge {
    font-size: 0.75rem;
    padding: 0.35em 0.65em;
  }
  
  .progress {
    background-color: #f1f5f9;
    border-radius: 0.5rem;
    box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.05);
  }
  
  .progress-bar-animated {
    animation: progress-bar-stripes 1s linear infinite;
  }
  
  @keyframes progress-bar-stripes {
    0% { background-position: 1rem 0; }
    100% { background-position: 0 0; }
  }
  
  /* Real-time progress update styles */
  .progress-counter {
    transition: all 0.3s ease;
  }
  
  .progress-counter.updated, .balance-metric .value.updated {
    transform: scale(1.1);
    color: #059669 !important;
  }
  
  .balance-metric .value.updated {
    transition: all 0.3s ease;
  }
  
  /* Toast animation styles */
  @keyframes slideIn {
    from {
      transform: translateX(400px);
      opacity: 0;
    }
    to {
      transform: translateX(0);
      opacity: 1;
    }
  }
  
  @keyframes slideOut {
    from {
      transform: translateX(0);
      opacity: 1;
    }
    to {
      transform: translateX(400px);
      opacity: 0;
    }
  }
  
  /* AI Feedback toast styling */
  .alert.position-fixed {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    border-radius: 0.5rem;
    font-weight: 500;
  }
  
  .alert-success { border-left: 4px solid #16a34a; }
  .alert-warning { border-left: 4px solid #f59e0b; }
  .alert-info { border-left: 4px solid #2563eb; }
</style>
{% endblock %}

{% block content %}
{% csrf_token %}
<input type="hidden" name="csrfmiddlewaretoken" value="{% csrf_token %}" id="csrf-token-input">

<!-- VISUAL TEST BANNER -->
<div style="background: linear-gradient(45deg, #ff0080, #ff8c00, #40e0d0); color: white; padding: 20px; text-align: center; font-size: 24px; font-weight: bold; margin-bottom: 20px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.3);">
  ⚡ NEW TEMPLATE LOADED - NO BOOTSTRAP GRID - FLEXBOX LAYOUT V3.0 ⚡
</div>

<div id="reconciliation-page">
  
  <!-- Header Section -->
  <div class="section-container">
    <div class="header-section">
      <div class="header-left">
        <h2 class="mb-1">
          <i class="fas fa-balance-scale text-primary"></i>
          Bank Reconciliation - {{ account.name }} 
          <span class="badge" style="background-color: hotpink; color: white;">Simple Mode - PINK TEST 🎨</span>
        </h2>
        <p class="text-muted mb-0">{{ company.name }}</p>
      </div>
      <div class="header-buttons">
        <a href="{% url 'reconciliation:dashboard' %}" class="btn btn-outline-secondary">
          <i class="fas fa-arrow-left"></i> Back to Dashboard
        </a>
        <a href="{% url 'bank_rules:list' %}" class="btn btn-outline-info" title="Manage Bank Rules">
          <i class="fas fa-bullseye"></i> Bank Rules
        </a>
        <a href="{% url 'reconciliation:account_reconciliation' account.id %}" class="btn btn-outline-primary">
          <i class="fas fa-cogs"></i> Advanced Mode
        </a>
      </div>
    </div>
  </div>

  <!-- Balance Summary -->
  <div class="section-container">
    <div class="balance-banner">
      <div class="balance-grid">
        <div class="balance-metric">
          <div class="label">Statement Balance</div>
          <div class="value text-primary">${{ progress.statement_balance|floatformat:2|intcomma }}</div>
        </div>
        <div class="balance-metric">
          <div class="label">Reconciled Balance</div>
          <div class="value text-info">${{ progress.reconciled_balance|floatformat:2|intcomma }}</div>
        </div>
        <div class="balance-metric">
          <div class="label">Difference</div>
          <div class="value {% if progress.difference == 0 %}text-success{% else %}text-warning{% endif %}">
            ${{ progress.difference|floatformat:2|intcomma }}
          </div>
        </div>
        <div class="balance-metric">
          <div class="label">Reconciled</div>
          <div class="value text-success">{{ progress.percentage|floatformat:0 }}%</div>
        </div>
      </div>
      
      <!-- Reconciliation Progress Section -->
      <div style="margin-top: 2rem;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
          <div class="progress-info">
            <span class="fw-semibold text-dark">Reconciliation Progress</span>
            <span class="text-muted ms-2">{{ progress.matched_transactions }} of {{ progress.total_transactions }} transactions</span>
          </div>
          <div class="progress-stats">
            <span class="badge bg-success me-1">{{ progress.matched_transactions }} Completed</span>
            <span class="badge bg-warning">{{ progress.unmatched_transactions }} Remaining</span>
          </div>
        </div>
        
        <!-- Progress Bar -->
        <div class="progress" style="height: 8px;">
          <div class="progress-bar bg-success progress-bar-striped progress-bar-animated" 
               role="progressbar" 
                     style="width: {{ progress.percentage|floatformat:1 }}%"
                     aria-valuenow="{{ progress.percentage|floatformat:1 }}" 
                     aria-valuemin="0" 
                     aria-valuemax="100">
          </div>
        </div>
        
        <!-- Detailed Progress Statistics -->
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-top: 1.5rem; text-align: center;">
          <div>
            <div class="small text-muted">Total Transactions</div>
            <div class="fw-bold text-primary">{{ progress.total_transactions|intcomma }}</div>
          </div>
          <div>
            <div class="small text-muted">Reconciled</div>
            <div class="fw-bold text-success">{{ progress.matched_transactions|intcomma }}</div>
          </div>
          <div>
            <div class="small text-muted">Remaining</div>
            <div class="fw-bold text-warning">{{ progress.unmatched_transactions|intcomma }}</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Transactions List -->
  <div class="section-container">
    <div class="card">
      <div class="card-header">
        <h5 class="card-title mb-0">
          <i class="fas fa-list"></i>
          <span class="transaction-list-title">Unmatched Transactions (<span class="transaction-count">{{ total_transactions }}</span>)</span>
          {% if total_pages > 1 %}
          <span class="badge bg-secondary ms-2">Page {{ current_page }} of {{ total_pages }}</span>
          <small class="text-muted ms-2">(Showing {{ showing_from }}-{{ showing_to }})</small>
          {% endif %}
        </h5>
      </div>
      <div class="card-body p-0">
        {% if transactions %}
            <div class="transaction-list" style="max-height:70vh; overflow-y:auto;">
              {% for t in transactions %}
              <div class="transaction-item p-3 border-bottom {% if t.amount > 0 %}border-credit{% else %}border-debit{% endif %}" data-transaction-id="{{ t.id }}">
                
                <!-- Clean Flexbox Layout - NO BOOTSTRAP GRID -->
                <div style="display: flex; align-items: center; gap: 1rem;">
                  
                  <!-- Transaction Number -->
                  <div style="flex-shrink: 0;">
                    <div class="transaction-number bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 35px; height: 35px; font-weight: 600; font-size: 0.9rem;">
                      {{ forloop.counter }}
                    </div>
                  </div>
                  
                  <!-- Left: Transaction Info -->
                  <div style="flex: 0 0 35%; min-width: 0;">
                    <div style="display: flex; align-items: start; justify-content: space-between; gap: 1rem;">
                      <div style="flex-grow: 1; min-width: 0;">
                        <div class="small text-primary fw-semibold txn-date">
                          <i class="bi bi-calendar me-1"></i>Гүйлгээний огноо: 
                          {% if t.transaction_datetime %}
                            {{ t.transaction_datetime|date:"Y-m-d H:i:s" }}
                          {% else %}
                            {{ t.date|date:"Y-m-d" }} 00:00:00
                          {% endif %}
                        </div>
                        <div class="txn-title fw-semibold">{{ t.description|default:"(no description)" }}</div>
                        <div class="txn-meta text-muted small">
                            Ref: {{ t.reference|default:"—" }} | Харьцсан данс: {{ t.related_account|default:"—" }}
                        </div>
                      </div>
                      <div style="text-align: right; flex-shrink: 0;">
                        <div class="{% if t.amount > 0 %}amount-pos{% else %}amount-neg{% endif %}">{% if t.amount > 0 %}+{% endif %}${{ t.amount|floatformat:2|intcomma }}</div>
                        <div class="small text-muted">{% if t.amount > 0 %}Received{% else %}Spent{% endif %}</div>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Middle: Save Button -->
                  <div style="flex: 0 0 100px; text-align: center;">
                    <button type="button" class="btn btn-primary btn-lg ok-btn" id="save{{ t.id }}" onclick="saveTransaction({{ t.id }})" style="display: none;">
                      OK
                    </button>
                  </div>
                  
                  <!-- Right: WHO/WHAT/WHY Form -->
                  <div style="flex: 1; min-width: 0;">
                    <div class="matching-form p-3 bg-light rounded">
                      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-bottom: 0.75rem;">
                        <div>
                          <label class="pillar-label text-info mb-1"><i class="bi bi-person me-1"></i>Who</label>
                          <div class="input-group input-group-sm position-relative">
                            <input type="text" 
                                   class="form-control hybrid-input who-input" 
                                   name="who_text_{{ t.id }}"
                                   placeholder="Type customer name..."
                                   value=""
                                   autocomplete="off">
                            <button class="btn btn-outline-secondary hybrid-dropdown-btn" 
                                    type="button" 
                                    onclick="showWhoDropdown(this, {{ t.id }})"
                                    title="Browse customers">
                              <i class="bi bi-chevron-down"></i>
                            </button>
                          </div>
                        </div>
                        <div>
                          <label class="pillar-label text-warning mb-1"><i class="bi bi-graph-up me-1"></i>What *</label>
                          <div class="input-group input-group-sm position-relative">
                            <input type="text" 
                                   class="form-control hybrid-input what-input" 
                                   name="what_text_{{ t.id }}"
                                   placeholder="Type account..."
                                   value=""
                                   autocomplete="off"
                                   required>
                            <button class="btn btn-outline-secondary hybrid-dropdown-btn" 
                                    type="button" 
                                    onclick="showWhatDropdown(this, {{ t.id }})"
                                    title="Browse accounts">
                              <i class="bi bi-chevron-down"></i>
                            </button>
                          </div>
                        </div>
                      </div>
                      <div>
                        <label class="pillar-label text-success mb-1"><i class="bi bi-chat-text me-1"></i>Why</label>
                        <input type="text" 
                               class="form-control form-control-sm why-input" 
                               name="why_{{ t.id }}"
                               placeholder="Enter description..."
                               value="{{ t.description }}"
                               autocomplete="off">
                      </div>
                      
                      <!-- Add Details Button -->
                      <div style="text-align: center; margin-top: 0.5rem;">
                        <a href="javascript:void(0)" 
                           class="btn btn-link btn-sm text-muted px-2 py-1" 
                           id="addDetails_{{ t.id }}"
                           onclick="toggleSmartDetails({{ t.id }})"
                           style="font-size: 0.85rem; text-decoration: none;">
                          <i class="bi bi-plus-circle me-1"></i>Add Details
                        </a>
                      </div>
                      
                    </div>
                  </div>
                </div>
                
                <!-- Smart Suggestions Showcase -->
                
                <!-- Smart Suggestions -->
                {% if t.smart_suggestions %}
                  <div class="mt-3 suggestions-section">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
                      <h6 class="mb-0 text-primary">
                        <i class="fas fa-brain me-2"></i>
                        Smart Suggestions ({{ t.smart_suggestions|length }})
                        <a href="{% url 'bank_rules:list' %}" 
                           class="badge bg-info text-white ms-2" 
                           title="Create rules to automate suggestions"
                           style="text-decoration: none; font-size: 0.7rem;">
                          🎯 Manage Rules
                        </a>
                      </h6>
                      <button class="btn btn-link btn-sm text-muted" type="button" data-bs-toggle="collapse" data-bs-target="#suggestions-{{ t.id }}" aria-expanded="true">
                        <i class="fas fa-chevron-up"></i> Hide
                      </button>
                    </div>
                      
                    <div class="collapse show" id="suggestions-{{ t.id }}">
                      <div style="display: grid; gap: 0.5rem;">
                        {% for suggestion in t.smart_suggestions %}
                        <div class="card suggestion-card {% if suggestion.source == 'ai_pattern' %}border-primary{% endif %}">
                          <div class="card-body p-3">
                            <div style="display: flex; align-items: center; justify-content: space-between; gap: 1rem;">
                              <div style="flex-grow: 1;">
                                <div style="display: flex; align-items: center; margin-bottom: 0.5rem; flex-wrap: wrap; gap: 0.5rem;">
                                  <!-- AI vs Rule Badge -->
                                  {% if suggestion.source == 'ai_pattern' %}
                                    <span class="badge bg-primary" title="AI Pattern Match">
                                      🧠 AI Pattern
                                    </span>
                                    <span class="badge bg-info" title="Confidence Score">
                                      {{ suggestion.confidence|floatformat:0 }}% confident
                                    </span>
                                    {% if suggestion.auto_apply %}
                                    <span class="badge bg-success" title="High confidence - can auto-apply">
                                      ⚡ Auto
                                        </span>
                                        {% endif %}
                                      {% elif suggestion.source == 'bank_rule' %}
                                        <span class="badge bg-success me-2" title="Bank Rule Match">
                                          🎯 Rule
                                        </span>
                                      {% else %}
                                        <span class="badge badge-soft me-2">
                                          {% if suggestion.match_percentage >= 80 %}
                                            <i class="fas fa-check-circle text-success"></i>
                                          {% elif suggestion.match_percentage >= 60 %}
                                            <i class="fas fa-info-circle text-warning"></i>
                                          {% else %}
                                            <i class="fas fa-question-circle text-muted"></i>
                                          {% endif %}
                                          {{ suggestion.match_percentage }}%
                                        </span>
                                      {% endif %}
                                      <strong class="me-2">{{ suggestion.suggested_who_text|default:suggestion.customer_name }}</strong>
                                      <small class="text-muted">{{ suggestion.engine_display_name }}</small>
                                    </div>
                                    <div class="small">
                                      {% if suggestion.source == 'ai_pattern' %}
                                        <!-- AI Pattern Details -->
                                        <div class="text-muted">
                                          <i class="fas fa-brain me-1"></i>
                                          <strong>AI Reason:</strong> {{ suggestion.coa_reason }}
                                        </div>
                                        {% if suggestion.suggested_coa %}
                                        <div class="text-muted">
                                          <i class="fas fa-chart-line me-1"></i>
                                          <strong>Suggested Account:</strong> {{ suggestion.suggested_coa.account_display }}
                                        </div>
                                        {% endif %}
                                      {% else %}
                                        <!-- Loan/Rule Details -->
                                        {% if suggestion.source == 'bank_rule' %}
                                          <!-- Bank Rule Specific Details -->
                                          <div class="text-muted">
                                            <i class="fas fa-gavel me-1"></i>
                                            <strong>Rule:</strong> {{ suggestion.rule_name }}
                                          </div>
                                          {% if suggestion.matched_data %}
                                          <div class="text-muted">
                                            <i class="fas fa-search me-1"></i>
                                            <strong>Matched:</strong> {{ suggestion.matched_data }}
                                          </div>
                                          {% endif %}
                                          {% if suggestion.matched_conditions %}
                                          <div class="text-muted mt-1">
                                            <i class="fas fa-list-check me-1"></i>
                                            <strong>Conditions:</strong>
                                            <ul class="mb-0 mt-1" style="font-size: 0.85em; padding-left: 1.5rem;">
                                              {% for cond in suggestion.matched_conditions %}
                                              <li>
                                                <span class="badge bg-light text-dark me-1">{{ cond.field }}</span>
                                                {{ cond.operator }} 
                                                <span class="text-primary">"{{ cond.value }}"</span>
                                                {% if cond.matched_value %}
                                                <span class="text-muted">(found: "{{ cond.matched_value }}")</span>
                                                {% endif %}
                                              </li>
                                              {% endfor %}
                                            </ul>
                                          </div>
                                          {% endif %}
                                        {% else %}
                                          <!-- Other suggestion types (loan, etc.) -->
                                          {% if suggestion.matched_data %}
                                          <div class="text-muted">
                                            <i class="fas fa-search me-1"></i>
                                            <strong>Detected:</strong> {{ suggestion.matched_data }}
                                          </div>
                                          {% endif %}
                                        {% endif %}
                                        {% if suggestion.match_reason %}
                                        <div class="text-muted">
                                          <i class="fas fa-info-circle me-1"></i>
                                          <strong>Reason:</strong> {{ suggestion.match_reason }}
                                        </div>
                                        {% endif %}
                                        {% if suggestion.coa_reason %}
                                        <div class="text-muted">
                                          <i class="fas fa-info-circle me-1"></i>
                                          <strong>Reason:</strong> {{ suggestion.coa_reason }}
                                        </div>
                                        {% endif %}
                                      {% endif %}
                                      {% if suggestion.loan_number %}
                                      <div class="text-muted">
                                        <i class="fas fa-id-card me-1"></i>
                                        <strong>Loan:</strong> {{ suggestion.loan_number }} 
                                        ({{ suggestion.loan_amount|floatformat:2 }} {{ suggestion.loan_type }})
                                      </div>
                                      {% endif %}
                                      {% if suggestion.suggested_coa and suggestion.source != 'ai_pattern' %}
                                      <div class="text-muted">
                                        <i class="fas fa-chart-line me-1"></i>
                                        <strong>Suggested Account:</strong> {{ suggestion.suggested_coa.account_display }}
                                      </div>
                                      {% endif %}
                                    </div>
                                  </div>
                                  <div class="text-end">
                                    {% if suggestion.source == 'ai_pattern' %}
                                      <!-- AI Pattern Apply Button -->
                                      <button class="btn btn-outline-primary btn-sm" 
                                              onclick="applySuggestion({{ t.id }}, null, '{{ suggestion.suggested_who_text|escapejs }}', {% if suggestion.suggested_coa %}'{{ suggestion.suggested_coa.account_id }}', '{{ suggestion.suggested_coa.account_display|escapejs }}'{% else %}null, null{% endif %}, {{ t.smart_suggestions|length }}, 'ai_pattern', {{ suggestion.pattern_id }}, {{ suggestion.confidence }})">
                                        <i class="fas fa-plus"></i> Apply
                                      </button>
                                    {% else %}
                                      <!-- Loan/Rule Apply Button -->
                                      <button class="btn btn-outline-primary btn-sm" 
                                              onclick="applySuggestion({{ t.id }}, {{ suggestion.loan_id }}, '{{ suggestion.customer_name|escapejs }}', {% if suggestion.suggested_coa %}'{{ suggestion.suggested_coa.account_id }}', '{{ suggestion.suggested_coa.account_display|escapejs }}'{% else %}null, null{% endif %}, {{ t.smart_suggestions|length }}, 'loan', null)">
                                        <i class="fas fa-plus"></i> Apply
                                      </button>
                                    {% endif %}
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>
                          {% endfor %}
                        </div>
                      </div>
                    </div>
                {% endif %}
                <!-- End Smart Suggestions Showcase -->
              </div>
              {% endfor %}
            </div>
            
            <!-- 🚀 Pagination Controls -->
            {% if total_pages > 1 %}
            <div class="border-top p-3">
              <nav aria-label="Transaction pagination">
                <ul class="pagination mb-0 justify-content-center">
                  <!-- Previous Button -->
                  <li class="page-item {% if not has_previous %}disabled{% endif %}">
                    {% if has_previous %}
                    <a class="page-link" href="?page={{ previous_page }}">
                      <i class="fas fa-chevron-left"></i> Previous
                    </a>
                    {% else %}
                    <span class="page-link" tabindex="-1">
                      <i class="fas fa-chevron-left"></i> Previous
                    </span>
                    {% endif %}
                  </li>
                  
                  <!-- Simple page indicator -->
                  <li class="page-item active">
                    <span class="page-link">Page {{ current_page }} of {{ total_pages }}</span>
                  </li>
                  
                  <!-- Next Button -->
                  <li class="page-item {% if not has_next %}disabled{% endif %}">
                    {% if has_next %}
                    <a class="page-link" href="?page={{ next_page }}">
                      Next <i class="fas fa-chevron-right"></i>
                    </a>
                    {% else %}
                    <span class="page-link" tabindex="-1">
                      Next <i class="fas fa-chevron-right"></i>
                    </span>
                    {% endif %}
                  </li>
                </ul>
              </nav>
              
              <!-- Quick Page Jump -->
              <div class="text-center mt-3">
                <form method="get" class="d-inline-flex align-items-center gap-2">
                  <label for="page-jump" class="mb-0 small text-muted">Jump to page:</label>
                  <input type="number" id="page-jump" name="page" class="form-control form-control-sm" style="width: 80px;" min="1" max="{{ total_pages }}" value="{{ current_page }}" placeholder="{{ current_page }}">
                  <button type="submit" class="btn btn-sm btn-outline-primary">Go</button>
                </form>
              </div>
            </div>
            {% endif %}
            
          {% else %}
            <!-- 🚀 FIX: Check total unmatched across ALL pages, not just current page -->
            {% if progress.total_unmatched_all_pages > 0 %}
            <div class="text-center py-5">
              <i class="fas fa-arrow-right text-primary mb-3" style="font-size: 3rem;"></i>
              <h4>Current Page Complete!</h4>
              <p class="text-muted">
                All transactions on this page have been reconciled.<br>
                <strong>{{ progress.total_unmatched_all_pages }} transactions remaining</strong> on other pages.
              </p>
              <a href="?page={{ next_page|default:1 }}" class="btn btn-primary">
                <i class="fas fa-arrow-right"></i> Go to Next Page
              </a>
            </div>
            {% else %}
            <div class="text-center py-5">
              <i class="fas fa-check-circle text-success mb-3" style="font-size: 3rem;"></i>
              <h4>All Transactions Reconciled!</h4>
              <p class="text-muted">Great job! You've completed the reconciliation process.</p>
            </div>
            {% endif %}
          {% endif %}
        </div>
      </div>
    </div>
  </div>

</div> <!-- End reconciliation-page -->

<!-- Link to the external JavaScript file -->
<script src="{% static 'process/js/reconciliation.js' %}"></script>

<!-- Dynamic COA Data as JSON -->
<script>
// Make COA data available globally
window.coaData = [
    {% for group_name, accounts in coa_groups.items %}
        {% for account in accounts %}
        {
            code: '{{ account.code }}',
            name: '{{ account.name }}',
            type: '{{ group_name }}',
            display: '{{ account.code }} — {{ account.name }}'
        },
        {% endfor %}
    {% endfor %}
];

// Fallback COA data if no dynamic data available
if (window.coaData.length === 0) {
    window.coaData = [
        { code: '4001', name: 'Sales Revenue', type: 'Revenue', display: '4001 — Sales Revenue' },
        { code: '4200', name: 'Interest Income', type: 'Revenue', display: '4200 — Interest Income' },
        { code: '6001', name: 'General Expenses', type: 'Expenses', display: '6001 — General Expenses' },
        { code: '6100', name: 'Office Supplies', type: 'Expenses', display: '6100 — Office Supplies' },
        { code: '6200', name: 'Professional Fees', type: 'Expenses', display: '6200 — Professional Fees' }
    ];
}

console.log('📊 COA Data loaded:', window.coaData.length, 'accounts');
</script>

<!-- Additional Simple JavaScript - Matching original UX exactly -->
<script>
// Get CSRF token for AJAX requests - Use cookie method like base template
function getCsrfToken() {
    // Try cookie first
    let token = getCookie('csrftoken');
    
    // Fallback: Try to get from DOM (meta tag or hidden input)
    if (!token) {
        const metaTag = document.querySelector('meta[name="csrf-token"]');
        if (metaTag) {
            token = metaTag.getAttribute('content');
        }
    }
    
    // Fallback: Try hidden input
    if (!token) {
        const input = document.querySelector('input[name="csrfmiddlewaretoken"]');
        if (input) {
            token = input.value;
        }
    }
    
    // Last resort: Try from form
    if (!token) {
        const form = document.querySelector('form');
        if (form) {
            const formToken = form.querySelector('[name="csrfmiddlewaretoken"]');
            if (formToken) {
                token = formToken.value;
            }
        }
    }
    
    return token;
}

// Helper function to get cookie (same as base template)
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// WHO Dropdown function - Exact same as original
window.showWhoDropdown = function(button, transactionId) {
    console.log('🎯 WHO dropdown clicked for transaction:', transactionId);
    
    // Remove existing dropdowns
    document.querySelectorAll('.temp-who-dropdown, .temp-dropdown, .temp-what-dropdown').forEach(d => d.remove());
    
    // Create dropdown
    const dropdown = document.createElement('div');
    dropdown.className = 'temp-who-dropdown position-absolute bg-white border rounded shadow';
    dropdown.style.cssText = 'z-index: 9999; top: 100%; left: 0; min-width: 250px; max-height: 300px; overflow-y: auto; margin-top: 2px;';
    
    // Dynamic active loans for current company only
    {% if loan_customers %}
    const loans = [
        {% for loan_info in loan_customers %}
        {
            loan_id: {{ loan_info.loan_id }},
            loan_number: '{{ loan_info.loan_number|escapejs }}',
            customer_name: '{{ loan_info.customer_name|escapejs }}',
            customer_id: {{ loan_info.customer_id }},
            loan_amount: {{ loan_info.loan_amount|default:0 }},
            loan_type: '{{ loan_info.loan_type|default:""|escapejs }}',
            display_text: '{{ loan_info.display_text|escapejs }}',
            display_detail: '{{ loan_info.display_detail|escapejs }}',
            phone: '{{ loan_info.phone|default:""|escapejs }}',
            national_id: '{{ loan_info.national_id|default:""|escapejs }}',
            vehicle_plates: {{ loan_info.vehicle_plates|safe }},
            vehicle_info: {{ loan_info.vehicle_info|safe }}
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];
    
    dropdown.innerHTML = `
        <div class="p-2 border-bottom bg-light fw-bold">{{ company.name }} - Active Loans</div>
        ${loans.map(loan => `
            <div class="p-2" style="cursor: pointer;" 
                 onmouseover="this.style.background='#f8f9fa'" 
                 onmouseout="this.style.background='white'"
                 onclick="selectWhoLoan_simple('${loan.display_text}', ${transactionId}, ${loan.loan_id})">
                <div class="fw-bold">${loan.display_text}</div>
                <small class="text-muted">${loan.display_detail}</small>
                <small class="text-muted d-block">
                    ID: ${loan.national_id} | Phone: ${loan.phone}
                    ${loan.vehicle_plates.length > 0 ? ' | Plates: ' + loan.vehicle_plates.join(', ') : ''}
                </small>
            </div>
        `).join('')}
    `;
    {% else %}
    dropdown.innerHTML = `
        <div class="p-2 border-bottom bg-light fw-bold">{{ company.name }} - Active Loans</div>
        <div class="p-2 text-muted">No active loans found for {{ company.name }}</div>
    `;
    {% endif %}
    
    // Position dropdown
    const container = button.parentElement;
    container.style.position = 'relative';
    container.appendChild(dropdown);
    
    // Add click-outside-to-close functionality
    setTimeout(() => {
        document.addEventListener('click', function closeDropdown(e) {
            if (!dropdown.contains(e.target) && !button.contains(e.target)) {
                dropdown.remove();
                document.removeEventListener('click', closeDropdown);
            }
        });
    }, 100); // Small delay to prevent immediate closure
    
    return false;
};

window.selectWhoLoan_simple = function(loanDisplayText, transactionId, loanId) {
    console.log('✅ Selected loan:', loanDisplayText, 'for transaction:', transactionId, 'loan ID:', loanId);
    
    // Find and populate WHO input
    const whoInput = document.querySelector(`[data-transaction-id="${transactionId}"] .who-input`);
    if (whoInput) {
        whoInput.value = loanDisplayText;
        whoInput.setAttribute('data-loan-id', loanId); // Store loan ID for reconciliation
        console.log('✅ Set WHO input to:', loanDisplayText);
    }
    
    // Remove all dropdowns
    document.querySelectorAll('.temp-who-dropdown, .temp-dropdown, .temp-what-dropdown').forEach(d => d.remove());
    
    // Check if successful match and show OK button
    checkForSuccessfulMatch(transactionId);
};

window.selectWhoCustomer_simple = function(customerName, transactionId) {
    console.log('✅ Selected customer:', customerName, 'for transaction:', transactionId);
    
    // Find and populate WHO input
    const whoInput = document.querySelector(`[data-transaction-id="${transactionId}"] .who-input`);
    if (whoInput) {
        whoInput.value = customerName;
        console.log('✅ Set WHO input to:', customerName);
    }
    
    // Remove all dropdowns
    document.querySelectorAll('.temp-who-dropdown, .temp-dropdown, .temp-what-dropdown').forEach(d => d.remove());
    
    // Check if successful match and show OK button
    checkForSuccessfulMatch(transactionId);
};

// WHAT Dropdown function - Uses dynamic COA data
window.showWhatDropdown = function(button, transactionId) {
    console.log('🎯 WHAT dropdown clicked for transaction:', transactionId);
    
    // Remove existing dropdowns
    document.querySelectorAll('.temp-what-dropdown, .temp-dropdown, .temp-who-dropdown').forEach(d => d.remove());
    
    // Create dropdown
    const dropdown = document.createElement('div');
    dropdown.className = 'temp-what-dropdown position-absolute bg-white border rounded shadow';
    dropdown.style.cssText = 'z-index: 9999; top: 100%; left: 0; min-width: 300px; max-height: 400px; overflow-y: auto; margin-top: 2px;';
    
    // Group accounts by type
    const groupedAccounts = {};
    window.coaData.forEach(account => {
        if (!groupedAccounts[account.type]) {
            groupedAccounts[account.type] = [];
        }
        groupedAccounts[account.type].push(account);
    });
    
    // Build dropdown content
    let dropdownContent = '<div class="p-2 border-bottom bg-light fw-bold">Chart of Accounts</div>';
    
    Object.keys(groupedAccounts).forEach(groupName => {
        dropdownContent += `<div class="p-2 bg-secondary text-white fw-bold small">${groupName}</div>`;
        groupedAccounts[groupName].forEach(account => {
            dropdownContent += `<div class="p-2 ps-3" style="cursor: pointer;" 
                 onmouseover="this.style.background='#f8f9fa'" 
                 onmouseout="this.style.background='white'"
                 onclick="selectWhatAccount_simple('${account.display}', ${transactionId})">${account.display}</div>`;
        });
    });
    
    if (Object.keys(groupedAccounts).length === 0) {
        dropdownContent += '<div class="p-2 text-muted">No accounts found</div>';
    }
    
    dropdown.innerHTML = dropdownContent;
    
    // Position dropdown
    const container = button.parentElement;
    container.style.position = 'relative';
    container.appendChild(dropdown);
    
    // Add click-outside-to-close functionality
    setTimeout(() => {
        document.addEventListener('click', function closeDropdown(e) {
            if (!dropdown.contains(e.target) && !button.contains(e.target)) {
                dropdown.remove();
                document.removeEventListener('click', closeDropdown);
            }
        });
    }, 100); // Small delay to prevent immediate closure
    
    return false;
};

window.selectWhatAccount_simple = function(accountName, transactionId) {
    console.log('✅ Selected account:', accountName, 'for transaction:', transactionId);
    
    // Find and populate WHAT input
    const whatInput = document.querySelector(`[data-transaction-id="${transactionId}"] .what-input`);
    if (whatInput) {
        whatInput.value = accountName;
        console.log('✅ Set WHAT input to:', accountName);
    }
    
    // Remove all dropdowns
    document.querySelectorAll('.temp-what-dropdown, .temp-dropdown, .temp-who-dropdown').forEach(d => d.remove());
    
    // Check if successful match and show OK button
    checkForSuccessfulMatch(transactionId);
};

// Save individual transaction
function saveTransaction(transactionId) {
    const whoInput = document.querySelector(`[data-transaction-id="${transactionId}"] .who-input`);
    const whatInput = document.querySelector(`[data-transaction-id="${transactionId}"] .what-input`);
    const whyInput = document.querySelector(`[data-transaction-id="${transactionId}"] .why-input`);
    
    if (!whoInput.value.trim() || !whatInput.value.trim()) {
        alert('Please fill in WHO and WHAT fields');
        return;
    }

    // Get CSRF token with error handling
    const csrfToken = getCsrfToken();
    if (!csrfToken) {
        alert('❌ CSRF token not found. Please refresh the page.');
        return;
    }
    
    const saveButton = document.getElementById('save' + transactionId);
    saveButton.disabled = true;
    saveButton.innerHTML = '<i class="spinner-border spinner-border-sm me-1"></i>Saving...';
    
    // 🧠 Extract AI suggestion data from input fields (if AI pattern was applied)
    const patternId = whoInput.getAttribute('data-pattern-id');
    const suggestionSource = whoInput.getAttribute('data-suggestion-source');
    const confidence = whoInput.getAttribute('data-confidence');
    const suggestedWho = whoInput.getAttribute('data-suggested-who');
    const suggestedWhatId = whatInput.getAttribute('data-suggested-what-id');
    
    console.log('🔍 DEBUG: Checking for AI suggestion data:', {
        patternId,
        suggestionSource,
        confidence,
        suggestedWho,
        suggestedWhatId
    });
    
    // Build AI suggestion data object (only if AI pattern was used)
    let aiSuggestion = null;
    let userAction = 'manual'; // Default: manual entry
    
    if (suggestionSource === 'ai_pattern' && patternId) {
        aiSuggestion = {
            pattern_id: parseInt(patternId),
            confidence: parseFloat(confidence) || 0,
            suggested_who: suggestedWho,
            suggested_what_id: parseInt(suggestedWhatId)
        };
        
        // Determine if user accepted suggestion as-is or modified it
        const whoChanged = whoInput.value.trim().toLowerCase() !== (suggestedWho || '').toLowerCase();
        const whatAccountId = whatInput.getAttribute('data-account-id');
        const whatChanged = whatAccountId && parseInt(whatAccountId) !== parseInt(suggestedWhatId);
        
        if (whoChanged || whatChanged) {
            userAction = 'modified'; // User changed the suggestion
        } else {
            userAction = 'accepted'; // User accepted suggestion as-is
        }
        
        console.log('🧠 AI Feedback detected:', { aiSuggestion, userAction, whoChanged, whatChanged });
    } else {
        console.log('⚠️ No AI suggestion detected (manual entry)');
    }
    
    // Send AJAX request
    fetch('/reconciliation/ajax/simple-match-transaction/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
            transaction_id: transactionId,
            who: whoInput.value.trim(),
            what: whatInput.value.trim(),
            why: whyInput.value.trim(),
            ai_suggestion: aiSuggestion,  // 🧠 Send AI suggestion data
            user_action: userAction        // 🧠 Send user action
        })
    })
    .then(response => response.json())
    .then(data => {
        console.log('📨 Server response:', data);
        
        if (data.success) {
            // 🎉 Show AI feedback if available
            if (data.ai_feedback) {
                console.log('🎯 AI Feedback received from server:', data.ai_feedback);
                const feedback = data.ai_feedback;
                let feedbackMessage = '';
                let feedbackType = 'info';
                
                if (feedback.action === 'accepted') {
                    feedbackMessage = `🎯 AI learned! Pattern accepted (${feedback.confidence}% confident)`;
                    feedbackType = 'success';
                } else if (feedback.action === 'modified') {
                    feedbackMessage = `🧠 AI learning: You changed ${feedback.what_changed}`;
                    feedbackType = 'warning';
                } else if (feedback.action === 'rejected') {
                    feedbackMessage = `📚 AI learning: Pattern needs improvement`;
                    feedbackType = 'info';
                }
                
                if (feedbackMessage) {
                    console.log('📢 Showing toast:', feedbackMessage);
                    showToast(feedbackMessage, feedbackType);
                }
            } else {
                console.log('ℹ️ No AI feedback in response');
            }
            
            // 🔄 Update pattern count in real-time
            if (data.pattern_stats) {
                console.log('📊 Pattern stats received:', data.pattern_stats);
                updatePatternStats(data.pattern_stats);
            } else {
                console.log('ℹ️ No pattern stats in response');
            }
            
            // Smooth transition: fade out and slide up using CSS classes
            const transactionItem = document.querySelector(`[data-transaction-id="${transactionId}"]`);
            
            // Step 1: Add saving effect briefly
            transactionItem.classList.add('saving');
            
            // Step 2: After a brief moment, start completion animation
            setTimeout(() => {
                transactionItem.classList.remove('saving');
                transactionItem.classList.add('completed');
                
                // ✅ NEW: Fetch real-time progress from server (single source of truth)
                updateProgressFromServer();
                
                // Completely remove from DOM after CSS transition completes
                setTimeout(() => {
                    transactionItem.remove();
                }, 600); // Match CSS transition duration
            }, 200);
            
            console.log('✅ Transaction successfully saved and hidden:', transactionId);
        } else {
            alert('❌ Error: ' + data.error);
            saveButton.disabled = false;
            saveButton.innerHTML = 'OK';
        }
    })
    .catch(error => {
        console.error('Save error:', error);
        alert('❌ Network error occurred');
        saveButton.disabled = false;
        saveButton.innerHTML = 'OK';
    });
}

// Check if transaction has successful match (WHO and WHAT filled) and show OK button
function checkForSuccessfulMatch(transactionId) {
    const whoInput = document.querySelector(`[data-transaction-id="${transactionId}"] .who-input`);
    const whatInput = document.querySelector(`[data-transaction-id="${transactionId}"] .what-input`);
    const okButton = document.getElementById('save' + transactionId);
    
    if (whoInput && whatInput && okButton) {
        const hasWho = whoInput.value.trim() !== '';
        const hasWhat = whatInput.value.trim() !== '';
        
        if (hasWho && hasWhat) {
            // Successful match - show blue OK button
            okButton.style.display = 'block';
            okButton.style.opacity = '1';
            okButton.disabled = false;
            okButton.className = 'btn btn-primary btn-lg ok-btn';
            okButton.innerHTML = 'OK';
            console.log('✅ Successful match detected for transaction:', transactionId);
        } else {
            // No match yet - hide button
            okButton.style.display = 'none';
            console.log('⏳ Waiting for complete match for transaction:', transactionId);
        }
    }
}

// Update reconciliation progress tracking in real-time
function updateReconciliationProgress(transactionItem = null) {
    // Extract transaction amount if transaction item is provided
    let transactionAmount = 0;
    if (transactionItem) {
        const amountElement = transactionItem.querySelector('.amount-pos, .amount-neg');
        if (amountElement) {
            const amountText = amountElement.textContent.replace(/[+\-$,]/g, '').trim();
            transactionAmount = parseFloat(amountText) || 0;
            // Keep the original sign from the CSS class
            if (amountElement.classList.contains('amount-neg')) {
                transactionAmount = -Math.abs(transactionAmount);
            } else {
                transactionAmount = Math.abs(transactionAmount);
            }
        }
    }
}
    
// 🆕 NEW APPROACH: Fetch real-time progress from server after each save
function updateProgressFromServer() {
    const accountId = parseInt('{{ account.id }}') || 0;
    console.log('🔍 DEBUG: accountId from template =', accountId, '| Template value: {{ account.id }}');
    if (!accountId) {
        console.error('Account ID not found');
        return;
    }
    
    fetch(`/reconciliation/ajax/progress/${accountId}/`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const progress = data.progress;
                const status = data.status;
                
                // Update all progress elements with SERVER data (single source of truth)
                const newCompleted = progress.matched_transactions;
                const newRemaining = progress.unmatched_transactions;
                const total = progress.total_transactions;
                const percentage = progress.percentage;
                
                console.log(`🔄 Server Progress: ${newCompleted}/${total} (${percentage}%) | Remaining: ${newRemaining}`);
                
                // Update progress bar
                const progressBar = document.querySelector('.progress-bar');
                if (progressBar) {
                    progressBar.style.width = `${percentage}%`;
                    progressBar.setAttribute('aria-valuenow', percentage);
                }
                
                // Update badges
                const completedBadge = document.querySelector('.badge.bg-success');
                const remainingBadge = document.querySelector('.badge.bg-warning');
                if (completedBadge) {
                    completedBadge.textContent = `${newCompleted.toLocaleString()} Completed`;
                }
                if (remainingBadge) {
                    remainingBadge.textContent = `${newRemaining.toLocaleString()} Remaining`;
                }
                
                // Update transaction count in header
                const transactionCountSpan = document.querySelector('.transaction-count');
                const transactionListTitle = document.querySelector('.transaction-list-title');
                if (transactionCountSpan) {
                    transactionCountSpan.textContent = newRemaining;
                }
                
                // Check completion status
                if (status.is_complete) {
                    // ALL transactions reconciled across ALL pages
                    if (transactionListTitle) {
                        transactionListTitle.innerHTML = '<i class="fas fa-check-circle text-success me-2"></i>All Transactions Reconciled!';
                    }
                    
                    // Show celebration
                    setTimeout(() => {
                        const progressContainer = document.querySelector('.reconciliation-progress');
                        if (progressContainer) {
                            progressContainer.innerHTML = `
                                <div class="text-center py-3">
                                    <i class="fas fa-check-circle text-success mb-2" style="font-size: 2rem;"></i>
                                    <div class="fw-bold text-success">🎉 All Transactions Reconciled!</div>
                                    <div class="text-muted small mt-1">Great job! You've completed the reconciliation process.</div>
                                </div>
                            `;
                        }
                    }, 1000);
                } else if (newRemaining > 0) {
                    // Still have work remaining
                    const visibleTransactions = document.querySelectorAll('.transaction-item').length;
                    
                    if (visibleTransactions === 0 && newRemaining > 0) {
                        // Current page complete, but more on other pages
                        if (transactionListTitle) {
                            transactionListTitle.innerHTML = '<i class="fas fa-arrow-right text-primary me-2"></i>Page Complete - Move to Next Page';
                        }
                        
                        // Show next page button
                        setTimeout(() => {
                            const progressContainer = document.querySelector('.reconciliation-progress');
                            if (progressContainer) {
                                const nextPage = parseInt('{{ next_page|default:1 }}') || 1;
                                progressContainer.innerHTML = `
                                    <div class="text-center py-3">
                                        <i class="fas fa-arrow-right text-primary mb-2" style="font-size: 2rem;"></i>
                                        <div class="fw-bold text-primary">✅ Page Complete!</div>
                                        <div class="text-muted small mt-1">${newRemaining} transactions remaining on other pages.</div>
                                        <a href="?page=${nextPage}" class="btn btn-sm btn-primary mt-2">
                                            <i class="fas fa-arrow-right"></i> Continue to Next Page
                                        </a>
                                    </div>
                                `;
                            }
                        }, 1000);
                    }
                }
                
                // Update balances
                updateBalanceDisplay(progress);
            }
        })
        .catch(error => {
            console.error('Error fetching progress:', error);
        });
}

function updateBalanceDisplay(progress) {
    const reconciledBalanceElement = document.querySelector('.balance-metric .value.text-info');
    const differenceElement = document.querySelector('.balance-metric .value.text-warning, .balance-metric .value.text-success');
    
    if (reconciledBalanceElement) {
        reconciledBalanceElement.textContent = '$' + progress.reconciled_balance.toLocaleString('en-US', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
        
        // Update difference
        if (differenceElement) {
            differenceElement.textContent = '$' + Math.abs(progress.difference).toLocaleString('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
            differenceElement.className = progress.difference === 0 ? 'value text-success' : 'value text-warning';
        }
        
        // Add animation
        reconciledBalanceElement.classList.add('updated');
        setTimeout(() => reconciledBalanceElement.classList.remove('updated'), 600);
    }
}

// OLD MANUAL CALCULATION (DEPRECATED - keeping for reference)
function updateProgressManually_OLD_DEPRECATED(transactionAmount) {
    // This function is NO LONGER USED - replaced by updateProgressFromServer()
    // Kept here for reference only
    
    // Get current progress elements
    const currentCompletedElement = document.querySelector('.reconciliation-progress .fw-bold.text-success');
    const currentRemainingElement = document.querySelector('.reconciliation-progress .fw-bold.text-warning');
    const progressInfoSpan = document.querySelector('.progress-info .text-muted');
    const progressBar = document.querySelector('.progress-bar');
    const completedBadge = document.querySelector('.badge.bg-success');
    const remainingBadge = document.querySelector('.badge.bg-warning');
    const reconciliationPercentage = document.querySelector('.balance-metric .value.text-success');
    const reconciledBalanceElement = document.querySelector('.balance-metric .value.text-info');
    const differenceElement = document.querySelector('.balance-metric .value.text-warning, .balance-metric .value.text-success');
    const transactionCountSpan = document.querySelector('.transaction-count');
    const transactionListTitle = document.querySelector('.transaction-list-title');
    
    if (currentCompletedElement && currentRemainingElement) {
        // Get current values
        const currentCompleted = parseInt(currentCompletedElement.textContent.replace(/,/g, '')) || 0;
        const currentRemaining = parseInt(currentRemainingElement.textContent.replace(/,/g, '')) || 0;
        
        // Calculate new values (increment completed by 1, decrement remaining by 1)
        const newCompleted = currentCompleted + 1;
        const newRemaining = Math.max(0, currentRemaining - 1);
        const total = newCompleted + newRemaining;
        const percentage = total > 0 ? Math.min(100, (newCompleted / total) * 100) : 0;
        
        console.log(`🔄 Progress Update: ${newCompleted}/${total} (${percentage.toFixed(1)}%) | Transaction Amount: $${transactionAmount}`);
        
        // Update progress bar with animation
        if (progressBar) {
            progressBar.style.width = `${percentage.toFixed(1)}%`;
            progressBar.setAttribute('aria-valuenow', percentage.toFixed(1));
        }
        
        // Update badges
        if (completedBadge) {
            completedBadge.textContent = `${newCompleted.toLocaleString()} Completed`;
        }
        if (remainingBadge) {
            remainingBadge.textContent = `${newRemaining.toLocaleString()} Remaining`;
        }
        
        // Update detailed progress statistics with animation
        currentCompletedElement.textContent = newCompleted.toLocaleString();
        currentCompletedElement.classList.add('updated');
        setTimeout(() => currentCompletedElement.classList.remove('updated'), 600);
        
        currentRemainingElement.textContent = newRemaining.toLocaleString();
        currentRemainingElement.classList.add('updated');
        setTimeout(() => currentRemainingElement.classList.remove('updated'), 600);
        
        // Update progress info text
        if (progressInfoSpan) {
            progressInfoSpan.textContent = `${newCompleted.toLocaleString()} of ${total.toLocaleString()} transactions`;
        }
        
        // Update main reconciliation percentage in balance banner
        if (reconciliationPercentage) {
            reconciliationPercentage.textContent = `${percentage.toFixed(0)}%`;
        }
        
        // Update reconciled balance
        if (reconciledBalanceElement && transactionAmount !== 0) {
            const currentBalanceText = reconciledBalanceElement.textContent.replace(/[$,]/g, '');
            const currentBalance = parseFloat(currentBalanceText) || 0;
            const newBalance = currentBalance + transactionAmount;
            
            // Format with commas and update
            reconciledBalanceElement.textContent = '$' + newBalance.toLocaleString('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
            
            // Update difference (Statement Balance - Reconciled Balance)
            if (differenceElement && differenceElement.parentElement.querySelector('.label').textContent === 'Difference') {
                const statementBalanceElement = document.querySelector('.balance-metric .value.text-primary');
                if (statementBalanceElement) {
                    const statementBalanceText = statementBalanceElement.textContent.replace(/[$,]/g, '');
                    const statementBalance = parseFloat(statementBalanceText) || 0;
                    const difference = statementBalance - newBalance;
                    
                    differenceElement.textContent = '$' + difference.toLocaleString('en-US', {
                        minimumFractionDigits: 2,
                        maximumFractionDigits: 2
                    });
                    
                    // Update difference color class
                    differenceElement.className = difference === 0 ? 'value text-success' : 'value text-warning';
                }
            }
            
            // Add update animation to balance
            reconciledBalanceElement.classList.add('updated');
            setTimeout(() => reconciledBalanceElement.classList.remove('updated'), 600);
        }
        
        // Update transaction count in header
        if (transactionCountSpan) {
            const currentCount = parseInt(transactionCountSpan.textContent) || 0;
            const newCount = Math.max(0, currentCount - 1);
            transactionCountSpan.textContent = newCount;
            
            // 🚀 FIX: Only show "All Complete" if we're on the last page with 0 remaining
            // Don't show it if there are other pages with transactions
            const totalUnmatchedAllPages = parseInt('{{ progress.total_unmatched_all_pages|default:0 }}') || 0;
            const currentPage = parseInt('{{ current_page|default:1 }}') || 1;
            const totalPages = parseInt('{{ total_pages|default:1 }}') || 1;
            const isLastPage = currentPage === totalPages;
            
            // Update header title when current page is complete
            if (newCount === 0 && transactionListTitle) {
                if (totalUnmatchedAllPages > 1 && !isLastPage) {
                    // Still have transactions on other pages
                    transactionListTitle.innerHTML = '<i class="fas fa-arrow-right text-primary me-2"></i>Page Complete - Move to Next Page';
                } else if (newCount === 0) {
                    // Truly all done
                    transactionListTitle.innerHTML = '<i class="fas fa-check-circle text-success me-2"></i>All Transactions Reconciled!';
                }
            }
        }
        
        // Show completion celebration only if ALL transactions across ALL pages are done
        const totalUnmatchedGlobal = parseInt('{{ progress.total_unmatched_all_pages|default:0 }}') || 0;
        if (newRemaining === 0 && total > 0 && totalUnmatchedGlobal <= 1) {
            setTimeout(() => {
                const progressContainer = document.querySelector('.reconciliation-progress');
                if (progressContainer) {
                    progressContainer.innerHTML = `
                        <div class="text-center py-3">
                            <i class="fas fa-check-circle text-success mb-2" style="font-size: 2rem;"></i>
                            <div class="fw-bold text-success">🎉 All Transactions Reconciled!</div>
                            <div class="text-muted small mt-1">Great job! You've completed the reconciliation process.</div>
                        </div>
                    `;
                }
            }, 1000);
        } else if (newRemaining === 0 && totalUnmatchedGlobal > 1) {
            // Show "Page Complete" message with next page link
            setTimeout(() => {
                const progressContainer = document.querySelector('.reconciliation-progress');
                if (progressContainer) {
                    const nextPage = parseInt('{{ next_page|default:1 }}') || 1;
                    progressContainer.innerHTML = `
                        <div class="text-center py-3">
                            <i class="fas fa-arrow-right text-primary mb-2" style="font-size: 2rem;"></i>
                            <div class="fw-bold text-primary">✅ Page Complete!</div>
                            <div class="text-muted small mt-1">${totalUnmatchedGlobal} transactions remaining on other pages.</div>
                            <a href="?page=${nextPage}" class="btn btn-sm btn-primary mt-2">
                                <i class="fas fa-arrow-right"></i> Continue to Next Page
                            </a>
                        </div>
                    `;
                }
            }, 1000);
        }
    }
}

// Auto-save when typing (debounced) + Auto-suggestions
document.addEventListener('input', function(e) {
    if (e.target.matches('.who-input, .what-input, .why-input')) {
        // Get transaction ID from the input's parent container
        const transactionContainer = e.target.closest('[data-transaction-id]');
        if (transactionContainer) {
            const transactionId = transactionContainer.getAttribute('data-transaction-id');
            
            // Auto-suggestions for WHO input
            if (e.target.matches('.who-input')) {
                showWhoAutoSuggestions(e.target, transactionId);
                
                // Check for successful match when WHO field changes
                clearTimeout(window.matchTimeout);
                window.matchTimeout = setTimeout(() => {
                    checkForSuccessfulMatch(transactionId);
                }, 300);
            }
            
            // Auto-suggestions for WHAT input
            if (e.target.matches('.what-input')) {
                showWhatAutoSuggestions(e.target, transactionId);
                
                // Check for successful match when WHAT field changes
                clearTimeout(window.matchTimeout);
                window.matchTimeout = setTimeout(() => {
                    checkForSuccessfulMatch(transactionId);
                }, 300);
            }
        }
        
        console.log('Input changed:', e.target.value);
    }
});

// WHO Auto-suggestions
function showWhoAutoSuggestions(input, transactionId) {
    const value = input.value.toLowerCase().trim();
    
    // Remove existing suggestions
    document.querySelectorAll('.auto-suggestion-who').forEach(d => d.remove());
    
    if (value.length < 2) return; // Only show suggestions after 2 characters
    
    // Filter loans based on input - current company only
    {% if loan_customers %}
    const loans = [
        {% for loan_info in loan_customers %}
        {
            loan_id: {{ loan_info.loan_id }},
            loan_number: '{{ loan_info.loan_number|escapejs }}',
            customer_name: '{{ loan_info.customer_name|escapejs }}',
            customer_id: {{ loan_info.customer_id }},
            display_text: '{{ loan_info.display_text|escapejs }}',
            display_detail: '{{ loan_info.display_detail|escapejs }}',
            phone: '{{ loan_info.phone|default:""|escapejs }}',
            national_id: '{{ loan_info.national_id|default:""|escapejs }}',
            vehicle_plates: {{ loan_info.vehicle_plates|safe }},
            vehicle_info: {{ loan_info.vehicle_info|safe }}
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];
    
    const filtered = loans.filter(loan => 
        loan.customer_name.toLowerCase().includes(value) || 
        loan.loan_number.toLowerCase().includes(value) ||
        loan.phone.toLowerCase().includes(value) ||
        loan.national_id.toLowerCase().includes(value) ||
        loan.vehicle_plates.some(plate => {
            // Flexible plate matching - remove formatting for search
            const cleanPlate = plate.replace(/[-\s]/g, '').toLowerCase();
            const cleanValue = value.replace(/[-\s]/g, '').toLowerCase();
            return cleanPlate.includes(cleanValue);
        })
    );
    
    if (filtered.length > 0) {
        const suggestions = document.createElement('div');
        suggestions.className = 'auto-suggestion-who position-absolute bg-white border rounded shadow';
        suggestions.style.cssText = 'z-index: 9998; top: 100%; left: 0; right: 0; max-height: 200px; overflow-y: auto; margin-top: 2px;';
        
        suggestions.innerHTML = filtered.slice(0, 5).map(loan => `
            <div class="p-2" style="cursor: pointer;" 
                 onmouseover="this.style.background='#f8f9fa'" 
                 onmouseout="this.style.background='white'"
                 onclick="selectWhoSuggestion('${loan.display_text}', ${transactionId}, ${loan.loan_id})">
                <div class="fw-bold small">${loan.display_text}</div>
                <small class="text-muted">${loan.display_detail}</small>
                ${loan.vehicle_plates.length > 0 ? 
                    `<small class="text-muted d-block">Plates: ${loan.vehicle_plates.join(', ')}</small>` : ''
                }
            </div>
        `).join('');
        
        input.parentElement.style.position = 'relative';
        input.parentElement.appendChild(suggestions);
        
        // Auto-close suggestions
        setTimeout(() => {
            document.addEventListener('click', function closeSuggestions(e) {
                if (!suggestions.contains(e.target) && e.target !== input) {
                    suggestions.remove();
                    document.removeEventListener('click', closeSuggestions);
                }
            });
        }, 100);
    }
    {% endif %}
}

// WHAT Auto-suggestions
function showWhatAutoSuggestions(input, transactionId) {
    const value = input.value.toLowerCase().trim();
    
    // Remove existing suggestions
    document.querySelectorAll('.auto-suggestion-what').forEach(d => d.remove());
    
    if (value.length < 2) return; // Only show suggestions after 2 characters
    
    // Filter accounts based on input
    const filtered = window.coaData.filter(account => 
        account.name.toLowerCase().includes(value) || 
        account.code.toLowerCase().includes(value) ||
        account.display.toLowerCase().includes(value)
    );
    
    if (filtered.length > 0) {
        const suggestions = document.createElement('div');
        suggestions.className = 'auto-suggestion-what position-absolute bg-white border rounded shadow';
        suggestions.style.cssText = 'z-index: 9998; top: 100%; left: 0; right: 0; max-height: 200px; overflow-y: auto; margin-top: 2px;';
        
        suggestions.innerHTML = filtered.slice(0, 5).map(account => `
            <div class="p-2" style="cursor: pointer;" 
                 onmouseover="this.style.background='#f8f9fa'" 
                 onmouseout="this.style.background='white'"
                 onclick="selectWhatSuggestion('${account.display}', ${transactionId})">
                <div class="fw-bold small">${account.display}</div>
                <small class="text-muted">${account.type}</small>
            </div>
        `).join('');
        
        input.parentElement.style.position = 'relative';
        input.parentElement.appendChild(suggestions);
        
        // Auto-close suggestions
        setTimeout(() => {
            document.addEventListener('click', function closeSuggestions(e) {
                if (!suggestions.contains(e.target) && e.target !== input) {
                    suggestions.remove();
                    document.removeEventListener('click', closeSuggestions);
                }
            });
        }, 100);
    }
}

// Selection functions for auto-suggestions
function selectWhoSuggestion(loanDisplayText, transactionId, loanId) {
    const whoInput = document.querySelector(`[data-transaction-id="${transactionId}"] .who-input`);
    if (whoInput) {
        whoInput.value = loanDisplayText;
        if (loanId) {
            whoInput.setAttribute('data-loan-id', loanId); // Store loan ID for reconciliation
        }
    }
    document.querySelectorAll('.auto-suggestion-who').forEach(d => d.remove());
    checkForSuccessfulMatch(transactionId);
}

function selectWhatSuggestion(accountName, transactionId) {
    const whatInput = document.querySelector(`[data-transaction-id="${transactionId}"] .what-input`);
    if (whatInput) {
        whatInput.value = accountName;
    }
    document.querySelectorAll('.auto-suggestion-what').forEach(d => d.remove());
    checkForSuccessfulMatch(transactionId);
}

console.log('✅ Simple reconciliation interface loaded - UX exactly matching original');

// Initialize all OK buttons - hide them initially until successful match
document.addEventListener('DOMContentLoaded', function() {
    // Hide all OK buttons initially
    document.querySelectorAll('[id^="save"]').forEach(button => {
        button.style.display = 'none';
    });
    
    // Check existing matches on page load
    document.querySelectorAll('[data-transaction-id]').forEach(container => {
        const transactionId = container.getAttribute('data-transaction-id');
        checkForSuccessfulMatch(transactionId);
    });
});

// Smart Details Toggle Function - Split Transaction Modal (EXACT COPY FROM ORIGINAL)
function toggleSmartDetails(transactionId) {
    console.log('Opening split transaction modal for transaction:', transactionId);
    
    // Get transaction data from DOM elements
    const transactionElement = document.querySelector(`[data-transaction-id="${transactionId}"]`);
    
    let transactionData = {
      id: transactionId,
      description: '',
      amount: '0.00',
      payee: '',
      date: new Date().toISOString().split('T')[0], // Default to today
      reference: ''
    };
    
    // Extract actual transaction data from the DOM
    if (transactionElement) {
      const descElement = transactionElement.querySelector('.txn-title');
      const amountElement = transactionElement.querySelector('.amount-pos, .amount-neg');
      const dateElement = transactionElement.querySelector('.txn-date');
      const refElement = transactionElement.querySelector('.txn-meta');
      const whoInput = transactionElement.querySelector(`input[name="who_text_${transactionId}"]`);
      const whatInput = transactionElement.querySelector(`input[name="what_text_${transactionId}"]`);
      const whyInput = transactionElement.querySelector(`input[name="why_${transactionId}"]`);
      
      if (descElement) transactionData.description = descElement.textContent.trim() || 'Split Transaction';
      if (amountElement) {
        const amountText = amountElement.textContent.replace(/[+\-$,]/g, '').trim();
        transactionData.amount = amountText || '0.00';
      }
      if (dateElement) {
        // Extract date from "8 Sep 2024" format
        const dateText = dateElement.textContent.trim();
        const dateMatch = dateText.match(/(\d{1,2})\s+(\w{3})\s+(\d{4})/);
        if (dateMatch) {
          const months = {'Jan':1, 'Feb':2, 'Mar':3, 'Apr':4, 'May':5, 'Jun':6, 'Jul':7, 'Aug':8, 'Sep':9, 'Oct':10, 'Nov':11, 'Dec':12};
          const day = dateMatch[1].padStart(2, '0');
          const month = months[dateMatch[2]].toString().padStart(2, '0');
          const year = dateMatch[3];
          transactionData.date = `${year}-${month}-${day}`;
        }
      }
      if (refElement) {
        const refText = refElement.textContent.trim();
        transactionData.reference = refText.replace('Ref: ', '').replace('—', '').trim();
      }
      if (whoInput) transactionData.payee = whoInput.value || '';
      if (whatInput) transactionData.whatAccount = whatInput.value || '';
      if (whyInput) transactionData.description = whyInput.value || transactionData.description;
    }
    
    // Ensure all fields have valid values
    transactionData.description = transactionData.description || 'Split Transaction';
    transactionData.amount = transactionData.amount || '0.00';
    transactionData.payee = transactionData.payee || '';
    transactionData.reference = transactionData.reference || '';
    
    console.log('Transaction data prepared:', transactionData);
    
    // Show the split transaction modal
    showSplitTransactionModal(transactionData);
}

// Show Split Transaction Modal (EXACT COPY FROM ORIGINAL)
function showSplitTransactionModal(transactionData) {
    // Sanitize and format data for display
    const sanitizedData = {
      id: transactionData.id || 0,
      description: (transactionData.description || 'Split Transaction').replace(/"/g, '&quot;'),
      amount: parseFloat(transactionData.amount || 0).toFixed(2),
      payee: (transactionData.payee || '').replace(/"/g, '&quot;'),
      date: transactionData.date || new Date().toISOString().split('T')[0],
      reference: (transactionData.reference || '').replace(/"/g, '&quot;')
    };
    
    // Create modal backdrop
    const backdrop = document.createElement('div');
    backdrop.className = 'modal-backdrop fade show';
    backdrop.style.zIndex = '1040';
    
    // Create modal container
    const modal = document.createElement('div');
    modal.className = 'modal fade show';
    modal.style.display = 'block';
    modal.style.zIndex = '1050';
    modal.setAttribute('tabindex', '-1');
    
    // Modal content with split transaction interface (EXACT COPY)
    modal.innerHTML = `
      <div class="modal-dialog modal-xl">
        <div class="modal-content">
          <!-- Modal Header -->
          <div class="modal-header bg-light">
            <div class="d-flex align-items-center">
              <i class="bi bi-diagram-3 me-2 text-primary" style="font-size: 1.2rem;"></i>
              <h5 class="modal-title mb-0">Split Transaction Details</h5>
            </div>
            <button type="button" class="btn-close" onclick="closeSplitModal()"></button>
          </div>

          <!-- Modal Body -->
          <div class="modal-body">
            <div class="container-fluid">
              <!-- Transaction Info Header -->
              <div class="alert alert-info mb-4">
                <div class="row">
                  <div class="col-md-8">
                    <strong>Transaction:</strong> \${sanitizedData.description}<br>
                    <small class="text-muted">Split this transaction into multiple GL codes with proper accounting allocation</small>
                  </div>
                  <div class="col-md-4 text-end">
                    <div class="fs-5 fw-bold text-primary" id="originalAmount">$\${sanitizedData.amount}</div>
                  </div>
                </div>
                <!-- Hidden transaction ID for form submission -->
                <input type="hidden" id="transactionId" value="\${sanitizedData.id}">
              </div>

              <!-- Header fields -->
              <div class="row mb-4">
                <div class="col-md-4">
                  <label class="form-label">Date:</label>
                  <input type="date" class="form-control" value="\${sanitizedData.date}" readonly>
                </div>
                <div class="col-md-4">
                  <label class="form-label"><i class="bi bi-person me-1"></i>Who (Payee):</label>
                  <input type="text" class="form-control who-input" value="\${sanitizedData.payee}" placeholder="e.g., XYZ Corp">
                </div>
                <div class="col-md-4">
                  <label class="form-label"><i class="bi bi-chat-text me-1"></i>Why (Description):</label>
                  <input type="text" class="form-control" id="splitDescription" value="\${sanitizedData.description}" placeholder="Enter description for this split transaction">
                </div>
              </div>

              <!-- Split Lines Table -->
              <div class="table-responsive">
                <table class="table table-bordered align-middle" id="splitLinesTable">
                  <thead class="table-light">
                    <tr>
                      <th style="min-width:300px">Description</th>
                      <th style="min-width:250px">Account</th>
                      <th style="min-width:150px">Tax Rate</th>
                      <th style="min-width:150px" class="text-end">Amount</th>
                      <th style="width:50px"></th>
                    </tr>
                  </thead>
                  <tbody id="splitLineBody">
                    <!-- Default split lines will be added here -->
                  </tbody>
                  <tfoot>
                    <tr class="table-secondary">
                      <td colspan="3" class="text-end fw-semibold">Split Total:</td>
                      <td class="text-end fw-semibold" id="splitTotalAmount">$0.00</td>
                      <td></td>
                    </tr>
                    <tr id="balanceValidationRow" class="border-top-0">
                      <td colspan="3" class="text-end">
                        <div class="d-flex justify-content-end align-items-center gap-3">
                          <div>
                            <small class="text-muted">Original Amount:</small>
                            <span class="fw-semibold" id="originalAmountFooter">$0.00</span>
                          </div>
                          <div>
                            <small class="text-muted">Difference:</small>
                            <span class="fw-semibold" id="balanceDifference">$0.00</span>
                          </div>
                        </div>
                      </td>
                      <td class="text-end">
                        <span class="badge" id="balanceStatus">
                          <i class="bi bi-circle"></i> Checking...
                        </span>
                      </td>
                      <td></td>
                    </tr>
                  </tfoot>
                </table>
              </div>

              <button class="btn btn-outline-primary btn-sm" onclick="addSplitLine()">
                <i class="bi bi-plus me-1"></i>Add Split Line
              </button>
            </div>
          </div>

          <!-- Modal Footer -->
          <div class="modal-footer">
            <div class="me-auto">
              <span class="badge bg-info">Prototype Only</span>
              <small class="text-muted ms-2">No data will be saved</small>
            </div>
            <button type="button" class="btn btn-success" onclick="saveSplitTransaction()">
              <i class="bi bi-check me-1"></i>Apply Split
            </button>
            <button type="button" class="btn btn-secondary" onclick="closeSplitModal()">Cancel</button>
          </div>
        </div>
      </div>
    `;

    // Add modal to DOM
    document.body.appendChild(backdrop);
    document.body.appendChild(modal);
    document.body.classList.add('modal-open');

    // Initialize split lines with transaction data
    initializeSplitLines(transactionData.amount, transactionData);
}

// EXACT COPY OF ALL SPLIT FUNCTIONS FROM ORIGINAL
function initializeSplitLines(totalAmount, transactionData = {}) {
    const amount = parseFloat(totalAmount) || 0;
    
    // Set original amount for balance validation
    document.getElementById('originalAmount').textContent = '$' + amount.toFixed(2);
    document.getElementById('originalAmountFooter').textContent = '$' + amount.toFixed(2);
    
    // Create split lines based on actual transaction data or provide blank template
    const splitLines = [];
    
    // If we have existing account data from the main form, use it as first split line
    if (transactionData.whatAccount && transactionData.whatAccount.trim() !== '') {
      splitLines.push({
        description: transactionData.description || 'Split Item 1',
        account: transactionData.whatAccount,
        taxRate: 'Tax Exempt (0%)',
        amount: amount.toFixed(2)
      });
    } else {
      // Provide blank split lines for user to fill in
      splitLines.push({
        description: transactionData.description || '',
        account: '',
        taxRate: 'Tax Exempt (0%)',
        amount: amount.toFixed(2)
      });
      
      // Add a second blank line if amount is significant (suggest potential split)
      if (amount > 100) {
        splitLines.push({
          description: '',
          account: '',
          taxRate: 'Tax Exempt (0%)',
          amount: '0.00'
        });
      }
    }

    const tbody = document.getElementById('splitLineBody');
    tbody.innerHTML = '';

    splitLines.forEach((line, index) => {
      addSplitLineRow(line, index);
    });

    updateSplitTotal();
}

// Add split line row (EXACT COPY)
function addSplitLineRow(preset = {}, index = 0) {
    const tbody = document.getElementById('splitLineBody');
    const row = document.createElement('tr');
    
    row.innerHTML = `
      <td>
        <input type="text" class="form-control form-control-sm" 
               value="\${preset.description || ''}" 
               placeholder="Line description">
      </td>
      <td>
        <input type="text" class="form-control form-control-sm" 
               value="\${preset.account || ''}" 
               placeholder="Account code or name">
      </td>
      <td>
        <select class="form-select form-select-sm">
          <option value="tax_exempt" \${(preset.taxRate || '').includes('Tax Exempt') ? 'selected' : ''}>Tax Exempt (0%)</option>
          <option value="gst_10" \${(preset.taxRate || '').includes('10%') ? 'selected' : ''}>GST (10%)</option>
          <option value="gst_free" \${(preset.taxRate || '').includes('GST Free') ? 'selected' : ''}>GST Free</option>
        </select>
      </td>
      <td>
        <input type="number" class="form-control form-control-sm text-end split-amount" 
               value="\${preset.amount || ''}" 
               step="0.01" 
               placeholder="0.00"
               oninput="updateSplitTotal()"
               onchange="updateSplitTotal()">
      </td>
      <td>
        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeSplitLine(this)">
          <i class="bi bi-trash"></i>
        </button>
      </td>
    `;

    tbody.appendChild(row);
}

// Add new split line (EXACT COPY)
function addSplitLine() {
    addSplitLineRow();
    updateSplitTotal();
}

// Remove split line (EXACT COPY) 
function removeSplitLine(button) {
    button.closest('tr').remove();
    updateSplitTotal();
}

// Update split total with balance validation (EXACT COPY)
function updateSplitTotal() {
    const amounts = document.querySelectorAll('.split-amount');
    let splitTotal = 0;
    
    amounts.forEach(input => {
      splitTotal += parseFloat(input.value) || 0;
    });

    // Get original transaction amount
    const originalAmountElement = document.getElementById('originalAmount');
    const originalAmount = parseFloat(originalAmountElement.textContent.replace(/[$,]/g, '')) || 0;
    
    // Calculate difference
    const difference = splitTotal - originalAmount;
    const absDifference = Math.abs(difference);
    
    // Update display
    document.getElementById('splitTotalAmount').textContent = '$' + splitTotal.toFixed(2);
    document.getElementById('balanceDifference').textContent = (difference >= 0 ? '+' : '') + '$' + difference.toFixed(2);
    
    // Update balance status and styling
    const statusBadge = document.getElementById('balanceStatus');
    const differenceElement = document.getElementById('balanceDifference');
    const validationRow = document.getElementById('balanceValidationRow');
    
    if (absDifference === 0) {
      // Perfect balance
      statusBadge.className = 'badge bg-success';
      statusBadge.innerHTML = '<i class="bi bi-check-circle"></i> Balanced';
      differenceElement.className = 'fw-semibold text-success';
      validationRow.className = 'border-top-0';
    } else if (absDifference <= 0.01) {
      // Minor rounding difference (acceptable)
      statusBadge.className = 'badge bg-warning';
      statusBadge.innerHTML = '<i class="bi bi-exclamation-triangle"></i> Minor Diff';
      differenceElement.className = 'fw-semibold text-warning';
      validationRow.className = 'border-top-0';
    } else {
      // Significant imbalance
      statusBadge.className = 'badge bg-danger';
      statusBadge.innerHTML = '<i class="bi bi-exclamation-circle"></i> Unbalanced';
      differenceElement.className = difference > 0 ? 'fw-semibold text-danger' : 'fw-semibold text-danger';
      validationRow.className = 'border-top-0';
    }
    
    // Update save button state
    updateSaveButtonState(absDifference);
}

// Update save button based on balance status (EXACT COPY)
function updateSaveButtonState(difference) {
    const saveButton = document.querySelector('button[onclick="saveSplitTransaction()"]');
    if (!saveButton) return;
    
    if (difference === 0) {
      saveButton.disabled = false;
      saveButton.className = 'btn btn-success';
      saveButton.innerHTML = '<i class="bi bi-check me-1"></i>Apply Split';
    } else if (difference <= 0.01) {
      saveButton.disabled = false;
      saveButton.className = 'btn btn-warning text-dark';
      saveButton.innerHTML = '<i class="bi bi-exclamation-triangle me-1"></i>Apply (Minor Diff)';
    } else {
      saveButton.disabled = true;
      saveButton.className = 'btn btn-danger';
      saveButton.innerHTML = '<i class="bi bi-exclamation-circle me-1"></i>Balance Required';
    }
}

// Save Split Transaction (EXACT COPY) 
function saveSplitTransaction() {
    const transactionId = document.getElementById('transactionId').value;
    const description = document.getElementById('splitDescription').value;
    
    // Collect all split lines
    const splitLines = [];
    const rows = document.querySelectorAll('#splitLineBody tr');
    
    rows.forEach((row, index) => {
      const descInput = row.querySelector('input[placeholder="Line description"]');
      const accountInput = row.querySelector('input[placeholder="Account code or name"]');
      const taxSelect = row.querySelector('select');
      const amountInput = row.querySelector('.split-amount');
      
      if (accountInput.value.trim() && parseFloat(amountInput.value || 0) !== 0) {
        splitLines.push({
          description: descInput.value.trim() || `Split line \${index + 1}`,
          account: accountInput.value.trim(),
          taxRate: taxSelect.value,
          amount: parseFloat(amountInput.value || 0)
        });
      }
    });
    
    if (splitLines.length === 0) {
      alert('Please add at least one split line with an account and amount.');
      return;
    }
    
    console.log('Saving split transaction:', {
      transactionId: transactionId,
      description: description,
      splitLines: splitLines
    });
    
    // Show success message (prototype only)
    alert(`Split Transaction Saved!\\n\\nTransaction ID: \${transactionId}\\nSplit into \${splitLines.length} lines\\n\\nNote: This is a prototype - no data was actually saved.`);
    
    closeSplitModal();
}

// Close Split Modal (EXACT COPY)
function closeSplitModal() {
    const modals = document.querySelectorAll('.modal, .modal-backdrop');
    modals.forEach(modal => modal.remove());
    document.body.classList.remove('modal-open');
}

// Apply Smart Suggestion
function applySuggestion(transactionId, loanId, customerName, coaAccountId, coaAccountDisplay, totalSuggestions, suggestionSource, patternId, confidence) {
    console.log('🎯 Applying suggestion:', { transactionId, loanId, customerName, coaAccountId, coaAccountDisplay, totalSuggestions, suggestionSource, patternId, confidence });
    
    // Fill the WHO input field with the suggested customer
    const whoInput = document.querySelector(`input[name="who_text_${transactionId}"]`);
    if (whoInput && customerName) {
        whoInput.value = customerName;
        if (loanId) {
            whoInput.setAttribute('data-loan-id', loanId);
        }
        
        // 🧠 Store pattern ID and confidence for AI feedback tracking
        if (suggestionSource === 'ai_pattern' && patternId) {
            console.log('✅ Setting AI attributes on WHO input:', { patternId, confidence, customerName });
            whoInput.setAttribute('data-pattern-id', patternId);
            whoInput.setAttribute('data-suggestion-source', 'ai_pattern');
            whoInput.setAttribute('data-confidence', confidence || 0);
            whoInput.setAttribute('data-suggested-who', customerName);
        } else {
            console.log('⚠️ NOT setting AI attributes. suggestionSource:', suggestionSource, 'patternId:', patternId);
        }
        
        // Trigger input event to activate any validation/styling
        whoInput.dispatchEvent(new Event('input', { bubbles: true }));
    }
    
    // Fill the WHAT input field with suggested COA account if available
    const whatInput = document.querySelector(`input[name="what_text_${transactionId}"]`);
    if (whatInput && coaAccountDisplay) {
        whatInput.value = coaAccountDisplay;
        whatInput.setAttribute('data-account-id', coaAccountId);
        
        // 🧠 Store pattern ID and confidence for AI feedback tracking
        if (suggestionSource === 'ai_pattern' && patternId) {
            console.log('✅ Setting AI attributes on WHAT input:', { patternId, confidence, coaAccountId });
            whatInput.setAttribute('data-pattern-id', patternId);
            whatInput.setAttribute('data-confidence', confidence || 0);
            whatInput.setAttribute('data-suggested-what-id', coaAccountId);
        } else {
            console.log('⚠️ NOT setting AI attributes on WHAT. suggestionSource:', suggestionSource, 'patternId:', patternId);
        }
        
        // Trigger input event
        whatInput.dispatchEvent(new Event('input', { bubbles: true }));
    }
    
    // Also check for WHO button approach (backward compatibility)
    const whoButton = document.querySelector(`[onclick*="showWhoDropdown"][onclick*="${transactionId}"]`);
    if (whoButton && loanId) {
        whoButton.setAttribute('data-loan-id', loanId);
    }
    
    // Check if this transaction has only 1 suggestion using the passed parameter
    const hasSingleSuggestion = totalSuggestions === 1;
    
    console.log('🔍 Auto-save check:', { 
        totalSuggestions, 
        hasSingleSuggestion,
        type: typeof totalSuggestions,
        suggestionSource
    });
    
    // Collapse the suggestions
    const suggestionsContainer = document.getElementById(`suggestions-${transactionId}`);
    if (suggestionsContainer) {
        const collapse = new bootstrap.Collapse(suggestionsContainer, { toggle: false });
        collapse.hide();
    }
    
    // Show enhanced success feedback
    let message = suggestionSource === 'ai_pattern' ? '🧠 AI Pattern Applied: ' : '✅ Applied: ';
    message += customerName;
    if (coaAccountDisplay) {
        message += ` → ${coaAccountDisplay}`;
    }
    
    // 🚀 AUTO-SAVE LOGIC: If only 1 suggestion, auto-save immediately
    if (hasSingleSuggestion) {
        message += ' (Auto-saving...)';
        showToast(message, 'success');
        
        // Auto-save after short delay to show the toast
        setTimeout(() => {
            console.log('🚀 Auto-saving transaction with single suggestion');
            saveTransaction(transactionId);
        }, 500);
    } else {
        // Multiple suggestions: Show OK button for manual confirmation
        showToast(message, 'success');
        
        const okButton = document.getElementById(`save${transactionId}`);
        if (okButton) {
            okButton.style.display = 'block';
            // Auto-focus on the save button for immediate confirmation
            setTimeout(() => okButton.focus(), 300);
        }
    }
}

// Update pattern statistics in real-time
function updatePatternStats(stats) {
    console.log('📊 Updating pattern stats:', stats);
    
    // Update pattern count badge if it exists
    const patternCountElement = document.querySelector('.pattern-count-badge');
    if (patternCountElement && stats.total_patterns !== undefined) {
        patternCountElement.textContent = stats.total_patterns;
    }
    
    // Update suggestions count in any visible suggestion sections
    document.querySelectorAll('.smart-suggestions-count').forEach(el => {
        if (stats.total_patterns !== undefined) {
            el.textContent = stats.total_patterns;
        }
    });
}

// Show toast notification
function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `alert alert-${type} position-fixed`;
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px; animation: slideIn 0.3s ease-out;';
    
    // Different icons for different types
    let icon = 'fa-check-circle';
    if (type === 'warning') icon = 'fa-exclamation-triangle';
    else if (type === 'info') icon = 'fa-info-circle';
    else if (type === 'danger') icon = 'fa-times-circle';
    
    toast.innerHTML = `
        <div class="d-flex align-items-center">
            <i class="fas ${icon} me-2"></i>
            ${message}
            <button type="button" class="btn-close ms-auto" onclick="this.parentElement.parentElement.remove()"></button>
        </div>
    `;
    document.body.appendChild(toast);
    
    // Auto remove after 4 seconds (longer for AI feedback)
    setTimeout(() => {
        if (toast.parentElement) {
            toast.style.animation = 'slideOut 0.3s ease-in';
            setTimeout(() => toast.remove(), 300);
        }
    }, 4000);
}

</script>
{% endblock %}

{% extends 'base.html' %}
{% load static humanize %}

{% block extra_head %}
<!-- CSRF Token for AJAX requests -->
{% csrf_token %}
<meta name="csrf-token" content="{{ csrf_token }}">
{% endblock %}

{% block title %}{{ title|default:"Bank Reconciliation" }} - Simple Mode{% endblock %}

{% block extra_css %}
<style>
  /* —— Layout polish to resemble Xero —— Exact same as original */
  .balance-banner { background:#f6f7f8; border:1px solid #e5e7eb; border-radius:.5rem; }
  .balance-metric .label { font-size:.8rem; color:#6b7280; }
  .balance-metric .value { font-weight:700; font-size:1rem; }
  .diff-badge { font-size:.75rem; }

  .x-tabs .nav-link { font-weight:600; }
  .x-tabs .nav-link.active { border-bottom:3px solid #2563eb; color:#111827; }

  .transaction-item { transition: background .15s ease, border-color .15s ease; }
  .transaction-item:hover { background:#f8fafc; }
  .border-credit { border-left:4px solid #16a34a !important; }
  .border-debit  { border-left:4px solid #ef4444 !important; }
  .amount-pos { color:#16a34a; font-weight:600; }
  .amount-neg { color:#ef4444; font-weight:600; }

  .pillar-label { font-size:.75rem; text-transform:uppercase; letter-spacing:.04em; font-weight:700; }
  .form-control-sm, .form-select-sm { font-size:.85rem; }

  .ok-btn { min-width:96px; }

  /* Compact mode */
  .compact .transaction-item { padding:.5rem .75rem !important; }
  .compact .txn-title { font-size:.9rem; }
  .compact .txn-meta { display:none; }
  .compact .matching-form { display:none; }

  .matching-form { background:#f8fafc; border-radius:.5rem; padding:1rem; margin-top:.5rem; }

  .sticky-side { position:sticky; top:1rem; }

  .badge-soft { background:#eaf2ff; color:#2563eb; border:1px solid #cfe0ff; }

  /* Smart Details Link Styling */
  .btn-link.text-muted {
    border: none;
    transition: all 0.2s ease;
  }
  .btn-link.text-muted:hover {
    color: #2563eb !important;
    background-color: rgba(37, 99, 235, 0.05);
  }

  /* Hybrid input styling - exact same as original */
  .hybrid-input { border: 1px solid #d1d5db; border-radius: 0.375rem; }
  .hybrid-dropdown-btn { border-left: 1px solid #d1d5db; }
  .temp-dropdown { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
  .temp-who-dropdown { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }

  /* Progress and balance styling */
  .progress-text { font-size:.85rem; color:#6b7280; }
  .btn-reconcile { background: #059669; border-color: #059669; color: white; }
  .btn-reconcile:hover { background: #047857; border-color: #047857; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
  <!-- Header Section - Same style as original -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h2 class="mb-1">
            <i class="fas fa-balance-scale text-primary"></i>
            Bank Reconciliation - {{ account.name }} 
            <span class="badge bg-info">Simple Mode</span>
          </h2>
          <p class="text-muted mb-0">{{ company.name }}</p>
        </div>
        <div>
          <a href="{% url 'reconciliation:dashboard' %}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left"></i> Back to Dashboard
          </a>
          <a href="{% url 'reconciliation:account_reconciliation' account.id %}" class="btn btn-outline-primary ms-2">
            <i class="fas fa-cogs"></i> Advanced Mode
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Balance Summary - Same style as original -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="balance-banner p-4">
        <div class="row text-center">
          <div class="col-md-3">
            <div class="balance-metric">
              <div class="label">Statement Balance</div>
              <div class="value text-primary">${{ progress.statement_balance|floatformat:2|intcomma }}</div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="balance-metric">
              <div class="label">Reconciled Balance</div>
              <div class="value text-info">${{ progress.reconciled_balance|floatformat:2|intcomma }}</div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="balance-metric">
              <div class="label">Difference</div>
              <div class="value {% if progress.difference == 0 %}text-success{% else %}text-warning{% endif %}">
                ${{ progress.difference|floatformat:2|intcomma }}
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="balance-metric">
              <div class="label">Reconciled</div>
              <div class="value text-success">{{ progress.percentage|floatformat:0 }}%</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Transactions List - Exact same UX as original -->
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <h5 class="card-title mb-0">
            <i class="fas fa-list"></i>
            Unmatched Transactions ({{ transactions|length }})
          </h5>
        </div>
        <div class="card-body p-0">
          {% if transactions %}
            <div class="transaction-list" style="max-height:70vh; overflow-y:auto;">
              {% for t in transactions %}
              <div class="transaction-item p-3 border-bottom {% if t.amount > 0 %}border-credit{% else %}border-debit{% endif %}" data-transaction-id="{{ t.id }}">
                <div class="row align-items-center">
                  <!-- Transaction Number -->
                  <div class="col-auto pe-2">
                    <div class="transaction-number bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 35px; height: 35px; font-weight: 600; font-size: 0.9rem;">
                      {{ forloop.counter }}
                    </div>
                  </div>
                  
                  <!-- Left: Transaction Info -->
                  <div class="col-md-4">
                    <div class="d-flex align-items-start justify-content-between">
                      <div class="flex-grow-1" style="min-width:0;">
                        <div class="small text-primary fw-semibold txn-date"><i class="bi bi-calendar me-1"></i>{{ t.date|date:"d M Y" }}</div>
                        <div class="txn-title fw-semibold">{{ t.description|default:"(no description)" }}</div>
                        <div class="txn-meta text-muted small">Ref: {{ t.reference|default:"—" }}</div>
                      </div>
                      <div class="text-end ms-3">
                        <div class="{% if t.amount > 0 %}amount-pos{% else %}amount-neg{% endif %}">{% if t.amount > 0 %}+{% endif %}${{ t.amount|floatformat:2 }}</div>
                        <div class="small text-muted">{% if t.amount > 0 %}Received{% else %}Spent{% endif %}</div>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Middle: Save Button -->
                  <div class="col-md-2 d-flex justify-content-center align-items-center">
                    <button type="button" class="btn btn-primary btn-lg ok-btn" id="save{{ t.id }}" onclick="saveTransaction({{ t.id }})">
                      OK
                    </button>
                  </div>
                  
                  <!-- Right: WHO/WHAT/WHY Form - Exact same structure -->
                  <div class="col-md-5">
                    <div class="matching-form p-3 bg-light rounded">
                      <div class="row mb-2">
                        <div class="col-6">
                          <label class="pillar-label text-info mb-1"><i class="bi bi-person me-1"></i>Who</label>
                          <div class="input-group input-group-sm position-relative">
                            <input type="text" 
                                   class="form-control hybrid-input who-input" 
                                   name="who_text_{{ t.id }}"
                                   placeholder="Type customer or contact name..."
                                   value=""
                                   autocomplete="off">
                            <button class="btn btn-outline-secondary hybrid-dropdown-btn" 
                                    type="button" 
                                    onclick="showWhoDropdown(this, {{ t.id }})"
                                    title="Browse all customers and contacts">
                              <i class="bi bi-chevron-down"></i>
                            </button>
                          </div>
                        </div>
                        <div class="col-6">
                          <label class="pillar-label text-warning mb-1"><i class="bi bi-graph-up me-1"></i>What *</label>
                          <div class="input-group input-group-sm position-relative">
                            <input type="text" 
                                   class="form-control hybrid-input what-input" 
                                   name="what_text_{{ t.id }}"
                                   placeholder="Type account code or name..."
                                   value=""
                                   autocomplete="off"
                                   required>
                            <button class="btn btn-outline-secondary hybrid-dropdown-btn" 
                                    type="button" 
                                    onclick="showWhatDropdown(this, {{ t.id }})"
                                    title="Browse all accounts">
                              <i class="bi bi-chevron-down"></i>
                            </button>
                          </div>
                        </div>
                      </div>
                      <div class="row">
                        <div class="col-12">
                          <label class="pillar-label text-success mb-1"><i class="bi bi-chat-text me-1"></i>Why</label>
                          <input type="text" 
                                 class="form-control form-control-sm why-input" 
                                 name="why_{{ t.id }}"
                                 placeholder="Enter description or memo..."
                                 value="{{ t.description }}"
                                 autocomplete="off">
                        </div>
                      </div>
                      
                      <!-- Add Details Button - Manual Splitting Logic -->
                      <div class="row mt-2">
                        <div class="col-12 text-center">
                          <a href="javascript:void(0)" 
                             class="btn btn-link btn-sm text-muted px-2 py-1" 
                             id="addDetails_{{ t.id }}"
                             onclick="toggleSmartDetails({{ t.id }})"
                             style="font-size: 0.85rem; text-decoration: none;">
                            <i class="bi bi-plus-circle me-1"></i>Add Details
                          </a>
                        </div>
                      </div>
                      
                    </div>
                  </div>
                </div>
              </div>
              {% endfor %}
            </div>
          {% else %}
            <div class="text-center py-5">
              <i class="fas fa-check-circle text-success mb-3" style="font-size: 3rem;"></i>
              <h4>All Transactions Reconciled!</h4>
              <p class="text-muted">Great job! All transactions have been matched.</p>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Link to the external JavaScript file -->
<script src="{% static 'process/js/reconciliation.js' %}"></script>

<!-- Dynamic COA Data as JSON -->
<script>
// Make COA data available globally
window.coaData = [
    {% for group_name, accounts in coa_groups.items %}
        {% for account in accounts %}
        {
            code: '{{ account.code }}',
            name: '{{ account.name }}',
            type: '{{ group_name }}',
            display: '{{ account.code }} — {{ account.name }}'
        },
        {% endfor %}
    {% endfor %}
];

// Fallback COA data if no dynamic data available
if (window.coaData.length === 0) {
    window.coaData = [
        { code: '4001', name: 'Sales Revenue', type: 'Revenue', display: '4001 — Sales Revenue' },
        { code: '4200', name: 'Interest Income', type: 'Revenue', display: '4200 — Interest Income' },
        { code: '6001', name: 'General Expenses', type: 'Expenses', display: '6001 — General Expenses' },
        { code: '6100', name: 'Office Supplies', type: 'Expenses', display: '6100 — Office Supplies' },
        { code: '6200', name: 'Professional Fees', type: 'Expenses', display: '6200 — Professional Fees' }
    ];
}

console.log('📊 COA Data loaded:', window.coaData.length, 'accounts');
</script>

<!-- Additional Simple JavaScript - Matching original UX exactly -->
<script>
// Get CSRF token for AJAX requests
function getCsrfToken() {
    return document.querySelector('meta[name="csrf-token"]').getAttribute('content');
}

// WHO Dropdown function - Exact same as original
window.showWhoDropdown = function(button, transactionId) {
    console.log('🎯 WHO dropdown clicked for transaction:', transactionId);
    
    // Remove existing dropdowns
    document.querySelectorAll('.temp-who-dropdown, .temp-dropdown, .temp-what-dropdown').forEach(d => d.remove());
    
    // Create dropdown
    const dropdown = document.createElement('div');
    dropdown.className = 'temp-who-dropdown position-absolute bg-white border rounded shadow';
    dropdown.style.cssText = 'z-index: 9999; top: 100%; left: 0; min-width: 250px; max-height: 300px; overflow-y: auto; margin-top: 2px;';
    
    // Dynamic loan customers from approved applications
    {% if loan_customers %}
    const customers = [
        {% for customer_info in loan_customers %}
        {
            name: '{{ customer_info.customer.first_name }} {{ customer_info.customer.last_name }}',
            email: '{{ customer_info.customer.email }}',
            company: '{{ customer_info.company.name }}',
            isSameCompany: {{ customer_info.is_same_company|yesno:"true,false" }}
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];
    
    dropdown.innerHTML = `
        <div class="p-2 border-bottom bg-light fw-bold">Approved Loan Customers</div>
        ${customers.map(customer => `
            <div class="p-2" style="cursor: pointer;" 
                 onmouseover="this.style.background='#f8f9fa'" 
                 onmouseout="this.style.background='white'"
                 onclick="selectWhoCustomer_simple('${customer.name}', ${transactionId})">
                <div class="fw-bold ${customer.isSameCompany ? '' : 'text-muted'}">${customer.name}</div>
                <small class="text-muted">${customer.email}</small>
                ${!customer.isSameCompany ? `<small class="d-block text-warning">📍 ${customer.company}</small>` : ''}
            </div>
        `).join('')}
    `;
    {% else %}
    dropdown.innerHTML = `
        <div class="p-2 border-bottom bg-light fw-bold">Approved Loan Customers</div>
        <div class="p-2 text-muted">No approved loan customers found</div>
    `;
    {% endif %}
    
    // Position dropdown
    const container = button.parentElement;
    container.style.position = 'relative';
    container.appendChild(dropdown);
    
    // Add click-outside-to-close functionality
    setTimeout(() => {
        document.addEventListener('click', function closeDropdown(e) {
            if (!dropdown.contains(e.target) && !button.contains(e.target)) {
                dropdown.remove();
                document.removeEventListener('click', closeDropdown);
            }
        });
    }, 100); // Small delay to prevent immediate closure
    
    return false;
};

window.selectWhoCustomer_simple = function(customerName, transactionId) {
    console.log('✅ Selected customer:', customerName, 'for transaction:', transactionId);
    
    // Find and populate WHO input
    const whoInput = document.querySelector(`[data-transaction-id="${transactionId}"] .who-input`);
    if (whoInput) {
        whoInput.value = customerName;
        console.log('✅ Set WHO input to:', customerName);
    }
    
    // Remove all dropdowns
    document.querySelectorAll('.temp-who-dropdown, .temp-dropdown, .temp-what-dropdown').forEach(d => d.remove());
    
    // Check if successful match and show OK button
    checkForSuccessfulMatch(transactionId);
};

// WHAT Dropdown function - Uses dynamic COA data
window.showWhatDropdown = function(button, transactionId) {
    console.log('🎯 WHAT dropdown clicked for transaction:', transactionId);
    
    // Remove existing dropdowns
    document.querySelectorAll('.temp-what-dropdown, .temp-dropdown, .temp-who-dropdown').forEach(d => d.remove());
    
    // Create dropdown
    const dropdown = document.createElement('div');
    dropdown.className = 'temp-what-dropdown position-absolute bg-white border rounded shadow';
    dropdown.style.cssText = 'z-index: 9999; top: 100%; left: 0; min-width: 300px; max-height: 400px; overflow-y: auto; margin-top: 2px;';
    
    // Group accounts by type
    const groupedAccounts = {};
    window.coaData.forEach(account => {
        if (!groupedAccounts[account.type]) {
            groupedAccounts[account.type] = [];
        }
        groupedAccounts[account.type].push(account);
    });
    
    // Build dropdown content
    let dropdownContent = '<div class="p-2 border-bottom bg-light fw-bold">Chart of Accounts</div>';
    
    Object.keys(groupedAccounts).forEach(groupName => {
        dropdownContent += `<div class="p-2 bg-secondary text-white fw-bold small">${groupName}</div>`;
        groupedAccounts[groupName].forEach(account => {
            dropdownContent += `<div class="p-2 ps-3" style="cursor: pointer;" 
                 onmouseover="this.style.background='#f8f9fa'" 
                 onmouseout="this.style.background='white'"
                 onclick="selectWhatAccount_simple('${account.display}', ${transactionId})">${account.display}</div>`;
        });
    });
    
    if (Object.keys(groupedAccounts).length === 0) {
        dropdownContent += '<div class="p-2 text-muted">No accounts found</div>';
    }
    
    dropdown.innerHTML = dropdownContent;
    
    // Position dropdown
    const container = button.parentElement;
    container.style.position = 'relative';
    container.appendChild(dropdown);
    
    // Add click-outside-to-close functionality
    setTimeout(() => {
        document.addEventListener('click', function closeDropdown(e) {
            if (!dropdown.contains(e.target) && !button.contains(e.target)) {
                dropdown.remove();
                document.removeEventListener('click', closeDropdown);
            }
        });
    }, 100); // Small delay to prevent immediate closure
    
    return false;
};

window.selectWhatAccount_simple = function(accountName, transactionId) {
    console.log('✅ Selected account:', accountName, 'for transaction:', transactionId);
    
    // Find and populate WHAT input
    const whatInput = document.querySelector(`[data-transaction-id="${transactionId}"] .what-input`);
    if (whatInput) {
        whatInput.value = accountName;
        console.log('✅ Set WHAT input to:', accountName);
    }
    
    // Remove all dropdowns
    document.querySelectorAll('.temp-what-dropdown, .temp-dropdown, .temp-who-dropdown').forEach(d => d.remove());
    
    // Check if successful match and show OK button
    checkForSuccessfulMatch(transactionId);
};

// Save individual transaction
function saveTransaction(transactionId) {
    const whoInput = document.querySelector(`[data-transaction-id="${transactionId}"] .who-input`);
    const whatInput = document.querySelector(`[data-transaction-id="${transactionId}"] .what-input`);
    const whyInput = document.querySelector(`[data-transaction-id="${transactionId}"] .why-input`);
    
    if (!whoInput.value.trim() || !whatInput.value.trim()) {
        alert('Please fill in WHO and WHAT fields');
        return;
    }
    
    const saveButton = document.getElementById('save' + transactionId);
    saveButton.disabled = true;
    saveButton.innerHTML = '<i class="spinner-border spinner-border-sm me-1"></i>Saving...';
    
    // Send AJAX request
    fetch('/reconciliation/ajax/simple-match-transaction/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        },
        body: JSON.stringify({
            transaction_id: transactionId,
            who: whoInput.value.trim(),
            what: whatInput.value.trim(),
            why: whyInput.value.trim()
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Mark as completed
            const transactionItem = document.querySelector(`[data-transaction-id="${transactionId}"]`);
            transactionItem.style.backgroundColor = '#f0fdf4';
            transactionItem.style.opacity = '0.7';
            
            saveButton.innerHTML = '<i class="bi bi-check-circle me-1"></i>Saved';
            saveButton.className = 'btn btn-success btn-lg ok-btn';
            
            alert('✅ Transaction saved successfully!');
        } else {
            alert('❌ Error: ' + data.error);
            saveButton.disabled = false;
            saveButton.innerHTML = 'OK';
        }
    })
    .catch(error => {
        console.error('Save error:', error);
        alert('❌ Network error occurred');
        saveButton.disabled = false;
        saveButton.innerHTML = 'OK';
    });
}

// Check if transaction has successful match (WHO and WHAT filled) and show OK button
function checkForSuccessfulMatch(transactionId) {
    const whoInput = document.querySelector(`[data-transaction-id="${transactionId}"] .who-input`);
    const whatInput = document.querySelector(`[data-transaction-id="${transactionId}"] .what-input`);
    const okButton = document.getElementById('save' + transactionId);
    
    if (whoInput && whatInput && okButton) {
        const hasWho = whoInput.value.trim() !== '';
        const hasWhat = whatInput.value.trim() !== '';
        
        if (hasWho && hasWhat) {
            // Successful match - show blue OK button
            okButton.style.display = 'block';
            okButton.style.opacity = '1';
            okButton.disabled = false;
            okButton.className = 'btn btn-primary btn-lg ok-btn';
            okButton.innerHTML = 'OK';
            console.log('✅ Successful match detected for transaction:', transactionId);
        } else {
            // No match yet - hide button
            okButton.style.display = 'none';
            console.log('⏳ Waiting for complete match for transaction:', transactionId);
        }
    }
}

// Auto-save when typing (debounced) + Auto-suggestions
document.addEventListener('input', function(e) {
    if (e.target.matches('.who-input, .what-input, .why-input')) {
        // Get transaction ID from the input's parent container
        const transactionContainer = e.target.closest('[data-transaction-id]');
        if (transactionContainer) {
            const transactionId = transactionContainer.getAttribute('data-transaction-id');
            
            // Auto-suggestions for WHO input
            if (e.target.matches('.who-input')) {
                showWhoAutoSuggestions(e.target, transactionId);
                
                // Check for successful match when WHO field changes
                clearTimeout(window.matchTimeout);
                window.matchTimeout = setTimeout(() => {
                    checkForSuccessfulMatch(transactionId);
                }, 300);
            }
            
            // Auto-suggestions for WHAT input
            if (e.target.matches('.what-input')) {
                showWhatAutoSuggestions(e.target, transactionId);
                
                // Check for successful match when WHAT field changes
                clearTimeout(window.matchTimeout);
                window.matchTimeout = setTimeout(() => {
                    checkForSuccessfulMatch(transactionId);
                }, 300);
            }
        }
        
        console.log('Input changed:', e.target.value);
    }
});

// WHO Auto-suggestions
function showWhoAutoSuggestions(input, transactionId) {
    const value = input.value.toLowerCase().trim();
    
    // Remove existing suggestions
    document.querySelectorAll('.auto-suggestion-who').forEach(d => d.remove());
    
    if (value.length < 2) return; // Only show suggestions after 2 characters
    
    // Filter customers based on input
    {% if loan_customers %}
    const customers = [
        {% for customer_info in loan_customers %}
        {
            name: '{{ customer_info.customer.first_name }} {{ customer_info.customer.last_name }}',
            email: '{{ customer_info.customer.email }}',
            company: '{{ customer_info.company.name }}',
            isSameCompany: {{ customer_info.is_same_company|yesno:"true,false" }}
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];
    
    const filtered = customers.filter(customer => 
        customer.name.toLowerCase().includes(value) || 
        customer.email.toLowerCase().includes(value)
    );
    
    if (filtered.length > 0) {
        const suggestions = document.createElement('div');
        suggestions.className = 'auto-suggestion-who position-absolute bg-white border rounded shadow';
        suggestions.style.cssText = 'z-index: 9998; top: 100%; left: 0; right: 0; max-height: 200px; overflow-y: auto; margin-top: 2px;';
        
        suggestions.innerHTML = filtered.slice(0, 5).map(customer => `
            <div class="p-2" style="cursor: pointer;" 
                 onmouseover="this.style.background='#f8f9fa'" 
                 onmouseout="this.style.background='white'"
                 onclick="selectWhoSuggestion('${customer.name}', ${transactionId})">
                <div class="fw-bold small ${customer.isSameCompany ? '' : 'text-muted'}">${customer.name}</div>
                <small class="text-muted">${customer.email}</small>
            </div>
        `).join('');
        
        input.parentElement.style.position = 'relative';
        input.parentElement.appendChild(suggestions);
        
        // Auto-close suggestions
        setTimeout(() => {
            document.addEventListener('click', function closeSuggestions(e) {
                if (!suggestions.contains(e.target) && e.target !== input) {
                    suggestions.remove();
                    document.removeEventListener('click', closeSuggestions);
                }
            });
        }, 100);
    }
    {% endif %}
}

// WHAT Auto-suggestions
function showWhatAutoSuggestions(input, transactionId) {
    const value = input.value.toLowerCase().trim();
    
    // Remove existing suggestions
    document.querySelectorAll('.auto-suggestion-what').forEach(d => d.remove());
    
    if (value.length < 2) return; // Only show suggestions after 2 characters
    
    // Filter accounts based on input
    const filtered = window.coaData.filter(account => 
        account.name.toLowerCase().includes(value) || 
        account.code.toLowerCase().includes(value) ||
        account.display.toLowerCase().includes(value)
    );
    
    if (filtered.length > 0) {
        const suggestions = document.createElement('div');
        suggestions.className = 'auto-suggestion-what position-absolute bg-white border rounded shadow';
        suggestions.style.cssText = 'z-index: 9998; top: 100%; left: 0; right: 0; max-height: 200px; overflow-y: auto; margin-top: 2px;';
        
        suggestions.innerHTML = filtered.slice(0, 5).map(account => `
            <div class="p-2" style="cursor: pointer;" 
                 onmouseover="this.style.background='#f8f9fa'" 
                 onmouseout="this.style.background='white'"
                 onclick="selectWhatSuggestion('${account.display}', ${transactionId})">
                <div class="fw-bold small">${account.display}</div>
                <small class="text-muted">${account.type}</small>
            </div>
        `).join('');
        
        input.parentElement.style.position = 'relative';
        input.parentElement.appendChild(suggestions);
        
        // Auto-close suggestions
        setTimeout(() => {
            document.addEventListener('click', function closeSuggestions(e) {
                if (!suggestions.contains(e.target) && e.target !== input) {
                    suggestions.remove();
                    document.removeEventListener('click', closeSuggestions);
                }
            });
        }, 100);
    }
}

// Selection functions for auto-suggestions
function selectWhoSuggestion(customerName, transactionId) {
    const whoInput = document.querySelector(`[data-transaction-id="${transactionId}"] .who-input`);
    if (whoInput) {
        whoInput.value = customerName;
    }
    document.querySelectorAll('.auto-suggestion-who').forEach(d => d.remove());
    checkForSuccessfulMatch(transactionId);
}

function selectWhatSuggestion(accountName, transactionId) {
    const whatInput = document.querySelector(`[data-transaction-id="${transactionId}"] .what-input`);
    if (whatInput) {
        whatInput.value = accountName;
    }
    document.querySelectorAll('.auto-suggestion-what').forEach(d => d.remove());
    checkForSuccessfulMatch(transactionId);
}

console.log('✅ Simple reconciliation interface loaded - UX exactly matching original');

// Initialize all OK buttons - hide them initially until successful match
document.addEventListener('DOMContentLoaded', function() {
    // Hide all OK buttons initially
    document.querySelectorAll('[id^="save"]').forEach(button => {
        button.style.display = 'none';
    });
    
    // Check existing matches on page load
    document.querySelectorAll('[data-transaction-id]').forEach(container => {
        const transactionId = container.getAttribute('data-transaction-id');
        checkForSuccessfulMatch(transactionId);
    });
});

// Smart Details Toggle Function - Split Transaction Modal (EXACT COPY FROM ORIGINAL)
function toggleSmartDetails(transactionId) {
    console.log('Opening split transaction modal for transaction:', transactionId);
    
    // Get transaction data from DOM elements
    const transactionElement = document.querySelector(`[data-transaction-id="${transactionId}"]`);
    
    let transactionData = {
      id: transactionId,
      description: '',
      amount: '0.00',
      payee: '',
      date: new Date().toISOString().split('T')[0], // Default to today
      reference: ''
    };
    
    // Extract actual transaction data from the DOM
    if (transactionElement) {
      const descElement = transactionElement.querySelector('.txn-title');
      const amountElement = transactionElement.querySelector('.amount-pos, .amount-neg');
      const dateElement = transactionElement.querySelector('.txn-date');
      const refElement = transactionElement.querySelector('.txn-meta');
      const whoInput = transactionElement.querySelector(`input[name="who_text_${transactionId}"]`);
      const whatInput = transactionElement.querySelector(`input[name="what_text_${transactionId}"]`);
      const whyInput = transactionElement.querySelector(`input[name="why_${transactionId}"]`);
      
      if (descElement) transactionData.description = descElement.textContent.trim() || 'Split Transaction';
      if (amountElement) {
        const amountText = amountElement.textContent.replace(/[+\-$,]/g, '').trim();
        transactionData.amount = amountText || '0.00';
      }
      if (dateElement) {
        // Extract date from "8 Sep 2024" format
        const dateText = dateElement.textContent.trim();
        const dateMatch = dateText.match(/(\d{1,2})\s+(\w{3})\s+(\d{4})/);
        if (dateMatch) {
          const months = {'Jan':1, 'Feb':2, 'Mar':3, 'Apr':4, 'May':5, 'Jun':6, 'Jul':7, 'Aug':8, 'Sep':9, 'Oct':10, 'Nov':11, 'Dec':12};
          const day = dateMatch[1].padStart(2, '0');
          const month = months[dateMatch[2]].toString().padStart(2, '0');
          const year = dateMatch[3];
          transactionData.date = `${year}-${month}-${day}`;
        }
      }
      if (refElement) {
        const refText = refElement.textContent.trim();
        transactionData.reference = refText.replace('Ref: ', '').replace('—', '').trim();
      }
      if (whoInput) transactionData.payee = whoInput.value || '';
      if (whatInput) transactionData.whatAccount = whatInput.value || '';
      if (whyInput) transactionData.description = whyInput.value || transactionData.description;
    }
    
    // Ensure all fields have valid values
    transactionData.description = transactionData.description || 'Split Transaction';
    transactionData.amount = transactionData.amount || '0.00';
    transactionData.payee = transactionData.payee || '';
    transactionData.reference = transactionData.reference || '';
    
    console.log('Transaction data prepared:', transactionData);
    
    // Show the split transaction modal
    showSplitTransactionModal(transactionData);
}

// Show Split Transaction Modal (EXACT COPY FROM ORIGINAL)
function showSplitTransactionModal(transactionData) {
    // Sanitize and format data for display
    const sanitizedData = {
      id: transactionData.id || 0,
      description: (transactionData.description || 'Split Transaction').replace(/"/g, '&quot;'),
      amount: parseFloat(transactionData.amount || 0).toFixed(2),
      payee: (transactionData.payee || '').replace(/"/g, '&quot;'),
      date: transactionData.date || new Date().toISOString().split('T')[0],
      reference: (transactionData.reference || '').replace(/"/g, '&quot;')
    };
    
    // Create modal backdrop
    const backdrop = document.createElement('div');
    backdrop.className = 'modal-backdrop fade show';
    backdrop.style.zIndex = '1040';
    
    // Create modal container
    const modal = document.createElement('div');
    modal.className = 'modal fade show';
    modal.style.display = 'block';
    modal.style.zIndex = '1050';
    modal.setAttribute('tabindex', '-1');
    
    // Modal content with split transaction interface (EXACT COPY)
    modal.innerHTML = `
      <div class="modal-dialog modal-xl">
        <div class="modal-content">
          <!-- Modal Header -->
          <div class="modal-header bg-light">
            <div class="d-flex align-items-center">
              <i class="bi bi-diagram-3 me-2 text-primary" style="font-size: 1.2rem;"></i>
              <h5 class="modal-title mb-0">Split Transaction Details</h5>
            </div>
            <button type="button" class="btn-close" onclick="closeSplitModal()"></button>
          </div>

          <!-- Modal Body -->
          <div class="modal-body">
            <div class="container-fluid">
              <!-- Transaction Info Header -->
              <div class="alert alert-info mb-4">
                <div class="row">
                  <div class="col-md-8">
                    <strong>Transaction:</strong> \${sanitizedData.description}<br>
                    <small class="text-muted">Split this transaction into multiple GL codes with proper accounting allocation</small>
                  </div>
                  <div class="col-md-4 text-end">
                    <div class="fs-5 fw-bold text-primary" id="originalAmount">$\${sanitizedData.amount}</div>
                  </div>
                </div>
                <!-- Hidden transaction ID for form submission -->
                <input type="hidden" id="transactionId" value="\${sanitizedData.id}">
              </div>

              <!-- Header fields -->
              <div class="row mb-4">
                <div class="col-md-4">
                  <label class="form-label">Date:</label>
                  <input type="date" class="form-control" value="\${sanitizedData.date}" readonly>
                </div>
                <div class="col-md-4">
                  <label class="form-label"><i class="bi bi-person me-1"></i>Who (Payee):</label>
                  <input type="text" class="form-control who-input" value="\${sanitizedData.payee}" placeholder="e.g., XYZ Corp">
                </div>
                <div class="col-md-4">
                  <label class="form-label"><i class="bi bi-chat-text me-1"></i>Why (Description):</label>
                  <input type="text" class="form-control" id="splitDescription" value="\${sanitizedData.description}" placeholder="Enter description for this split transaction">
                </div>
              </div>

              <!-- Split Lines Table -->
              <div class="table-responsive">
                <table class="table table-bordered align-middle" id="splitLinesTable">
                  <thead class="table-light">
                    <tr>
                      <th style="min-width:300px">Description</th>
                      <th style="min-width:250px">Account</th>
                      <th style="min-width:150px">Tax Rate</th>
                      <th style="min-width:150px" class="text-end">Amount</th>
                      <th style="width:50px"></th>
                    </tr>
                  </thead>
                  <tbody id="splitLineBody">
                    <!-- Default split lines will be added here -->
                  </tbody>
                  <tfoot>
                    <tr class="table-secondary">
                      <td colspan="3" class="text-end fw-semibold">Split Total:</td>
                      <td class="text-end fw-semibold" id="splitTotalAmount">$0.00</td>
                      <td></td>
                    </tr>
                    <tr id="balanceValidationRow" class="border-top-0">
                      <td colspan="3" class="text-end">
                        <div class="d-flex justify-content-end align-items-center gap-3">
                          <div>
                            <small class="text-muted">Original Amount:</small>
                            <span class="fw-semibold" id="originalAmountFooter">$0.00</span>
                          </div>
                          <div>
                            <small class="text-muted">Difference:</small>
                            <span class="fw-semibold" id="balanceDifference">$0.00</span>
                          </div>
                        </div>
                      </td>
                      <td class="text-end">
                        <span class="badge" id="balanceStatus">
                          <i class="bi bi-circle"></i> Checking...
                        </span>
                      </td>
                      <td></td>
                    </tr>
                  </tfoot>
                </table>
              </div>

              <button class="btn btn-outline-primary btn-sm" onclick="addSplitLine()">
                <i class="bi bi-plus me-1"></i>Add Split Line
              </button>
            </div>
          </div>

          <!-- Modal Footer -->
          <div class="modal-footer">
            <div class="me-auto">
              <span class="badge bg-info">Prototype Only</span>
              <small class="text-muted ms-2">No data will be saved</small>
            </div>
            <button type="button" class="btn btn-success" onclick="saveSplitTransaction()">
              <i class="bi bi-check me-1"></i>Apply Split
            </button>
            <button type="button" class="btn btn-secondary" onclick="closeSplitModal()">Cancel</button>
          </div>
        </div>
      </div>
    `;

    // Add modal to DOM
    document.body.appendChild(backdrop);
    document.body.appendChild(modal);
    document.body.classList.add('modal-open');

    // Initialize split lines with transaction data
    initializeSplitLines(transactionData.amount, transactionData);
}

// EXACT COPY OF ALL SPLIT FUNCTIONS FROM ORIGINAL
function initializeSplitLines(totalAmount, transactionData = {}) {
    const amount = parseFloat(totalAmount) || 0;
    
    // Set original amount for balance validation
    document.getElementById('originalAmount').textContent = '$' + amount.toFixed(2);
    document.getElementById('originalAmountFooter').textContent = '$' + amount.toFixed(2);
    
    // Create split lines based on actual transaction data or provide blank template
    const splitLines = [];
    
    // If we have existing account data from the main form, use it as first split line
    if (transactionData.whatAccount && transactionData.whatAccount.trim() !== '') {
      splitLines.push({
        description: transactionData.description || 'Split Item 1',
        account: transactionData.whatAccount,
        taxRate: 'Tax Exempt (0%)',
        amount: amount.toFixed(2)
      });
    } else {
      // Provide blank split lines for user to fill in
      splitLines.push({
        description: transactionData.description || '',
        account: '',
        taxRate: 'Tax Exempt (0%)',
        amount: amount.toFixed(2)
      });
      
      // Add a second blank line if amount is significant (suggest potential split)
      if (amount > 100) {
        splitLines.push({
          description: '',
          account: '',
          taxRate: 'Tax Exempt (0%)',
          amount: '0.00'
        });
      }
    }

    const tbody = document.getElementById('splitLineBody');
    tbody.innerHTML = '';

    splitLines.forEach((line, index) => {
      addSplitLineRow(line, index);
    });

    updateSplitTotal();
}

// Add split line row (EXACT COPY)
function addSplitLineRow(preset = {}, index = 0) {
    const tbody = document.getElementById('splitLineBody');
    const row = document.createElement('tr');
    
    row.innerHTML = `
      <td>
        <input type="text" class="form-control form-control-sm" 
               value="\${preset.description || ''}" 
               placeholder="Line description">
      </td>
      <td>
        <input type="text" class="form-control form-control-sm" 
               value="\${preset.account || ''}" 
               placeholder="Account code or name">
      </td>
      <td>
        <select class="form-select form-select-sm">
          <option value="tax_exempt" \${(preset.taxRate || '').includes('Tax Exempt') ? 'selected' : ''}>Tax Exempt (0%)</option>
          <option value="gst_10" \${(preset.taxRate || '').includes('10%') ? 'selected' : ''}>GST (10%)</option>
          <option value="gst_free" \${(preset.taxRate || '').includes('GST Free') ? 'selected' : ''}>GST Free</option>
        </select>
      </td>
      <td>
        <input type="number" class="form-control form-control-sm text-end split-amount" 
               value="\${preset.amount || ''}" 
               step="0.01" 
               placeholder="0.00"
               oninput="updateSplitTotal()"
               onchange="updateSplitTotal()">
      </td>
      <td>
        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeSplitLine(this)">
          <i class="bi bi-trash"></i>
        </button>
      </td>
    `;

    tbody.appendChild(row);
}

// Add new split line (EXACT COPY)
function addSplitLine() {
    addSplitLineRow();
    updateSplitTotal();
}

// Remove split line (EXACT COPY) 
function removeSplitLine(button) {
    button.closest('tr').remove();
    updateSplitTotal();
}

// Update split total with balance validation (EXACT COPY)
function updateSplitTotal() {
    const amounts = document.querySelectorAll('.split-amount');
    let splitTotal = 0;
    
    amounts.forEach(input => {
      splitTotal += parseFloat(input.value) || 0;
    });

    // Get original transaction amount
    const originalAmountElement = document.getElementById('originalAmount');
    const originalAmount = parseFloat(originalAmountElement.textContent.replace(/[$,]/g, '')) || 0;
    
    // Calculate difference
    const difference = splitTotal - originalAmount;
    const absDifference = Math.abs(difference);
    
    // Update display
    document.getElementById('splitTotalAmount').textContent = '$' + splitTotal.toFixed(2);
    document.getElementById('balanceDifference').textContent = (difference >= 0 ? '+' : '') + '$' + difference.toFixed(2);
    
    // Update balance status and styling
    const statusBadge = document.getElementById('balanceStatus');
    const differenceElement = document.getElementById('balanceDifference');
    const validationRow = document.getElementById('balanceValidationRow');
    
    if (absDifference === 0) {
      // Perfect balance
      statusBadge.className = 'badge bg-success';
      statusBadge.innerHTML = '<i class="bi bi-check-circle"></i> Balanced';
      differenceElement.className = 'fw-semibold text-success';
      validationRow.className = 'border-top-0';
    } else if (absDifference <= 0.01) {
      // Minor rounding difference (acceptable)
      statusBadge.className = 'badge bg-warning';
      statusBadge.innerHTML = '<i class="bi bi-exclamation-triangle"></i> Minor Diff';
      differenceElement.className = 'fw-semibold text-warning';
      validationRow.className = 'border-top-0';
    } else {
      // Significant imbalance
      statusBadge.className = 'badge bg-danger';
      statusBadge.innerHTML = '<i class="bi bi-exclamation-circle"></i> Unbalanced';
      differenceElement.className = difference > 0 ? 'fw-semibold text-danger' : 'fw-semibold text-danger';
      validationRow.className = 'border-top-0';
    }
    
    // Update save button state
    updateSaveButtonState(absDifference);
}

// Update save button based on balance status (EXACT COPY)
function updateSaveButtonState(difference) {
    const saveButton = document.querySelector('button[onclick="saveSplitTransaction()"]');
    if (!saveButton) return;
    
    if (difference === 0) {
      saveButton.disabled = false;
      saveButton.className = 'btn btn-success';
      saveButton.innerHTML = '<i class="bi bi-check me-1"></i>Apply Split';
    } else if (difference <= 0.01) {
      saveButton.disabled = false;
      saveButton.className = 'btn btn-warning text-dark';
      saveButton.innerHTML = '<i class="bi bi-exclamation-triangle me-1"></i>Apply (Minor Diff)';
    } else {
      saveButton.disabled = true;
      saveButton.className = 'btn btn-danger';
      saveButton.innerHTML = '<i class="bi bi-exclamation-circle me-1"></i>Balance Required';
    }
}

// Save Split Transaction (EXACT COPY) 
function saveSplitTransaction() {
    const transactionId = document.getElementById('transactionId').value;
    const description = document.getElementById('splitDescription').value;
    
    // Collect all split lines
    const splitLines = [];
    const rows = document.querySelectorAll('#splitLineBody tr');
    
    rows.forEach((row, index) => {
      const descInput = row.querySelector('input[placeholder="Line description"]');
      const accountInput = row.querySelector('input[placeholder="Account code or name"]');
      const taxSelect = row.querySelector('select');
      const amountInput = row.querySelector('.split-amount');
      
      if (accountInput.value.trim() && parseFloat(amountInput.value || 0) !== 0) {
        splitLines.push({
          description: descInput.value.trim() || `Split line \${index + 1}`,
          account: accountInput.value.trim(),
          taxRate: taxSelect.value,
          amount: parseFloat(amountInput.value || 0)
        });
      }
    });
    
    if (splitLines.length === 0) {
      alert('Please add at least one split line with an account and amount.');
      return;
    }
    
    console.log('Saving split transaction:', {
      transactionId: transactionId,
      description: description,
      splitLines: splitLines
    });
    
    // Show success message (prototype only)
    alert(`Split Transaction Saved!\\n\\nTransaction ID: \${transactionId}\\nSplit into \${splitLines.length} lines\\n\\nNote: This is a prototype - no data was actually saved.`);
    
    closeSplitModal();
}

// Close Split Modal (EXACT COPY)
function closeSplitModal() {
    const modals = document.querySelectorAll('.modal, .modal-backdrop');
    modals.forEach(modal => modal.remove());
    document.body.classList.remove('modal-open');
}

</script>
{% endblock %}

{% extends 'base.html' %}
{% load static humanize %}

{% block extra_head %}
<!-- CSRF Token for AJAX requests -->
{% csrf_token %}
<meta name="csrf-token" content="{{ csrf_token }}">
{% endblock %}

{% block title %}{{ title|default:"Bank Reconciliation" }} - Simple Mode{% endblock %}

{% block extra_css %}
<style>
  /* Keep the same styling as original */
  .balance-banner { background:#f6f7f8; border:1px solid #e5e7eb; border-radius:.5rem; }
  .balance-metric .label { font-size:.8rem; color:#6b7280; }
  .balance-metric .value { font-weight:700; font-size:1rem; }
  .diff-badge { font-size:.75rem; }
  .transaction-row { border-left: 4px solid transparent; }
  .transaction-row.matched { border-left-color: #10b981; background-color: #f0fdf4; }
  .transaction-row:hover { background-color: #f9fafb; }
  .amount-pos { color: #10b981; font-weight: 600; }
  .amount-neg { color: #ef4444; font-weight: 600; }
  .hybrid-input { border: 1px solid #d1d5db; border-radius: 0.375rem; }
  .hybrid-dropdown-btn { border-left: 1px solid #d1d5db; }
  .temp-dropdown { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
  <!-- Header Section - Same style as original -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h2 class="mb-1">
            <i class="fas fa-balance-scale text-primary"></i>
            Bank Reconciliation - {{ account.name }} 
            <span class="badge bg-info">Simple Mode</span>
          </h2>
          <p class="text-muted mb-0">{{ company.name }}</p>
        </div>
        <div>
          <a href="{% url 'reconciliation:dashboard' %}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left"></i> Back to Dashboard
          </a>
          <a href="{% url 'reconciliation:account_reconciliation' account.id %}" class="btn btn-outline-primary ms-2">
            <i class="fas fa-cogs"></i> Advanced Mode
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Progress Section -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h6 class="card-title mb-0">Reconciliation Progress</h6>
            <span class="badge bg-primary progress-percentage">{{ progress.percentage|floatformat:0 }}% Complete</span>
          </div>
          <div class="progress mb-2" style="height: 8px;">
            <div class="progress-bar bg-success" role="progressbar" 
                 style="width: {{ progress.percentage }}%" 
                 aria-valuenow="{{ progress.percentage }}" 
                 aria-valuemin="0" 
                 aria-valuemax="100"></div>
          </div>
          <div class="row text-center">
            <div class="col">
              <small class="text-muted progress-text">
                {{ progress.matched_transactions }} of {{ progress.total_transactions }} transactions completed
              </small>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Balance Summary - Same style as original -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="balance-banner p-4">
        <div class="row text-center">
          <div class="col-md-3">
            <div class="balance-metric">
              <div class="label">Statement Balance</div>
              <div class="value text-primary">${{ progress.statement_balance|floatformat:2|intcomma }}</div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="balance-metric">
              <div class="label">System Balance</div>
              <div class="value text-info">${{ progress.system_balance|floatformat:2|intcomma }}</div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="balance-metric">
              <div class="label">Difference</div>
              <div class="value {% if progress.difference == 0 %}text-success{% else %}text-warning{% endif %}">
                ${{ progress.difference|floatformat:2|intcomma }}
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="balance-metric">
              <div class="label">Reconciled</div>
              <div class="value text-success">{{ progress.percentage|floatformat:0 }}%</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Quick Match Form -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <h6 class="mb-0">Quick Batch Matching</h6>
        </div>
        <div class="card-body">
          <form id="quickMatchForm">
            <div class="row">
              <div class="col-md-3">
                <label class="form-label">WHO (Contact/Payee)</label>
                <input type="text" class="form-control" id="quickWho" placeholder="Enter contact name">
              </div>
              <div class="col-md-4">
                <label class="form-label">WHAT (Account)</label>
                <select class="form-control" id="quickWhat">
                  <option value="">Select account...</option>
                  {% for group_name, accounts in coa_groups.items %}
                    <optgroup label="{{ group_name }}">
                      {% for account_item in accounts %}
                        <option value="{{ account_item.name }}">{{ account_item.code }} - {{ account_item.name }}</option>
                      {% endfor %}
                    </optgroup>
                  {% endfor %}
                </select>
              </div>
              <div class="col-md-3">
                <label class="form-label">WHY (Description)</label>
                <input type="text" class="form-control" id="quickWhy" placeholder="Enter description">
              </div>
              <div class="col-md-2">
                <label class="form-label">&nbsp;</label>
                <button type="button" class="btn btn-primary d-block w-100" onclick="applyToAll()">
                  Apply to All Empty
                </button>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Action Buttons - Simplified -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="d-flex gap-2">
        <button class="btn btn-success" onclick="saveAllTransactions()" id="saveAllBtn">
          <i class="bi bi-check2-all me-1"></i>Save All Matches
        </button>
        <button class="btn btn-outline-warning" onclick="clearAllFields()">
          <i class="bi bi-arrow-clockwise me-1"></i>Clear All Fields
        </button>
        <button class="btn btn-outline-info" onclick="updateProgress()">
          <i class="bi bi-arrow-repeat me-1"></i>Refresh Progress
        </button>
      </div>
    </div>
  </div>

  <!-- Transactions Table - Same style as original but simplified -->
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <h5 class="card-title mb-0">
            <i class="fas fa-list"></i>
            Unmatched Transactions ({{ transactions|length }})
          </h5>
        </div>
        <div class="card-body p-0">
          {% if transactions %}
            <div class="table-responsive">
              <table class="table table-hover mb-0">
                <thead class="table-light">
                  <tr>
                    <th style="width: 100px;">Date</th>
                    <th>Description</th>
                    <th style="width: 120px;" class="text-end">Amount</th>
                    <th style="width: 200px;">WHO (Payee)</th>
                    <th style="width: 250px;">WHAT (Account)</th>
                    <th style="width: 200px;">WHY (Description)</th>
                  </tr>
                </thead>
                <tbody>
                  {% for transaction in transactions %}
                    <tr data-transaction-id="{{ transaction.id }}" class="transaction-row">
                      <td>{{ transaction.date|date:"M d" }}</td>
                      <td>{{ transaction.description|truncatechars:50 }}</td>
                      <td class="text-end">
                        <span class="{% if transaction.amount >= 0 %}amount-pos{% else %}amount-neg{% endif %}">
                          ${{ transaction.amount|floatformat:2|intcomma }}
                        </span>
                      </td>
                      <td>
                        <input type="text" class="form-control form-control-sm who-input" 
                               placeholder="Enter contact name">
                      </td>
                      <td>
                        <input type="text" class="form-control form-control-sm what-input" 
                               placeholder="Enter account name">
                      </td>
                      <td>
                        <input type="text" class="form-control form-control-sm why-input" 
                               placeholder="Enter description" 
                               value="{{ transaction.description }}">
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <div class="text-center py-5">
              <i class="fas fa-check-circle text-success mb-3" style="font-size: 3rem;"></i>
              <h4>All Transactions Reconciled!</h4>
              <p class="text-muted">Great job! All transactions have been matched.</p>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Link to the external JavaScript file -->
<script src="{% static 'process/js/reconciliation.js' %}"></script>

<!-- Additional Simple JavaScript -->
<script>
// Get CSRF token for AJAX requests - Use cookie method like base template
function getCsrfToken() {
    // Use same cookie method as base template
    return getCookie('csrftoken');
}

// Helper function to get cookie (same as base template)
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Apply quick match values to all empty fields
function applyToAll() {
  const who = document.getElementById('quickWho').value.trim();
  const what = document.getElementById('quickWhat').value.trim();
  const why = document.getElementById('quickWhy').value.trim();
  
  if (!who || !what) {
    alert('Please enter WHO and WHAT fields');
    return;
  }
  
  if (confirm('Apply these values to all empty fields?')) {
    document.querySelectorAll('[data-transaction-id]').forEach(row => {
      const whoInput = row.querySelector('.who-input');
      const whatInput = row.querySelector('.what-input');
      const whyInput = row.querySelector('.why-input');
      
      if (whoInput && !whoInput.value.trim()) whoInput.value = who;
      if (whatInput && !whatInput.value.trim()) whatInput.value = what;
      if (whyInput && !whyInput.value.trim() && why) whyInput.value = why;
    });
    
    alert('✅ Values applied to all empty fields');
    updateProgress();
  }
}

// Override the progress update function for simple interface
function updateProgress() {
    const totalRows = document.querySelectorAll('[data-transaction-id]').length;
    let completedRows = 0;
    
    document.querySelectorAll('[data-transaction-id]').forEach(row => {
        const whoInput = row.querySelector('.who-input');
        const whatInput = row.querySelector('.what-input');
        
        if (whoInput && whatInput && whoInput.value.trim() && whatInput.value.trim()) {
            completedRows++;
        }
    });

    const percentage = totalRows > 0 ? Math.round((completedRows / totalRows) * 100) : 0;

    // Update progress bar
    const progressBar = document.querySelector('.progress-bar');
    if (progressBar) {
        progressBar.style.width = percentage + '%';
        progressBar.setAttribute('aria-valuenow', percentage);
    }

    // Update progress text
    const progressText = document.querySelector('.progress-text');
    if (progressText) {
        progressText.textContent = `${completedRows} of ${totalRows} transactions completed`;
    }
    
    // Update progress badge
    const progressBadge = document.querySelector('.progress-percentage');
    if (progressBadge) {
        progressBadge.textContent = `${percentage}% Complete`;
    }

    console.log(`Progress: ${completedRows}/${totalRows} (${percentage}%)`);
}

// Auto-save when typing (debounced)
document.addEventListener('input', function(e) {
    if (e.target.matches('.who-input, .what-input, .why-input')) {
        clearTimeout(window.saveTimeout);
        window.saveTimeout = setTimeout(() => {
            updateProgress();
        }, 500);
    }
});

console.log('Simple reconciliation interface loaded');
</script>
{% endblock %}

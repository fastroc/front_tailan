{% extends 'base.html' %}
{% load static %}

{% block title %}{{ title|default:"Bank Reconciliation" }}{% endblock %}

{% block extra_css %}
<style>
  /* —— Layout polish to resemble Xero —— */
  .balance-banner { background:#f6f7f8; border:1px solid #e5e7eb; border-radius:.5rem; }
  .balance-metric .label { font-size:.8rem; color:#6b7280; }
  .balance-metric .value { font-weight:700; font-size:1rem; }
  .diff-badge { font-size:.75rem; }

  .x-tabs .nav-link { font-weight:600; }
  .x-tabs .nav-link.active { border-bottom:3px solid #2563eb; color:#111827; }

  .transaction-item { transition: background .15s ease, border-color .15s ease; }
  .transaction-item:hover { background:#f8fafc; }
  .border-credit { border-left:4px solid #16a34a !important; }
  .border-debit  { border-left:4px solid #ef4444 !important; }
  .amount-pos { color:#16a34a; font-weight:600; }
  .amount-neg { color:#ef4444; font-weight:600; }

  .pillar-label { font-size:.75rem; text-transform:uppercase; letter-spacing:.04em; font-weight:700; }
  .form-control-sm, .form-select-sm { font-size:.85rem; }

  .ok-btn { min-width:96px; }

  /* Compact mode */
  .compact .transaction-item { padding:.5rem .75rem !important; }
  .compact .txn-title { font-size:.9rem; }
  .compact .txn-meta { display:none; }

  .sticky-side { position:sticky; top:1rem; }

  .badge-soft { background:#eaf2ff; color:#2563eb; border:1px solid #cfe0ff; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4" id="reconRoot">
  <!-- ======= Top banner: balances ======= -->
  <div class="balance-banner p-3 mb-3">
    <div class="d-flex align-items-center justify-content-between flex-wrap gap-3">
      <div class="d-flex align-items-center gap-3">
        <i class="fas fa-university text-primary" style="font-size: 28px;"></i>
        <div class="fw-bold">Match transactions from your bank with your books</div>
      </div>
      <div class="d-flex align-items-center gap-3">
        <div class="balance-metric text-end">
          <div class="label">Statement Balance</div>
          <div class="value" id="statementBalance">$125,750.00</div>
        </div>
        <div class="vr"></div>
        <div class="balance-metric text-end">
          <div class="label">Balance in System</div>
          <div class="value" id="systemBalance">$125,750.00</div>
        </div>
        <span id="diffBadge" class="badge diff-badge ms-2"></span>
      </div>
    </div>
  </div>

  <!-- ======= Tabs (Reconcile | Cash coding | Bank statements | Account transactions) ======= -->
  <ul class="nav nav-tabs x-tabs mb-3" role="tablist">
    <li class="nav-item" role="presentation">
      <span class="nav-link active" role="tab">Reconcile ({{ transactions|length }})</span>
    </li>
    <li class="nav-item" role="presentation">
      <a class="nav-link disabled" role="tab" aria-disabled="true">Cash coding</a>
    </li>
    <li class="nav-item" role="presentation">
      <a class="nav-link disabled" role="tab" aria-disabled="true">Bank statements</a>
    </li>
    <li class="nav-item" role="presentation">
      <a class="nav-link disabled" role="tab" aria-disabled="true">Account transactions</a>
    </li>
    <li class="ms-auto nav-item d-flex align-items-center gap-2">
      <span class="text-muted small">Compact view</span>
      <div class="form-check form-switch m-0">
        <input class="form-check-input" type="checkbox" id="compactToggle">
      </div>
    </li>
  </ul>

  <!-- ======= Top: Progress / recent matches (moved to top) ======= -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-body">
          <div class="row g-4 align-items-center">
            <!-- Progress counters -->
            <div class="col-lg-3">
              <div class="row g-2 text-center">
                <div class="col-6">
                  <div class="border rounded p-2">
                    <div class="h5 m-0 text-success" id="matchedCount">0</div>
                    <div class="small text-success">Matched</div>
                  </div>
                </div>
                <div class="col-6">
                  <div class="border rounded p-2">
                    <div class="h5 m-0 text-warning" id="pendingCount">{{ transactions|length }}</div>
                    <div class="small text-warning">Pending</div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Recent matches -->
            <div class="col-lg-6">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <strong class="small">Recent matches</strong>
                <span class="badge badge-soft" id="recentCount">0</span>
              </div>
              <div id="recentMatches" class="small" style="max-height: 80px; overflow-y: auto;">
                <div class="text-muted">No matches yet. Start matching transactions.</div>
              </div>
            </div>
            
            <!-- Quick actions -->
            <div class="col-lg-3">
              <div class="d-grid gap-2">
                <button class="btn btn-outline-primary btn-sm" onclick="autoMatch()"><i class="fas fa-magic me-1"></i>Auto-match</button>
                <button class="btn btn-outline-secondary btn-sm" onclick="clearMatches()"><i class="fas fa-undo me-1"></i>Clear all</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ======= Full Width: Bank transactions ======= -->
  <div class="row">
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-header bg-white border-0 pt-3 pb-2 d-flex justify-content-between align-items-center">
          <div class="fw-bold">Bank transactions ({{ transactions|length }})</div>
          <div class="small text-muted">Review your bank statement lines</div>
        </div>
        <div class="card-body p-0">
          <div class="transaction-list" style="max-height:60vh; overflow-y:auto;">
            {% for t in transactions %}
            <div class="transaction-item p-3 border-bottom {% if t.amount > 0 %}border-credit{% else %}border-debit{% endif %}" data-transaction-id="{{ t.id }}">
              <div class="row g-3 align-items-center">
                <!-- Left: Transaction info (4 columns) -->
                <div class="col-lg-4">
                  <div class="small text-primary fw-semibold txn-date mb-1">
                    <i class="fas fa-calendar me-1"></i>{{ t.date|date:"d M Y" }}
                  </div>
                  <div class="txn-title fw-semibold mb-1">{{ t.description|default:"(no description)"|truncatechars:40 }}</div>
                  <div class="txn-meta text-muted small">Ref: {{ t.reference|default:"—" }} · Memo: {{ t.memo|default:"—" }}</div>
                  <div class="{% if t.amount > 0 %}amount-pos{% else %}amount-neg{% endif %} fw-bold mt-1">
                    {% if t.amount > 0 %}+{% endif %}${{ t.amount|floatformat:0 }}
                    <span class="small text-muted ms-1">{% if t.amount > 0 %}Received{% else %}Spent{% endif %}</span>
                  </div>
                </div>

                <!-- Center: OK Button (1 column) -->
                <div class="col-lg-1 d-flex justify-content-center">
                  <button type="button" class="btn btn-primary btn-sm ok-btn d-none" id="ok{{ t.id }}" onclick="okMatch({{ t.id }})" style="min-width: 60px;">
                    <i class="fas fa-check me-1"></i>OK
                  </button>
                </div>

                <!-- Right: WHO/WHAT/WHY form (7 columns) -->
                <div class="col-lg-7">
                  <div class="row g-2">
                    <!-- First Row: WHO and WHAT -->
                    <div class="col-lg-4">
                      <label class="pillar-label text-info mb-1 small"><i class="fas fa-user me-1"></i>Who</label>
                      <select class="form-select form-select-sm" name="who_{{ t.id }}">
                        <option value="">Contact…</option>
                        <option value="vendor_abc">ABC Company</option>
                        <option value="customer_xyz">XYZ Corp</option>
                        <option value="employee_john">John Doe</option>
                        <option value="bank_transfer">Bank Transfer</option>
                        <option value="government">Government</option>
                        <option value="supplier">Supplier</option>
                        <option value="utility_company">Utility</option>
                      </select>
                    </div>
                    
                    <div class="col-lg-8">
                      <label class="pillar-label text-warning mb-1 small"><i class="fas fa-chart-line me-1"></i>What *</label>
                      <select class="form-select form-select-sm" name="what_{{ t.id }}" required onchange="checkOK({{ t.id }})">
                        <option value="">Choose account…</option>
                        <optgroup label="ASSETS">
                          <option value="1001">1001 — Cash in Hand</option>
                          <option value="1100">1100 — Business Checking</option>
                          <option value="1200">1200 — Accounts Receivable</option>
                          <option value="1300">1300 — Inventory</option>
                          <option value="1400">1400 — Prepaid Expenses</option>
                        </optgroup>
                        <optgroup label="LIABILITIES">
                          <option value="2001">2001 — Accounts Payable</option>
                          <option value="2100">2100 — Accrued Expenses</option>
                          <option value="2200">2200 — Short-term Loans</option>
                        </optgroup>
                        <optgroup label="INCOME">
                          <option value="4000">4000 — Sales Revenue</option>
                          <option value="4100">4100 — Service Income</option>
                          <option value="4200">4200 — Consulting Income</option>
                        </optgroup>
                        <optgroup label="EXPENSES">
                          <option value="5000">5000 — Office Expenses</option>
                          <option value="5100">5100 — Travel Expenses</option>
                          <option value="5200">5200 — Marketing</option>
                          <option value="5300">5300 — Utilities</option>
                          <option value="5400">5400 — Professional Services</option>
                        </optgroup>
                      </select>
                    </div>
                    
                    <!-- Second Row: WHY (full width under WHO and WHAT) -->
                    <div class="col-lg-12">
                      <label class="pillar-label text-success mb-1 small"><i class="fas fa-comment-alt me-1"></i>Why</label>
                      <input class="form-control form-control-sm" name="why_{{ t.id }}" placeholder="Enter description or memo…" value="{{ t.memo|default:'' }}"/>
                    </div>
                    
                    <!-- Third Row: TAX (smaller, under WHY) -->
                    <div class="col-lg-4">
                      <label class="form-label mb-1" style="font-size: 0.65rem; color: #6c757d;">Tax Rate</label>
                      <select class="form-select form-select-sm" name="tax_{{ t.id }}" style="font-size: 0.75rem;">
                        <option value="">No Tax (0%)</option>
                        <option value="5">GST (5%)</option>
                        <option value="10">VAT (10%)</option>
                        <option value="15">Tax (15%)</option>
                      </select>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            {% empty %}
            <div class="text-center text-muted py-5"><i class="fas fa-inbox fa-2x mb-2"></i><div>No transactions</div></div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // ——— Balances diff badge ———
  function updateDiffBadge() {
    const s = parseFloat((document.getElementById('statementBalance')?.textContent||'0').replace(/[,$\s]/g,'')) || 0;
    const b = parseFloat((document.getElementById('systemBalance')?.textContent||'0').replace(/[,$\s]/g,'')) || 0;
    const diff = (s - b).toFixed(2);
    const badge = document.getElementById('diffBadge');
    if (!badge) return;
    if (diff == 0 || diff === '0.00') {
      badge.className = 'badge bg-success diff-badge';
      badge.textContent = 'Balanced';
    } else {
      badge.className = 'badge bg-warning text-dark diff-badge';
      badge.textContent = 'Diff $' + Math.abs(diff);
    }
  }

  // ——— Compact toggle ———
  const root = document.getElementById('reconRoot');
  const compactToggle = document.getElementById('compactToggle');
  if (compactToggle) {
    compactToggle.addEventListener('change', (e) => {
      if (e.target.checked) root.classList.add('compact');
      else root.classList.remove('compact');
    });
  }

  // ——— Matching logic ———
  let matched = [];

  function checkOK(id) {
    const sel = document.querySelector(`[name="what_${id}"]`);
    const btn = document.getElementById('ok'+id);
    if (!sel || !btn) return;
    if (sel.value) btn.classList.remove('d-none');
    else btn.classList.add('d-none');
  }

  function okMatch(id) {
    const row = document.querySelector(`[data-transaction-id="${id}"]`);
    const what = row.querySelector(`[name="what_${id}"]`)?.value;
    if (!what) { alert('Please choose an account (What)'); return; }

    // Freeze fields
    row.querySelectorAll('select, input').forEach(el => el.disabled = true);

    // Visual confirmation
    const okBtn = document.getElementById('ok'+id);
    okBtn.innerHTML = '<i class="fas fa-check me-1"></i>Matched';
    okBtn.classList.add('btn-outline-primary');
    okBtn.classList.remove('btn-primary');
    okBtn.disabled = true;

    // Row styling for matched state
    row.style.backgroundColor = '#f0f9f0';
    row.style.borderLeft = '4px solid #16a34a';

    // Counters
    matched.push(id);
    document.getElementById('matchedCount').textContent = matched.length;
    const total = {{ transactions|length }};
    document.getElementById('pendingCount').textContent = total - matched.length;

    // Recent list
    const desc = row.querySelector('.txn-title')?.textContent?.trim() || ('Txn #' + id);
    const lg = document.getElementById('recentMatches');
    if (lg && lg.firstElementChild && lg.firstElementChild.classList.contains('list-group-item') && lg.firstElementChild.textContent.includes('No matches yet')) {
      lg.innerHTML = '';
    }
    const item = document.createElement('div');
    item.className = 'list-group-item d-flex justify-content-between align-items-start';
    item.innerHTML = `<div><div class="small fw-semibold">${desc}</div><div class="text-muted small">${what}</div></div><span class="badge bg-success">✓</span>`;
    lg.prepend(item);
    const rc = document.getElementById('recentCount');
    rc.textContent = (parseInt(rc.textContent||'0')+1).toString();

    // Update balances (simulate matching effect)
    updateDiffBadge();
  }

  function autoMatch(){
    alert('Auto-match will learn from your past matches and suggest accounts for similar transactions.\n\nThis feature analyzes transaction descriptions and amounts to find patterns.');
  }

  function clearMatches(){
    if(!confirm('Clear all matches? This will reset all matched transactions.')) return;
    matched.forEach(id => {
      const row = document.querySelector(`[data-transaction-id="${id}"]`);
      if (row) {
        row.style.backgroundColor = '';
        row.style.borderLeft = '';
        row.querySelectorAll('select, input').forEach(el => el.disabled = false);
        const btn = document.getElementById('ok'+id);
        if (btn) {
          btn.innerHTML = '<i class="fas fa-check me-1"></i>OK';
          btn.classList.remove('btn-outline-primary');
          btn.classList.add('btn-primary');
          btn.classList.add('d-none');
          btn.disabled = false;
        }
      }
    });
    matched = [];
    document.getElementById('matchedCount').textContent = '0';
    document.getElementById('pendingCount').textContent = '{{ transactions|length }}';
    document.getElementById('recentMatches').innerHTML = '<div class="list-group-item text-muted small">No matches yet. Start matching transactions.</div>';
    document.getElementById('recentCount').textContent = '0';
    updateDiffBadge();
  }

  document.addEventListener('DOMContentLoaded', () => {
    updateDiffBadge();
    console.log('Xero-style bank reconciliation interface ready');
  });
</script>
{% endblock %}

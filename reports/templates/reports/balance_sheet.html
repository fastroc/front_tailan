{% extends "base.html" %}
{% load static %}
{% load humanize %}

{% block title %}{{ report_title }} - {{ company.name }}{% endblock %}

{% block extra_css %}
<style>
/* Professional Balance Sheet Styling */
.balance-sheet-report {
    background: #f8fafc;
    min-height: 100vh;
    padding: 2rem 0;
}

.report-header {
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    padding: 2rem;
    margin-bottom: 2rem;
}

.company-header {
    text-align: center;
    margin-bottom: 2rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid #e2e8f0;
}

.report-table {
    font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace;
    font-size: 0.95rem;
}

.report-table th {
    background: #1e293b !important;
    color: white !important;
    font-weight: 600;
    padding: 1rem;
    border: none;
}

.report-table td {
    padding: 0.75rem 1rem;
    border-bottom: 1px solid #e2e8f0;
    vertical-align: middle;
}

.section-header {
    background: #f1f5f9 !important;
    font-weight: 700;
    color: #1e293b !important;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.account-row:hover {
    background: #f8fafc;
}

.total-row {
    background: #e2e8f0 !important;
    font-weight: 700;
    border-top: 2px solid #1e293b;
}

.grand-total-row {
    background: #1e293b !important;
    color: white !important;
    font-weight: 700;
    border-top: 3px solid #1e293b;
    border-bottom: 3px solid #1e293b;
}

.amount-column {
    text-align: right;
    font-weight: 600;
    min-width: 140px;
}

.account-code {
    color: #64748b;
    font-weight: 500;
    min-width: 80px;
}

.account-name {
    color: #1e293b;
    font-weight: 500;
}

.balance-check {
    margin-top: 2rem;
    padding: 1rem;
    border-radius: 8px;
}

.balance-check.balanced {
    background: #dcfce7;
    border: 1px solid #16a34a;
    color: #166534;
}

.balance-check.unbalanced {
    background: #fee2e2;
    border: 1px solid #dc2626;
    color: #991b1b;
}

.export-buttons {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1rem;
}

.export-btn {
    padding: 0.5rem 1rem;
    border-radius: 6px;
    text-decoration: none;
    font-size: 0.9rem;
    font-weight: 500;
    transition: all 0.3s ease;
}

.report-controls {
    background: white;
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1rem;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.date-control {
    max-width: 200px;
}

@media (max-width: 768px) {
    .report-table {
        font-size: 0.85rem;
    }
    
    .amount-column {
        min-width: 100px;
    }
    
    .export-buttons {
        flex-direction: column;
    }
}

@media print {
    .export-buttons,
    .report-controls,
    .btn {
        display: none !important;
    }
    
    .balance-sheet-report {
        background: white;
        padding: 0;
    }
    
    .report-header {
        box-shadow: none;
        border: 1px solid #000;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="balance-sheet-report">
    <div class="container-fluid">
        <!-- Report Controls -->
        <div class="report-controls">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h1 class="h4 mb-0">{{ report_title }}</h1>
                    <small class="text-muted">{{ report_subtitle }}</small>
                </div>
                <div class="col-md-6 text-md-end">
                    <div class="d-flex align-items-center justify-content-md-end gap-3">
                        <div class="date-control">
                            <label class="form-label mb-1">As at Date:</label>
                            <input type="date" class="form-control form-control-sm" value="{{ report_date|date:'Y-m-d' }}" 
                                   onchange="updateReport(this.value)">
                        </div>
                        <div class="export-buttons">
                            <a href="?as_of_date={{ report_date|date:'Y-m-d' }}&format=pdf" class="export-btn btn btn-outline-danger btn-sm">
                                <i class="bi bi-file-pdf me-1"></i>PDF
                            </a>
                            <a href="?as_of_date={{ report_date|date:'Y-m-d' }}&format=excel" class="export-btn btn btn-outline-success btn-sm">
                                <i class="bi bi-file-excel me-1"></i>Excel
                            </a>
                            <button onclick="window.print()" class="export-btn btn btn-outline-secondary btn-sm">
                                <i class="bi bi-printer me-1"></i>Print
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Balance Sheet Report -->
        <div class="report-header">
            <!-- Company Header -->
            <div class="company-header">
                <h2 class="mb-1">{{ company.name }}</h2>
                <h3 class="h4 text-primary mb-1">{{ report_title }}</h3>
                <p class="text-muted mb-0">{{ report_subtitle }}</p>
            </div>

            <!-- Balance Sheet Table -->
            <div class="table-responsive">
                <table class="table table-sm report-table">
                    <thead>
                        <tr>
                            <th style="width: 10%;">Code</th>
                            <th style="width: 60%;">Account Name</th>
                            <th style="width: 30%;" class="text-end">Amount</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- ASSETS SECTION -->
                        <tr class="section-header">
                            <td colspan="3">ASSETS</td>
                        </tr>
                        
                        <!-- Current Assets -->
                        {% if balance_sheet.assets.current_assets %}
                        <tr class="section-header" style="background: #f8fafc !important;">
                            <td colspan="3" style="padding-left: 2rem; font-weight: 600; color: #4338ca !important;">Current Assets</td>
                        </tr>
                        {% for asset in balance_sheet.assets.current_assets %}
                        <tr class="account-row">
                            <td class="account-code">{{ asset.account.code }}</td>
                            <td class="account-name" style="padding-left: 3rem;">{{ asset.account.name }}</td>
                            <td class="amount-column">${{ asset.balance|floatformat:2|intcomma }}</td>
                        </tr>
                        {% endfor %}
                        <tr class="total-row">
                            <td colspan="2" style="padding-left: 2rem;"><strong>Total Current Assets</strong></td>
                            <td class="amount-column"><strong>${{ balance_sheet.totals.current_assets|floatformat:2|intcomma }}</strong></td>
                        </tr>
                        {% endif %}

                        <!-- Fixed Assets -->
                        {% if balance_sheet.assets.fixed_assets %}
                        <tr class="section-header" style="background: #f8fafc !important;">
                            <td colspan="3" style="padding-left: 2rem; font-weight: 600; color: #4338ca !important;">Fixed Assets</td>
                        </tr>
                        {% for asset in balance_sheet.assets.fixed_assets %}
                        <tr class="account-row">
                            <td class="account-code">{{ asset.account.code }}</td>
                            <td class="account-name" style="padding-left: 3rem;">{{ asset.account.name }}</td>
                            <td class="amount-column">${{ asset.balance|floatformat:2|intcomma }}</td>
                        </tr>
                        {% endfor %}
                        <tr class="total-row">
                            <td colspan="2" style="padding-left: 2rem;"><strong>Total Fixed Assets</strong></td>
                            <td class="amount-column"><strong>${{ balance_sheet.totals.fixed_assets|floatformat:2|intcomma }}</strong></td>
                        </tr>
                        {% endif %}

                        <!-- Other Assets -->
                        {% if balance_sheet.assets.other_assets %}
                        <tr class="section-header" style="background: #f8fafc !important;">
                            <td colspan="3" style="padding-left: 2rem; font-weight: 600; color: #4338ca !important;">Other Assets</td>
                        </tr>
                        {% for asset in balance_sheet.assets.other_assets %}
                        <tr class="account-row">
                            <td class="account-code">{{ asset.account.code }}</td>
                            <td class="account-name" style="padding-left: 3rem;">{{ asset.account.name }}</td>
                            <td class="amount-column">${{ asset.balance|floatformat:2|intcomma }}</td>
                        </tr>
                        {% endfor %}
                        <tr class="total-row">
                            <td colspan="2" style="padding-left: 2rem;"><strong>Total Other Assets</strong></td>
                            <td class="amount-column"><strong>${{ balance_sheet.totals.other_assets|floatformat:2|intcomma }}</strong></td>
                        </tr>
                        {% endif %}

                        <!-- Total Assets -->
                        <tr class="grand-total-row">
                            <td colspan="2"><strong>TOTAL ASSETS</strong></td>
                            <td class="amount-column"><strong>${{ balance_sheet.totals.total_assets|floatformat:2|intcomma }}</strong></td>
                        </tr>

                        <!-- Spacing -->
                        <tr style="height: 2rem;"><td colspan="3"></td></tr>

                        <!-- LIABILITIES SECTION -->
                        <tr class="section-header">
                            <td colspan="3">LIABILITIES</td>
                        </tr>

                        <!-- Current Liabilities -->
                        {% if balance_sheet.liabilities.current_liabilities %}
                        <tr class="section-header" style="background: #f8fafc !important;">
                            <td colspan="3" style="padding-left: 2rem; font-weight: 600; color: #dc2626 !important;">Current Liabilities</td>
                        </tr>
                        {% for liability in balance_sheet.liabilities.current_liabilities %}
                        <tr class="account-row">
                            <td class="account-code">{{ liability.account.code }}</td>
                            <td class="account-name" style="padding-left: 3rem;">{{ liability.account.name }}</td>
                            <td class="amount-column">${{ liability.absolute_balance|floatformat:2|intcomma }}</td>
                        </tr>
                        {% endfor %}
                        <tr class="total-row">
                            <td colspan="2" style="padding-left: 2rem;"><strong>Total Current Liabilities</strong></td>
                            <td class="amount-column"><strong>${{ balance_sheet.totals.current_liabilities|floatformat:2|intcomma }}</strong></td>
                        </tr>
                        {% endif %}

                        <!-- Long-term Liabilities -->
                        {% if balance_sheet.liabilities.long_term_liabilities %}
                        <tr class="section-header" style="background: #f8fafc !important;">
                            <td colspan="3" style="padding-left: 2rem; font-weight: 600; color: #dc2626 !important;">Long-term Liabilities</td>
                        </tr>
                        {% for liability in balance_sheet.liabilities.long_term_liabilities %}
                        <tr class="account-row">
                            <td class="account-code">{{ liability.account.code }}</td>
                            <td class="account-name" style="padding-left: 3rem;">{{ liability.account.name }}</td>
                            <td class="amount-column">${{ liability.absolute_balance|floatformat:2|intcomma }}</td>
                        </tr>
                        {% endfor %}
                        <tr class="total-row">
                            <td colspan="2" style="padding-left: 2rem;"><strong>Total Long-term Liabilities</strong></td>
                            <td class="amount-column"><strong>${{ balance_sheet.totals.long_term_liabilities|floatformat:2|intcomma }}</strong></td>
                        </tr>
                        {% endif %}

                        <!-- Total Liabilities -->
                        <tr class="total-row">
                            <td colspan="2"><strong>TOTAL LIABILITIES</strong></td>
                            <td class="amount-column"><strong>${{ balance_sheet.totals.total_liabilities|floatformat:2|intcomma }}</strong></td>
                        </tr>

                        <!-- Spacing -->
                        <tr style="height: 1rem;"><td colspan="3"></td></tr>

                        <!-- EQUITY SECTION -->
                        <tr class="section-header">
                            <td colspan="3">EQUITY</td>
                        </tr>

                        {% for equity in balance_sheet.equity %}
                        <tr class="account-row">
                            <td class="account-code">{{ equity.account.code }}</td>
                            <td class="account-name" style="padding-left: 2rem;">{{ equity.account.name }}</td>
                            <td class="amount-column">${{ equity.absolute_balance|floatformat:2|intcomma }}</td>
                        </tr>
                        {% endfor %}

                        <!-- Total Equity -->
                        <tr class="total-row">
                            <td colspan="2"><strong>TOTAL EQUITY</strong></td>
                            <td class="amount-column"><strong>${{ balance_sheet.totals.total_equity|floatformat:2|intcomma }}</strong></td>
                        </tr>

                        <!-- Spacing -->
                        <tr style="height: 1rem;"><td colspan="3"></td></tr>

                        <!-- Total Liabilities + Equity -->
                        <tr class="grand-total-row">
                            <td colspan="2"><strong>TOTAL LIABILITIES & EQUITY</strong></td>
                            <td class="amount-column"><strong>${{ balance_sheet.totals.total_liabilities_equity|floatformat:2|intcomma }}</strong></td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Balance Check -->
            <div class="balance-check {% if balance_sheet.totals.balance_check == 0 %}balanced{% else %}unbalanced{% endif %}">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <strong>
                            {% if balance_sheet.totals.balance_check == 0 %}
                                <i class="bi bi-check-circle me-2"></i>Balance Sheet is BALANCED
                            {% else %}
                                <i class="bi bi-exclamation-triangle me-2"></i>Balance Sheet is NOT BALANCED
                            {% endif %}
                        </strong>
                        <div class="small mt-1">
                            Total Assets: ${{ balance_sheet.totals.total_assets|floatformat:2|intcomma }} | 
                            Total Liabilities & Equity: ${{ balance_sheet.totals.total_liabilities_equity|floatformat:2|intcomma }}
                            {% if balance_sheet.totals.balance_check != 0 %}
                            | Difference: ${{ balance_sheet.totals.balance_check|floatformat:2|intcomma }}
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-md-4 text-md-end">
                        <div class="small text-muted">
                            Generated on {{ "now"|date:"F j, Y \a\\t g:i A" }}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="text-center mt-4">
            <a href="{% url 'reports:xero_dashboard' %}" class="btn btn-secondary me-2">
                <i class="bi bi-arrow-left me-2"></i>Back to Dashboard
            </a>
            <a href="{% url 'reports:trial_balance' %}?as_of_date={{ report_date|date:'Y-m-d' }}" class="btn btn-outline-primary me-2">
                <i class="bi bi-calculator me-2"></i>View Trial Balance
            </a>
            <a href="{% url 'reports:profit_loss' %}?end_date={{ report_date|date:'Y-m-d' }}" class="btn btn-outline-success">
                <i class="bi bi-graph-up me-2"></i>View Profit & Loss
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function updateReport(newDate) {
    const url = new URL(window.location);
    url.searchParams.set('as_of_date', newDate);
    window.location.href = url.toString();
}

// Enhanced table interactions
document.addEventListener('DOMContentLoaded', function() {
    // Add hover effects to account rows
    const accountRows = document.querySelectorAll('.account-row');
    accountRows.forEach(row => {
        row.addEventListener('mouseenter', function() {
            this.style.backgroundColor = '#f1f5f9';
        });
        
        row.addEventListener('mouseleave', function() {
            this.style.backgroundColor = '';
        });
    });
    
    // Add click handlers for drill-down functionality
    accountRows.forEach(row => {
        row.addEventListener('click', function() {
            const accountCode = this.querySelector('.account-code').textContent.trim();
            if (accountCode) {
                // In a real implementation, this would show account detail
                console.log('Drill down for account:', accountCode);
            }
        });
    });
});
</script>
{% endblock %}

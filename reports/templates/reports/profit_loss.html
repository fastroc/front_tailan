{% extends "base.html" %}
{% load static %}
{% load humanize %}

{% block title %}{{ report_title }} - {{ company.name }}{% endblock %}

{% block extra_css %}
<style>
/* Professional Profit & Loss Styling */
.profit-loss-report {
    background: #f8fafc;
    min-height: 100vh;
    padding: 2rem 0;
}

.report-header {
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    padding: 2rem;
    margin-bottom: 2rem;
}

.company-header {
    text-align: center;
    margin-bottom: 2rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid #e2e8f0;
}

.pl-table {
    font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace;
    font-size: 0.95rem;
}

.pl-table th {
    background: #059669 !important;
    color: white !important;
    font-weight: 600;
    padding: 1rem;
    border: none;
}

.pl-table td {
    padding: 0.75rem 1rem;
    border-bottom: 1px solid #e2e8f0;
    vertical-align: middle;
}

.revenue-section {
    background: #dcfce7 !important;
    color: #166534 !important;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.expense-section {
    background: #fee2e2 !important;
    color: #991b1b !important;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.account-row:hover {
    background: #f8fafc;
}

.subtotal-row {
    background: #f1f5f9 !important;
    font-weight: 600;
    border-top: 1px solid #94a3b8;
}

.total-row {
    background: #e2e8f0 !important;
    font-weight: 700;
    border-top: 2px solid #1e293b;
}

.net-profit-row {
    background: #059669 !important;
    color: white !important;
    font-weight: 700;
    border-top: 3px solid #059669;
    border-bottom: 3px solid #059669;
}

.net-loss-row {
    background: #dc2626 !important;
    color: white !important;
    font-weight: 700;
    border-top: 3px solid #dc2626;
    border-bottom: 3px solid #dc2626;
}

.amount-column {
    text-align: right;
    font-weight: 600;
    min-width: 140px;
}

.account-code {
    color: #64748b;
    font-weight: 500;
    min-width: 80px;
}

.account-name {
    color: #1e293b;
    font-weight: 500;
}

.period-info {
    background: #e0f2fe;
    border: 1px solid #0891b2;
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 2rem;
}

.profit-margin-display {
    text-align: center;
    padding: 1.5rem;
    margin-top: 2rem;
    border-radius: 8px;
    background: linear-gradient(135deg, #059669 0%, #0891b2 100%);
    color: white;
}

.profit-margin-display.negative {
    background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
}

.report-controls {
    background: white;
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1rem;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.date-range {
    display: flex;
    gap: 1rem;
    align-items: center;
}

.export-buttons {
    display: flex;
    gap: 0.5rem;
}

@media (max-width: 768px) {
    .pl-table {
        font-size: 0.85rem;
    }
    
    .amount-column {
        min-width: 100px;
    }
    
    .date-range {
        flex-direction: column;
        gap: 0.5rem;
    }
    
    .export-buttons {
        flex-direction: column;
    }
}

@media print {
    .export-buttons,
    .report-controls,
    .btn {
        display: none !important;
    }
    
    .profit-loss-report {
        background: white;
        padding: 0;
    }
    
    .report-header {
        box-shadow: none;
        border: 1px solid #000;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="profit-loss-report">
    <div class="container-fluid">
        <!-- Report Controls -->
        <div class="report-controls">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h1 class="h4 mb-0">{{ report_title }}</h1>
                    <small class="text-muted">{{ report_subtitle }}</small>
                </div>
                <div class="col-md-6 text-md-end">
                    <div class="d-flex align-items-center justify-content-md-end gap-3">
                        <div class="date-range">
                            <div>
                                <label class="form-label mb-1">From:</label>
                                <input type="date" class="form-control form-control-sm" value="{{ start_date|date:'Y-m-d' }}" 
                                       id="startDate">
                            </div>
                            <div>
                                <label class="form-label mb-1">To:</label>
                                <input type="date" class="form-control form-control-sm" value="{{ end_date|date:'Y-m-d' }}" 
                                       id="endDate">
                            </div>
                            <button onclick="updateReport()" class="btn btn-primary btn-sm">Update</button>
                        </div>
                        <div class="export-buttons">
                            <a href="?start_date={{ start_date|date:'Y-m-d' }}&end_date={{ end_date|date:'Y-m-d' }}&format=pdf" 
                               class="btn btn-outline-danger btn-sm">
                                <i class="bi bi-file-pdf me-1"></i>PDF
                            </a>
                            <a href="?start_date={{ start_date|date:'Y-m-d' }}&end_date={{ end_date|date:'Y-m-d' }}&format=excel" 
                               class="btn btn-outline-success btn-sm">
                                <i class="bi bi-file-excel me-1"></i>Excel
                            </a>
                            <button onclick="window.print()" class="btn btn-outline-secondary btn-sm">
                                <i class="bi bi-printer me-1"></i>Print
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Period Information -->
        <div class="period-info">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <strong>Reporting Period:</strong> {{ period_months }} month{% if period_months > 1 %}s{% endif %}
                    ({{ start_date|date:"F j, Y" }} to {{ end_date|date:"F j, Y" }})
                </div>
                <div class="col-md-4 text-md-end">
                    <strong>Report Date:</strong> {{ "now"|date:"F j, Y" }}
                </div>
            </div>
        </div>

        <!-- Main Profit & Loss Report -->
        <div class="report-header">
            <!-- Company Header -->
            <div class="company-header">
                <h2 class="mb-1">{{ company.name }}</h2>
                <h3 class="h4 text-success mb-1">{{ report_title }}</h3>
                <p class="text-muted mb-0">{{ report_subtitle }}</p>
            </div>

            <!-- P&L Table -->
            <div class="table-responsive">
                <table class="table table-sm pl-table">
                    <thead>
                        <tr>
                            <th style="width: 10%;">Code</th>
                            <th style="width: 60%;">Account Name</th>
                            <th style="width: 30%;" class="text-end">Amount</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- REVENUE SECTION -->
                        <tr class="revenue-section">
                            <td colspan="3">REVENUE</td>
                        </tr>
                        
                        {% for revenue in profit_loss.revenue_accounts %}
                        <tr class="account-row">
                            <td class="account-code">{{ revenue.account.code }}</td>
                            <td class="account-name" style="padding-left: 2rem;">{{ revenue.account.name }}</td>
                            <td class="amount-column">${{ revenue.balance|floatformat:2|intcomma }}</td>
                        </tr>
                        {% endfor %}
                        
                        {% if not profit_loss.revenue_accounts %}
                        <tr>
                            <td colspan="3" class="text-center text-muted" style="padding: 2rem;">
                                No revenue recorded for this period
                            </td>
                        </tr>
                        {% endif %}
                        
                        <!-- Total Revenue -->
                        <tr class="total-row">
                            <td colspan="2"><strong>TOTAL REVENUE</strong></td>
                            <td class="amount-column"><strong>${{ profit_loss.totals.total_revenue|floatformat:2|intcomma }}</strong></td>
                        </tr>

                        <!-- Spacing -->
                        <tr style="height: 2rem;"><td colspan="3"></td></tr>

                        <!-- EXPENSES SECTION -->
                        <tr class="expense-section">
                            <td colspan="3">EXPENSES</td>
                        </tr>
                        
                        {% for expense in profit_loss.expense_accounts %}
                        <tr class="account-row">
                            <td class="account-code">{{ expense.account.code }}</td>
                            <td class="account-name" style="padding-left: 2rem;">{{ expense.account.name }}</td>
                            <td class="amount-column">${{ expense.balance|floatformat:2|intcomma }}</td>
                        </tr>
                        {% endfor %}
                        
                        {% if not profit_loss.expense_accounts %}
                        <tr>
                            <td colspan="3" class="text-center text-muted" style="padding: 2rem;">
                                No expenses recorded for this period
                            </td>
                        </tr>
                        {% endif %}
                        
                        <!-- Total Expenses -->
                        <tr class="total-row">
                            <td colspan="2"><strong>TOTAL EXPENSES</strong></td>
                            <td class="amount-column"><strong>${{ profit_loss.totals.total_expenses|floatformat:2|intcomma }}</strong></td>
                        </tr>

                        <!-- Spacing -->
                        <tr style="height: 2rem;"><td colspan="3"></td></tr>

                        <!-- Net Profit/Loss -->
                        <tr class="{% if profit_loss.totals.net_profit >= 0 %}net-profit-row{% else %}net-loss-row{% endif %}">
                            <td colspan="2">
                                <strong>
                                    {% if profit_loss.totals.net_profit >= 0 %}
                                        NET PROFIT
                                    {% else %}
                                        NET LOSS
                                    {% endif %}
                                </strong>
                            </td>
                            <td class="amount-column">
                                <strong>${{ profit_loss.totals.net_profit|floatformat:2|intcomma }}</strong>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Profit Margin Display -->
            <div class="profit-margin-display {% if profit_loss.totals.net_profit < 0 %}negative{% endif %}">
                <div class="row align-items-center">
                    <div class="col-md-4 text-center">
                        <div style="font-size: 2.5rem; font-weight: 700;">
                            {{ profit_loss.totals.profit_margin|floatformat:1 }}%
                        </div>
                        <div>Profit Margin</div>
                    </div>
                    <div class="col-md-4 text-center">
                        <div style="font-size: 1.5rem; font-weight: 600;">
                            ${{ profit_loss.totals.total_revenue|floatformat:0|intcomma }}
                        </div>
                        <div>Total Revenue</div>
                    </div>
                    <div class="col-md-4 text-center">
                        <div style="font-size: 1.5rem; font-weight: 600;">
                            ${{ profit_loss.totals.total_expenses|floatformat:0|intcomma }}
                        </div>
                        <div>Total Expenses</div>
                    </div>
                </div>
            </div>

            <!-- Summary Cards -->
            <div class="row mt-4">
                <div class="col-md-3">
                    <div class="card text-center border-success">
                        <div class="card-body">
                            <h5 class="card-title text-success">Revenue</h5>
                            <h4 class="text-success">${{ profit_loss.totals.total_revenue|floatformat:0|intcomma }}</h4>
                            <small class="text-muted">{{ profit_loss.revenue_accounts|length }} account{% if profit_loss.revenue_accounts|length != 1 %}s{% endif %}</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center border-danger">
                        <div class="card-body">
                            <h5 class="card-title text-danger">Expenses</h5>
                            <h4 class="text-danger">${{ profit_loss.totals.total_expenses|floatformat:0|intcomma }}</h4>
                            <small class="text-muted">{{ profit_loss.expense_accounts|length }} account{% if profit_loss.expense_accounts|length != 1 %}s{% endif %}</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center border-{% if profit_loss.totals.net_profit >= 0 %}success{% else %}danger{% endif %}">
                        <div class="card-body">
                            <h5 class="card-title text-{% if profit_loss.totals.net_profit >= 0 %}success{% else %}danger{% endif %}">
                                {% if profit_loss.totals.net_profit >= 0 %}Net Profit{% else %}Net Loss{% endif %}
                            </h5>
                            <h4 class="text-{% if profit_loss.totals.net_profit >= 0 %}success{% else %}danger{% endif %}">
                                ${{ profit_loss.totals.net_profit|floatformat:0|intcomma }}
                            </h4>
                            <small class="text-muted">{{ profit_loss.totals.profit_margin|floatformat:1 }}% margin</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center border-info">
                        <div class="card-body">
                            <h5 class="card-title text-info">Period</h5>
                            <h4 class="text-info">{{ period_months }} Month{% if period_months > 1 %}s{% endif %}</h4>
                            <small class="text-muted">{{ start_date|date:"M Y" }} - {{ end_date|date:"M Y" }}</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Report Footer -->
            <div class="text-center mt-4 pt-3 border-top">
                <small class="text-muted">
                    Generated on {{ "now"|date:"F j, Y \a\\t g:i A" }} | 
                    {{ profit_loss.revenue_accounts|length|add:profit_loss.expense_accounts|length }} accounts included |
                    {% if profit_loss.totals.net_profit >= 0 %}
                        Profit: ${{ profit_loss.totals.net_profit|floatformat:0|intcomma }}
                    {% else %}
                        Loss: ${{ profit_loss.totals.net_profit|floatformat:0|intcomma }}
                    {% endif %}
                </small>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="text-center mt-4">
            <a href="{% url 'reports:xero_dashboard' %}" class="btn btn-secondary me-2">
                <i class="bi bi-arrow-left me-2"></i>Back to Dashboard
            </a>
            <a href="{% url 'reports:balance_sheet' %}?as_of_date={{ end_date|date:'Y-m-d' }}" class="btn btn-outline-primary me-2">
                <i class="bi bi-building me-2"></i>View Balance Sheet
            </a>
            <a href="{% url 'reports:trial_balance' %}?as_of_date={{ end_date|date:'Y-m-d' }}" class="btn btn-outline-info">
                <i class="bi bi-calculator me-2"></i>View Trial Balance
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function updateReport() {
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    
    if (startDate && endDate) {
        const url = new URL(window.location);
        url.searchParams.set('start_date', startDate);
        url.searchParams.set('end_date', endDate);
        window.location.href = url.toString();
    }
}

// Enhanced table interactions
document.addEventListener('DOMContentLoaded', function() {
    // Add hover effects to account rows
    const accountRows = document.querySelectorAll('.account-row');
    accountRows.forEach(row => {
        row.addEventListener('mouseenter', function() {
            this.style.backgroundColor = '#f1f5f9';
        });
        
        row.addEventListener('mouseleave', function() {
            this.style.backgroundColor = '';
        });
    });
    
    // Add click handlers for drill-down functionality
    accountRows.forEach(row => {
        row.addEventListener('click', function() {
            const accountCode = this.querySelector('.account-code').textContent.trim();
            if (accountCode) {
                // In a real implementation, this would show account detail
                console.log('Drill down for account:', accountCode);
            }
        });
    });
    
    // Animate profit margin on page load
    setTimeout(() => {
        const profitMargin = document.querySelector('.profit-margin-display');
        if (profitMargin) {
            profitMargin.style.opacity = '0';
            profitMargin.style.transform = 'translateY(20px)';
            profitMargin.style.transition = 'all 0.8s ease';
            
            setTimeout(() => {
                profitMargin.style.opacity = '1';
                profitMargin.style.transform = 'translateY(0)';
            }, 200);
        }
    }, 100);
});
</script>
{% endblock %}
